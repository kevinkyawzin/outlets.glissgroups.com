@model BigMac.Models.Salesorder_m_salesorder

@{
    ViewBag.Title = "SalesOrder";
    Layout = "~/Views/Shared/_GeneralLayoutPage.cshtml";
    string rno="";
    string qno = "";
    if (Model.resourcecode == "") 
    {rno = "";}
    else 
    {rno = "Order# : " + Model.resourcecode;    }

    if (Model.queuenumber == "")
    { qno = ""; }
    else
    { qno = "Queue# : " + Model.queuenumber; }
    
}
@section partialCSS {
    <link href="@Url.Content("~/css/app/salesorder/salesorder_main.css")" rel="stylesheet" type="text/css" />
}
<style>
    .fixme {
        position: relative;
        left: expression( ( 20 + ( ignoreMe2 = document.documentElement.scrollLeft ? document.documentElement.scrollLeft : document.body.scrollLeft ) ) + 'px' );
        background-color: #FFFFFF;
    }

    .table > thead > tr > th {
        word-wrap: break-word;
        padding: 5px 0 5px 0;
        margin: 0px;
        text-align: center;
        vertical-align: central;
        font-weight:600;
        vertical-align:middle;
    }

    .table > tbody > tr > td {
        text-align: right;
        vertical-align: middle;        
        font-size: small;
        height: 25px;
        padding: 1px 5px 1px 5px;
    }
    .table > tbody > tr > td > input {
            text-align: right;
            vertical-align: central;
            font-weight: 600;
            font-size: small;
            padding-top: 0px;
            padding-right: 0px;
            font-size: 13px;
    }
     #tblIncompletedCourse .classDataTable { text-align: left; }


     .btn-default{
         background-color:#dddddd;
     }

     .btn-default:hover {
        cursor:not-allowed !important;
     }

     input[type="checkbox"]{
        width:20px;
     }

     .text-center {
       text-align:center !important;
     }
     .text-left {
           text-align:left !important;
     }
     .text-right{
          text-align:right !important;
     }
      
   
     .ptop5{
         padding-top:5px;
     }

     .ui-autocomplete{
       z-index: 999999 !important;
     }
</style>
<input type="hidden" value="@ViewBag.Rcode" id="rcode" />
<input type="hidden" value="@Model.resourcecode" id="socode" />
<input type="hidden" value="@Model.status" id="status" />
<input type="hidden" value="@Model.id" id="soid" />
<input type="hidden" value="@ViewBag.AppID" id="appid" />
<input type="hidden" value="@Model.invoiceid" id="invoiceid" />
<input type="hidden" value="@Model.cussupid" id="txtcustid" />
<input type="hidden" value="@Model.cussupname" id="txtcustname" />
<input type="hidden" value="@ViewBag.CussupCode" id="txtcustcode" />
<input type="hidden" id="c" value="@ViewBag.CitiDesc" />
<input type="hidden" id="b" value="@ViewBag.BonusDesc" />
<input type="hidden" value="@ViewBag.CoName" id="hidconame" />
<input type="hidden" value="@ViewBag.CoAddress" id="hidcoaddress" />
<input type="hidden" value="@ViewBag.Tel" id="hidtel" />
<input type="hidden" value="@ViewBag.Fax" id="hidfax" />
<input type="hidden" value="@ViewBag.Email" id="hidemail" />
<input type="hidden" value="@ViewBag.CoRegNo" id="hidcoregno" />
<input type="hidden" value="@ViewBag.GSTRegNo" id="hidgstregno" />
<input type="hidden" value="@ViewBag.StaffID" id="hidstaffid" />
<input type="hidden" value="@ViewBag.FacilityID" id="hidfacilityid" />
<input type="hidden" id="hidsignfilename" />
<input type="hidden" value="@ViewBag.IsMobile" id="hidismobile" />
<input type="hidden" value="" id="hidItemID" />

<div class="row" style="margin-top:-10px;">
    <div class="col-lg-12">
        <div class="box">
            <div class="box-content">
                @using (Html.BeginForm("CampaignDetail", "Campaign", FormMethod.Post, new { @class = "form-horizontal" }))
                {
                    @Html.ValidationSummary(true)
                    <fieldset>
                        <div class="row">
                            <div class="col-lg-12 hidden-sm">
                                <div class="col-lg-10" style="">
                                    <div id="divAppointment" style="display:none;">
                                        <table class='table table-striped table-bordered' id="tblAppointment" width="100%">
                                            <thead>
                                                <tr>
                                                    <th style='width:3%;background-color:#903030;color:#e5e5e5'>ID</th>
                                                    <th style='width:5%;background-color:#903030;color:#e5e5e5'>Date</th>
                                                    <th style='width:15%;background-color:#903030;color:#e5e5e5'>Time</th>
                                                    <th style='width:15%;background-color:#903030;color:#e5e5e5'>Name</th>
                                                    <th style='width:9%;background-color:#903030;color:#e5e5e5'>Mobile</th>
                                                    <th style='width:9%;background-color:#903030;color:#e5e5e5'>NRIC</th>
                                                    <th style='width:15%;background-color:#903030;color:#e5e5e5'>Staff</th>
                                                    <th style='width:10%;background-color:#903030;color:#e5e5e5'>Room</th>
                                                    <th style='width:15%;background-color:#903030;color:#e5e5e5'>Description</th>
                                                    <th style='width:5%;background-color:#903030;color:#e5e5e5'>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                     </div>
                                </div>
                                <div class="col-lg-2" style="color:black;font-size:23px;padding-right:10px;font-weight:700;height:30px;vertical-align:middle;padding-left:0px;padding-top:0px;text-align:right;">
                                    <span id="txtQueueNo">@qno </span>
                                    <div id="dateHigher" style="text-align:right;padding-right:10px;font-size:18px;color:black;font-weight: normal;">@DateTime.Now.ToString("hh:mm:ss dd/MM/yyyy")</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-12 hidden-sm">
                                <div class="col-lg-9" style="">
                                </div>
                                <div id="lblSONO" class="col-lg-3" style="color:#383737;font-size:17px;padding-right:10px;font-weight:700;height:30px;vertical-align:middle;padding-left:0px;padding-top:5px;text-align:right;">
                                    <span id="txtsono">@rno </span>
                                </div>
                            </div>
                            <div class="col-sm-12 hidden-lg ">
                           </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-12 hidden-sm">
                               <div class="col-lg-9" style="">
                                </div>
                                <div id="dateLower" class="col-lg-3" style="text-align:right;padding-right:10px;font-size:14px;color:black;">@DateTime.Now.ToString("hh:mm:ss dd/MM/yyyy")</div>
                            </div>
                            <div class="col-sm-12 hidden-lg ">
                            
                            </div>
                        </div>
                     
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="box">
                                    <div class="box-header">
                                        <i class="fa fa-list-alt"></i>&nbsp;Order Details
                                    </div>
                                    <div class="box-content">
                                        <div class="col-sm-12">
                                            <div class="col-lg-6 hidden-sm">
                                                <div class="form-group">
                                                    <label class="control-label">Customer</label>
                                                    <div class="controls" style="padding-right:10px;">
                                                        <input type='text' class='form-control' style="color:black" id="txtCustomer" placeholder="Enter Customer Name / Mobile / Code" />
                                                   </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-6 hidden-sm">
                                                <div class="form-group" style="padding-right: 10px;">
                                                    <label class="control-label">Staff</label>
                                                    <div class="controls" style="padding-right:10px;">
                                                        @Html.DropDownList("cbobkstaff", new SelectList(@ViewBag.StaffOptions, "id", "name"), string.Empty)
                                                    </div>     
                                              </div>
                                            </div>
                                            <div class="clearfix"></div>
                                            <div class="col-lg-6 hidden-sm">
                                                <div class="form-group">
                                                    <label class="control-label">Facility</label>
                                                    <div class="controls" style="padding-right:10px;">
                                                        @Html.DropDownList("cbofacility", new SelectList(@ViewBag.FacilityOptions, "id", "name"), string.Empty)
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-12 hidden-sm">
                                                <div style="float:right;padding:35px 0px 0px 0px;">
                                                    <button id="btnMember" type="button" class="btn btn-success" value="search" style="width:170px;" onclick="OpenMemberDialog();">Create New Customer</button>
                                                    <button type="button" id="btnSaleOrderListing" class="btn btn-success" style="background-color: #931313; width: 110px;" onclick='goToListing();'>Order List</button>
                                                    <button type="button" id="btnSaleOrderNew" class="btn btn-success" style="background-color: #931313; width: 100px;" onclick="newOrder();">New Order</button>

                                                  </div>
                                            </div>
                                            <div class="clearfix"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>  
                            <div class="col-lg-6">
                                <div class="box">
                                    <div class="box-header">
                                        <i class="fa fa-edit"></i>&nbsp;Item Entry
                                    </div>
                                    <div class="box-content">
                                        <div class="col-sm-12">
                                            <div class="col-lg-9 hidden-sm">
                                                <div class="form-group">
                                                    <label class="control-label">Product</label>
                                                    <div class="controls" style="padding-right:10px;"><input type='text' class='form-control' id="txtProduct" placeholder="Enter Product Name/Code" /></div>
                                                </div>
                                            </div>
                                          
                                            <div class="col-lg-2 hidden-sm" >
                                                <div class="form-group" style="padding-right: 10px;">
                                                    <label class="control-label">Qty</label>
                                                    <div class="controls"><input type='text' class='form-control' style="text-align:right" id="txtQty" /></div>
                                                </div>
                                            </div>
                                           
                                            <div class="clearfix"></div>
                                            <div class="col-lg-11 hidden-sm">
                                                <div class="form-group">
                                                    <label class="control-label">Description</label>
                                                    <div class="controls">
                                                        <textarea rows="3" style="width: 100%; overflow: hidden; word-wrap: break-word; resize: horizontal;" id="txtProdDescription" disabled="disabled"> </textarea>
                                                    </div>
                                                </div>
                                            </div>
                                           
                                            <div class="col-lg-12 hidden-sm">
                                                <div style="float:right;padding:0px 0px 0px 0px;">
                                                    <button type="button" id="btnBalance" class="btn btn-success" value="Package" onclick="showProductBalance();" style="width:100px;">Product Balance</button>
                                                    <button type="button" id="btnSalesKit" class="btn btn-success" value="Catalog" onclick="showSalesKit(this);" style="width:90px;">Sales Kits</button>
                                                    <button type="button" id="btnCatalog" class="btn btn-success" value="Catalog" onclick="showIncomCourseList();" style="width:150px;display:none;">Incompleted Course</button>
                                                    <button type="button" id="btnFreeServices" class="btn btn-success" value="FreeServices" onclick="showFreeServices();" style="width:110px;">Free Item</button>
                                                    <button type="button" id="btnPackage" class="btn btn-success" value="Package" onclick="showPackage();" style="width:100px;">Package</button>
                                                    <button type="button" id="btnAddItem" class="btn btn-success" value="Print" onclick="addItem();">Add Item</button>
                                                </div>
                                            </div>
                                            
                                            <div class="clearfix"></div>
                                        </div>
                                        <div id="leaveConfig" style="background-color:red;">
                                        </div>
                                    </div>
                                </div>
                            </div>  
                            <div class="col-lg-4">    
                            </div> 
                         </div>
                        <div class="row">
                            <div class="" style="padding-top:20px;padding-left:15px;padding-left:15px;padding-right:15px;">
                                <div class="">
                                    <table class="table table-striped table-bordered" id="tblItem">
                                        <thead>
                                            <tr>
                                                <th rowspan='2' style="width:2%;background-color:#1e53ab;color:#e5e5e5">S/N</th>
                                                <th rowspan='2' style="display:none">ID</th>
                                                <th rowspan='2' style="display:none">PID</th>
                                                <th rowspan='2' style="display:none">Code</th>
                                                <th rowspan='2' style="width:10%;background-color:#1e53ab;color:#e5e5e5">Description</th>
                                                <th rowspan='2' style="width:3%;background-color:#1e53ab;color:#e5e5e5">Bal</th>
                                                <th rowspan='2' style="width:3%;background-color:#1e53ab;color:#e5e5e5">Qty</th>
                                                <th rowspan='2' style="width:2%;background-color:#1e53ab;color:#e5e5e5;display:none;">UOM</th>
                                                <th rowspan='2' style="width:2%;background-color:#1e53ab;color:#e5e5e5;display:none;">Rdm Qty</th>
                                                <th rowspan='2' style="width:3%;background-color:#1e53ab;color:#e5e5e5">Sell S$</th>
                                                <th rowspan='2' style="width:3%;background-color:#1e53ab;color:#e5e5e5">Total S$</th>
                                                <th rowspan='2' style="width:5%;background-color:#1e53ab;color:#e5e5e5">Facility</th>
                                                <th rowspan='2' style="width:5%;background-color:#1e53ab;color:#e5e5e5">Staff</th>
                                                <th rowspan='2' style="width:5%;background-color:#1e53ab;color:#e5e5e5">Start Time</th>
                                                <th rowspan='2' style="width:5%;background-color:#1e53ab;color:#e5e5e5">End Time</th>
                                                <th rowspan='2' style="width:4%;background-color:#1e53ab;color:#e5e5e5">Status</th>
                                                <th rowspan='2' style="width:3%;background-color:#1e53ab;color:#e5e5e5">ST/ET</th>
                                                <th rowspan='2' style="width:3%;background-color:#1e53ab;color:#e5e5e5">Edit</th>
                                                <th rowspan='2' style="width:3%;background-color:#1e53ab;color:#e5e5e5">Remove</th>
                                                <th rowspan='2' style="width:3%;background-color:#1e53ab;color:#e5e5e5">Copy</th>
                                                <th rowspan='2' style="width:3%;background-color:#1e53ab;display:none;color:#e5e5e5">Staff</th>
                                                <th rowspan='2' style="width:3%;background-color:#1e53ab;color:#e5e5e5">Treat</th>
                                                <th colspan='4' style='text-align: center; background-color: #1e53ab; color: white; width: 12%;'>Redeem</th>
                                                <th rowspan='2' style="display:none">cat</th>
                                                <th rowspan='2' style="display:none">subcat</th>
                                                <th rowspan='2' style="display:none">brand</th>
                                                <th rowspan='2' style="display:none">R&C</th>
                                                <th rowspan='2' style="display:none">PackageCode</th>
                                                <th rowspan='2' style="display:none">PackageLineNo</th>
                                                <th rowspan='2' style="display:none">IsPackageSelected</th>
                                                <th rowspan='2' style="display:none">ServiceAllowance</th>
                                                <th rowspan='2' style="display:none">StaffId</th>
                                                <th rowspan='2' style="display:none">BranchAssetId</th>
                                                </tr>
                                                <tr>
                                                    <th style="width: 2%; background-color: #1e53ab; color: white">FOC</th>
                                                    <th style="width: 2%; background-color: #1e53ab; color: white">PKG</th>
                                                    <th style="width: 2%; background-color: #1e53ab; color: white">PTS</th>
                                                    <th style="width: 2%; background-color: #1e53ab; color: white">POS</th>
                                               </tr>
                                           
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                               
                            </div>
                        </div>
                        <div class="row" style="padding-top:10px;">
                            <div id="reminderPayment" style="color: red; font-size:15px;font-weight:bold;text-align:right;padding-right: 10px;display:none;">
                                Please settle your refund!
                            </div>
                            <div class="col-lg-12">
                                <div class="col-lg-2">
                                </div>
                                <div class="col-lg-1" style="padding:10px 0px 0px 0px;display:inline;text-align:center;">Grand Total:</div>
                                <div class="col-lg-1" style="padding:10px 0px 0px 0px; text-align:right;display:inline;">
                                    <input type='text' class='form-control' id="txtTotal" style="text-align:right;" disabled />
                                    <input type='text' class='form-control' id="txtGrandTotal" style="text-align:right;display:none;" disabled />
                                </div>
                                <div class="col-lg-1" style="padding:10px 0px 0px 0px; text-align:right;display:inline;">
                                    <button type="button" id="btnConfirm" class="btn btn-success" style="background-color: #931313; width: 80px;" onclick="SaveSO();">Confirm</button>
                                </div>
                                <div class="col-lg-2">
                                </div>
                                <div class="col-lg-5" style="padding:10px 0px 0px 0px; text-align:right;display:inline;display:inline;white-space:nowrap;">
                                    <button type="button" id="btnPrintOrderReceipt" class="btn btn-success" style="background-color: #931313; width: 80px;text-align:center;padding-right:0px;padding-left:0px;" onclick="showPrint();">Print</button>
                                    <button type="button" id="btnRedeemFOCItems" class="btn btn-success" style="background-color: #931313; width: 100px;text-align:center;padding-right:0px;padding-left:0px;" onclick="showRedeemFOC();">Redeem FOC</button>
                                    <button type="button" id="btnRedeemPackageItems" class="btn btn-success" style="background-color: #931313; width: 100px;text-align:center;text-align:center;padding-right:0px;padding-left:0px;" onclick="showRedeemPackage();">Redeem PKG</button>
                                    <button type="button" id="btnRedeemPointsItems" class="btn btn-success" style="background-color: #931313; width: 100px;text-align:center;text-align:center;padding-right:0px;padding-left:0px;" onclick="showRedeemPoints();">Redeem PTS</button>
                                    <button type="button" id="btnPayItems" class="btn btn-success" style="background-color: #931313; width: 60px;" onclick="goToPOS();">Pay</button>
                                </div>
                            </div>
                        </div>
                     
                        <div class="row" style="padding-top:30px;">
                            <div class="col-sm-12">
                                <div class="col-lg-3 hidden-sm">
                                    <div class="form-group">
                                        <div>Start Time</div>
                                        <div class="controls" style="padding-right:10px;">
                                            <select id="cboStartTimeHR" class='form-control' style="color:grey;width:50px;display:inline;">
                                                <option value="01">01</option>
                                                <option value="02">02</option>
                                                <option value="03">03</option>
                                                <option value="04">04</option>
                                                <option value="05">05</option>
                                                <option value="06">06</option>
                                                <option value="07">07</option>
                                                <option value="08" selected="">08</option>
                                                <option value="09">09</option>
                                                <option value="10">10</option>
                                                <option value="11">11</option>
                                                <option value="12">12</option>
                                            </select>
                                            <label class="control-label">:</label>
                                            <select id="cboStartTimeMin" class='form-control' style="color:grey;width:50px;display:inline;">
                                                <option value="00" selected="">00</option>
                                                <option value="15">15</option>
                                                <option value="30">30</option>
                                                <option value="45">45</option>
                                            </select>
                                            <select id="cboStartTimeAMPM" class='form-control' style="color:grey;width:55px;display:inline;">
                                                <option value="AM" selected="">AM</option>
                                                <option value="PM">PM</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3 hidden-sm">
                                    <div class="form-group" style="padding-right: 10px;">
                                        <div>End Time</div>
                                        <div class="controls" style="padding-right:10px;">
                                            <select id="cboEndTimeHR" class='form-control' style="color:grey;width:50px;display:inline;">
                                                <option value="01">01</option>
                                                <option value="02">02</option>
                                                <option value="03">03</option>
                                                <option value="04">04</option>
                                                <option value="05">05</option>
                                                <option value="06">06</option>
                                                <option value="07">07</option>
                                                <option value="08" selected="">08</option>
                                                <option value="09">09</option>
                                                <option value="10">10</option>
                                                <option value="11">11</option>
                                                <option value="12">12</option>
                                            </select>
                                            <label class="control-label">:</label>
                                            <select id="cboEndTimeMin" class='form-control' style="color:grey;width:50px;display:inline;">
                                                <option value="00" selected="">00</option>
                                                <option value="15">15</option>
                                                <option value="30">30</option>
                                                <option value="45">45</option>
                                            </select>
                                            <select id="cboEndTimeAMPM" class='form-control' style="color:grey;width:55px;display:inline;">
                                                <option value="AM" selected="">AM</option>
                                                <option value="PM">PM</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6 hidden-sm">
                                    <div class="col-lg-12 hidden-sm">
                                        <div class="form-group" style="padding-right: 10px;">
                                            <div>Remarks</div>
                                            <div class="controls" style="padding-right:10px;">
                                                <input id="txtRemark" type="text" class="form-control" value="@Model.remark"> </input>
                                            </div>
                                        </div>
                                    </div>
                                   
                                </div>
                            </div>
                        </div>
                        <div>
                            <div>
                                <div id="queuedOrder" style="display:none;padding:10px;">

                                </div>

                            </div>
                        </div>
                  
                    </fieldset>
                }
            </div>
        </div>
    </div>    
</div>
<div id="Customer_dialog-modal">
    <div class="col-lg-12" id="divCustomerDialog" style="overflow-style:scrollbar;">
        <div style="width:100%;background-color: #EEE;padding: 10px 10px 10px;font-weight:bold;color:black;">
            Create Customer
        </div>
        <div id="divMember">
            <table style="width:100%;border-spacing:5px;border-collapse:separate;">
                <tr>
                    <td style="width:20px;"></td>
                    <td style="width:200px;">Name</td>
                    <td colspan="2" style="width:200px;"><input id="txtnewname" class="form-control" /></td>
                    <td><span style="color:red;">*</span></td>
                </tr>
                <tr>
                    <td></td>
                    <td>NRIC</td>
                    <td colspan="2"><input id="txtnric" class="form-control" /></td>
                    <td><span style="color:red;">*</span></td>
                </tr>
                <tr>
                    <td></td>
                    <td>Mobile</td>
                    <td colspan="2"><input id="txtmobile" class="form-control" /></td>
                    <td><span style="color:red;">*</span></td>
                </tr>
                <tr>
                    <td></td>
                    <td>Gender</td>
                    <td colspan="2">@Html.DropDownList("cboGender", new SelectList(@ViewBag.GenderOptions, "Text", "Value"), new { @class = "form-control" }) </td>
                    <td></td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td style="width:60px;"><button type="button" id="btnCustomerSave" onclick="CHKDuplicateNRICSaveCustomer();" class="btn btn-primary" style="width:100px;">Save</button></td>                    
                    <td style="width:60px;"><button type="button" id="btnClose" onclick="closeCustomerDialog()" class="btn btn-primary" style="width:100px;">Cancel</button></td>
                    <td></td>
                </tr>
            </table>
        </div>
    </div>
</div>
<div id="Balance_dialog-modal">
    <div class="col-lg-12" id="divBalDialog" style="overflow-style:scrollbar;">
        <div style="width:100%;background-color: #EEE;padding: 10px 10px 10px;font-weight:bold;color:black;">
            Summary
        </div>
        <div style="padding-top:20px;">
            <table>
                <tr>
                    <td style="width:140px;"></td>
                    <td>Gliss Pts</td>
                    <td>Rwd Pts</td>
                </tr>
                <tr>
                    <td style="width:120px;">Balance</td>
                    <td style="padding-bottom:10px;"><div class="controls"><input type='text' class='form-control' id="txtCBalance" style="text-align:right" disabled="disabled" /></div></td>
                    <td style="padding-bottom:10px;"><div class="controls"><input type='text' class='form-control' id="txtBBalance" style="text-align:right" disabled="disabled" /></div></td>
                </tr>
                <tr>
                    <td style="width:120px;">Reserved Amount</td>
                    <td style="padding-bottom:10px;"><div class="controls"><input type='text' class='form-control' id="txtCReserved" style="text-align:right" disabled="disabled" /></div></td>
                    <td style="padding-bottom:10px;"><div class="controls"><input type='text' class='form-control' id="txtBReserved" style="text-align:right" disabled="disabled" /></div></td>
                </tr>
                <tr>
                    <td style="width:120px;">Available</td>
                    <td style="padding-bottom:10px;"><div class="controls"><input type='text' class='form-control' id="txtCAvailable" style="text-align:right" disabled="disabled" /></div></td>
                    <td style="padding-bottom:10px;"><div class="controls"><input type='text' class='form-control' id="txtBAvailable" style="text-align:right" disabled="disabled" /></div></td>
                </tr>
            </table>
        </div>
        <div class="col-lg-12" style="padding: 10px 10px 10px;text-align:right;">
            <button type="button" id="btnStaffClose" onclick="closeBalanceDialog();" class="btn btn-primary" style="width:100px;">Close</button>
        </div>
    </div>
</div>
<div id="Login_dialog-modal">
    <div class="col-lg-12" id="divLoginDialog" style="overflow-style:scrollbar;">
        <div style="width:100%;background-color: #EEE;padding: 10px 10px 10px;font-weight:bold;color:black;">
            <span id="loginheader"></span>
        </div>
        <div id="divMember">
            <table style="width:100%;border-spacing:5px;border-collapse:separate;padding-top:10px;">
                <tr>
                    <td style="width:20px;"></td>
                    <td style="width:200px;">User Name</td>
                    <td colspan="2" style="width:200px;"><input id="txtname" class="form-control" /></td>
                    <td><span style="color:red;">*</span></td>
                </tr>
                <tr>
                    <td></td>
                    <td>Password</td>
                    <td colspan="2"><input type="password" id="txtpwd" class="form-control" /></td>
                    <td><span style="color:red;">*</span></td>
                </tr>
                @*<tr>
                    <td style="width:20px;"></td>
                    <td style="width:200px;">Remarks</td>
                    <td colspan="2" style="width:200px;"><input id="txtremarks" class="form-control" /></td>
                    <td><span style="color:red;">*</span></td>
                </tr>*@
                <tr>
                    <td></td>
                    <td></td>
                    <td style="width:60px;"><button type="button" id="btnVoid" onclick="voidSO();" class="btn btn-primary" style="width:100px;">Void</button></td>
                    <td style="width:60px;"><button type="button" id="btnClose" onclick="closeLoginDialog()" class="btn btn-primary" style="width: 100px;">Cancel</button></td>
                    <td></td>
                </tr>
            </table>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-lg-12 hidden-sm">
        <div class="box">
            <div class="col-sm-2">
                <a class="quick-button" href="~/Access/BranchStaffIndex">
                    <i class="fa fa-home"></i>
                    <p>Home</p>
                </a>
            </div>
        </div>
        <div class="box">
            <div class="col-sm-2">
                <a class="quick-button" href="~/Reports/DailySalesClosing.aspx">
                    <i class="fa fa-user"></i>
                    <p>Daily Closing</p>
                </a>
            </div>
        </div>
        <div class="box">
            <div class="col-sm-2">
                <a class="quick-button" href="~/Reports/DailySalesClosingDetails.aspx">
                    <i class="fa fa-user"></i>
                    <p>Daily Closing Details</p>
                </a>
            </div>
        </div>
      
        <div class="box">
            <div class="col-sm-2">
                <a class="quick-button" onclick="showPaymentList();">
                    <i class="fa fa-user"></i>
                    <p>Payment History</p>
                </a>
            </div>
        </div>
        <div class="box">
            <div class="col-sm-2">
                <a class="quick-button" onclick="OpenBalanceDialog();">
                    <i class="fa fa-user"></i>
                    <p>Customer Balance</p>
                </a>
            </div>
        </div>
        <div class="box">
            <div class="col-sm-2">
                <a class="quick-button" href="~/POS/POS">
                    <i class="fa fa-usd"></i>
                    <p>POS</p>
                </a>
            </div>
        </div>

    </div>
 </div>
<button id="btnMessage" class="btn btn-primary noty" data-noty-options='{"text":"Please select Member","layout":"topRight","type":"error"}' style="display:none;">Top Right</button>

<div class="modal fade" id="mdlIncompleteCourse" tabindex="-1" role="dialog" aria-labelledby="mdlIncompleteCourseLabel" aria-hidden="true">
    <div class="modal-dialog" id="IncompleteCourse_dialog-modal" style="width: 850px; top: 5px; ">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="mdlAccessRightLabel">Incomplete Course Listing</h4>
            </div>

            <div class="widget-body no-padding">
                <div style="padding: 10px 10px 10px 10px; background-color: #FAFAFA;">
                    <div style="width: 100%;">
                        <table id="tblIncompletedCourse" class="table table-striped table-bordered table-hover" width="100%">
                            <thead>
                                <tr>
                                    <th style='width:50px;'>Pkg Code</th>
                                    <th style='width:80px;'>Pkg Desc</th>
                                    <th style='width:120px;'>Description</th>
                                    <th style='width:40px;'>UOM</th>
                                    <th style='width:40px;'>Balance</th>
                                    <th style='width:20px;'></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="mdlSalesKit" tabindex="-1" role="dialog" aria-labelledby="mdlSalesKitLabel" aria-hidden="true">
    <div class="modal-dialog" id="SalesKit_dialog-modal" style="width: 90%; top: 20px; ">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="mdlAccessRightLabel">Sales Kits Listing</h4>
            </div>
            <div class="widget-body no-padding">
                <div style="padding: 10px 10px 10px 10px; background-color: #FAFAFA;">
                    <div style="width: 100%;">                      
                        <div class="col-lg-12"  id="divSalesKitList"></div>
                    </div>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<div class="modal fade" id="mdlFreeServices" tabindex="-1" role="dialog" aria-labelledby="mdlFreeServicesLabel" aria-hidden="true">
    <div class="modal-dialog" id="FreeServices_dialog-modal" style="width: 90%; top: 20px; ">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="mdlAccessRightLabel">Free Services Listing</h4>
            </div>

            <div class="widget-body no-padding">
                <div style="padding: 10px 10px 10px 10px; background-color: #FAFAFA;">
                    <div style="width: 100%;">
                        <div class="col-lg-12" id="divFreeServicesList"></div>
                    </div>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<div class="modal fade" id="mdlSalesKitItem" tabindex="-1" role="dialog" aria-labelledby="mdlSalesKitItemLabel" aria-hidden="true">
    <div class="modal-dialog" id="SaleKit_Item_dialog-modal" style="width: 90%;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="mdlAccessRightLabel">Sales Kit Item Listing</h4>
            </div>
            <div class="widget-body no-padding">
                <div style="padding: 10px 10px 10px 10px; background-color: #FAFAFA;">
                    <div style="width: 100%;">
                        <div class="col-lg-12" id="divSalesKitItemList"></div>
                    </div>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->



<div class="modal fade" id="mdlProductBalance" tabindex="-1" role="dialog" aria-labelledby="mdlProductBalanceLable" aria-hidden="true">
    <div class="modal-dialog" id="product_balance_dialog-modal" style="width: 60%;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title">Product Balance</h4>
            </div>
            <div class="widget-body no-padding">
                <div style="padding: 10px 10px 10px 10px; background-color: #FAFAFA;">
                    <div style="width: 100%;">
                        <div class="col-lg-12" id="divProductList"></div>
                    </div>
                    <div class="col-lg-12" style="padding: 10px 10px 10px;text-align:right;">
                        <button type="button" id="btnAddProductItme" onclick="populateProductItem()" class="btn btn-primary" style="width:100px;">Add</button>
                    </div>

                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="mdlPackage" tabindex="-1" role="dialog" aria-labelledby="mdlPackageLabel" aria-hidden="true">
    <div class="modal-dialog" id="Package_dialog-modal" style="width: 60%;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="mdlAccessRightLabel">Package Balance</h4>
            </div>
            <div class="widget-body no-padding">
                <div style="padding: 10px 10px 10px 10px; background-color: #FAFAFA;">
                    <div style="width: 100%;">
                        <div class="col-lg-12" id="divPackageList"></div>
                    </div>
                    <div class="col-lg-12" style="padding: 10px 10px 10px;text-align:right;">
                        <button type="button" id="btnAddPackage" onclick="populatePackageItem()" class="btn btn-primary" style="width:100px;">Add</button>
                    </div>

                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="mdlPrint" tabindex="-1" role="dialog" aria-labelledby="mdlPrintLabel" aria-hidden="true">
    <div class="modal-dialog" id="Print_dialog-modal" style="width: 60%;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="mdlAccessRightLabel">Receipt</h4>
            </div>
            <div class="widget-body no-padding">
                <div style="padding: 10px 10px 10px 10px; background-color: #FAFAFA;">
                    
                    <div style="width: 100%;">
                        <div class="col-lg-12" id="divPOSPrintList"></div>
                    </div>
                    
                    <div style="width: 100%;">
                        <div class="col-lg-12" id="divPTSPrintList"></div>
                    </div>
           
                    <div style="width: 100%;">
                        <div class="col-lg-12" id="divPKGPrintList"></div>
                    </div>
                    
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="mdlRedeemFOC" tabindex="-1" role="dialog" aria-labelledby="mdlRedeemFOCLabel" aria-hidden="true">
    <div class="modal-dialog" id="RedeemFOC_dialog-modal" style="width: 50%;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="mdlAccessRightLabel">Redeem FOC Listing</h4>
            </div>
            <div class="widget-body no-padding">
                <div style="padding: 10px 10px 10px 10px; background-color: #FAFAFA;">
                    <div style="width: 100%;">
                        <div class="col-lg-12" id="divRedeemFOCList"></div>
                    </div>
                    <div class="col-lg-12" style="padding: 10px 10px 10px;text-align:right;">
                        <button type="button" id="btnRedeemFOC" onclick="redeemFOCItem()" class="btn btn-primary" style="width:100px;">Redeem</button>
                    </div>

                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="mdlPaymentList" tabindex="-1" role="dialog" aria-labelledby="mdlPaymentListLabel" aria-hidden="true">
    <div class="modal-dialog" id="PaymentList_dialog-modal" style="width: 70%;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="mdlAccessRightLabel">Payment History</h4>
            </div>
            <div class="widget-body no-padding">
                <div style="padding: 10px 10px 10px 10px; background-color: #FAFAFA;">
                    <div style="width: 100%;">
                        <div class="col-lg-12" id="divPaymentList"></div>
                    </div>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<div class="modal fade" id="mdlRedeemPackage" tabindex="-1" role="dialog" aria-labelledby="mdlRedeemPackageLabel" aria-hidden="true">
    <div class="modal-dialog" id="RedeemPackage_dialog-modal" style="width: 60%;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="mdlAccessRightLabel">Redeem Package Listing</h4>
            </div>
            <div class="widget-body no-padding">
                <div style="padding: 10px 10px 10px 10px; background-color: #FAFAFA;">
                    <div style="width: 100%;">
                        <div class="col-lg-12" id="divRedeemPackageList"></div>
                    </div>
                    <div class="col-lg-12" style="padding: 10px 10px 10px;text-align:right;">
                        <button type="button" id="btnRedeemPackage" onclick="redeemPackageItem()" class="btn btn-primary" style="width:100px;">Redeem</button>
                    </div>

                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="mdlTreatmentListing" tabindex="-1" role="dialog" aria-labelledby="mdlTreatmentListingLabel" aria-hidden="true">
    <div class="modal-dialog" id="TreatmentListing_dialog-modal" style="width: 800px;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="mdlAccessRightLabel">History of Treatment</h4>
            </div>
            <div class="widget-body no-padding">
                <div style="padding: 10px 10px 10px 10px; background-color: #FAFAFA;">
                    <div style="width: 100%;">
                        <div class="col-lg-12" id="divTreatmentListing"></div>
                    </div>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="mdlRedeemPoints" tabindex="-1" role="dialog" aria-labelledby="mdlRedeemPointsLabel" aria-hidden="true">
    <div class="modal-dialog" id="RedeemPoints_dialog-modal" style="width: 90%;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="mdlAccessRightLabel">Redeem Points Listing</h4>
            </div>
            <div class="widget-body no-padding">
                <div style="padding: 10px 10px 10px 10px; background-color: #FAFAFA;">

                    <div style="width: 100%;">
                        <div class="col-lg-12" id="divRedeemPointsList"></div>
                    </div>
                    <div class="col-lg-12" style="padding: 10px 10px 10px;text-align:right;">
                        <div class="col-lg-9"></div>
                        <div class="col-lg-1" style="text-align:right;font-weight:bold;padding-top:20px;"> Balance </div>
                        <div class="col-lg-1" style="padding-right:10px;padding-left:0px;padding-bottom:10px;">
                            Gliss Pts: <input type='text' class='form-control' id="txtAvailableCitiPts" disabled />
                        </div>
                        <div class="col-lg-1" style="padding-right:0px;padding-left:0px;padding-bottom:10px;">
                            Rwd Pts: <input type='text' class='form-control' id="txtAvailableRwdPts" disabled />
                        </div>
                    </div>
                    <div class="col-lg-12" style="padding: 10px 10px 10px;text-align:right;">
                        <div class="col-lg-9"></div>
                        <div class="col-lg-1" style="text-align:right;font-weight:bold;padding-top:0px;"> Total </div>
                        <div class="col-lg-1" style="padding-right:10px;padding-left:0px;padding-bottom:10px;">
                            <input type='text' class='form-control' id="txtTotalCitiPts" disabled />
                        </div>
                        <div class="col-lg-1" style="padding-right:0px;padding-left:0px;padding-bottom:10px;">
                            <input type='text' class='form-control' id="txtTotalRwdPts" disabled />
                        </div>
                    </div>

                    <div class="col-lg-12" style="padding: 50px 10px 10px 10px;text-align:right;">
                        <button type="button" id="btnRedeemPoints" onclick="redeemPointsItem()" class="btn btn-primary" style="width:100px;">Redeem</button>
                    </div>

                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="mdlRedeemPointsTreatment" tabindex="-1" role="dialog" aria-labelledby="mdlRedeemPointsTreatmentLabel" aria-hidden="true">
    <div class="modal-dialog" id="RedeemPointsTreatment_dialog-modal" style="width: 70%;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h3 class="modal-title" id="mdlAccessRightLabel">Treatment Entry</h3>
            </div>
            <div class="widget-body" style="padding:5px 10px 10px 10px;">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="col-lg-6">
                            <div class="row" style="padding-top:5px;">
                                <div class="col-lg-4">
                                    Consultant
                                </div>
                                <div class="col-lg-8" style="">
                                    @Html.DropDownList("optionServiceStaff", new SelectList(@ViewBag.StaffOptions, "id", "name"), string.Empty)
                                </div>
                            </div>
                            <div class="row" style="padding-top:5px;">
                                <div class="col-lg-4" style="">
                                    Facility
                                </div>
                                <div class="col-lg-8" style="">
                                    @Html.DropDownList("optionServiceFacility", new SelectList(@ViewBag.FacilityOptions, "id", "name"), string.Empty)
                                </div>
                            </div>
                            <div class="row" style="padding-top:5px;">
                                <div class="col-lg-4" style="">
                                    Start Time
                                </div>
                                <div class="col-lg-4" style="">
                                    <input type="text" class="form-control" id="txtServiceStartTime" placeholder="hh:mm AM/PM">
                                </div>
                            </div>
                            <div class="row" style="padding-top:5px;">
                                <div class="col-lg-4" style="">
                                    End Time
                                </div>
                                <div class="col-lg-4" style="">
                                    <input type="text" class="form-control" id="txtServiceEndTime" placeholder="hh:mm AM/PM">
                                </div>
                            </div>
                            <div class="row" style="padding-top:5px;">
                                <div class="col-lg-4" style="">
                                    Customer
                                </div>
                                <div class="col-lg-8" style="">
                                    <input type="text" class="form-control" id="txtCustomerName" disabled>
                                </div>
                            </div>
                            <div class="row" style="padding-top:5px;">
                                <div class="col-lg-9">

                                </div>
                                <div class="col-lg-1">
                                    <button type="button" id="btnServiceStaff" onclick="SaveServiceStaff();" class="btn btn-primary" style="width:50px;padding-left:0px;padding-right:0px;text-align:center;">Save</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-1">
                           
                        </div>
                        <div class="col-lg-4">
                            <div class="row" style="padding-top:5px;">
                                <div class="col-lg-4">
                                    Type
                                </div>
                                <div class="col-lg-8" style="">
                                    <select id="optionTreatmentType" name="optionTreatmentType" class="form-control">
                                        <option value="Hair">Hair</option>
                                        <option value="Face">Face</option>
                                        <option value="Body">Body</option>
                                        <option value="Nail">Nail</option>
                                        <option value="Foot">Foot</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row" style="padding-top:5px;">
                                <img class="img-thumbnail" style="width:250px;height:200px;" id="imgTreatment" src="../Images/hair.png">
                            </div>
                         </div>
                    </div>
                 </div>
                    <div>
                        <br />
                        <div class="row">
                            <div class="col-lg-6" style="">
                                Remarks 1
                            </div>
                            <div class="col-lg-6" style="">
                                Remarks 2
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-6" style="">
                                <textarea id="txtTreatmentDescription" rows="3" style="width: 100%; overflow: hidden; word-wrap: break-word; resize: horizontal; height:50px;"></textarea>
                            </div>
                            <div class="col-lg-6" style="">
                                <textarea id="txtTreatmentDescription2" rows="3" style="width: 100%; overflow: hidden; word-wrap: break-word; resize: horizontal; height:50px;"></textarea>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-6" style="">
                                Remarks 3
                            </div>
                            <div class="col-lg-6" style="">
                                Remarks 4
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-6" style="">
                                <textarea id="txtTreatmentDescription3" rows="3" style="width: 100%; overflow: hidden; word-wrap: break-word; resize: horizontal; height:50px;"></textarea>
                            </div>
                            <div class="col-lg-6" style="">
                                <textarea id="txtTreatmentDescription4" rows="3" style="width: 100%; overflow: hidden; word-wrap: break-word; resize: horizontal; height:50px;"></textarea>
                            </div>
                        </div>

                    </div>
                    <div class='clearfix'></div>
                    <div style="width:100%;padding: 5px 10px 10px;text-align:right;">
                        <button type="button" id="btnTreatmentClear" onclick="clearTreatment();" class="btn btn-primary" style="width:80px;">Clear</button>
                        <button type="button" id="btnTreatmentAdd" onclick="AddTreatmentItem();" class="btn btn-primary" style="width:80px;">Add</button>
                    </div>
                    <div><b>History of Treatment</b></div>
                    <div id="divTreatmentList" style="max-height:300px;overflow-y:auto;">
                        <table id='tbltreatment' style="width:100%;" class="table table-condensed">
                            <thead>
                                <tr>
                                    <td style="display:none"></td>
                                    <td style="width:50px;">Date</td>
                                    <td style="width:50px;">Start Time</td>
                                    <td style="width:50px;">End Time</td>
                                    <td style="width:100px;">Consultant</td>
                                    <td style="width:100px;">Type</td>
                                    <td style="width:100px;display:none;">Remarks1</td>
                                    <td style="width:100px;display:none;">Remarks2</td>
                                    <td style="width:100px;display:none;">Remarks3</td>
                                    <td style="width:100px;display:none;">Remarks4</td>
                                    <td style="width:30px;"></td>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div style="width:100%;padding: 5px 10px 10px;text-align:right;">
                        <button type="button" id="btnTreatmentClose" onclick="CloseTreatment();" class="btn btn-primary" style="width:80px;">Close</button>
                    </div>

                </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="mdlStaffItem" tabindex="-1" role="dialog" aria-labelledby="mdlStaffItemLabel" aria-hidden="true">
    <div class="modal-dialog" id="StaffItem_dialog-modal" style="width: 25%;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h3 class="modal-title" id="mdlAccessRightLabel">Service Staff</h3>
            </div>
            <div class="widget-body" style="padding:10px 10px 10px 10px;">
                <div class="row">
                        <div class="col-lg-4" style="padding-left:30px;text-align:left;">
                            Staff
                        </div>          
                </div>
                <div class="row">
                        <div class="col-lg-11" style="padding-left:30px;padding-bottom:10px;">
                            @Html.DropDownList("optionServiceStaff", new SelectList(@ViewBag.StaffOptions, "id", "name"), string.Empty)
                        </div>
                </div>
                <div class="row">
                        <div class="col-lg-4" style="padding-left:30px;text-align:left;">
                            Facility
                        </div>
                </div>
                <div class="row">
                    <div class="col-lg-11" style="padding-left:30px;padding-bottom:10px;">
                        @Html.DropDownList("optionServiceFacility", new SelectList(@ViewBag.FacilityOptions, "id", "name"), string.Empty)
                    </div>
                </div>
                <div class="row" id="divServiceStartTime">
                        <div class="col-lg-5" style="padding-left:30px;text-align:left;">
                            Start Time
                        </div>
                </div>
                <div class="row" id="divServiceStartTimeText">
                        <div class="col-lg-5" style="padding-left:30px;padding-bottom:10px;">
                            <input type="text" class="form-control" id="txtServiceStartTime" placeholder="hh:mm AM/PM">
                        </div>
                </div>
                <div class="row" id="divServiceEndTime">
                        <div class="col-lg-5" style="padding-left:30px;">
                            End Time
                        </div>
                </div>
                <div class="row" id="divServiceEndTimeText">
                        <div class="col-lg-5" style="padding-left:30px;padding-bottom:10px;">
                            <input type="text" class="form-control" id="txtServiceEndTime" placeholder="hh:mm AM/PM">
                        </div>
                </div>


                    <div class="row">
                        <div style="width:100%;padding: 10px 20px 10px;text-align:right;">
                            <button type="button" id="btnSaveServiceStaff" onclick="SaveServiceStaff();" class="btn btn-primary" style="width:120px;">Save</button>
                        </div>
                    </div>
                        </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->




<div class="modal fade" id="mdlHistory" tabindex="-1" role="dialog" aria-labelledby="mdlHistory" aria-hidden="true" style="z-index:9999;">
    <div class="modal-dialog" id="History_dialog-modal" style="width: 650px; top: 150px; ">
        <div class="modal-content">
            <div class="modal-header" style="color:white;background-image: -webkit-gradient(linear,left top,left bottom,from(#841A1A),to(#B52F2F));">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="mdlAccessRightLabel">Appointment History</h4>
            </div>

            <div class="widget-body no-padding">
                <div style="padding: 10px 10px 10px 10px; background-color: #FAFAFA;">
                    <div style="width: 100%;">
                        <div class="ptop5" style="height:200px;overflow-y:auto;">
                            <table class="table table-striped table-bordered" id="tblHistory">
                                <thead>
                                    <tr>
                                        <th rowspan='2' style="width:5%;background-color:#903030;color:#e5e5e5">S/N</th>
                                        <th rowspan='2' style="width:40%;background-color:#903030;color:#e5e5e5">Description</th>
                                        <th rowspan='2' style="width:15%;background-color:#903030;color:#e5e5e5">Date</th>
                                        <th rowspan='2' style="width:25%;background-color:#903030;color:#e5e5e5">Time</th>
                                        <th rowspan='2' style="width:15%;background-color:#903030;color:#e5e5e5">Status</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="ptop5" style="white-space:nowrap;text-align:right;">
                            <button type="button" class="btn btn-primary" onclick="closeModal('mdlHistory');">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="mdlPackageBalance" tabindex="-1" role="dialog" aria-labelledby="mdlPackageBalance" aria-hidden="true" style="z-index:9999;">
    <div class="modal-dialog" id="OrderDetails_dialog-modal" style="width: 700px; top: 150px; ">
        <div class="modal-content">
            <div class="modal-header" style="color:white;background-image: -webkit-gradient(linear,left top,left bottom,from(#841A1A),to(#B52F2F));">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="mdlAccessRightLabel">Package Balance</h4>
            </div>

            <div class="widget-body no-padding">
                <div style="padding: 10px 10px 10px 10px; background-color: #FAFAFA;">
                    <div style="width: 100%;">
                        <div class="ptop5">
                            <table class="table table-striped table-bordered" id="tblPackageBalance">
                                <thead>
                                    <tr>
                                        <th rowspan='2' style="width:5%;background-color:#903030;color:#e5e5e5">S/N</th>
                                        <th rowspan='2' style="width:10%;background-color:#903030;color:#e5e5e5">Date</th>
                                        <th rowspan='2' style="width:15%;background-color:#903030;color:#e5e5e5">Receipt</th>
                                        <th rowspan='2' style="width:30%;background-color:#903030;color:#e5e5e5">Package</th>
                                        <th rowspan='2' style="width:30%;background-color:#903030;color:#e5e5e5">Product</th>
                                        <th rowspan='2' style="width:10%;background-color:#903030;color:#e5e5e5">Balance</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="ptop5" style="white-space:nowrap;text-align:right;">
                            <button type="button" class="btn btn-primary" onclick="closeModal('mdlPackageBalance');">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="mdlServices" tabindex="-1" role="dialog" aria-labelledby="mdlServices" aria-hidden="true" style="z-index:9999;">
    <div class="modal-dialog" id="OrderDetails_dialog-modal" style="width: 650px; top: 150px; ">
        <div class="modal-content">
            <div class="modal-header" style="color:white;background-image: -webkit-gradient(linear,left top,left bottom,from(#841A1A),to(#B52F2F));">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="mdlAccessRightLabel">Services</h4>
            </div>

            <div class="widget-body no-padding">
                <div style="padding: 10px 10px 10px 10px; background-color: #FAFAFA;">
                    <div style="width: 100%;">
                        <div class="row ptop5">
                            <div class="col-lg-4">
                            </div>
                            <div class="col-lg-4">
                                Gliss Pts
                            </div>
                            <div class="col-lg-4">
                                Rwd Pts
                            </div>
                        </div>
                        <div class="row ptop5">
                            <div class="col-lg-4">
                                Balance
                            </div>
                            <div class="col-lg-4">
                                <input type="text" id="txtAppCBalance" class="form-control" value="600" style="text-align:right;" />
                            </div>
                            <div class="col-lg-4">
                                <input type="text" id="txtAppBBalance" class="form-control" value="200" style="text-align:right;" />
                            </div>
                        </div>
                        <div class="row ptop5">
                            <div class="col-lg-4">
                                Reserve Amount
                            </div>
                            <div class="col-lg-4">
                                <input type="text" id="txtAppCReserved" class="form-control" value="0" style="text-align:right;" />
                            </div>
                            <div class="col-lg-4">
                                <input type="text" id="txtAppBReserved" class="form-control" value="0" style="text-align:right;" />
                            </div>
                        </div>
                        <div class="row ptop5">
                            <div class="col-lg-4">
                                Available
                            </div>
                            <div class="col-lg-4">
                                <input type="text" id="txtAppCAvailable" class="form-control" value="600" style="text-align:right;" />
                            </div>
                            <div class="col-lg-4">
                                <input type="text" id="txtAppBAvailable" class="form-control" value="200" style="text-align:right;" />
                            </div>
                        </div>
                        <div class="row ptop5">
                            <div class="col-lg-4">
                                Product
                            </div>
                            <div class="col-lg-8">
                                <input type="text" id="txtAppProduct" class="form-control" value="" placeholder="Enter Product Name/Code" />
                            </div>
                        </div>
                        <div class="ptop5">
                            <table class="table table-striped table-bordered" id="tblProductDetails">
                                <thead>
                                    <tr>
                                        <th rowspan='2' style="width:30%;background-color:#903030;color:#e5e5e5">Product Code</th>
                                        <th rowspan='2' style="width:30%;background-color:#903030;color:#e5e5e5">Description</th>
                                        <th rowspan='2' style="width:10%;background-color:#903030;color:#e5e5e5">UOM</th>
                                        <th rowspan='2' style="width:10%;background-color:#903030;color:#e5e5e5">Selling Price</th>
                                        <th rowspan='2' style="width:10%;background-color:#903030;color:#e5e5e5">Gliss Pts</th>
                                        <th rowspan='2' style="width:10%;background-color:#903030;color:#e5e5e5">Rwd Pts</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="ptop5" style="white-space:nowrap;text-align:right;">
                            <button type="button" class="btn btn-primary" onclick="closeModal('mdlServices');">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="mdlAppointment" tabindex="-1" role="dialog" aria-labelledby="mdlAppointment" aria-hidden="true">
    <div class="modal-dialog" id="Appointment_dialog-modal" style="width: 700px; top: 5px; ">
        <div class="modal-content">
            <div class="modal-header" style="color:white;background-image: -webkit-gradient(linear,left top,left bottom,from(#841A1A),to(#B52F2F));">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="mdlAccessRightLabel">Appointments</h4>
            </div>

            <div class="widget-body no-padding">
                <div style="padding: 10px 10px 10px 10px; background-color: #FAFAFA;">
                    <div class="col-lg-12">
                        <div class="row ptop5">
                            <div class="col-lg-2">
                                <label>
                                    Date:
                                </label>
                            </div>
                            <div class="col-lg-4">
                                <input type="text" id="txtAppDate" value="" class="form-control" disabled />
                            </div>
                            <div class="col-lg-2">
                                <label>
                                    Staff:
                                </label>
                                <span style="color:red;">*</span>
                            </div>
                            <div class="col-lg-4">
                                @Html.DropDownList("cboAppStaff", new SelectList(@ViewBag.StaffOptions, "id", "name"), string.Empty, new { @class = "form-control" })
                            </div>

                        </div>
                        <div class="row ptop5">
                            <div class="col-lg-2">
                                <label>
                                    Name:
                                </label>
                                <span style="color:red;">*</span>
                            </div>
                            <div class="col-lg-4">
                                <div class="controls">
                                    <input type='text' class='form-control' id="txtAppCustomerName" placeholder="Enter Customer Name" />
                                </div>

                            </div>
                            <div class="col-lg-2">
                                <label>
                                    Room:
                                </label>
                                <span style="color:red;">*</span>
                            </div>
                            <div class="col-lg-4">
                                @Html.DropDownList("cboAppFacility", new SelectList(@ViewBag.FacilityOptions, "id", "name"), string.Empty, new { @class = "form-control" })
                            </div>
                        </div>
                        <div class="row ptop5">
                            <div class="col-lg-2">
                                <label>
                                    C. Code:
                                </label>
                            </div>
                            <div class="col-lg-4">
                                <input type="text" id="txtAppCode" value="" class="form-control" placeholder="Enter Customer Code" />
                            </div>
                            <div class="col-lg-2">
                                <label>
                                    Email:
                                </label>
                            </div>
                            <div class="col-lg-4">
                                <input type="text" id="txtAppEmail" value="" class="form-control" />
                            </div>
                        </div>
                        <div class="row ptop5">
                            <div class="col-lg-2">
                                <label>
                                    Mobile:
                                </label>
                                <span style="color:red;">*</span>
                            </div>
                            <div class="col-lg-4">
                                <input type="text" id="txtAppMobile" value="" class="form-control" />
                            </div>
                            <div class="col-lg-2">
                                <label>
                                    NRIC:
                                </label>
                            </div>
                            <div class="col-lg-4">
                                <input type="text" id="txtAppNRIC" value="" class="form-control" />
                            </div>
                        </div>
                        <div class="row ptop5">
                            <div class="col-lg-2">
                                <label>
                                    From:
                                </label>
                            </div>
                            <div class="col-lg-4">
                                <select id="cboAppStartTimeHR" class='form-control' style="width:45px;display:inline;">
                                    <option value="01">01</option>
                                    <option value="02">02</option>
                                    <option value="03">03</option>
                                    <option value="04">04</option>
                                    <option value="05">05</option>
                                    <option value="06">06</option>
                                    <option value="07">07</option>
                                    <option value="08" selected="">08</option>
                                    <option value="09">09</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                </select>
                                <label class="control-label">:</label>
                                <select id="cboAppStartTimeMin" class='form-control' style="width:45px;display:inline;">
                                    <option value="00" selected="">00</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                </select>
                                <select id="cboAppStartTimeAMPM" class='form-control' style="width:51px;display:inline;">
                                    <option value="AM" selected="">AM</option>
                                    <option value="PM">PM</option>
                                </select>
                            </div>
                            <div class="col-lg-2">
                                <label>
                                    To:
                                </label>
                            </div>
                            <div class="col-lg-4">
                                <select id="cboAppEndTimeHR" class='form-control' style="width:45px;display:inline;">
                                    <option value="01">01</option>
                                    <option value="02">02</option>
                                    <option value="03">03</option>
                                    <option value="04">04</option>
                                    <option value="05">05</option>
                                    <option value="06">06</option>
                                    <option value="07">07</option>
                                    <option value="08" selected="">08</option>
                                    <option value="09">09</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                </select>
                                <label class="control-label">:</label>
                                <select id="cboAppEndTimeMin" class='form-control' style="width:45px;display:inline;">
                                    <option value="00" selected="">00</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                </select>
                                <select id="cboAppEndTimeAMPM" class='form-control' style="width:51px;display:inline;">
                                    <option value="AM" selected="">AM</option>
                                    <option value="PM">PM</option>
                                </select>
                            </div>
                        </div>
                        <div class="row ptop5">
                            <div class="col-lg-2">
                                <label>
                                    Category:
                                </label>
                            </div>
                            <div class="col-lg-4">
                                <select id="cboCategory" class='form-control'>
                                    <option value="0"></option>
                                    <option value="1">Hair</option>
                                    <option value="2">Spa</option>
                                    <option value="3">Nails</option>
                                </select>
                            </div>
                            <div class="col-lg-2">
                                <label>
                                    Subcategory:
                                </label>
                            </div>
                            <div class="col-lg-4">
                                <select id="cboSubCategory" class='form-control'></select>
                            </div>
                        </div>

                        <div class="row ptop5">
                            <div class="col-lg-2">
                                <label>
                                    Description:
                                </label>
                            </div>
                            <div class="col-lg-10">
                                <textarea id="txtAppDescription" rows="6" style="height:90px;width:100%;"></textarea>
                            </div>
                        </div>
                        <div class="row ptop5">
                            <div class="col-lg-4">
                            </div>
                            <div class="col-lg-3" style="text-align:right;margin-top:5px;">
                                <label id="outstandingBalance" class="control-label"></label>
                            </div>
                            <div class="col-lg-5">
                                <div style="white-space:nowrap;text-align:right;">
                                    <button type="button" class="btn btn-primary" style="width: 150px;height:30px;" onclick="openPackageBalance()">Package Balance</button>
                                    <button type="button" class="btn btn-primary" style="width: 90px;height:30px;" onclick="openServices();">Jumbo</button>
                                </div>
                            </div>
                        </div>
                        <div class="row ptop5">
                            <div class="col-lg-2">
                                <label>
                                    Channel:
                                </label>
                            </div>
                            <div class="col-lg-4">
                                <select id="cboAppChannel" class='form-control'>
                                    <option value="0"></option>
                                    <option value="1">Advertisement</option>
                                    <option value="2">Website</option>
                                    <option value="3">Referred By Friend</option>
                                    <option value="4">Newspaper</option>
                                    <option value="5">Facebook</option>
                                    <option value="6">Twitter</option>
                                    <option value="7">Walk in</option>
                                </select>
                            </div>
                            <div class="col-lg-3">
                                <label>
                                    <label class="control-label"><input type="radio" value="Wait List" name="rbStatus">Wait List</label>
                                </label>
                            </div>
                            <div class="col-lg-3">
                                <label>
                                    <label class="control-label"><input type="radio" value="Arrived" name="rbStatus">Arrived</label>
                                </label>
                            </div>
                        </div>
                        <div class="row ptop5">
                            <div class="col-lg-2" style="white-space:nowrap;">
                                <label>
                                    Booked By:
                                </label>
                            </div>
                            <div class="col-lg-4">
                                @Html.DropDownList("cboAppBookedBy", new SelectList(@ViewBag.StaffOptions, "id", "name"), string.Empty, new { @class = "form-control", @disabled = "disabled" })
                            </div>
                            <div class="col-lg-3">
                                <label>
                                    <label class="control-label"><input type="radio" value="Booking" checked name="rbStatus">Booking</label>
                                </label>
                            </div>
                            <div class="col-lg-3">
                                <label>
                                    <label class="control-label"><input type="radio" value="Done" name="rbStatus">Done</label>
                                </label>
                            </div>
                        </div>
                        <div class="row ptop5">
                            <div class="col-lg-2">

                            </div>
                            <div class="col-lg-4">
                                <label id="sonumber" class="control-label"></label>
                            </div>
                            <div class="col-lg-3">
                                <label>
                                    <label class="control-label"><input type="radio" value="Confirmed" name="rbStatus">Confirmed</label>
                                </label>
                            </div>
                            <div class="col-lg-3">
                                <label>
                                    <label class="control-label"><input type="radio" value="No Show" name="rbStatus">No Show</label>
                                </label>
                            </div>
                        </div>
                        <div class="row ptop5">
                            <div class="col-lg-2">
                                <label>

                                </label>
                            </div>
                            <div class="col-lg-4" style="margin-top:-15px;">
                                <label id="queuenumber" class="control-label"></label>
                            </div>
                            <div class="col-lg-3">
                                <label>
                                    <label class="control-label"><input type="radio" value="Cancelled" name="rbStatus">Cancelled</label>
                                </label>
                            </div>
                            <div class="col-lg-3">

                            </div>
                        </div>
                        <div class="row ptop5">
                            <div class="col-lg-6">
                                <div style="white-space:nowrap;text-align:left;">
                                    <button id="btnHistory" type="button" class="btn btn-primary" onclick="openHistory()">History</button>
                                    <button id="btnPrintAppointment" type="button" class="btn btn-primary">Print</button>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div style="white-space:nowrap;text-align:right;">
                                    <button id="btnSaveAppointment" type="button" class="btn btn-primary" onclick="saveNewAppointment()">Save</button>
                                    <button id="btnCloseAppointment" type="button" class="btn btn-primary" onclick="closeModal('mdlAppointment');">Close</button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<script type="text/javascript">
    var load = 0;
    var selectedCatprod;
    var selectedprod;
    var selectedcust;
    var itemcount = 0;
    var itemid = 0;
    var oldpid = 0;
    var pcount = 0;
    var selectedItemTr;
    var ItemUpdateFlag = 0;
    var prodcol;
    var stblrowcount = 0;
    var CurSOID = 0;
    var selSalesOrder;
    var btnobj = new Object();
    var btnosaleskitbj = new Object();
    var isMobile = $('#hidismobile').val();

    var tlist = new Array();
    var staffName = "";
    var selTdtlid = 0;
    var selTkeyid = "";

    var treatmentList = new Array();
    var staffName = "";
    var trmLineNo = 0;
    var trmResouceId = "";
    var trmOldItem = true;

    var selectedItemRow;
    var voidItemParam;
    var treatmentItemParam;
    var itemIndex = 0;
    var treatmentItemProductId = 0;


    var editPackageItem = false;
    var editPackageQty = 0;

    var isCopy = false;
    var copiedQty = 0;
    var editTreatmentID = 0;

    var appointmentID = 0;
    var _customerCode;

    $(document).ready(function () {
        initAppointment();

        getCustomer();
        getProduct();
        
        showSalesKitList();
        $('#cbofacility').val($('#hidfacilityid').val());
       
        $("#txtQty").on('input', function (event) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });

        $('#cbobkstaff').addClass("form-control");
        $('#cbofacility').addClass("form-control");

        $(document).on('click', '#tblAppointment > tbody > tr > td', function () {
            openAppointmentModal();
        });

        $("#cbofacility").change(function () {
            loadQueuedOrder();
        });

        $("#optionTreatmentType").change(function () {
            if ($(this).val() == "Hair") {
                $('#imgTreatment').attr("src", "../Images/hair.png");
            }
            else if ($(this).val() == "Face") {
                $('#imgTreatment').attr("src", "../Images/hair.png");
            }
            else if ($(this).val() == "Body") {
                $('#imgTreatment').attr("src", "../Images/body.png");
            }
            else if ($(this).val() == "Nail") {
                $('#imgTreatment').attr("src", "../Images/nail.png");
            }
            else if ($(this).val() == "Foot") {
                $('#imgTreatment').attr("src", "../Images/feet.png");
            }
        });



        $('#Login_dialog-modal').dialog({
            modal: true,
            autoOpen: false,
            open: function (event, ui) {
                $('.ui-widget-header').removeClass('ui-widget-header').htm('');
            }
        });

        var loginOptions = {
            modal: true,
            height: 250,
            minHeight: 250,
            maxHeight: 250,
            width: 480,
            minWidth: 480,
            maxWidth: 480,
            dialogClass: "sfFormwrapper"
        };
        $('#Login_dialog-modal').dialog('option', loginOptions);


        var soid = $('#soid').val();
        var appid = $('#appid').val();

        if (soid == "0") {

            if (appid != "0") {
                $("#divAppointment").show();
                getAppointmentDetails();
            }

            disableOptionButtons();
            fillItemTable(1);
            $("#dateHigher").show();
            $("#dateLower").hide();

            loadQueuedOrder();

        }
        else {
            $.ajax({
                url: '@Url.Action("IsAppointmentBooking", "POS")',
                data: { soid: soid },
                type: 'POST',
                success: function (data) {
                    if (data > 0) {
                        $('#dateLower').css('margin-top', '-28px');
                        $('#lblSONO').css('margin-top', '-52px');
                        $('#appid').val(data)
                        $("#divAppointment").show();
                        getAppointmentDetails();
                    }
                }
            });
          
            $('#cbobkstaff').val($('#hidstaffid').val());
            $('#txtCustomer').val($('#txtcustname').val() + "(" + $('#txtcustcode').val() + ")");
            
            $("#dateHigher").hide();
            $("#dateLower").show();

            if ($('#txtcustname').val() == "") {
                GoBackToSO();
            }
            else {
                selectedcust = new Object();
                selectedcust.id = $('#txtcustid').val();
                selectedcust.cussupname = $('#txtcustname').val();
                selectedcust.inhousecode = $('#txtcustcode').val();
                getItemDetail();
            }

        }

        if ($('#status').val().toUpperCase() == "CANCEL") {
            disableButtonsCancelStatus();
        }


        $('#Customer_dialog-modal').dialog({
            //position: [280, 120],
            modal: true,
            autoOpen: false,
            open: function (event, ui) {
                $('.ui-widget-header').removeClass('ui-widget-header').htm('');
            },
        });

        var moptions = {
            modal: true,
            height: 320,
            minHeight: 300,
            maxHeight: 320,
            width: 530,
            minWidth: 530,
            maxWidth: 530,
            dialogClass: "sfFormwrapper"
        };
        $('#Customer_dialog-modal').dialog('option', moptions);


        $('#Treatment_dialog-modal').dialog({
            modal: true,
            autoOpen: false,
            open: function (event, ui) {
                $('.ui-widget-header').removeClass('ui-widget-header').htm('');
            },
            close: function () { }
        });

        var soptions = {
            modal: true,
            height: 500,
            minHeight: 500,
            maxHeight: 500,
            width: 530,
            minWidth: 530,
            maxWidth: 530,
            dialogClass: "sfFormwrapper"
        };
        $('#Treatment_dialog-modal').dialog('option', soptions);

        $('#Balance_dialog-modal').dialog({
            //position: [280, 120],
            modal: true,
            autoOpen: false,
            open: function (event, ui) {
                $('.ui-widget-header').removeClass('ui-widget-header').htm('');
            },
        });

        var moptions = {
            modal: true,
            height: 350,
            minHeight: 350,
            maxHeight: 350,
            width: 530,
            minWidth: 530,
            maxWidth: 530,
            dialogClass: "sfFormwrapper"
        };

        $('#Balance_dialog-modal').dialog('option', moptions);

        $('#txtmobile').live("keypress", function (e) {
            if (e.keyCode == 13) {
                btnCustomerSave.focus()
                return false; // prevent the button click from happening
            }
        });

        $(document).on('click', '.focCheckbox', function (e) {
            var index = e.currentTarget.parentNode.parentNode.rowIndex;

            if (e.currentTarget.checked) {
                $('#tblItem tr:eq(' + index + ') .rdmCheckbox').attr("disabled", true);
                $('#tblItem tr:eq(' + index + ') .ptsCheckbox').attr("disabled", true);
                $('#tblItem tr:eq(' + index + ') .posCheckbox').attr("disabled", true);
                //$('#tblItem tr:eq(' + index + ')').find('td').eq(10).text('0.00');
            }
            else {
                $('#tblItem tr:eq(' + index + ') .rdmCheckbox').attr("disabled", false);
                $('#tblItem tr:eq(' + index + ') .ptsCheckbox').attr("disabled", false);
                $('#tblItem tr:eq(' + index + ') .posCheckbox').attr("disabled", false);


            }

        });



        $(document).on('click', '.rdmCheckbox', function (e) {
            var index = e.currentTarget.parentNode.parentNode.rowIndex;

            if (e.currentTarget.checked) {

                if ($('#tblItem tr:eq(' + index + ')').find('td').eq(26).text() == "Package") {
                    var packageClass = "package_" + $('#tblItem tr:eq(' + index + ')').find('td').eq(2).text() + "_" + $('#tblItem tr:eq(' + index + ')').find('td').eq(0).text();
                    $('.' + packageClass + ' .rdmCheckbox').attr("disabled", true);
                }
                else {
                    var packagecode = $('#tblItem tr:eq(' + index + ')').find('td').eq(30).html();

                    if (packagecode == "" || packagecode == "null" || packagecode == null) {
                        $('#tblItem tr:eq(' + index + ') .focCheckbox').attr("disabled", true);
                        $('#tblItem tr:eq(' + index + ') .ptsCheckbox').attr("disabled", true);
                        $('#tblItem tr:eq(' + index + ') .posCheckbox').attr("disabled", true);
                    }
                    else {
                        var packageClass = $('#tblItem tr:eq(' + index + ')')[0].className.replace("package", "package_main");
                        var packageItemClass = $('#tblItem tr:eq(' + index + ')')[0].className;

                        if ($('.' + packageItemClass + ' .rdmCheckbox:checked').length > 0) {
                            $('.' + packageClass + ' .focCheckbox').attr("disabled", true);
                            $('.' + packageClass + ' .ptsCheckbox').attr("disabled", true);
                            $('.' + packageClass + ' .posCheckbox').attr("disabled", true);
                        }
                    }

                }

                $('#tblItem tr:eq(' + index + ') .focCheckbox').attr("disabled", true);
                $('#tblItem tr:eq(' + index + ') .ptsCheckbox').attr("disabled", true);
                $('#tblItem tr:eq(' + index + ') .posCheckbox').attr("disabled", true);
            }
            else {

                if ($('#tblItem tr:eq(' + index + ')').find('td').eq(26).text() == "Package") {
                    var packageClass = "package_" + $('#tblItem tr:eq(' + index + ')').find('td').eq(2).text() + "_" + $('#tblItem tr:eq(' + index + ')').find('td').eq(0).text();
                    $('.' + packageClass + ' .rdmCheckbox').attr("disabled", false);
                }
                else {
                    var packagecode = $('#tblItem tr:eq(' + index + ')').find('td').eq(30).html();

                    if (packagecode == "" || packagecode == "null" || packagecode == null) {
                        $('#tblItem tr:eq(' + index + ') .focCheckbox').attr("disabled", false);
                        $('#tblItem tr:eq(' + index + ') .ptsCheckbox').attr("disabled", false);
                        $('#tblItem tr:eq(' + index + ') .posCheckbox').attr("disabled", false);
                    }
                    else {
                        var packageClass = $('#tblItem tr:eq(' + index + ')')[0].className.replace("package", "package_main");
                        var packageItemClass = $('#tblItem tr:eq(' + index + ')')[0].className;

                        if ($('.' + packageItemClass + ' .rdmCheckbox:checked').length <= 0) {
                            $('.' + packageClass + ' .focCheckbox').attr("disabled", false);
                            $('.' + packageClass + ' .ptsCheckbox').attr("disabled", false);
                            $('.' + packageClass + ' .posCheckbox').attr("disabled", false);
                        }
                    }
                }


                $('#tblItem tr:eq(' + index + ') .focCheckbox').attr("disabled", false);
                $('#tblItem tr:eq(' + index + ') .ptsCheckbox').attr("disabled", false);
                $('#tblItem tr:eq(' + index + ') .posCheckbox').attr("disabled", false);

                //disableSessionNotEnded();

            }
            disableNotPendingSales();
            calculateGrandTotal();
        });

        $(document).on('click', '.ptsCheckbox', function (e) {
            var index = e.currentTarget.parentNode.parentNode.rowIndex;

            if (e.currentTarget.checked) {

                if ($('#tblItem tr:eq(' + index + ')').find('td').eq(26).text() == "Package") {
                    var packageClass = "package_" + $('#tblItem tr:eq(' + index + ')').find('td').eq(2).text() + "_" + $('#tblItem tr:eq(' + index + ')').find('td').eq(0).text();
                    $('.' + packageClass + ' .rdmCheckbox').attr("disabled", true);
                }

                $('#tblItem tr:eq(' + index + ') .focCheckbox').attr("disabled", true);
                $('#tblItem tr:eq(' + index + ') .rdmCheckbox').attr("disabled", true);
                $('#tblItem tr:eq(' + index + ') .posCheckbox').attr("disabled", true);
            }
            else {

                if ($('#tblItem tr:eq(' + index + ')').find('td').eq(26).text() == "Package") {

                    var packageClass = "package_" + $('#tblItem tr:eq(' + index + ')').find('td').eq(2).text() + "_" + $('#tblItem tr:eq(' + index + ')').find('td').eq(0).text();
                    $('.' + packageClass + ' .rdmCheckbox').attr("disabled", false);

                }


                $('#tblItem tr:eq(' + index + ') .focCheckbox').attr("disabled", false);
                $('#tblItem tr:eq(' + index + ') .rdmCheckbox').attr("disabled", false);
                $('#tblItem tr:eq(' + index + ') .posCheckbox').attr("disabled", false);

                disableSessionNotEnded();
            }
            disableNotPendingSales();
            calculateGrandTotal();


        });

        $(document).on('click', '.posCheckbox', function (e) {
            var index = e.currentTarget.parentNode.parentNode.rowIndex;

            if (e.currentTarget.checked) {

                if ($('#tblItem tr:eq(' + index + ')').find('td').eq(26).text() == "Package") {
                    var packageClass = "package_" + $('#tblItem tr:eq(' + index + ')').find('td').eq(2).text() + "_" + $('#tblItem tr:eq(' + index + ')').find('td').eq(0).text();
                    $('.' + packageClass + ' .rdmCheckbox').attr("disabled", true);
                }

                $('#tblItem tr:eq(' + index + ') .focCheckbox').attr("disabled", true);
                $('#tblItem tr:eq(' + index + ') .rdmCheckbox').attr("disabled", true);
                $('#tblItem tr:eq(' + index + ') .ptsCheckbox').attr("disabled", true);
            }
            else {
                if ($('#tblItem tr:eq(' + index + ')').find('td').eq(26).text() == "Package") {
                    var packageClass = "package_" + $('#tblItem tr:eq(' + index + ')').find('td').eq(2).text() + "_" + $('#tblItem tr:eq(' + index + ')').find('td').eq(0).text();
                    $('.' + packageClass + ' .rdmCheckbox').attr("disabled", false);
                }


                $('#tblItem tr:eq(' + index + ') .focCheckbox').attr("disabled", false);
                $('#tblItem tr:eq(' + index + ') .rdmCheckbox').attr("disabled", false);
                $('#tblItem tr:eq(' + index + ') .ptsCheckbox').attr("disabled", false);

                disableSessionNotEnded();
            }
            disableNotPendingSales();
            calculateGrandTotal();


        });

    });

    function disableOptionButtons() {
        $('#btnPayItems').attr("disabled", true);
        $('#btnPrintOrderReceipt').attr("disabled", true);
        $('#btnRedeemFOCItems').attr("disabled", true);
        $('#btnRedeemPackageItems').attr("disabled", true);
        $('#btnRedeemPointsItems').attr("disabled", true);
        $('#btnTreatmentListing').attr("disabled", true);
    }

    function disableButtonsCancelStatus() {

        $('#btnPayItems').attr("disabled", true);
        $('#btnRedeemFOCItems').attr("disabled", true);
        $('#btnRedeemPackageItems').attr("disabled", true);
        $('#btnRedeemPointsItems').attr("disabled", true);
        $('#btnTreatmentListing').attr("disabled", true);
        $('#btnSalesKit').attr("disabled", true);
        $('#btnFreeServices').attr("disabled", true);
        $('#btnPackage').attr("disabled", true);
        $('#btnAddItem').attr("disabled", true);
        $('#btnConfirm').attr("disabled", true);
        $('#cbobkstaff').attr("disabled", true);
        $('#cbofacility').attr("disabled", true);

    }

    function enableOptionButtons() {
        $('#btnPrintOrderReceipt').removeAttr("disabled");
        $('#btnPayItems').removeAttr("disabled");
        $('#btnRedeemFOCItems').removeAttr("disabled");
        $('#btnRedeemPackageItems').removeAttr("disabled");
        $('#btnRedeemPointsItems').removeAttr("disabled");
        $('#btnTreatmentListing').removeAttr("disabled");
    }

    function calculateGrandTotal() {
        var grandTotal = 0;

        $('#tblItem > tbody > tr').each(function (i, row) {
            var tds = $(row).find('td');
            if (tds.eq(25).find('.posCheckbox').is(':checked') && tds.eq(15).html() != "VOID") {
                var rdmQty = tds.eq(8).html();

                if (rdmQty == "")
                    rdmQty = "0";

                var qtyToPay = parseInt(tds.eq(6).html()) - parseInt(rdmQty);
                var sellprice = qtyToPay * parseFloat(tds.eq(9).html());


                grandTotal = grandTotal + sellprice;

            }

        });

        $("#txtGrandTotal").val(grandTotal.toFixed(2));
    }


    function calculateTotal() {
        var grandTotal = 0;

        $('#tblItem > tbody > tr').each(function (i, row) {
            var tds = $(row).find('td');
            if (tds.eq(10).html() != "") {
                var totalprice = parseFloat(tds.eq(10).html());
                grandTotal = grandTotal + totalprice;
            }

        });

        $("#txtTotal").val(grandTotal.toFixed(2));
    }

    function getCurTime() {
        var d = new Date();
        var hr = d.getHours();
        var mns = d.getMinutes();
        var ampm = "";
        var curtime = "";
        if (hr > 10) {
            if (hr >= 12) {
                ampm = "PM";
                hr = hr - 12;
                if (hr < 10) {
                    hr = "0" + hr;
                }
            }
            else {
                ampm = "AM";
                hr = "0" + hr;
            }
        }
        else {
            ampm = "AM";
            if (hr == 0) {
                hr = "12";
            }
            else {
                if (hr >= 10)
                    hr = hr;
                else
                    hr = "0" + hr;


            }
        }
        curtime = hr + ":" + mns + " " + ampm;
        return curtime;
    }
    function getCustomer() {
        $("#txtCustomer").autocomplete({
            minLength: 3,
            source: function (req, res) {
                jQuery.ajax({
                    url: '@Url.Action("getMemberInfo", "CusSup")',
                    cache: false,
                    dataType: 'json',
                    data: { custInfo: $('#txtCustomer').val(), count: 10 },
                    error: function (data) {

                        return false;
                    },
                    success: function (data) {
                        res($.map(data, function (item) {
                            return {
                                label: item.cussupname + "(" + item.inhousecode + ")",
                                value: item.cussupname + "(" + item.inhousecode + ")",
                                id: item.id,
                                inhousecode: item.inhousecode,
                                cussupname: item.cussupname
                            }
                        }));
                    }
                });
            },
            select: function (event, ui) {
                selectedcust = ui.item;
            }
        });
    }
   
    $("#txtCustomer").change(function e() {
        if ($(this).val() == "") {
            selectedcust = null;
        }
    });

    function getProduct() {
        $("#txtProduct").autocomplete({
            minLength: 3,
            source: function (req, res) {
                jQuery.ajax({
                    url: '@Url.Action("getProductInfo", "Product")',
                    cache: false,
                    dataType: 'json',
                    data: { prodInfo: $('#txtProduct').val(), count: 10 },
                    error: function (data) {
                        return false;
                    },
                    success: function (data) {
                        res($.map(data, function (item) {
                            return {
                                label: item.desc + " per " + item.uom + "(" + item.productcode + ")",
                                value: item.desc,
                                category: item.category,
                                categorysub: item.categorysub,
                                brand: item.brand,
                                RangesNSeries: item.RangesNSeries,
                                uom: item.uom,
                                desc: item.desc,
                                id: item.id,
                                productcode: item.productcode,
                                sellprice: item.sellprice.toFixed(2),
                                serviceallowance: item.serviceallowance.toFixed(2)

                            }
                        }));
                    }
                });
            },
            select: function (event, ui) {
                selectedprod = ui.item;
                $("#txtProdDescription").val(selectedprod.desc + " : " + selectedprod.productcode + "\n" + selectedprod.category + "," + selectedprod.categorysub + "," + selectedprod.brand + "," + selectedprod.RangesNSeries + "\nUOM: " + selectedprod.uom);
                $('#txtQty').val("1");
                if (selectedprod.category == 'Package') {
                    getPackagedetail(selectedprod.id);
                }
                else {
                    clearProductBundleDetailgrd();
                }
                $('#txtQty').focus();
            }
        });

        $('#txtProduct').keypress(function (e) {
            if (e.keyCode == 13) {  // detect the enter key
                var AltCode = $('#txtProduct').val();
                if (AltCode != '') {
                    $.ajax({
                        url: '@Url.Action("getProductInfoByAltCode", "Product")',
                        data: { altCode: AltCode },
                        type: 'POST',
                        success: function (data) {
                            if (data.length > 0) {
                                $("#txtProdDescription").val(data[0].desc + " : " + data[0].productcode + "\n" + data[0].category + "," + data[0].categorysub + "," + data[0].brand + "," + data[0].RangesNSeries + "\nUOM: " + data[0].uom);
                                $('#txtQty').val("1");
                                selectedprod = new Object();
                                selectedprod.id = data[0].id;
                                selectedprod.desc = data[0].desc;
                                selectedprod.productcode = data[0].productcode;
                                selectedprod.category = data[0].category;
                                selectedprod.categorysub = data[0].categorysub;
                                selectedprod.brand = data[0].brand;
                                selectedprod.rangesNSeries = data[0].rangesNSeries;
                                selectedprod.uom = data[0].uom;
                                selectedprod.serviceallowance = data[0].serviceallowance;
                                if (selectedprod.category == 'Package') {
                                    getPackagedetail(selectedprod.id);
                                }
                                else {
                                    clearProductBundleDetailgrd();
                                }
                                $('#txtQty').focus();
                            }
                        },
                        error: function (ts) {
                            alert(ts.responseText)
                        }
                    });
                }
            }
        });
    }

   

    function getPackagedetail(productid) {
        $.ajax({
            url: '@Url.Action("getProductBundleDetails", "Product")',
            data: { pid: productid },
            type: 'POST',
            success: function (data) {
                populateProductBundleDetail(data);
            }
        });
    }

    function populateProductBundleDetail(data) {
        var htmlstr = "";
        var x = 0;
        if (data) {
            for (x; x < data.length; x++) {
                htmlstr = htmlstr + "<tr><td>" + data[x].lineno + "</td><td style='text-align:left;'>" + data[x].description + "</td><td>" + data[x].qty + "</td><td><input class='form-control' name='txtQty' value=" + data[x].qty + " style='text-align:right;'/></td><td style='text-align:left;'>" + data[x].uom + "</td></tr>"
            }
        }
        $("#tblPackageDetls > tbody").append(htmlstr);

        $("#tblPackageDetls > tbody > tr").find('input:text').each(function (index) {
            $(this).on('input', function (event) {
                this.value = this.value.replace(/[^0-9]/g, '');
                var tds = $(this).closest('tr').find('td');
                if (parseInt(this.value) > parseInt(tds.eq(2).html())) {
                    this.value = tds.eq(2).html();
                    var msg = "Not allow to enter more than available quantity!";
                    var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                    showMessage(attrvalue);
                }
            });
            $(this).change(function e() { changeQty(this); });
        });
    }
    function clearProductBundleDetailgrd() {
        $("#tblPackageDetls > tbody").empty();
    }


    function selectItem() {
        selectedprod = selectedCatprod;
        $("#txtProdDescription").val(selectedprod.desc + " : " + selectedprod.productcode + "\n" + selectedprod.category + "," + selectedprod.categorysub + "," + selectedprod.brand + "," + selectedprod.RangesNSeries + "\nUOM: " + selectedprod.uom);
        CloseProductDialog();
    }

    function getItemDetail() {
        $("#btnConfirm").text("Update");
        $('#txtCustomer').attr("disabled", true);
        var soid = $('#soid').val();
        enableOptionButtons();
        populateTime(soid);
        $.ajax({
            url: '@Url.Action("getSalesOrderDetailsWithBalance", "POS")',
            data: { soid: soid, mid: $('#txtcustid').val() },
            type: 'POST',
            success: function (data) {
                populateItemDetail(data);
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });


    }

    function populateTime(soid) {
        $.ajax({
            url: '@Url.Action("getSalesOrderTime", "POS")',
            data: { soid: soid, mid: $('#txtcustid').val() },
            type: 'POST',
            success: function (data) {
                if (data.length > 0) {
                    var strStartTime = data[0].starttime;
                    var strEndTime = data[0].endtime;

                    var startTime = strStartTime.split(":");
                    var endTime = strEndTime.split(":");

                    var startTimeHr = startTime[0];
                    var endTimeHr = endTime[0];

                    var startTimeMin = startTime[1].split(" ")[0];
                    var endTimeMin = endTime[1].split(" ")[0];

                    var startTimeAMPM = startTime[1].split(" ")[1];
                    var endTimeAMPM = endTime[1].split(" ")[1];

                    $("#cboStartTimeHR").val(startTimeHr);
                    $("#cboStartTimeMin").val(startTimeMin);
                    $("#cboStartTimeAMPM").val(startTimeAMPM);

                    $("#cboEndTimeHR").val(endTimeHr);
                    $("#cboEndTimeMin").val(endTimeMin);
                    $("#cboEndTimeAMPM").val(endTimeAMPM);
                }
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });
    }
    //loaded from SO listing
    function populateItemDetail(data) {

        var htmlstr = "";
        itemcount = 0;
        var x = 0;
        var soid = $('#soid').val();
        var sostatus = $('#status').val().toUpperCase();
        if (data) {
            for (x; x < data.length; x++) {
                itemcount++;
                var packageClass = "";
                var trClass = "";
                var style = "";
                if (data[x].status == "VOID")
                    style = "color:red";
                if (data[x].category == "Package") {
                    packageClass = "package_" + data[x].productid + "_" + data[x].lineno;
                    trClass = "package_main_" + data[x].productid + "_" + data[x].lineno;
                }

                if (data[x].packagecode != null)
                    trClass = "package_" + data[x].packagecode + "_" + data[x].packagelineno;

                htmlstr = htmlstr + "<tr class='" + trClass + "' style='" + style + "'><td>" + data[x].lineno + "</td><td style='display:none'>" + data[x].id + "</td><td style='display:none'>" + data[x].productid + "</td>";
                htmlstr = htmlstr + "<td style='display:none'>" + data[x].productcode + "</td>";

                if (data[x].packagecode != null)
                    htmlstr = htmlstr + "<td style='text-align:left;padding-left:20px;'>" + data[x].productdesc + "</td>";
                else
                    htmlstr = htmlstr + "<td style='text-align:left;'>" + data[x].productdesc + "</td>";

                if (data[x].category == "Package")
                    htmlstr = htmlstr + "<td></td>";
                else
                    htmlstr = htmlstr + "<td>" + data[x].balance + "</td>";

                htmlstr = htmlstr + "<td>" + data[x].qty + "</td><td style='display:none;'>" + data[x].uom + "</td>";

                var redeemedQty = data[x].redeemedqty;


                if (data[x].category == "Package")
                    htmlstr = htmlstr + "<td style='display:none;'></td>";
                else
                    htmlstr = htmlstr + "<td style='display:none;'>" + (redeemedQty) + "</td>";

                if (data[x].packagecode == null) {
                    htmlstr = htmlstr + "<td>" + data[x].unitprice.toFixed(2) + "</td>";

                    if (data[x].foc)
                        htmlstr = htmlstr + "<td>0.00</td>";
                    else
                        htmlstr = htmlstr + "<td>" + (data[x].qty * data[x].unitprice).toFixed(2) + "</td>";

                    htmlstr = htmlstr + "<td class='text-left'>" + data[x].branchassetname + "</td>";
                    htmlstr = htmlstr + "<td class='text-left'>" + data[x].staffname.substring(0, 9) + "...</td>";
                    htmlstr = htmlstr + "<td>" + data[x].starttime + "</td>";
                    htmlstr = htmlstr + "<td>" + data[x].endtime + "</td>";
                    htmlstr = htmlstr + "<td class='text-center'>" + data[x].status + "</td>";

                    if (soid == "0") {
                        htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary' onclick='TimeItem(this);'></a></td>";
                        htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary' onclick='EditItem(this);'><i class='fa fa-edit' title='Edit Items'></i></a></td>";
                        htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-danger' onclick='RemoveItem(this,\"" + packageClass + "\")' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>";
                        htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary' onclick='CopyItem(this);'><i class='fa fa-files-o' title='Copy Item'></i></a></td>";
                        htmlstr = htmlstr + "<td class='text-center' style='display:none;'><a class='btn btn-warning' onclick='StaffItem(this);'><i class='fa fa-user'></i></a></td>";
                        htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary' onclick='ViewTreatmentItem(this)' title='Treatment'><i class='fa fa-medkit'></i></a></td>";
                    }
                    else {

                        if (data[x].status == "PAID" || data[x].status == "PARTIAL") {
                            htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-default'><i class='fa fa-check'></i></a></td>";
                            htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-default' ><i class='fa fa-edit' title='Edit Items'></i></a></td>";
                            htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-danger' title='Remove Item' onclick='RemoveItem(this,\"\")'><i class='fa fa-trash-o '></i></a</td>";
                            htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary' onclick='CopyItem(this);'><i class='fa fa-files-o' title='Copy Item'></i></a></td>";
                            htmlstr = htmlstr + "<td class='text-center' style='display:none;'><a class='btn btn-warning' onclick='StaffItem(this);'><i class='fa fa-user'></i></a></td>";
                            htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary' onclick='ViewTreatmentItem(this)' title='Treatment'><i class='fa fa-medkit'></i></a></td>";
                        }
                        else if (data[x].status == "REDEEM") {
                            htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-default'><i class='fa fa-check'></i></a></td>";
                            htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-default' ><i class='fa fa-edit' title='Edit Items'></i></a></td>";
                            htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-danger' title='Remove Item' onclick='RemoveItem(this,\"\")'><i class='fa fa-trash-o '></i></a></td>";
                            htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary' onclick='CopyItem(this);'><i class='fa fa-files-o' title='Copy Item'></i></a></td>";
                            htmlstr = htmlstr + "<td class='text-center'  style='display:none;'><a class='btn btn-warning' onclick='StaffItem(this);'><i class='fa fa-user'></i></a></td>";
                            htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary' onclick='ViewTreatmentItem(this)' title='Treatment'><i class='fa fa-medkit'></i></a></td>";
                        }
                        else if (data[x].status == "VOID") {
                            htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-default'><i class='fa fa-check'></i></a></td>";
                            htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-default'><i class='fa fa-edit' title='Edit Items'></i></a></td>";
                            htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-default' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>";
                            htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-default'><i class='fa fa-files-o' title='Copy Item'></i></a></td>";
                            htmlstr = htmlstr + "<td class='text-center' style='display:none;'><a class='btn btn-default'><i class='fa fa-user'></i></a></td>";
                            htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-default' title='Treatment'><i class='fa fa-medkit'></i></a></td>";

                        }
                        else {

                            if (data[x].status == "QUEUE")
                                htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary' onclick='TimeItem(this);'><i class='fa fa-play'></i></a></td>";
                            else if (data[x].status == "START")
                                htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary' onclick='TimeItem(this);'><i class='fa fa-stop'></i></a></td>";
                            else if (data[x].status == "END")
                                htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary'><i class='fa fa-check'></i></a></td>";

                            if (data[x].ispackageselected) {
                                htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-default'><i class='fa fa-edit' title='Edit Items'></i></a></td>";
                                htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-danger' onclick='RemoveItem(this,\"" + packageClass + "\")' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>";
                                htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-default'><i class='fa fa-files-o' title='Copy Item'></i></a></td>";

                            }
                            else {
                                htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary' onclick='EditItem(this);'><i class='fa fa-edit' title='Edit Items'></i></a></td>";
                                htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-danger' onclick='RemoveItem(this,\"" + packageClass + "\")' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>";

                                if (data[x].category == "Package")
                                    htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-default'><i class='fa fa-files-o' title='Copy Item'></i></a></td>";
                                else
                                    htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary' onclick='CopyItem(this);'><i class='fa fa-files-o' title='Copy Item'></i></a></td>";
                            }

                            htmlstr = htmlstr + "<td class='text-center' style='display:none;'><a class='btn btn-warning' onclick='StaffItem(this);'><i class='fa fa-user'></i></a></td>";
                            htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary' onclick='ViewTreatmentItem(this)' title='Treatment'><i class='fa fa-medkit'></i></a></td>";

                        }

                    }
                }
                else {
                    htmlstr = htmlstr + "<td></td>";
                    htmlstr = htmlstr + "<td></td>";
                    htmlstr = htmlstr + "<td class='text-left'>" + data[x].branchassetname + "</td>";
                    htmlstr = htmlstr + "<td class='text-left'>" + data[x].staffname.substring(0, 9) + "...</td>";
                    htmlstr = htmlstr + "<td>" + data[x].starttime + "</td>";
                    htmlstr = htmlstr + "<td>" + data[x].endtime + "</td>";
                    htmlstr = htmlstr + "<td class='text-center'>" + data[x].status + "</td>";

                    if (data[x].status == "QUEUE")
                        htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary' onclick='TimeItem(this);'><i class='fa fa-play'></i></a></td>";
                    else if (data[x].status == "START")
                        htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary' onclick='TimeItem(this);'><i class='fa fa-stop'></i></a></td>";
                    else if (data[x].status == "END")
                        htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary'><i class='fa fa-check'></i></a></td>";
                    else {
                        htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-default'><i class='fa fa-check'></i></a></td>";
                    }



                    if (data[x].status == "VOID") {
                        htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-default' ><i class='fa fa-edit' title='Edit Items'></i></a></td>";
                        htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-default' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>";
                        htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-default'><i class='fa fa-files-o' title='Copy Item'></i></a></td>";

                        htmlstr = htmlstr + "<td class='text-center' style='display:none;'><a class='btn btn-default'><i class='fa fa-user'></i></a></td>";
                        htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-default' title='Treatment'><i class='fa fa-medkit'></i></a></td>";

                    }
                    else {

                        if (data[x].status == "PAID") {
                            htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-default' ><i class='fa fa-edit' title='Edit Items'></i></a></td>";
                            htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-default' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>";
                            htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-default'><i class='fa fa-files-o' title='Copy Item'></i></a></td>";

                            htmlstr = htmlstr + "<td class='text-center' style='display:none;'><a class='btn btn-default'><i class='fa fa-user'></i></a></td>";
                            htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-default' title='Treatment'><i class='fa fa-medkit'></i></a></td>";

                        }
                        else {
                            if (data[x].status == "REDEEM") {
                                htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-default' ><i class='fa fa-edit' title='Edit Items'></i></a></td>";
                                htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-default' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>";

                            } else {
                                htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary' onclick='EditItem(this);'><i class='fa fa-edit' title='Edit Items'></i></a></td>";
                                htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-danger' onclick='RemoveItem(this,\"\")' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>";

                            }
                            htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary' onclick='CopyItem(this);'><i class='fa fa-files-o' title='Copy Item'></i></a></td>";

                            htmlstr = htmlstr + "<td class='text-center' style='display:none;'><a class='btn btn-warning' onclick='StaffItem(this);'><i class='fa fa-user'></i></a></td>";
                            htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary' onclick='ViewTreatmentItem(this)' title='Treatment'><i class='fa fa-medkit'></i></a></td>";
                        }
                    }

                }


                if (data[x].category == "Package") {
                    if (data[x].ispackageselected) {
                        htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";
                        htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";
                        htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";
                        htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";

                    }
                    else {
                        if (data[x].foc) {
                            htmlstr = htmlstr + "<td><input type='checkbox' class='focCheckbox form-control' checked/></td>";
                            htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";
                            htmlstr = htmlstr + "<td><input type='checkbox' class='ptsCheckbox form-control' disabled/></td>";
                            htmlstr = htmlstr + "<td><input type='checkbox' class='posCheckbox form-control' disabled/></td>";
                        }
                        else if (data[x].pos) {
                            htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";
                            htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";
                            htmlstr = htmlstr + "<td><input type='checkbox' class='ptsCheckbox form-control' disabled/></td>";
                            htmlstr = htmlstr + "<td><input type='checkbox' class='posCheckbox form-control' checked/></td>";
                        }
                        else if (data[x].pts) {
                            htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";
                            htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";
                            htmlstr = htmlstr + "<td><input type='checkbox' class='ptsCheckbox form-control' checked/></td>";
                            htmlstr = htmlstr + "<td><input type='checkbox' class='posCheckbox form-control' disabled/></td>";
                        }
                        else {
                            htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";
                            htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";
                            htmlstr = htmlstr + "<td><input type='checkbox' class='ptsCheckbox form-control' /></td>";
                            htmlstr = htmlstr + "<td><input type='checkbox' class='posCheckbox form-control' /></td>";
                        }
                    }
                }
                else {

                    if (data[x].packagecode == null) {

                        if (data[x].category == "Free Services") {
                            if (data[x].foc) {
                                htmlstr = htmlstr + "<td><input type='checkbox' class='focCheckbox form-control' checked/></td>";
                                htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";
                                htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";
                                htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";

                            }
                            else {
                                htmlstr = htmlstr + "<td><input type='checkbox' class='focCheckbox form-control'/></td>";
                                htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";
                                htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";
                                htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";
                            }
                        }
                        else {
                            if (data[x].foc) {

                                htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";

                                if (data[x].balance > 0)
                                    htmlstr = htmlstr + "<td><input type='checkbox' class='rdmCheckbox form-control' disabled/></td>";
                                else
                                    htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";

                                htmlstr = htmlstr + "<td><input type='checkbox' class='ptsCheckbox form-control' disabled/></td>";
                                htmlstr = htmlstr + "<td><input type='checkbox' class='posCheckbox form-control' disabled/></td>";

                            }
                            else if (data[x].rdm) {
                                htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";

                                if (data[x].balance > 0) {
                                    htmlstr = htmlstr + "<td><input type='checkbox' class='rdmCheckbox form-control' checked/></td>";
                                    htmlstr = htmlstr + "<td><input type='checkbox' class='ptsCheckbox form-control' disabled/></td>";
                                    htmlstr = htmlstr + "<td><input type='checkbox' class='posCheckbox form-control' disabled/></td>";
                                }
                                else {
                                    htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";
                                    htmlstr = htmlstr + "<td><input type='checkbox' class='ptsCheckbox form-control' /></td>";
                                    htmlstr = htmlstr + "<td><input type='checkbox' class='posCheckbox form-control' /></td>";
                                }

                            }
                            else if (data[x].pts) {
                                htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";
                                if (data[x].balance > 0)
                                    htmlstr = htmlstr + "<td><input type='checkbox' class='rdmCheckbox form-control' disabled/></td>";
                                else
                                    htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";
                                htmlstr = htmlstr + "<td><input type='checkbox' class='ptsCheckbox form-control' checked/></td>";
                                htmlstr = htmlstr + "<td><input type='checkbox' class='posCheckbox form-control' disabled/></td>";
                            }
                            else if (data[x].pos) {
                                htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";
                                if (data[x].balance > 0)
                                    htmlstr = htmlstr + "<td><input type='checkbox' class='rdmCheckbox form-control' disabled/></td>";
                                else
                                    htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";
                                htmlstr = htmlstr + "<td><input type='checkbox' class='ptsCheckbox form-control' disabled/></td>";
                                htmlstr = htmlstr + "<td><input type='checkbox' class='posCheckbox form-control' checked/></td>";

                            }
                            else {

                                htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";
                                if (data[x].balance > 0)
                                    htmlstr = htmlstr + "<td><input type='checkbox' class='rdmCheckbox form-control'/></td>";
                                else
                                    htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";
                                htmlstr = htmlstr + "<td><input type='checkbox' class='ptsCheckbox form-control' /></td>";
                                htmlstr = htmlstr + "<td><input type='checkbox' class='posCheckbox form-control' /></td>";

                            }
                        }
                    }
                    else {

                        htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";
                        if (data[x].rdm)
                            htmlstr = htmlstr + "<td><input type='checkbox' class='rdmCheckbox form-control' checked/></td>";
                        else
                            htmlstr = htmlstr + "<td><input type='checkbox' class='rdmCheckbox form-control' /></td>";
                        htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";
                        htmlstr = htmlstr + "<td><input type='checkbox' class='form-control' disabled/></td>";

                    }

                }

                htmlstr = htmlstr + "<td style='display:none'>" + data[x].category + "</td><td style='display:none'>" + data[x].categorysub + "</td><td style='display:none'>" + data[x].brand + "</td><td style='display:none'>" + data[x].RangesNSeries + "</td>";
                htmlstr = htmlstr + "<td style='display:none'>" + data[x].packagecode + "</td>";
                htmlstr = htmlstr + "<td style='display:none'>" + data[x].packagelineno + "</td>";
                htmlstr = htmlstr + "<td style='display:none'>" + data[x].ispackageselected + "</td>";
                htmlstr = htmlstr + "<td style='display:none'>" + data[x].serviceallowance.toFixed(2) + "</td>";
                htmlstr = htmlstr + "<td style='display:none'>" + data[x].staffid + "</td>";
                htmlstr = htmlstr + "<td style='display:none'>" + data[x].branchassetid + "</td></tr>";

            }
        }

        $("#tblItem > tbody").append(htmlstr);

        fillItemTable(x + 1);
        calculateGrandTotal();
        calculateTotal();
        disableCheckboxes();
        disableSessionNotEnded();
        disableNotPendingSales();

    }

    function disableCheckboxes() {
        $("#tblItem > tbody > tr").each(function (index) {
            var tds = $(this).closest('tr').find('td');
            if (tds.eq(15).html() == "QUEUE" || tds.eq(15).html() == "START" || tds.eq(15).html() == "END") {
                var foc = (tds.eq(22).find('.focCheckbox').is(':checked')) ? 1 : 0;
                var rdm = (tds.eq(23).find('.rdmCheckbox').is(':checked')) ? 1 : 0;
                var pts = (tds.eq(24).find('.ptsCheckbox').is(':checked')) ? 1 : 0;
                var pos = (tds.eq(25).find('.posCheckbox').is(':checked')) ? 1 : 0;

                if (foc) {
                    if (tds.eq(26).text() == "Package") {
                        var packageClass = "package_" + tds.eq(2).text();
                        $('.' + packageClass + ' .rdmCheckbox').attr("disabled", true);
                    }
                }

                if (rdm) {

                    if (tds.eq(26).text() == "Package") {

                        var packageClass = "package_" + tds.eq(2).html() + "_" + tds.eq(0).html();
                        $('.' + packageClass + ' .rdmCheckbox').attr("disabled", true);
                    }
                    else {

                        if (tds.eq(30).text() != "") {
                            var packageClass = "package_main_" + tds.eq(29).text() + "_" + tds.eq(31).text();

                            $('.' + packageClass + ' .focCheckbox').attr("disabled", true);
                            $('.' + packageClass + ' .ptsCheckbox').attr("disabled", true);
                            $('.' + packageClass + ' .posCheckbox').attr("disabled", true);

                        }
                    }

                }

                if (pts) {
                    if (tds.eq(26).text() == "Package") {
                        var packageClass = "package_" + tds.eq(2).html() + "_" + tds.eq(0).html();
                        $('.' + packageClass + ' .rdmCheckbox').attr("disabled", true);
                    }

                }

                if (pos) {
                    if (tds.eq(26).text() == "Package") {
                        var packageClass = "package_" + tds.eq(2).html() + "_" + tds.eq(0).html();
                        $('.' + packageClass + ' .rdmCheckbox').attr("disabled", true);
                    }

                }



            }

        });
    }

    function disableNotPendingSales() {
        $("#tblItem > tbody > tr").each(function (index) {
            var tds = $(this).closest('tr').find('td');
            if (tds.eq(15).html() == "PAID" || tds.eq(15).html() == "REDEEM" || tds.eq(15).html() == "VOID") {
                tds.eq(22).find('.focCheckbox').attr("disabled", "disabled");
                tds.eq(23).find('.rdmCheckbox').attr("disabled", "disabled");
                tds.eq(24).find('.ptsCheckbox').attr("disabled", "disabled");
                tds.eq(25).find('.posCheckbox').attr("disabled", "disabled");
            }

        });
    }

    function disableSessionNotEnded() {
        $("#tblItem > tbody > tr").each(function (index) {
            var tds = $(this).closest('tr').find('td');
            var foc = (tds.eq(22).find('.focCheckbox').is(':checked')) ? 1 : 0;
            var rdm = (tds.eq(23).find('.rdmCheckbox').is(':checked')) ? 1 : 0;
            var pts = (tds.eq(24).find('.ptsCheckbox').is(':checked')) ? 1 : 0;
            var pos = (tds.eq(25).find('.posCheckbox').is(':checked')) ? 1 : 0;

            if (tds.eq(7).html() == "Session" && (tds.eq(15).html() == "QUEUE" || tds.eq(15).html() == "START")) {
                tds.eq(22).find('.focCheckbox').attr("disabled", "disabled");
                tds.eq(23).find('.rdmCheckbox').attr("disabled", "disabled");
                tds.eq(24).find('.ptsCheckbox').attr("disabled", "disabled");
                //tds.eq(20).find('.posCheckbox').attr("disabled", "disabled");
            }
            else if (tds.eq(7).html() == "Session" && tds.eq(15).html() == "END") {
                if (foc) {
                    tds.eq(22).find('.focCheckbox').removeAttr("disabled");
                }
                else if (rdm) {
                    tds.eq(23).find('.rdmCheckbox').removeAttr("disabled");
                }
                else if (pts) {
                    tds.eq(24).find('.ptsCheckbox').removeAttr("disabled");
                }
                else if (pos) {
                    tds.eq(25).find('.posCheckbox').removeAttr("disabled");
                }
                else {
                    tds.eq(22).find('.focCheckbox').removeAttr("disabled");
                    tds.eq(23).find('.rdmCheckbox').removeAttr("disabled");
                    tds.eq(24).find('.ptsCheckbox').removeAttr("disabled");
                    //tds.eq(20).find('.posCheckbox').removeAttr("disabled");
                }

            }
            else if (tds.eq(7).html() != "Session" && (tds.eq(15).html() != "REDEEM" || tds.eq(15).html() != "PAID")) {
                if (foc) {
                    tds.eq(22).find('.focCheckbox').removeAttr("disabled");
                }
                else if (rdm) {
                    tds.eq(23).find('.rdmCheckbox').removeAttr("disabled");
                }
                else if (pts) {
                    tds.eq(24).find('.ptsCheckbox').removeAttr("disabled");
                }
                else if (pos) {
                    tds.eq(25).find('.posCheckbox').removeAttr("disabled");
                }
                else {
                    tds.eq(22).find('.focCheckbox').removeAttr("disabled");
                    tds.eq(23).find('.rdmCheckbox').removeAttr("disabled");
                    tds.eq(24).find('.ptsCheckbox').removeAttr("disabled");
                    //tds.eq(20).find('.posCheckbox').removeAttr("disabled");
                }
            }

            if (tds.eq(15).html() == "PARTIAL") {
                tds.eq(22).find('.focCheckbox').attr("disabled", "disabled");
                tds.eq(23).find('.rdmCheckbox').attr("disabled", "disabled");
                tds.eq(24).find('.ptsCheckbox').attr("disabled", "disabled");
                tds.eq(25).find('.posCheckbox').attr("disabled", "disabled");
            }

        });
    }


    function fillItemTable(r) {
        var htmlstr = "";
        var soid = $('#soid').val();
        var sostatus = $('#status').val().toUpperCase();

        if (itemcount < 5) {
            for (var x = r; x <= 5; x++) {

                htmlstr = htmlstr + "<tr><td>" + x + "</td><td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='text-align:left;'></td><td></td>";
                htmlstr = htmlstr + "<td></td><td style='display:none'></td><td style='display:none'></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>";
                if (soid == "0") {
                    htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary'><i class='fa fa-play'></i></a></td>";
                    htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary' ><i class='fa fa-edit' title='Edit Items'></i></a></td>";
                    htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-danger' title='Remove Item'><i class='fa fa-trash-o'></i></a></td>";
                    htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary' onclick='CopyItem(this);'><i class='fa fa-files-o' title='Copy Item'></i></a></td>";
                    htmlstr = htmlstr + "<td class='text-center' style='display:none;'><a class='btn btn-warning'><i class='fa fa-user'></i></a></td>";
                    htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary' title='Treatment'><i class='fa fa-medkit'></i></a></td>";

                }
                else {
                    htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary'><i class='fa fa-play'></i></a></td>";
                    htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary'><i class='fa fa-edit' title='Edit Items'></i></a></td>";
                    htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-danger' title='Remove Item'><i class='fa fa-trash-o'></i></a></td>";
                    htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary' onclick='CopyItem(this);'><i class='fa fa-files-o' title='Copy Item'></i></a></td>";
                    htmlstr = htmlstr + "<td class='text-center' style='display:none;'><a class='btn btn-warning'><i class='fa fa-user'></i></a></td>";
                    htmlstr = htmlstr + "<td class='text-center'><a class='btn btn-primary' title='Treatment'><i class='fa fa-medkit'></i></a></td>";

                }
                htmlstr = htmlstr + "<td></td><td></td><td></td><td></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'></td></tr>";
            }
        }

        $("#tblItem > tbody").append(htmlstr);
    }
    function RemoveItem(paramtr, packageClass) {
        var tds = $(paramtr).closest('tr').find('td');

        if (tds.eq(15).html() == "PAID" || tds.eq(15).html() == "REDEEM" || tds.eq(15).html() == "PARTIAL" || parseInt(tds.eq(8).html()) > 0) {
            VoidItem(paramtr);
        }
        else {

            var voidPackage = false;

            if (tds.eq(26).html() == "Package") {
                var subTr = $(paramtr).closest('tr')[0].className.replace("_main", "");

                $("." + subTr).each(function (index, elem) {
                    var subTd = $(this).closest('tr').find('td');

                    if (parseInt(subTd.eq(8).html()) > 0 || subTd.eq(15).html() == "REDEEM" || subTd.eq(15).html() == "PAID" || subTd.eq(15).html() == "PARTIAL") {
                        voidPackage = true;
                        VoidItem(paramtr);
                    }

                });
            }

            if (voidPackage == false) {

                if (itemcount > 5) {


                    var item = itemcount;
                    $(paramtr).closest('tr').remove(); itemcount--;

                    if (tds.eq(30).html() != "") {
                        var classname = "package_main_" + tds.eq(30).html() + "_" + tds.eq(31).html();
                        var mainRow = $("#tblItem tr." + classname).find('td');

                        mainRow.eq(32).html("1");
                        mainRow.eq(25).html("<input type='checkbox' class='form-control' disabled/>");
                        mainRow.eq(24).html("<input type='checkbox' class='form-control' disabled/>");
                        mainRow.eq(23).html("<input type='checkbox' class='form-control' disabled/>");
                        mainRow.eq(22).html("<input type='checkbox' class='form-control' disabled/>");
                        mainRow.eq(17).html("<a class='btn btn-default'><i class='fa fa-edit' title='Edit Items'></i></a>");

                        if ($("." + classname).length > 0) {
                            //if all subitems is deleted, delete the parent
                            var subitemClassName = "package_" + tds.eq(30).html() + "_" + tds.eq(31).html();

                            if ($("." + subitemClassName).length == 0) {
                                $("#tblItem tr." + classname).remove();
                                itemcount--;
                                item--;
                            }
                        }
                    }

                    if (packageClass != "") {
                        $("." + packageClass).each(function (index) {
                            this.remove();
                            itemcount--;
                            item--;
                        });
                    }

                    fillItemTable(item);
                }
                else {
                    var item = 5;
                    $(paramtr).closest('tr').remove(); itemcount--;

                    if (tds.eq(30).html() != "") {
                        var classname = "package_main_" + tds.eq(30).html() + "_" + tds.eq(31).html();
                        var mainRow = $("#tblItem tr." + classname).find('td');

                        mainRow.eq(32).html("1");
                        mainRow.eq(25).html("<input type='checkbox' class='form-control' disabled/>");
                        mainRow.eq(24).html("<input type='checkbox' class='form-control' disabled/>");
                        mainRow.eq(23).html("<input type='checkbox' class='form-control' disabled/>");
                        mainRow.eq(22).html("<input type='checkbox' class='form-control' disabled/>");
                        mainRow.eq(17).html("<a class='btn btn-default'><i class='fa fa-edit' title='Edit Items'></i></a>");

                        if ($("." + classname).length > 0) {
                            //if all subitems is deleted, delete the parent
                            var subitemClassName = "package_" + tds.eq(30).html() + "_" + tds.eq(31).html();

                            if ($("." + subitemClassName).length == 0) {
                                $("#tblItem tr." + classname).remove();
                                itemcount--;
                                item--;
                            }
                        }


                    }



                    if (packageClass != "") {
                        $("." + packageClass).each(function (index) {
                            this.remove();
                            itemcount--;
                            item--;
                        });
                    }

                    fillItemTable(item);
                }

                lineNoReorder();

                $("#btnSOClose").attr("disabled", true);
            }
        }

        calculateTotal();


    }

    function CopyItem(paramtr) {
        isCopy = true;
        var tds = $(paramtr).closest('tr').find('td');
        copiedQty = tds.eq(6).html();

        jQuery.ajax({
            url: '@Url.Action("getProductInfoByCode", "Product")',
            cache: false,
            dataType: 'json',
            data: { code: tds.eq(3).html() },
            error: function (data) {
                return false;
            },
            success: function (data) {
                selectedprod = {
                    label: data[0].desc + " per " + data[0].uom + "(" + data[0].productcode + ")",
                    value: data[0].desc,
                    category: data[0].category,
                    categorysub: data[0].categorysub,
                    brand: data[0].brand,
                    RangesNSeries: data[0].RangesNSeries,
                    uom: data[0].uom,
                    desc: data[0].desc,
                    id: data[0].id,
                    productcode: data[0].productcode,
                    sellprice: data[0].sellprice.toFixed(2),
                    serviceallowance: data[0].serviceallowance.toFixed(2)
                }



                addItem();
                isCopy = false;
                copiedQty = 0;
            }
        });
    }

    function lineNoReorder() {
        var table = document.getElementById('tblItem');
        var rowCount = table.rows.length - 1;
        var noRowSelected = 1;

        for (var i = 2; i < rowCount; i++) {
            var row = table.rows[i];
            row.cells[0].innerHTML = i - 1;
        }
    }


    @*function showIncomCourseList() {
        if (selectedcust != null) {
            var mid = selectedcust.id;
            var oTable = $('#tblIncompletedCourse').dataTable({
                "aaSorting": [[0, "resourcecode"], [1, "desc"]], // Default 1st column sorting
                "bProcessing": true,
                "aoColumnDefs": [
                    {
                        "bVisible": false, "aTargets": [0]
                    }
                ],
                "aoColumnDefs": [
                    {
                        "aTargets": [5],
                        "mRender": function (data, type, full) {
                            if (data) {
                                var html = "<a class='btn btn-primary' onclick='AddIncompletedCoursetoItemGrid(" + data + ");' ><i class='glyphicon-edit' title='Edit Items'></i></a>";
                                return html;
                            }
                        }
                    }
                ],
                "sAjaxSource": 'getIncompletePackageRedeemDetail?mid=' + mid,
                "bStateSave": true, // Remember paging & filters
                "bDeferRender": false,
                "bServerSide": true,
                "bDestroy": true,
                "oSearch": { "sSearch": "" },
                "aoColumns": [
                             { "sWidth": "50px", "mDataProp": "packagecode" }, { "sWidth": "80px", "mDataProp": "packagedesc" },
                             { "sWidth": "120px", "mDataProp": "productdesc" },
                             { "sWidth": "40px", "mDataProp": "uom" }, { "sWidth": "40px", "mDataProp": "balance" }, { "sWidth": "20px", "mDataProp": "productid" },
                ]
            });
            $('#IncompleteCourse_dialog-modal').dialog('open');
        }
        else {
            var msg = "Choose customer first.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
        }
    }
    function AddIncompletedCoursetoItemGrid(pId) {
        var trobj;
        var trs = $('#tblItem > tbody').find('tr');
        itemcount++;
        var rowhtml = "";
        var lno = itemcount;
        $.ajax({
            url: '@Url.Action("getProductDetails", "Product")',
            data: { pid: pId },
            async: false,
            type: 'POST',
            success: function (data) {
                if (data) {
                    rowhtml = "<td>" + lno + "</td><td style='display:none'>" + itemid + "</td><td style='display:none'>" + data[0].id + "</td>"
                       + "<td style='display:none'>" + data[0].productcode + "</td><td style='text-align:left;'>" + data[0].desc + "</td>"
                       + "<td>1</td><td style='text-align:left;'>" + data[0].uom + "</td>"
                       + "<td><a class='btn btn-primary' onclick='EditItem(this)'><i class='fa fa-edit' title='Edit Items'></i></a></td>"
                       + "<td><a class='btn btn-danger' onclick='RemoveItem(this,'')' title='Remove Item'><i class='fa fa-trash-o'></i></a></td>"
                       + "<td style='display:none'>" + data[0].category + "</td><td style='display:none'>" + data[0].categorysub + "</td>"
                       + "<td style='display:none'>" + data[0].brand + "</td><td style='display:none'>" + data[0].rangesNSeries + "</td>";
                }
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });
        if (itemcount <= 5) {
            trobj = trs[itemcount - 1];
            $(trobj).html(rowhtml);
        }
        else {
            $("#tblItem > tbody").append("<tr>" + rowhtml + "</tr>");
        }
        ItemUpdateFlag = 0;
        itemid = 0;
        $('#mdlIncompleteCourse').find('.close').trigger('click');
    }*@

    function selectSalesOrder(btn) {
        btnobj = btn;
    }

    function populatePackageItem() {

        var packageArr = [];

        $("#tblPackageList > tbody > tr").find('input:text').each(function (index) {
            var tds = $(this).closest('tr').find('td');

            if (parseInt(this.value) > 0) {

                var index = -1;

                for (var i = 0; i < packageArr.length; i++) {
                    if (packageArr[i].id == tds.eq(0).html()) {
                        index = i;
                    }
                }

                if (index > -1)
                    packageArr[index].subitems.push({ id: tds.eq(4).html(), qty: this.value });
                else
                    packageArr.push({ id: tds.eq(0).html(), subitems: [{ id: tds.eq(4).html(), qty: this.value }] });

            }

        });

        for (var i = 0; i < packageArr.length; i++) {
            var trobj;
            var trs = $('#tblItem > tbody').find('tr');
            itemcount++;
            var rowhtml = "";
            var lno = itemcount;
            var packageid = packageArr[i].id;
            var subitems = packageArr[i].subitems;

            $.ajax({
                url: '@Url.Action("getSalesKitItemDetail", "POS")',
                data: { pid: packageArr[i].id },
                async: false,
                type: 'POST',
                success: function (data) {
                    if (data) {
                        var packageClass = "package_" + data[0].id + "_" + lno;

                        console.log(data);

                        rowhtml = "<td>" + lno + "</td><td style='display:none'>" + itemid + "</td><td style='display:none'>" + data[0].id + "</td>"
                           + "<td style='display:none'>" + data[0].productcode + "</td><td style='text-align:left;'>" + data[0].desc + "</td>"
                           + "<td></td><td>1</td><td style='text-align:left;display:none;'>" + data[0].uom + "</td><td style='display:none;'></td>"
                           + "<td>" + data[0].sellprice.toFixed(2) + "</td>"
                           + "<td>" + (data[0].sellprice * 1).toFixed(2) + "</td>"
                           + "<td  class='text-left'>" + $("#cbofacility option:selected").text() + "</td>"
                           + "<td  class='text-left'>" + $("#cbobkstaff option:selected").text().substring(0, 9) + "...</td>"
                           + "<td></td>"
                           + "<td></td>"
                           + "<td></td>"
                           + "<td class='text-center'><a class='btn btn-primary'><i class='fa fa-play'></i></a></td>"
                           + "<td class='text-center'><a class='btn btn-default'><i class='fa fa-edit' title='Edit Items'></i></a></td>"
                           + "<td class='text-center'><a class='btn btn-danger' onclick='RemoveItem(this,\"" + packageClass + "\")' title='Remove Item'><i class='fa fa-trash-o'></i></a></td>"
                           + "<td class='text-center'><a class='btn btn-default'><i class='fa fa-files-o' title='Copy Item'></i></a></td>"
                           + "<td class='text-center' style='display:none'><a class='btn btn-warning' onclick='StaffItem(this);'><i class='fa fa-user'></i></a></td>"
                           + "<td class='text-center'><a class='btn btn-primary' onclick='ViewTreatmentItem(this)' title='Treatment'><i class='fa fa-medkit'></i></a></td>"
                           + "<td><input type='checkbox' class='form-control' disabled/></td>"
                           + "<td><input type='checkbox' class='form-control' disabled/></td>"
                           + "<td><input type='checkbox' class='form-control' disabled/></td>"
                           + "<td><input type='checkbox' class='form-control' disabled/></td>"
                           + "<td style='display:none'>" + data[0].category + "</td><td style='display:none'>" + data[0].categorysub + "</td>"
                           + "<td style='display:none'>" + data[0].brand + "</td><td style='display:none'>" + data[0].RangesNSeries + "</td>"
                           + "<td style='display:none'></td>"
                           + "<td style='display:none'></td>"
                           + "<td style='display:none'>1</td>"
                           + "<td style='display:none'>" + data[0].serviceallowance.toFixed(2) + "</td>"
                           + "<td style='display:none'>" + $("#cbobkstaff").val() + "</td>"
                           + "<td style='display:none'>" + $("#cbofacility").val() + "</td>";

                    }

                },
                error: function (ts) { showMessage(ts.responseText, "error") }
            });



            if (itemcount <= 5) {
                trobj = trs[itemcount - 1];
                var lineNumber = itemcount;
                var pkgMainClass = "package_main_" + packageid + "_" + itemcount;
                $(trobj).addClass(pkgMainClass);
                $(trobj).html(rowhtml);

                $.ajax({
                    url: '@Url.Action("getProductBundleDetailsWithBalance", "Product")',
                    data: { pid: packageid, mid: selectedcust.id },
                    type: 'POST',
                    async: false,
                    success: function (data) {

                        for (x = 0; x < data.length; x++) {

                            var selectedQty = $.grep(subitems, function (element, index) {
                                return element.id == data[x].productid;
                            });


                            if (selectedQty.length > 0) {
                                itemcount++

                                var redeemedqty = 0;

                                var rowhtml = "<td>" + itemcount + "</td><td style='display:none'>" + itemid + "</td><td style='display:none'>" + data[x].productid + "</td><td style='display:none'>" + data[x].productcode + "</td><td style='text-align:left;padding-left:20px;'>" + data[x].description + "</td>"
                                    + "<td>" + data[x].balance + "</td><td>" + selectedQty[0].qty + "</td><td style='display:none;'>" + data[x].uom + "</td><td style='display:none;'>" + redeemedqty + "</td><td></td><td></td>"
                                    + "<td class='text-left'>" + $("#cbofacility option:selected").text() + "</td>"
                                    + "<td class='text-left'>" + $("#cbobkstaff option:selected").text().substring(0, 9) + "...</td>"
                                    + "<td></td>"
                                    + "<td></td>"
                                    + "<td></td>"
                                    + "<td class='text-center'><a class='btn btn-primary'><i class='fa fa-play'></i></a></td>"
                                    + "<td class='text-center'><a class='btn btn-primary' onclick='EditItem(this);'><i class='fa fa-edit' title='Edit Items'></i></a></td>"
                                    + "<td class='text-center'><a class='btn btn-danger' onclick='RemoveItem(this,\"\")' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>"
                                    + "<td class='text-center'><a class='btn btn-primary' onclick='CopyItem(this);'><i class='fa fa-files-o' title='Copy Item'></i></a></td>"
                                    + "<td class='text-center' style='display:none'><a class='btn btn-warning' onclick='StaffItem(this);'><i class='fa fa-user'></i></a></td>"
                                    + "<td class='text-center'><a class='btn btn-primary' onclick='ViewTreatmentItem(this)' title='Treatment'><i class='fa fa-medkit'></i></a></td>"
                                    + "<td><input type='checkbox' class='form-control' disabled/></td>"
                                    + "<td><input type='checkbox' class='rdmCheckbox form-control' disabled/></td>"
                                    + "<td><input type='checkbox' class='form-control' disabled/></td>"
                                    + "<td><input type='checkbox' class='form-control' disabled/></td>"
                                    + "<td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'>" + packageid + "</td>"
                                    + "<td style='display:none'>" + lineNumber + "</td>"
                                    + "<td style='display:none'>1</td>"
                                    + "<td style='display:none'>" + data[x].serviceallowance.toFixed(2) + "</td>"
                                    + "<td style='display:none'>" + $("#cbobkstaff").val() + "</td>"
                                    + "<td style='display:none'>" + $("#cbofacility").val() + "</td>";

                                var pkgClass = "package_" + packageid + "_" + lineNumber;

                                if (itemcount <= 5) {
                                    trobj = trs[itemcount - 1];

                                    $(trobj).addClass(pkgClass);
                                    $(trobj).html(rowhtml);

                                }
                                else {
                                    $("#tblItem > tbody").append("<tr class='" + pkgClass + "'>" + rowhtml + "</tr>");

                                }
                            }

                        }

                    }
                });



            }
            else {
                $("#tblItem > tbody").append("<tr>" + rowhtml + "</tr>");
                var lineNumber = itemcount;
                $.ajax({
                    url: '@Url.Action("getProductBundleDetailsWithBalance", "Product")',
                    data: { pid: packageid, mid: selectedcust.id },
                    type: 'POST',
                    async: false,
                    success: function (data) {

                        for (x = 0; x < data.length; x++) {

                            var selectedQty = $.grep(subitems, function (element, index) {
                                return element.id == data[x].productid;
                            });

                            if (selectedQty.length > 0) {
                                itemcount++

                                var redeemedqty = 0;

                                var rowhtml = "<td>" + itemcount + "</td><td style='display:none'>" + itemid + "</td><td style='display:none'>" + data[x].productid + "</td><td style='display:none'>" + data[x].productcode + "</td><td style='text-align:left;padding-left:20px;'>" + data[x].description + "</td>"
                                    + "<td>" + data[x].balance + "</td><td>" + selectedQty[0].qty + "</td><td style='display:none;'>" + data[x].uom + "</td><td style='display:none;'>" + redeemedqty + "</td><td></td><td></td>"
                                    + "<td>" + $("#cbofacility option:selected").text() + "</td>"
                                    + "<td>" + $("#cbobkstaff option:selected").text().substring(0, 9) + "...</td>"
                                    + "<td></td>"
                                    + "<td></td>"
                                    + "<td></td>"
                                    + "<td class='text-center'><a class='btn btn-primary'><i class='fa fa-play'></i></a></td>"
                                    + "<td class='text-center'><a class='btn btn-primary' onclick='EditItem(this);'><i class='fa fa-edit' title='Edit Items'></i></a></td>"
                                    + "<td class='text-center'><a class='btn btn-danger' onclick='RemoveItem(this,\"\")' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>"
                                    + "<td class='text-center'><a class='btn btn-primary' onclick='CopyItem(this);'><i class='fa fa-files-o' title='Copy Item'></i></a></td>"
                                    + "<td class='text-center' style='display:none'><a class='btn btn-warning' onclick='StaffItem(this);'><i class='fa fa-user'></i></a></td>"
                                    + "<td class='text-center'><a class='btn btn-primary' onclick='ViewTreatmentItem(this)' title='Treatment'><i class='fa fa-medkit'></i></a></td>"
                                    + "<td><input type='checkbox' class='form-control' disabled/></td>"
                                    + "<td><input type='checkbox' class='rdmCheckbox form-control' disabled/></td>"
                                    + "<td><input type='checkbox' class='form-control' disabled/></td>"
                                    + "<td><input type='checkbox' class='form-control' disabled/></td>"
                                    + "<td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'>" + packageid + "</td>"
                                    + "<td style='display:none'>" + lineNumber + "</td>"
                                    + "<td style='display:none'>1</td>"
                                    + "<td style='display:none'>" + data[x].serviceallowance.toFixed(2) + "</td>"
                                    + "<td style='display:none'>" + $("#cbobkstaff").val() + "</td>"
                                    + "<td style='display:none'>" + $("#cbofacility").val() + "</td>";

                                var pkgClass = "package_" + packageid + "_" + lineNumber;
                                $("#tblItem > tbody").append("<tr class='" + pkgClass + "'>" + rowhtml + "</tr>");

                            }

                        }

                    }
                });
            }

            ItemUpdateFlag = 0;
            itemid = 0;
        }

        $('#mdlPackage').modal('hide');

    }

    function showProductBalance() {

        $('#divProductList').empty();

        if (!(selectedcust) || selectedcust == "undefined") {
            var msg = "Please select customer!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }

        var selStaff = $("#cbobkstaff").val();
        if (selStaff == '' || selStaff == 'undefined') {
            var msg = "Please select staff!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }

        var selFacility = $("#cbofacility").val();
        if (selFacility == '' || selFacility == 'undefined') {
            var msg = "Please select facility!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }

        $('#mdlProductBalance').modal('show');

        $.ajax({
            url: '@Url.Action("getProductReddemDetail", "POS")',
            data: { mid: selectedcust.id },
            type: 'POST',
            success: function (data) {
                populateProductBalance(data);
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });
    }


    function showPackage() {

        $('#divPackageList').empty();

        if (!(selectedcust) || selectedcust == "undefined") {
            var msg = "Please select customer!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }

        var selStaff = $("#cbobkstaff").val();
        if (selStaff == '' || selStaff == 'undefined') {
            var msg = "Please select staff!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }

        var selFacility = $("#cbofacility").val();
        if (selFacility == '' || selFacility == 'undefined') {
            var msg = "Please select facility!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }

        $('#mdlPackage').modal('show');

        $.ajax({
            url: '@Url.Action("getPackageRedeemDetail", "POS")',
            data: { mid: selectedcust.id },
            type: 'POST',
            success: function (data) {
                populatePackage(data);
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });
    }

    function getBalanceinPackage(productid) {
        var balance = 0;
        $.ajax({
            url: '@Url.Action("getPackageRedeemDetail", "POS")',
            data: { mid: selectedcust.id },
            type: 'POST',
            async: false,
            success: function (data) {

                var item = $.grep(data, function (element, index) {
                    return element.productid == productid;
                });

                balance = (item.length > 0) ? item[0].balance : 0
            },
            error: function (ts) {
                showMessage(ts.responseText, "error")
                return 0;
            }
        });

        return balance;
    }

    function populateProductBalance(data) {
        var OpenHtmlstr = "<table class='table table-striped table-bordered' id ='tblSelectedList'><thead>";
        var Htmlstr = "";
        var closeHtml = "</tbody></table>";
        var pkgcode;
        Htmlstr = Htmlstr + "<tr><th style='Display:none;' >id</th>";
        Htmlstr = Htmlstr + "<th style='width:10px;text-align:right;display:none;'>S/N</th><th style='Display:none;' >Package Code</th>";
        Htmlstr = Htmlstr + "<th style='width:120px;text-align:left;display:none;'>Package</th><th style='Display:none;' >Product Code</th>";
        Htmlstr = Htmlstr + "<th style='width:120px;text-align:left;'>Description</th><th style='width:40px;text-align:left;' >UOM</th>";
        Htmlstr = Htmlstr + "<th style='width:30px;text-align:right;display:none;'>Credit</th>";
        Htmlstr = Htmlstr + "<th style='width:30px;text-align:right;display:none;'>Debit</th>";
        Htmlstr = Htmlstr + "<th style='width:30px;text-align:right;'>Balance</th><th style='width:40px;' >Qty </th>";
        Htmlstr = Htmlstr + "</tr></thead><tbody>";
        var pkgdesc = "";
        for (var x = 0; x < data.length; x++) {

            //if (data[x].packagedesc != pkgdesc) {
            //    Htmlstr += "<tr><td style='text-align:left;'>" + data[x].packagedesc + "</td><td></td><td></td><td></td></tr>";
            //    pkgdesc = data[x].packagedesc;
            //}

            Htmlstr += "<tr id=" + data[x].id + "'><td style='Display:none;'>" + data[x].id + "</td>";
            Htmlstr += "<td style='width:10px;text-align:right;display:none;'>" + (x + 1) + "</td><td style='Display:none;'>" + data[x].packagecode + "</td>";
            Htmlstr += "<td style='width:120px;text-align:left;display:none;'></td>" + "<td style='Display:none;'>" + data[x].productid + "</td>";
            Htmlstr += "<td style='width:120px;text-align:left;padding-left:30px;'>" + data[x].productdesc + "</td><td style='width:40px;text-align:left;'>" + data[x].uom + "</td>";
            Htmlstr += "<td style='width:40px;text-align:right;display:none;'>" + data[x].credit + "</td>";
            Htmlstr += "<td style='width:40px;text-align:right;display:none;'>" + data[x].debit + "</td>";
            Htmlstr += "<td style='width:40px;text-align:right;'>" + data[x].balance + "</td><td style='width:40px;'><input class='form-control' name='txtQty' style='text-align:right;'/></td>";

            //if (data[x].packagecode == null) {
            //    pkgcode = "";
            //}
            //else {
            //    pkgcode = data[x].packagecode;
            //}

        }

        OpenHtmlstr = "<table class='table table-bordered' id ='tblPackageList'><thead>";
        $('#divProductList').html(OpenHtmlstr + Htmlstr + closeHtml);

        $("#tblPackageList > tbody > tr").find('input:text').each(function (index) {
            $(this).on('input', function (event) {
                this.value = this.value.replace(/[^0-9]/g, '');
                var tds = $(this).closest('tr').find('td');
                if (parseInt(this.value) > parseInt(tds.eq(10).html())) {
                    this.value = tds.eq(10).html();
                    var msg = "Not allow to enter more than available quantity!";
                    var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                    showMessage(attrvalue);
                }
            });
            $(this).change(function e() { changeQty(this); });
        });

        $("#tblPackageList > tbody > tr").find('select').each(function (index) {
            $(this).val($(this).attr("v"));
            $(this).change(function e() { changeStaff(this); });
        });
        $("#tblSelectedList > tbody > tr").find('select').each(function (index) {
            $(this).val($(this).attr("v"));
        });
    }

    function populatePackage(data) {
        var OpenHtmlstr = "<table class='table table-striped table-bordered' id ='tblSelectedList'><thead>";
        var Htmlstr = "";
        var closeHtml = "</tbody></table>";
        var pkgcode;
        Htmlstr = Htmlstr + "<tr><th style='Display:none;' >id</th>";
        Htmlstr = Htmlstr + "<th style='width:10px;text-align:right;display:none;'>S/N</th><th style='Display:none;' >Package Code</th>";
        Htmlstr = Htmlstr + "<th style='width:120px;text-align:left;display:none;'>Package</th><th style='Display:none;' >Product Code</th>";
        Htmlstr = Htmlstr + "<th style='width:120px;text-align:left;'>Description</th><th style='width:40px;text-align:left;' >UOM</th>";
        Htmlstr = Htmlstr + "<th style='width:30px;text-align:right;display:none;'>Credit</th>";
        Htmlstr = Htmlstr + "<th style='width:30px;text-align:right;display:none;'>Debit</th>";
        Htmlstr = Htmlstr + "<th style='width:30px;text-align:right;'>Balance</th><th style='width:40px;' >Qty </th>";
        Htmlstr = Htmlstr + "</tr></thead><tbody>";
        var pkgdesc = "";
        for (var x = 0; x < data.length; x++) {


            if (data[x].packagedesc != pkgdesc) {
                Htmlstr += "<tr><td style='text-align:left;'>" + data[x].packagedesc + "</td><td></td><td></td><td></td></tr>";
                pkgdesc = data[x].packagedesc;
            }

            Htmlstr += "<tr id=" + data[x].id + "'><td style='Display:none;'>" + data[x].id + "</td>";
            Htmlstr += "<td style='width:10px;text-align:right;display:none;'>" + (x + 1) + "</td><td style='Display:none;'>" + data[x].packagecode + "</td>";
            Htmlstr += "<td style='width:120px;text-align:left;display:none;'></td>" + "<td style='Display:none;'>" + data[x].productid + "</td>";
            Htmlstr += "<td style='width:120px;text-align:left;padding-left:30px;'>" + data[x].productdesc + "</td><td style='width:40px;text-align:left;'>" + data[x].uom + "</td>";
            Htmlstr += "<td style='width:40px;text-align:right;display:none;'>" + data[x].credit + "</td>";
            Htmlstr += "<td style='width:40px;text-align:right;display:none;'>" + data[x].debit + "</td>";
            Htmlstr += "<td style='width:40px;text-align:right;'>" + data[x].balance + "</td><td style='width:40px;'><input class='form-control' name='txtQty' style='text-align:right;'/></td>";
            if (data[x].packagecode == null) {
                pkgcode = "";
            }
            else {
                pkgcode = data[x].packagecode;
            }

        }

        OpenHtmlstr = "<table class='table table-bordered' id ='tblPackageList'><thead>";
        $('#divPackageList').html(OpenHtmlstr + Htmlstr + closeHtml);

        $("#tblPackageList > tbody > tr").find('input:text').each(function (index) {
            $(this).on('input', function (event) {
                this.value = this.value.replace(/[^0-9]/g, '');
                var tds = $(this).closest('tr').find('td');
                if (parseInt(this.value) > parseInt(tds.eq(10).html())) {
                    this.value = tds.eq(10).html();
                    var msg = "Not allow to enter more than available quantity!";
                    var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                    showMessage(attrvalue);
                }
            });
            $(this).change(function e() { changeQty(this); });
        });

        $("#tblPackageList > tbody > tr").find('select').each(function (index) {
            $(this).val($(this).attr("v"));
            $(this).change(function e() { changeStaff(this); });
        });
        $("#tblSelectedList > tbody > tr").find('select').each(function (index) {
            $(this).val($(this).attr("v"));
        });
    }


    function showRedeemFOC() {

        if ($('input.focCheckbox:enabled').length <= 0) {
            var msg = "There are no foc items to redeem.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return;

        }

        if ($('input.focCheckbox:checked:enabled').length <= 0) {
            var msg = "Please select foc items to redeem.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return;
        }


        if (!(selectedcust) || selectedcust == "undefined") {
            var msg = "Please select customer!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }


        updateSelectedOptions();

        updateSalesOrderDetails();

        $('#divRedeemFOCList').empty();

        $('#mdlRedeemFOC').modal('show');


        $.ajax({
            url: '@Url.Action("getSalesOrderFOCToRedeemDetail", "POS")',
            data: { mid: selectedcust.id, soid: $('#soid').val() },
            type: 'POST',
            async: false,
            success: function (data) {
                populateRedeemFOC(data);
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });

    }


    function populateRedeemFOC(data) {
        if (data.length == 0) {
            var OpenHtmlstr = "There are no foc items to redeem.";
            $('#divRedeemFOCList').html(OpenHtmlstr);
            $('#btnRedeemFOC').attr("disabled", "disabled");

        }
        else {
            $('#btnRedeemFOC').removeAttr("disabled");
            var OpenHtmlstr = "<table class='table table-striped table-bordered' id='tblRedeemSelectedList'><thead>";
            var Htmlstr = "";
            var closeHtml = "</tbody></table>";
            var pkgcode;
            Htmlstr = Htmlstr + "<tr><th style='Display:none;'>id</th>";
            Htmlstr = Htmlstr + "<th style='width:10px;text-align:right;'>S/N</th>"
            Htmlstr = Htmlstr + "<th style='Display:none;'>Product Code</th>";
            Htmlstr = Htmlstr + "<th style='width:120px;text-align:left;'>Product</th>"
            Htmlstr = Htmlstr + "<th style='width:40px;text-align:left;' >UOM</th>";
            Htmlstr = Htmlstr + "<th style='width:40px;Display:none;'>Total Qty</th>";
            Htmlstr = Htmlstr + "<th style='width:40px;Display:none;'>Rdm Qty</th>";
            Htmlstr = Htmlstr + "<th style='width:40px;'>To Redeem</th>";
            Htmlstr = Htmlstr + "<th style='width:40px;'>Qty</th>";
            Htmlstr = Htmlstr + "</tr></thead><tbody>";

            for (var x = 0; x < data.length; x++) {

                Htmlstr += "<tr id=" + data[x].id + "'><td style='Display:none;'>" + data[x].id + "</td>";
                Htmlstr += "<td style='width:10px;text-align:right;'>" + (x + 1) + "</td>";
                Htmlstr += "<td style='Display:none;'>" + data[x].productid + "</td>";
                Htmlstr += "<td style='width:120px;text-align:left;'>" + data[x].productdesc + "</td><td style='width:40px;text-align:left;'>" + data[x].uom + "</td>";
                Htmlstr += "<td style='width:40px;text-align:right;Display:none;'>" + data[x].qty + "</td>";
                Htmlstr += "<td style='width:40px;text-align:right;Display:none;'>" + data[x].redeemedqty + "</td>";
                Htmlstr += "<td style='width:40px;text-align:right;'>" + (data[x].qty - data[x].redeemedqty) + "</td>";
                Htmlstr += "<td style='width:40px;text-align:right;'><input class='form-control' name='txtQty' style='text-align:right;' value='1'/></td>";

            }

            OpenHtmlstr = "<table class='table table-bordered' id ='tblRedeemFOCList'><thead>";
            $('#divRedeemFOCList').html(OpenHtmlstr + Htmlstr + closeHtml);

            $("#tblRedeemFOCList > tbody > tr").find('input:text').each(function (index) {
                $(this).on('input', function (event) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                    var tds = $(this).closest('tr').find('td');

                    if (parseInt(this.value) > parseInt(tds.eq(7).html())) {
                        this.value = tds.eq(7).html();
                        var msg = "Not allow to enter more than available quantity!";
                        var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                        showMessage(attrvalue);
                    }

                    if (parseInt(this.value) == 0) {
                        this.value = tds.eq(7).html();
                        var msg = "Please enter a value greater than zero!";
                        var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                        showMessage(attrvalue);
                    }

                });
                $(this).change(function e() { changeQty(this); });
            });

        }
    }

    function redeemFOCItem() {
        if (confirm('Are you sure you want to redeem?')) {

            var focList = [];

            $("#tblRedeemFOCList > tbody > tr").each(function (index) {
                var tds = $(this).closest('tr').find('td');

                var obj = new Object();
                obj.qty = $(tds).closest('tr').find('input[name=txtQty]').val();
                obj.resourcecode = $("#socode").val();
                obj.id = $(tds[0]).html();
                focList.push(obj);

            });

            $.ajax({
                url: '@Url.Action("RedeemSOFOC", "POS")',
                data: JSON.stringify({ redeem: focList, resource: $('#resource').val() }),
                type: 'POST',
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    if (data) {
                        $('#mdlRedeemFOC').modal('hide');
                        reloadTableItem("Successfully Redeemed.");
                    }
                },
                error: function (req, status, err) {

                }
            });
        }


    }

    function showRedeemPackage() {

        if ($('input.rdmCheckbox:enabled').length <= 0) {
            var msg = "There are no items to redeem.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return;

        }

        if ($('input.rdmCheckbox:checked:enabled').length <= 0) {
            var msg = "Please select items to redeem.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return;
        }


        if (!(selectedcust) || selectedcust == "undefined") {
            var msg = "Please select customer!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }


        if (!validateRDM())
            return false;

        updateSelectedOptions();

        updateSalesOrderDetails();

        $('#divRedeemPackageList').empty();

        $('#mdlRedeemPackage').modal('show');


        $.ajax({
            url: '@Url.Action("getSalesOrderPackageToRedeemDetail", "POS")',
            data: { mid: selectedcust.id, soid: $('#soid').val() },
            type: 'POST',
            async: false,
            success: function (data) {
                populateRedeemPackage(data);
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });

    }

    function validateRDM() {
        var detlCollection = [];
        var valid = true;
        $('#tblItem > tbody > tr').each(function (i, row) {
            var tds = $(row).find('td');
            if (tds.eq(15).html() == "QUEUE" || tds.eq(15).html() == "START" || tds.eq(15).html() == "END") {

                if (tds.eq(23).find('.rdmCheckbox').is(':checked')) {
                    if (tds.eq(5).html() == "0") {
                        valid = false;
                        var msg = "Unable to redeem " + tds.eq(4).html() + " due to insufficient balance!";
                        var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                        showMessage(attrvalue);
                    }
                }

            }
        });

        return valid;
    }

    function updateSelectedOptions() {
        var detlCollection = [];

        $('#tblItem > tbody > tr').each(function (i, row) {
            var tds = $(row).find('td');
            if (tds.eq(15).html() == "QUEUE" || tds.eq(15).html() == "START" || tds.eq(15).html() == "END") {

                var detl = new Object();
                detl.id = parseInt(tds.eq(1).html());
                detl.foc = (tds.eq(22).find('.focCheckbox').is(':checked')) ? 1 : 0;
                detl.rdm = (tds.eq(23).find('.rdmCheckbox').is(':checked')) ? 1 : 0;
                detl.pts = (tds.eq(24).find('.ptsCheckbox').is(':checked')) ? 1 : 0;
                detl.pos = (tds.eq(25).find('.posCheckbox').is(':checked')) ? 1 : 0;
                detlCollection.push(detl);
            }
        });

        if (detlCollection.length > 0) {
            $.ajax({
                url: '@Url.Action("updateSalesOrderOptions", "POS")',
                data: JSON.stringify({ sodetails: detlCollection }),
                type: 'POST',
                dataType: "json",
                async: false,
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                },
                error: function (ts) { showMessage(ts.responseText, "error") }
            });
        }

    }

    function updateSalesOrderDetails() {

        var detlCollection = [];

        $('#tblItem > tbody > tr').each(function (i, row) {
            var tds = $(row).find('td');

            if (tds.eq(4).html() != "" && $('#soid').val() != "") {

                var detl = new Object();
                i = i + 1;
                detl.lineno = i;
                detl.id = tds.eq(1).html();
                detl.productid = tds.eq(2).html();
                detl.productcode = tds.eq(3).html();
                detl.productdesc = tds.eq(4).html();
                detl.qty = tds.eq(6).html();
                detl.uom = tds.eq(7).html();
                detl.unitprice = tds.eq(9).html();
                detl.status = (tds.eq(15).html() == "") ? "" : tds.eq(15).html();
                detl.foc = (tds.eq(22).find('.focCheckbox').is(':checked')) ? 1 : 0;
                detl.rdm = (tds.eq(23).find('.rdmCheckbox').is(':checked')) ? 1 : 0;
                detl.pts = (tds.eq(24).find('.ptsCheckbox').is(':checked')) ? 1 : 0;
                detl.pos = (tds.eq(25).find('.posCheckbox').is(':checked')) ? 1 : 0;
                detl.packagecode = tds.eq(30).html() == "" ? "" : tds.eq(30).html();
                detl.packagelineno = tds.eq(31).html() == "" ? 0 : tds.eq(31).html();
                detl.ispackageselected = tds.eq(32).html() == "" ? 0 : tds.eq(32).html();
                detl.serviceallowance = tds.eq(33).html() == "" ? 0 : tds.eq(33).html();
                detl.staffid = tds.eq(34).html() == "" ? 0 : tds.eq(34).html();
                detl.branchassetid = tds.eq(35).html() == "" ? 0 : tds.eq(35).html();
                detl.resourcecode = $('#socode').val();
                detl.salesorderid = $('#soid').val();
                detl.currency = "SGD";
                detl.exchangerate = 1;


                var treatmentCollection = new Array();
                var keyid = "";

                if (detl.id == "0") {
                    keyid = tds.eq(0).html();

                    for (var x = 0 ; x < treatmentList.length; x++) {
                        if (treatmentList[x].keyid == keyid) {
                            var tobjtmp = new Object();
                            tobjtmp = treatmentList[x];
                            tobjtmp.resourcedetailid = keyid;
                            tobjtmp.staffid = $("#cbobkstaff").val();
                            treatmentCollection.push(tobjtmp);
                        }
                    }
                }

                detl.treatment = treatmentCollection;
                detl.staffserviceid = $("#cbobkstaff").val();
                
                detlCollection.push(detl);
            }
        });

        $.ajax({
            url: '@Url.Action("updateSalesOrderDetails", "POS")',
            data: JSON.stringify({ sodetails: detlCollection, resource: $('#rcode').val(), salesorderid: $('#soid').val(), cussupname: selectedcust.cussupname }),
            type: 'POST',
            dataType: "json",
            async: false,
            contentType: "application/json; charset=utf-8",
            success: function (data) {

            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });


    }

    function updateSalesOrderTime() {
        var starttime = $("#cboStartTimeHR option:selected").text() + ":" + $("#cboStartTimeMin option:selected").text() + " " + $("#cboStartTimeAMPM option:selected").text();//$('#txtStartTime').val();
        var endtime = $("#cboEndTimeHR option:selected").text() + ":" + $("#cboEndTimeMin option:selected").text() + " " + $("#cboEndTimeAMPM option:selected").text();//$('#txtEndTime').val();

        $.ajax({
            url: '@Url.Action("updateSalesOrderTime", "POS")',
            data: JSON.stringify({ starttime: starttime, endtime: endtime, resourcecode: $('#rcode').val(), soid: $('#soid').val() }),
            type: 'POST',
            dataType: "json",
            async: false,
            contentType: "application/json; charset=utf-8",
            success: function (data) {

            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });


    }

    function updateSalesOrderStaffAndAsset() {
        var result = true;

        $.ajax({
            url: '@Url.Action("updateSalesOrderStaffAndAsset", "POS")',
            data: JSON.stringify({ resource: $('#rcode').val(), salesorderid: $('#soid').val(), staffid: $("#cbobkstaff").val(), branchassetid: $("#cbofacility").val() }),
            type: 'POST',
            dataType: "json",
            async: false,
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                if (data == "UNAVAILABLE") {
                    result = false;
                }
                else {
                    result = true;
                }
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });

        return result;
    }

    function populateRedeemPackage(data) {
        if (data.length == 0) {
            var OpenHtmlstr = "There are no items to redeem.";
            $('#divRedeemPackageList').html(OpenHtmlstr);
            $('#btnRedeemPackage').attr("disabled", "disabled");

        }
        else {
            $('#btnRedeemPackage').removeAttr("disabled");
            var OpenHtmlstr = "<table class='table table-striped table-bordered' id='tblRedeemSelectedList'><thead>";
            var Htmlstr = "";
            var closeHtml = "</tbody></table>";
            var pkgcode;
            Htmlstr = Htmlstr + "<tr><th style='Display:none;' >id</th>";
            Htmlstr = Htmlstr + "<th style='width:10px;text-align:right;'>S/N</th><th style='Display:none;' >Package Code</th>";
            Htmlstr = Htmlstr + "<th style='width:120px;text-align:left;'>Package</th><th style='Display:none;' >Product Code</th>";
            Htmlstr = Htmlstr + "<th style='width:120px;text-align:left;'>Product</th><th style='width:40px;text-align:left;' >UOM</th>";
            Htmlstr = Htmlstr + "<th style='width:30px;text-align:right;display:none;'>Purchased</th>";
            Htmlstr = Htmlstr + "<th style='width:30px;text-align:right;display:none;'>Used</th>";
            Htmlstr = Htmlstr + "<th style='width:40px;display:none;'>Total Qty</th>";
            Htmlstr = Htmlstr + "<th style='width:40px;display:none;'>Rdm Qty</th>";
            Htmlstr = Htmlstr + "<th style='width:40px;'>To Redeem</th>";
            Htmlstr = Htmlstr + "<th style='width:40px;'>Qty</th>";
            Htmlstr = Htmlstr + "<th style='width:30px;text-align:right;'>Balance</th>";
            Htmlstr = Htmlstr + "</tr></thead><tbody>";

            for (var x = 0; x < data.length; x++) {

                Htmlstr += "<tr id=" + data[x].id + "'><td style='Display:none;'>" + data[x].id + "</td>";
                Htmlstr += "<td style='width:10px;text-align:right;'>" + (x + 1) + "</td><td style='Display:none;'>" + data[x].packagecode + "</td>";
                Htmlstr += "<td style='width:120px;text-align:left;'>" + data[x].packagedesc + "</td>" + "<td style='Display:none;'>" + data[x].productid + "</td>";
                Htmlstr += "<td style='width:120px;text-align:left;'>" + data[x].productdesc + "</td><td style='width:40px;text-align:left;'>" + data[x].uom + "</td>";
                Htmlstr += "<td style='width:40px;text-align:right;display:none;'>" + data[x].credit + "</td>";
                Htmlstr += "<td style='width:40px;text-align:right;display:none;'>" + data[x].debit + "</td>";
                Htmlstr += "<td style='width:40px;text-align:right;display:none;'>" + data[x].qty + "</td>";
                Htmlstr += "<td style='width:40px;text-align:right;display:none;'>" + data[x].redeemedqty + "</td>";
                Htmlstr += "<td style='width:40px;text-align:right;'>" + (data[x].qty - data[x].redeemedqty) + "</td>";
                Htmlstr += "<td style='width:40px;text-align:right;'><input class='form-control' name='txtQty' style='text-align:right;' value='1' /></td>";
                Htmlstr += "<td style='width:40px;text-align:right;'>" + data[x].balance + "</td>";
                if (data[x].packagecode == null) {
                    pkgcode = "";
                }
                else {
                    pkgcode = data[x].packagecode;
                }

            }

            OpenHtmlstr = "<table class='table table-bordered' id ='tblRedeemPackageList'><thead>";
            $('#divRedeemPackageList').html(OpenHtmlstr + Htmlstr + closeHtml);


            $("#tblRedeemPackageList > tbody > tr").find('input:text').each(function (index) {
                $(this).on('input', function (event) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                    var tds = $(this).closest('tr').find('td');

                    if (parseInt(this.value) > parseInt(tds.eq(11).html())) {
                        this.value = tds.eq(11).html();
                        var msg = "Not allow to enter more than available quantity!";
                        var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                        showMessage(attrvalue);
                    }

                    if (parseInt(this.value) == 0) {
                        this.value = tds.eq(11).html();
                        var msg = "Please enter a value greater than zero!";
                        var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                        showMessage(attrvalue);
                    }

                });
                $(this).change(function e() { changeQty(this); });
            });

        }
    }

    function redeemPackageItem() {
        if (confirm('Are you sure you want to redeem?')) {

            var packageList = [];

            $("#tblRedeemPackageList > tbody > tr").each(function (index) {
                var tds = $(this).closest('tr').find('td');
                var obj = new Object();
                obj.cussupid = selectedcust.id;
                obj.packagecode = $(tds[2]).html();
                obj.packagedesc = $(tds[3]).html().replace("amp;", "");
                obj.productid = $(tds[4]).html();
                obj.productdesc = $(tds[5]).html().replace("amp;", "");
                obj.uom = $(tds[6]).html();
                obj.credit = 0;
                obj.debit = $(tds).closest('tr').find('input[name=txtQty]').val();
                obj.resource = "PACKAGEREDEEM";
                obj.redemptiontype = "PQ";
                obj.refno = $("#socode").val();
                obj.invoiceitemid = $(tds[0]).html(); // temp container for soid
                packageList.push(obj);

            });

            $.ajax({
                url: '@Url.Action("RedeemSOPackageSavetoCussupRedemption", "POS")',
                data: JSON.stringify({ redeem: packageList, resource: $('#resource').val() }),
                type: 'POST',
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    if (data) {
                        $('#mdlRedeemPackage').modal('hide');
                        reloadTableItem("Successfully Redeemed.");
                    }
                },
                error: function (req, status, err) {

                }
            });
        }


    }

    function reloadTableItem(message) {
        var attrvalue = '{"text":"' + message + '","layout":"topRight","type":"success"}';
        showMessage(attrvalue);
        $("#tblItem > tbody").empty();
        getItemDetail();
    }

    function showRedeemPoints() {

        if ($('input.ptsCheckbox:enabled').length <= 0) {
            var msg = "There are no items to redeem.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return;
        }

        if ($('input.ptsCheckbox:checked:enabled').length <= 0) {
            var msg = "Please select items to redeem.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return;

        }

        if (!(selectedcust) || selectedcust == "undefined") {
            var msg = "Please select customer!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }

        updateSelectedOptions();

        updateSalesOrderDetails();

        $('#divRedeemPointsList').empty();

        $('#mdlRedeemPoints').modal('show');

        $.ajax({
            url: '@Url.Action("getSalesOrderPointsToRedeemDetail", "POS")',
            data: { mid: selectedcust.id, soid: $('#soid').val() },
            type: 'POST',
            async: false,
            success: function (data) {
                populateRedeemPoints(data);
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });

    }


    function populateRedeemPoints(data) {

        if (data.length == 0) {
            var OpenHtmlstr = "There are no items to redeem.";
            $('#divRedeemPointsList').html(OpenHtmlstr);
            $('#btnRedeemPoints').attr("disabled", "disabled");

        }
        else {
            $('#btnRedeemPoints').removeAttr("disabled");
            var Htmlstr = "";
            var closeHtml = "</tbody></table>";

            var pkgcode;

            Htmlstr = Htmlstr + "<tr>";
            Htmlstr = Htmlstr + "<th rowspan='2' style='Display:none;'>id</th>";
            Htmlstr = Htmlstr + "<th rowspan='2' style='Display:none;'>pid</th>";
            Htmlstr = Htmlstr + "<th rowspan='2' style='Display:none;'>pcode</th>";
            Htmlstr = Htmlstr + "<th rowspan='2' style='text-align:right;padding-right:10px;width:20px;'>S/N</th>";
            Htmlstr = Htmlstr + "<th rowspan='2' style='width:20px;'>Description</th>";
            Htmlstr = Htmlstr + "<th rowspan='2' style='Display:none;'>sellprice</th>";
            Htmlstr = Htmlstr + "<th rowspan='2' style='Display:none;'>comission</th>";
            Htmlstr = Htmlstr + "<th rowspan='2' style='width:50px;Display:none;'>Total Qty</th>";
            Htmlstr = Htmlstr + "<th rowspan='2' style='width:50px;Display:none;'>Rdm Qty</th>";
            Htmlstr = Htmlstr + "<th rowspan='2' style='width:50px;'>To Redeem</th>";
            Htmlstr = Htmlstr + "<th rowspan='2' style='width:50px;'>Qty</th>";
            Htmlstr = Htmlstr + "<th rowspan='2' style='width:80px;'>UOM</th>";
            Htmlstr = Htmlstr + "<th colspan='2' style='text-align:center;'>Redeem</th>";
            Htmlstr = Htmlstr + "<th colspan='2' style='text-align:center;'>Award</th>";
            Htmlstr = Htmlstr + "<th rowspan='2'>Service Staff</th></tr>";
            Htmlstr = Htmlstr + "<tr><th style='text-align:center;'>" + $('#c').val() + "</th><th style='text-align:center;'>" + $('#b').val() + "</th><th style='text-align:center;'>" + $('#c').val() + "</th><th style='text-align:center;'>" + $('#b').val() + "</th></tr>";
            Htmlstr = Htmlstr + "</tr></thead><tbody>";

            var totalCitiPts = 0;
            var totalRwdPts = 0;

            for (var x = 0; x < data.length; x++) {
                Htmlstr += "<tr id=" + data[x].id + " dtlid=" + data[x].id + ">";
                Htmlstr += "<td style='Display:none;'>" + data[x].id + "</td>";
                Htmlstr += "<td style='Display:none;'>" + data[x].productid + "</td>";
                Htmlstr += "<td style='Display:none;'>" + data[x].productcode + "</td>";
                Htmlstr += "<td style='width:10px;text-align:right;'>" + (x + 1) + "</td>";
                Htmlstr += "<td style='width:120px;text-align:left;'>" + data[x].productdesc + "</td>"
                Htmlstr += "<td style='width:120px;text-align:left;Display:none;'>" + data[x].sellprice + "</td>"
                Htmlstr += "<td style='width:120px;text-align:left;Display:none;'>" + data[x].servicecommission + "</td>"
                Htmlstr += "<td style='width:40px;text-align:right;Display:none;'>" + data[x].qty + "</td>";
                Htmlstr += "<td style='width:40px;text-align:right;Display:none;'>" + data[x].redeemedqty + "</td>";
                Htmlstr += "<td style='width:40px;text-align:right;'>" + (data[x].qty - data[x].redeemedqty) + "</td>";
                Htmlstr += "<td style='width:40px;text-align:right;'><input class='form-control txtPkgQty' name='txtQty' style='text-align:right;' value='1'/></td>";
                Htmlstr += "<td style='width:40px;text-align:left;'>" + data[x].uom + "</td>";
                Htmlstr += "<td style='width:40px;text-align:right;'>" + data[x].redeemciti + "</td>";
                Htmlstr += "<td style='width:40px;text-align:right;'>" + data[x].redeemrwd + "</td>";
                Htmlstr += "<td style='width:40px;text-align:right;'>" + data[x].awardciti + "</td>";
                Htmlstr += "<td style='width:40px;text-align:right;'>" + data[x].awardrwd + "</td>";
                Htmlstr += "<td style='width:150px;'><select class='form-control' id='cbostaffR_0_" + data[x].id + "'>" + $('#cbobkstaff').html() + "</select></td></tr>";

            }

            $("#txtTotalCitiPts").val(totalCitiPts);
            $("#txtTotalRwdPts").val(totalRwdPts);

            OpenHtmlstr = "<table class='table table-bordered' id ='tblRedeemPointsList'><thead>";
            $('#divRedeemPointsList').html(OpenHtmlstr + Htmlstr + closeHtml);

            calculatePoints();

            $("#tblRedeemPointsList > tbody > tr").find('input:text').each(function (index) {

                $(this).on('input', function (event) {

                    this.value = this.value.replace(/[^0-9]/g, '');
                    var tds = $(this).closest('tr').find('td');

                    if (parseInt(this.value) > parseInt(tds.eq(9).html())) {
                        this.value = tds.eq(9).html();
                        var msg = "Not allow to enter more than available quantity!";
                        var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                        showMessage(attrvalue);
                    }

                    if (parseInt(this.value) == 0) {
                        this.value = tds.eq(9).html();
                        var msg = "Please enter a value greater than zero!";
                        var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                        showMessage(attrvalue);
                    }


                });

                $(this).change(function e() {
                    changeQty(this);
                });


            });

            $("#tblRedeemPointsList .txtPkgQty").keyup(function (index) {
                calculatePoints();
            });


            getMemberbalance(selectedcust.id)
        }
    }


    function calculatePoints() {
        var totalCitiPts = 0;
        var totalRwdPts = 0;

        $("#tblRedeemPointsList > tbody > tr").each(function (index) {
            var tds = $(this).closest('tr').find('td');

            var qty = (tds.eq(10).find('input').val() == "") ? "0" : tds.eq(10).find('input').val();

            totalCitiPts = totalCitiPts + (parseInt(qty) * parseFloat(tds.eq(12).html()));
            totalRwdPts = totalRwdPts + (parseInt(qty) * parseFloat(tds.eq(13).html()));

        });

        $("#txtTotalCitiPts").val(totalCitiPts);
        $("#txtTotalRwdPts").val(totalRwdPts);
    }


    function redeemPointsItem() {
        var totalCitiPts = 0;
        var totalRwdPts = 0;
        var availbleCitiPts = 0;
        var availableRwdPts = 0;

        totalCitiPts = $("#txtTotalCitiPts").val();
        totalRwdPts = $("#txtTotalRwdPts").val();
        availbleCitiPts = $("#txtAvailableCitiPts").val();
        availableRwdPts = $("#txtAvailableRwdPts").val();

        if (parseFloat(totalCitiPts) > parseFloat(availbleCitiPts)) {
            var msg = "Insuffient Gliss Pts.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return;
        }

        if (parseFloat(totalRwdPts) > parseFloat(availableRwdPts)) {
            var msg = "Insuffient Rwd Pts.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return;
        }


        if (confirm('Are you sure you want to redeem?')) {

            var redeemList = new Array();

            $("#tblRedeemPointsList > tbody > tr").each(function (i, row) {
                var tds = $(row).find('td');

                if ((tds.eq(10).find('input').val() > 0)) {

                    var rid = 0;
                    var obj = new Object();

                    var itemidArray = "";
                    obj.id = 0;
                    obj.cussupid = selectedcust.id;
                    obj.type = "REDEEM";
                    obj.cussupname = selectedcust.cussupname;
                    obj.status = "CLOSE";
                    obj.salesorderid = $('#soid').val();//$("#socode").val()
                    obj.staffid = $("#cbobkstaff").val();
                    obj.salesorderdetailid = tds.eq(0).html();
                    var tsellprice = 0;
                    var tac = 0;
                    var tab = 0;
                    var tsc = 0;
                    var i = 0;
                    var itemcount = 0;

                    var itemCollection = new Array();


                    i = i + 1;
                    itemcount++;

                    var item = new Object();
                    item.lineno = i;

                    item.id = tds.eq(0).html();
                    item.productid = tds.eq(1).html();
                    item.productcode = tds.eq(2).html();
                    item.productdesc = tds.eq(4).html();
                    item.unitprice = tds.eq(5).html();
                    item.servicecommission = tds.eq(6).html();
                    item.qty = (tds.eq(10).find('input').val() == "") ? 0 : tds.eq(10).find('input').val();
                    item.uom = tds.eq(11).html();
                    item.redeemdollars = tds.eq(12).html();
                    item.redeembonus = tds.eq(13).html();
                    item.awarddollars = tds.eq(14).html();
                    item.awardbonus = tds.eq(15).html();
                    item.lineamount = tds.eq(5).html();
                    var staff = tds.eq(16).find('select');
                    item.staffserviceid = staff[0].value;

                    itemCollection.push(item);

                    tsellprice = tsellprice + (parseFloat(item.unitprice) * item.qty);

                    //var tlistCollection = new Array();
                    //var rkeyid = $(row).attr('id');


                    //for (var x = 0 ; x < tlist.length; x++) {
                    //    if (tlist[x].keyid == rkeyid) {
                    //        var tobjtmp = new Object();
                    //        tobjtmp = tlist[x];
                    //        tobjtmp.resourcedetailid = item.id;
                    //        tobjtmp.staffid = $("#cbobkstaff").val();
                    //        tlistCollection.push(tobjtmp);
                    //        tlist.splice(x, 1);
                    //        x--;
                    //    }
                    //}
                    //item.treatment = null;


                    obj.total_subtotal = tsellprice;
                    obj.total_total = tsellprice;
                    obj.items = itemCollection;


                    redeemList.push(obj);
                }

            });


            $.ajax({
                url: '@Url.Action("RedeemSOPointsSave", "POS")',
                data: JSON.stringify({ redeemList: redeemList, resource: $('#resource').val() }),
                type: 'POST',
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    if (data) {
                        if (data == "Success") {
                            $('#mdlRedeemPoints').modal('hide');
                            reloadTableItem("Successfully Redeemed.");
                        }
                        else {
                            var msg = "An error occured while saving. Please contact the administrator.";
                            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                            showMessage(attrvalue);

                        }
                    }
                },
                error: function (req, status, err) {

                }
            });
        }


    }

    @*function showTreatmentListing() {

        if (!(selectedcust) || selectedcust == "undefined") {
            var msg = "Please select customer!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }

        $('#divTreatmentListing').empty();


        $.ajax({
            url: '@Url.Action("getSalesOrderCustomerTreatment", "POS")',
            data: { mid: selectedcust.id, productid: $('#soid').val() },
            type: 'POST',
            success: function (data) {

                if (data.length > 0) {
                    $('#mdlTreatmentListing').modal('show');
                    populateTreatmentListing(data);
                }
                else {
                    var msg = "No Treatment Available!";
                    var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                    showMessage(attrvalue);

                }
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });

    }*@

    //function populateTreatmentListing(data) {


    //    var Htmlstr = "";
    //    var closeHtml = "</tbody></table>";

    //    Htmlstr = Htmlstr + "<tr>";
    //    Htmlstr = Htmlstr + "<th rowspan='2' style='Display:none;'>id</th>";
    //    Htmlstr = Htmlstr + "<th rowspan='2' style='text-align:right;padding-right:10px;width:20px;'>Sr.</th>";
    //    Htmlstr = Htmlstr + "<th rowspan='2' style='width:50px;'>Date</th>";
    //    Htmlstr = Htmlstr + "<th rowspan='2' style='width:50px;'>Description</th>";
    //    Htmlstr = Htmlstr + "<th rowspan='2' style='width:50px;'>Service Staff</th>";
    //    Htmlstr = Htmlstr + "</tr></thead><tbody>";

    //    for (var x = 0; x < data.length; x++) {
    //        Htmlstr += "<tr>";
    //        Htmlstr += "<td style='Display:none;'>" + data[x].id + "</td>";
    //        Htmlstr += "<td style='width:10px;text-align:right;'>" + (x + 1) + "</td>";
    //        Htmlstr += "<td style='width:100px;text-align:left;'>" + data[x].date + "</td>"
    //        Htmlstr += "<td style='width:150px;text-align:left;'>" + data[x].description + "</td>"
    //        Htmlstr += "<td style='width:120px;text-align:left;'>" + data[x].staffname + "</td></tr>";
    //    }

    //    OpenHtmlstr = "<table class='table table-bordered' id ='tblTreatmentListing'><thead>";
    //    $('#divTreatmentListing').html(OpenHtmlstr + Htmlstr + closeHtml);

    //}


    //function showTreatment(paramtr) {


    //    var htmlstr = "";
    //    var rid = $('#soid').val();
    //    staffName = $("#cbobkstaff :selected").text();
    //    var tblrid = $(paramtr).closest('tr').attr("id");
    //    var dtlid = $(paramtr).closest('tr').attr("dtlid");
    //    selTkeyid = tblrid;
    //    selTdtlid = dtlid;

    //    for (var i = 0; i < tlist.length; i++) {
    //        if (tlist[i].keyid == selTkeyid) {
    //            htmlstr = htmlstr + "<tr><td style='display:none'>0</td><td style='display:none'>" + selTkeyid + "</td><td style='display:none'>" + selTdtlid + "</td><td style='display:none'>" + i + "</td><td>" + tlist[i].createbyname + "</td><td>" + tlist[i].description + "</td><td><a class='btn btn-primary' onclick='RemoveTreatment(this);'><i class='fa fa-trash-o' title='remove'></i></a></td></tr>";
    //        }
    //    }


    //    $('#txtTreatmentDescription').val("");
    //    $('#tbltreatment tbody').html('');
    //    $('#tbltreatment tbody').html(htmlstr);
    //    $('#mdlRedeemPointsTreatment').modal('show');
    //}

    //function AddTreatment() {
    //    var htmlstr = "";
    //    var uname = "";
    //    var tmpobj = new Object();
    //    tmpobj.id = 0;
    //    tmpobj.resourcedetailid = selTdtlid;
    //    tmpobj.keyid = selTkeyid;
    //    tmpobj.createbyname = staffName;
    //    tmpobj.cureateby = 0;
    //    tmpobj.createdate = Date.now();
    //    tmpobj.statusfield = "NEW";
    //    tmpobj.description = $('#txtTreatmentDescription').val();
    //    tlist.push(tmpobj);

    //    htmlstr = "<tr><td style='display:none'>0</td><td style='display:none'>" + selTkeyid + "</td><td style='display:none'>" + selTdtlid + "</td><td style='display:none'>" + (tlist.length - 1) + "</td><td>" + tmpobj.createbyname + "</td><td>" + tmpobj.description + "</td><td><a class='btn btn-primary' onclick='RemoveTreatment(this);'><i class='fa fa-trash-o' title='Remove'></i></a></td></tr>";
    //    $("#tbltreatment tbody").append(htmlstr);
    //    $('#txtTreatmentDescription').val("");
    //}

    //function RemoveTreatment(paramtr) {
    //    var tds = $(paramtr).closest('tr').find('td');
    //    var treatmentid = tds.eq(0).html();
    //    var tindex = tds.eq(3).html();
    //    tlist.splice(tindex, 1);
    //    $(paramtr).closest('tr').remove();
    //}

    function getMemberbalance(mid) {

        $.ajax({
            url: '@Url.Action("getMemberList", "CusSup")',
            data: { mid: mid },
            type: 'POST',
            success: function (data) {
                if (data.length > 0) {
                    $('#txtAvailableCitiPts').val(data[0].CBalance);
                    $('#txtAvailableRwdPts').val(data[0].BBalance);

                }
                else {
                    $('#txtAvailableCitiPts').val('0');
                    $('#txtAvailableRwdPts').val('0');

                }
            },
            error: function (ts) { alert(ts.responseText) }
        });
    }

    function showSalesKitList() {
        $.ajax({
            url: '@Url.Action("getSalesKitsList", "POS")',
            data: {},
            type: 'POST',
            success: function (data) {
                populateSaleKitsList(data);
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });
    }

    function populateSaleKitsList(data) {
        var htmlstr = ""; var count = 0;
        var r = 0;
        if (data) {
            for (var x = 0; x < data.length; x++) {
                count++;
                htmlstr += "<div class='col-sm-2'><a class='quick-button' data-toggle='modal' data-target='#mdlSalesKitItem' onclick='displaySalesKitsItemList(" + data[x].id + ")'><i class='fa fa-briefcase'></i><p>" + data[x].desc + "</p></a></div>";
                if (isMobile == 0) {
                    r = 6;
                }
                else {
                    r = 4;
                }
                if ((count % r) == 0) {
                    htmlstr += "<div class='clearfix'></div><br/>";
                }
            }
            if ((count % r) != 0) {
                htmlstr += "<div class='clearfix'></div><br/>";
            }
            $('#divSalesKitList').html(htmlstr);
        }
    }

    function showSalesKit() {
        if (!(selectedcust) || selectedcust == "undefined") {
            var msg = "Please select customer!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }

        var selStaff = $("#cbobkstaff").val();
        if (selStaff == '' || selStaff == 'undefined') {
            var msg = "Please select staff!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }

        var selFacility = $("#cbofacility").val();
        if (selFacility == '' || selFacility == 'undefined') {
            var msg = "Please select facility!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }

        $('#mdlSalesKit').modal('show');
        //btnosaleskitbj = btn;
    }

    function showSalesKitItemList(skid) {

        $.ajax({
            url: '@Url.Action("getSalesKitItemList", "POS")',
            data: { skpid: skid },
            type: 'POST',
            success: function (data) {
                populateSaleKitItemsList(data);
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });

    }

    function populateSaleKitItemsList(data) {
        var htmlstr = "";
        var count = 0;
        var r = 0;
        if (isMobile == 0) {
            r = 6;
        }
        else {
            r = 4;
        }
        if (data) {
            for (var x = 0; x < data.length; x++) {
                count++;
                var itemdisplay = data[x].desc + "<br>" + "$ " + data[x].sellprice;
                htmlstr += "<div class='col-sm-2'><a class='quick-button' onclick='populateSalesKitDtlstogrd(" + data[x].id + ")'><i class='fa fa-briefcase'></i><p>" + itemdisplay + "</p></a></div>";
                if ((count % r) == 0) {
                    htmlstr += "<div class='clearfix'></div><br/>";
                }
            }
            if ((count % r) != 0) {
                htmlstr += "<div class='clearfix'></div><br/>";
            }
            $('#divSalesKitItemList').html(htmlstr);
        }
    }

    function populateSalesKitDtlstogrd(pId) {

        if (!(selectedcust) || selectedcust == "undefined") {
            var msg = "Please select customer!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }

        var trobj;
        var trs = $('#tblItem > tbody').find('tr');
        itemcount++;
        var rowhtml = "";
        var lno = itemcount;
        var cat = "";
        var productid = 0;
        $.ajax({
            url: '@Url.Action("getSalesKitItemDetail", "POS")',
            data: { pid: pId },
            async: false,
            type: 'POST',
            success: function (data) {
                if (data) {
                    var sellprice = data[0].sellprice;
                    var prodBalance = getBalanceinPackage(data[0].id);
                    var redeemedqty = 0;
                    var packageClass = "";
                    cat = data[0].category;
                    productid = data[0].id;

                    if (data[0].category == "Package") {
                        packageClass = "package_" + data[0].id + "_" + lno;
                    }

                    rowhtml = "<td>" + lno + "</td><td style='display:none'>" + itemid + "</td><td style='display:none'>" + data[0].id + "</td>"
                       + "<td style='display:none'>" + data[0].productcode + "</td><td style='text-align:left;'>" + data[0].desc + "</td>"
                       + "<td>" + prodBalance + "</td><td>1</td><td style='text-align:left;display:none;'>" + data[0].uom + "</td><td style='display:none;'>" + redeemedqty + "</td><td>" + sellprice + "</td><td>" + (1 * sellprice).toFixed(2) + "</td>"
                       + "<td class='text-left'>" + $("#cbofacility option:selected").text() + "</td>"
                       + "<td class='text-left'>" + $("#cbobkstaff option:selected").text().substring(0, 9) + "...</td>"
                       + "<td></td>"
                       + "<td></td>"
                       + "<td></td>"
                       + "<td class='text-center'><a class='btn btn-primary'><i class='fa fa-play'></i></a></td>"
                       + "<td class='text-center'><a class='btn btn-primary' onclick='EditItem(this)'><i class='fa fa-edit' title='Edit Items'></i></a></td>";

                    if (packageClass == "")
                        rowhtml += "<td class='text-center'><a class='btn btn-danger' onclick='RemoveItem(this,\"\")' title='Remove Item'><i class='fa fa-trash-o'></i></a></td>";
                    else
                        rowhtml += "<td class='text-center'><a class='btn btn-danger' onclick='RemoveItem(this,\"" + packageClass + "\")' title='Remove Item'><i class='fa fa-trash-o'></i></a></td>";

                    rowhtml += "<td class='text-center'><a class='btn btn-primary' onclick='CopyItem(this);'><i class='fa fa-files-o' title='Copy Item'></i></a></td>"
                       + "<td class='text-center' style='display:none'><a class='btn btn-warning' onclick='StaffItem(this);'><i class='fa fa-user'></i></a></td>"
                       + "<td class='text-center'><a class='btn btn-primary' onclick='ViewTreatmentItem(this)' title='Treatment Item'><i class='fa fa-medkit'></i></a></td>"

                       + "<td><input type='checkbox' class='form-control' disabled/></td>";

                    if (prodBalance > 0)
                        rowhtml += "<td><input type='checkbox'  class='rdmCheckbox form-control' /></td>";
                    else
                        rowhtml += "<td><input type='checkbox' class='form-control' disabled/></td>";

                    rowhtml += "<td><input type='checkbox' class='ptsCheckbox form-control' /></td>"
                       + "<td><input type='checkbox' class='posCheckbox form-control' /></td>"
                       + "<td style='display:none'>" + data[0].category + "</td><td style='display:none'>" + data[0].categorysub + "</td>"
                       + "<td style='display:none'>" + data[0].brand + "</td><td style='display:none'>" + data[0].rangesNSeries + "</td><td style='display:none'></td><td style='display:none'></td><td style='display:none'>0</td>"
                       + "<td style='display:none'>" + data[0].serviceallowance.toFixed(2) + "</td>"
                       + "<td style='display:none'>" + $("#cbobkstaff").val() + "</td>"
                       + "<td style='display:none'>" + $("#cbofacility").val() + "</td>";
                }
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });

        if (itemcount <= 5) {
            trobj = trs[itemcount - 1];
            var lineNumber = itemcount;
            if (cat == 'Package') {
                $(trobj).removeClass();
                $(trobj).addClass("package_main_" + productid + "_" + lineNumber);
            }
            $(trobj).html(rowhtml);

            if (cat == 'Package') {
                $.ajax({
                    url: '@Url.Action("getProductBundleDetailsWithBalance", "Product")',
                    data: { pid: productid, mid: selectedcust.id },
                    type: 'POST',
                    success: function (data) {

                        for (x = 0; x < data.length; x++) {
                            itemcount++
                            var packageQty = (1 * data[x].qty);
                            var redeemedqty = 0;

                            var rowhtml = "<td>" + itemcount + "</td><td style='display:none'>" + itemid + "</td><td style='display:none'>" + data[x].productid + "</td><td style='display:none'>" + data[x].productcode + "</td><td style='text-align:left;padding-left:20px;'>" + data[x].description + "</td>"
                                + "<td>" + data[x].balance + "</td><td>" + packageQty + "</td><td style='display:none;'>" + data[x].uom + "</td><td style='display:none;'>" + redeemedqty + "</td><td></td><td></td>"
                                + "<td class='text-left'>" + $("#cbofacility option:selected").text() + "</td>"
                                + "<td class='text-left'>" + $("#cbobkstaff option:selected").text().substring(0, 9) + "...</td>"
                                + "<td></td>"
                                + "<td></td>"
                                + "<td></td>"
                                + "<td class='text-center'><a class='btn btn-primary'><i class='fa fa-play'></i></a></td>"
                                + "<td class='text-center'><a class='btn btn-primary'onclick='EditItem(this);' title='Edit Item'><i class='fa fa-edit' title='Edit Items'></i></a></td>"
                                + "<td class='text-center'><a class='btn btn-danger' onclick='RemoveItem(this,\"\")' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>"
                                + "<td class='text-center'><a class='btn btn-primary' onclick='CopyItem(this);'><i class='fa fa-files-o' title='Copy Item'></i></a></td>"
                                + "<td class='text-center' style='display:none'><a class='btn btn-warning' onclick='StaffItem(this);'><i class='fa fa-user'></i></a></td>"
                                + "<td class='text-center'><a class='btn btn-primary' onclick='ViewTreatmentItem(this)' title='Treatment'><i class='fa fa-medkit'></i></a></td>"
                                + "<td><input type='checkbox' class='form-control' disabled/></td>"
                                + "<td><input type='checkbox' class='rdmCheckbox form-control' disabled/></td>"
                                + "<td><input type='checkbox' class='form-control' disabled/></td>"
                                + "<td><input type='checkbox' class='form-control' disabled/></td>"
                                + "<td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'>" + productid + "</td>"
                                + "<td style='display:none'>" + lineNumber + "</td><td style='display:none'>0</td><td style='display:none'>" + data[x].serviceallowance + "</td>"
                                + "<td style='display:none'>" + $("#cbobkstaff").val() + "</td>"
                                + "<td style='display:none'>" + $("#cbofacility").val() + "</td>";

                            trobj = trs[itemcount - 1];
                            var trClass = "package_" + productid + "_" + lineNumber
                            $(trobj).addClass(trClass);
                            $(trobj).html(rowhtml);

                            if (itemcount > 5) {
                                $("#tblItem > tbody").append("<tr class='" + trClass + "'>" + rowhtml + "</tr>");
                            }

                        }

                    }
                });

            }

        }
        else {
            $("#tblItem > tbody").append("<tr>" + rowhtml + "</tr>");
            var lineNumber = itemcount;
            if (cat == 'Package') {
                $.ajax({
                    url: '@Url.Action("getProductBundleDetailsWithBalance", "Product")',
                    data: { pid: productid, mid: selectedcust.id },
                    type: 'POST',
                    async: false,
                    success: function (data) {

                        for (x = 0; x < data.length; x++) {

                            itemcount++
                            var packageQty = (1 * data[x].qty);
                            var redeemedqty = 0;

                            var rowhtml = "<td>" + itemcount + "</td><td style='display:none'>" + itemid + "</td><td style='display:none'>" + data[x].productid + "</td><td style='display:none'>" + data[x].productcode + "</td><td style='text-align:left;padding-left:20px;'>" + data[x].description + "</td>"
                                + "<td>" + data[x].balance + "</td><td>" + packageQty + "</td><td style='display:none;'>" + data[x].uom + "</td><td style='display:none;'>" + redeemedqty + "</td><td></td><td></td>"
                                + "<td>" + $("#cbofacility option:selected").text() + "</td>"
                                + "<td>" + $("#cbobkstaff option:selected").text().substring(0, 9) + "...</td>"
                                + "<td></td>"
                                + "<td></td>"
                                + "<td></td>"
                                + "<td class='text-center'><a class='btn btn-primary'><i class='fa fa-play'></i></a></td>"
                                + "<td class='text-center'><a class='btn btn-primary' onclick='EditItem(this);'><i class='fa fa-edit' title='Edit Items'></i></a></td>"
                                + "<td class='text-center'><a class='btn btn-danger' onclick='RemoveItem(this,\"\")' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>"
                                + "<td class='text-center'><a class='btn btn-primary' onclick='CopyItem(this);'><i class='fa fa-files-o' title='Copy Item'></i></a></td>"
                                + "<td class='text-center' style='display:none'><a class='btn btn-warning' onclick='StaffItem(this);'><i class='fa fa-user'></i></a></td>"
                                + "<td class='text-center'><a class='btn btn-primary' onclick='ViewTreatmentItem(this)' title='Treatment'><i class='fa fa-medkit'></i></a></td>"
                                + "<td><input type='checkbox' class='form-control' disabled/></td>"
                                + "<td><input type='checkbox' class='rdmCheckbox form-control' disabled/></td>"
                                + "<td><input type='checkbox' class='form-control' disabled/></td>"
                                + "<td><input type='checkbox' class='form-control' disabled/></td>"
                                + "<td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'>" + productid + "</td>"
                                + "<td style='display:none'>" + lineNumber + "</td>"
                                + "<td style='display:none'>1</td>"
                                + "<td style='display:none'>" + data[x].serviceallowance.toFixed(2) + "</td>"
                                + "<td style='display:none'>" + $("#cbobkstaff").val() + "</td>"
                                + "<td style='display:none'>" + $("#cbofacility").val() + "</td>";

                            var pkgClass = "package_" + productid + "_" + lineNumber;
                            $("#tblItem > tbody").append("<tr class='" + pkgClass + "'>" + rowhtml + "</tr>");



                        }

                    }
                });
            }
        }
        ItemUpdateFlag = 0;
        itemid = 0;
        $('#mdlSalesKitItem').find('.close').trigger('click');
    }

    function showFreeServices() {

        if (!(selectedcust) || selectedcust == "undefined") {
            var msg = "Please select customer!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }

        var selStaff = $("#cbobkstaff").val();
        if (selStaff == '' || selStaff == 'undefined') {
            var msg = "Please select staff!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }

        var selFacility = $("#cbofacility").val();
        if (selFacility == '' || selFacility == 'undefined') {
            var msg = "Please select facility!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }

        $.ajax({
            url: '@Url.Action("getFreeServicesList", "POS")',
            data: {},
            type: 'POST',
            success: function (data) {
                if (data.length > 0) {
                    $('#mdlFreeServices').modal('show');
                    populateFreeServicesList(data);
                }
                else {
                    var msg = "No Available Free Services!";
                    var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                    showMessage(attrvalue);
                }
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });
    }

    function populateFreeServicesList(data) {
        var htmlstr = "";
        var count = 0;
        var r = 0;
        if (isMobile == 0) {
            r = 6;
        }
        else {
            r = 4;
        }
        if (data) {
            for (var x = 0; x < data.length; x++) {
                count++;
                var itemdisplay = data[x].desc + "<br>";
                htmlstr += "<div class='col-sm-2'><a class='quick-button' onclick='populateFreeServicesDtlstogrd(" + data[x].id + ")'><i class='fa fa-briefcase'></i><p>" + itemdisplay + "</p></a></div>";
                if ((count % r) == 0) {
                    htmlstr += "<div class='clearfix'></div><br/>";
                }
            }
            if ((count % r) != 0) {
                htmlstr += "<div class='clearfix'></div><br/>";
            }
            $('#divFreeServicesList').html(htmlstr);
        }
    }

    function populateFreeServicesDtlstogrd(pId) {

        if (!(selectedcust) || selectedcust == "undefined") {
            var msg = "Please select customer!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }

        var trobj;
        var trs = $('#tblItem > tbody').find('tr');
        itemcount++;
        var rowhtml = "";
        var lno = itemcount;
        $.ajax({
            url: '@Url.Action("getFreeServicesItemDetail", "POS")',
            data: { pid: pId },
            async: false,
            type: 'POST',
            success: function (data) {
                if (data) {

                    rowhtml = "<td>" + lno + "</td><td style='display:none'>" + itemid + "</td><td style='display:none'>" + data[0].id + "</td>"
                       + "<td style='display:none'>" + data[0].productcode + "</td><td style='text-align:left;'>" + data[0].desc + "</td>"
                       + "<td></td><td>1</td><td style='text-align:left;display:none;'>" + data[0].uom + "</td><td style='display:none;'></td><td>0.00</td><td>0.00</td>"
                       + "<td class='text-left'>" + $("#cbofacility option:selected").text() + "</td>"
                       + "<td class='text-left'>" + $("#cbobkstaff option:selected").text().substring(0, 9) + "...</td>"
                       + "<td></td>"
                       + "<td></td>"
                       + "<td></td>"
                       + "<td class='text-center'><a class='btn btn-primary'><i class='fa fa-play'></i></a></td>"
                       + "<td class='text-center'><a class='btn btn-primary' onclick='EditItem(this)'><i class='fa fa-edit' title='Edit Items'></i></a></td>"
                       + "<td class='text-center'><a class='btn btn-danger' onclick='RemoveItem(this,\"\")' title='Remove Item'><i class='fa fa-trash-o'></i></a></td>"
                       + "<td class='text-center'><a class='btn btn-primary' onclick='CopyItem(this);'><i class='fa fa-files-o' title='Copy Item'></i></a></td>"
                       + "<td class='text-center' style='display:none'><a class='btn btn-warning' onclick='StaffItem(this);'><i class='fa fa-user'></i></a></td>"
                       + "<td class='text-center'><a class='btn btn-primary' onclick='ViewTreatmentItem(this)' title='Treatment Item'><i class='fa fa-medkit'></i></a></td>"
                       + "<td><input type='checkbox' class='focCheckbox form-control' /></td>"
                       + "<td><input type='checkbox' class='form-control' disabled/></td>"
                       + "<td><input type='checkbox' class='form-control' disabled/></td>"
                       + "<td><input type='checkbox' class='form-control' disabled/></td>"
                       + "<td style='display:none'>" + data[0].category + "</td><td style='display:none'>" + data[0].categorysub + "</td>"
                       + "<td style='display:none'>" + data[0].brand + "</td><td style='display:none'>" + data[0].rangesNSeries + "</td><td style='display:none'></td><td style='display:none'></td><td style='display:none'>0</td>"
                       + "<td style='display:none'>" + data[0].serviceallowance.toFixed(2) + "</td>"
                       + "<td style='display:none'>" + $("#cbobkstaff").val() + "</td>"
                       + "<td style='display:none'>" + $("#cbofacility").val() + "</td>"
                }
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });

        if (itemcount <= 5) {
            trobj = trs[itemcount - 1];
            $(trobj).html(rowhtml);

        }
        else {
            $("#tblItem > tbody").append("<tr>" + rowhtml + "</tr>");
        }
        ItemUpdateFlag = 0;
        itemid = 0;
        $('#mdlFreeServices').find('.close').trigger('click');
    }

    //Added by ZawZO on 8 Dec 2015
    function displaySalesKitsItemList(pID) {
        $('#mdlSalesKit').find('.close').trigger('click');
        showSalesKitItemList(pID);
    }
    function clearInvoiceDetailsgrd() {
        $("#tblItem > tbody").empty();
    }

    function TimeItem(paramtr) {
        var tds = $(paramtr).closest('tr').find('td');

        var itemid = tds.eq(1).html();
        var optionStatus = tds.eq(16).html();
        var itemstatus = "";

        if (optionStatus.indexOf("play") > 0) {
            itemstatus = "START";
        }
        else if (optionStatus.indexOf("stop") > 0) {
            itemstatus = "END";
        }

        $.ajax({
            url: '@Url.Action("updateSalesOrderItemStatus", "POS")',
            data: JSON.stringify({ resource: $('#rcode').val(), itemid: itemid, status: itemstatus }),
            type: 'POST',
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var result = data.split(",");

                if (result[0] == "SUCCESS") {
                    tds.eq(15).html(itemstatus);

                    if (itemstatus == "START") {
                        tds.eq(13).html(result[1]);
                        tds.eq(16).html("<a class='btn btn-primary' onclick='TimeItem(this);'><i class='fa fa-stop'></i></a>");
                    }
                    else if (itemstatus == "END") {
                        tds.eq(14).html(result[1]);
                        tds.eq(16).html("<a class='btn btn-primary' ><i class='fa fa-check'></i></a>");
                    }

                    disableSessionNotEnded();
                }
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });
    }

    function StaffItem(paramtr) {
        var tds = $(paramtr).closest('tr').find('td');
        selectedItemRow = tds;


        $('#hidItemID').val(tds.eq(1).html());
        $('#txtServiceStartTime').val(tds.eq(13).html());
        $('#txtServiceEndTime').val(tds.eq(14).html());
        $('#optionServiceStaff').val(tds.eq(34).html());
        $('#optionServiceFacility').val(tds.eq(35).html());
        $('#optionServiceStaff').addClass("form-control");
        $('#optionServiceFacility').addClass("form-control");

        if (tds.eq(15).html() == "" || tds.eq(15).html() == "QUEUE" || tds.eq(15).html() == "START") {
            $('#divServiceStartTime').hide()
            $('#divServiceEndTime').hide();
            $('#divServiceStartTimeText').hide()
            $('#divServiceEndTimeText').hide();
        }
        else {
            $('#divServiceStartTime').show()
            $('#divServiceEndTime').show();
            $('#divServiceStartTimeText').show()
            $('#divServiceEndTimeText').show();
        }

        $('#mdlStaffItem').modal('show');
    }

    function SaveServiceStaff() {

        var itemid = $('#hidItemID').val();

        if (itemid != 0) {
            var staffid = $('#optionServiceStaff').val();
            var branchassetid = $('#optionServiceFacility').val();
            var starttime = $('#txtServiceStartTime').val();
            var endtime = $('#txtServiceEndTime').val();

            if (starttime == "") {
                var msg = "Please enter start time.";
                var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                showMessage(attrvalue);
                return false;
            }
            else {
                if (isValidTimeFormat(starttime) == false) {
                    var msg = "Invalid start time format.";
                    var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                    showMessage(attrvalue);
                    return false;
                }
            }
            if (endtime == "") {
                var msg = "Please enter end time.";
                var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                showMessage(attrvalue);
                return false;
            }
            else {
                if (isValidTimeFormat(endtime) == false) {
                    var msg = "Invalid end time format.";
                    var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                    showMessage(attrvalue);
                    return false;
                }
            }

            var isValidTime = isServiceValidPeriod();

            if (isValidTime == false) {
                var msg = "Start Time should be less than end time!";
                var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                showMessage(attrvalue);
                return false;
            }

            $.ajax({
                url: '@Url.Action("updateSalesOrderItemStaff", "POS")',
                data: JSON.stringify({ resource: $('#rcode').val(), itemid: itemid, staffid: staffid, branchassetid: branchassetid, startTime: starttime, endTime: endtime }),
                type: 'POST',
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    if (data == "SUCCESS") {
                        $('#mdlStaffItem').modal('hide');
                        reloadTableItem("Successfully updated item.");
                        treatmentItemParam.eq(12).html($("#optionServiceStaff :selected").text());
                        treatmentItemParam.eq(13).html(starttime);
                        treatmentItemParam.eq(14).html(endtime);
                        treatmentItemParam.eq(34).html(staffid);
                    }
                },
                error: function (ts) { showMessage(ts.responseText, "error") }
            });
        }
        else {
            var tds = selectedItemRow;
            tds.eq(34).html($('#optionServiceStaff').val());
            tds.eq(35).html($('#optionServiceFacility').val());
            //tds.eq(11).html($('#txtServiceStartTime').val());
            //tds.eq(12).html($('#txtServiceEndTime').val());
            tds.eq(13).html($('#optionServiceStaff :selected').text());
            tds.eq(14).html($('#optionServiceFacility :selected').text());
            $('#mdlStaffItem').modal('hide');
        }
    }

    function VoidItem(paramtr) {

        var tds = $(paramtr).closest('tr').find('td');
        voidItemParam = tds;
        if (tds.eq(15).html() == "PAID" || tds.eq(15).html() == "REDEEM" || tds.eq(15).html() == "PARTIAL") {
            openPasswordDialog();
        }
        else {
            if (tds.eq(26).html() == "Package") {
                openPasswordDialog();
            }
            if (parseInt(tds.eq(8).html()) > 0) {

                openPasswordDialog();
            }
        }
    }

    function voidSO() {

        var tds = voidItemParam;
        var itemid = tds.eq(1).html();
        var category = tds.eq(26).html();

        $.ajax({
            url: '@Url.Action("VoidItem", "POS")',
            data: JSON.stringify({ soitemid: itemid, resource: $('#rcode').val(), category: category, uname: $('#txtname').val(), pwd: $('#txtpwd').val() }),
            type: 'POST',
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                if (data == "Success") {
                    closeLoginDialog();
                    reloadTableItem("Successfully Voided Item.");

                    if (tds.eq(15).html() == "PAID" || tds.eq(15).html() == "PARTIAL")
                        $("#reminderPayment").show();
                }
                else {
                    closeLoginDialog();
                    var msg = data;
                    var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                    showMessage(attrvalue);
                }

            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });


    }

    function ViewTreatmentItem(paramtr) {
        clearTreatment();
        var tds = $(paramtr).closest('tr').find('td');
        var productid = tds.eq(2).html();

        treatmentItemProductId = productid;
        treatmentItemParam = $(paramtr).closest('tr').find('td');

        itemIndex = $(paramtr).closest('tr').index();

        selectedItemRow = tds;

        $('#hidItemID').val(tds.eq(1).html());
        $('#txtServiceStartTime').val(tds.eq(13).html());
        $('#txtServiceEndTime').val(tds.eq(14).html());
        $('#optionServiceStaff').val(tds.eq(34).html());
        $('#txtCustomerName').val(selectedcust.cussupname);
        $('#optionServiceFacility').val(tds.eq(35).html());
        $('#optionServiceStaff').addClass("form-control");
        $('#optionServiceFacility').addClass("form-control");

        populateTreatmentList();

    }

    function clearTreatment() {
        $('#txtTreatmentDescription').val("");
        $('#txtTreatmentDescription2').val("");
        $('#txtTreatmentDescription3').val("");
        $('#txtTreatmentDescription4').val("");
        $("#optionTreatmentType").val("Hair");
        $("#btnTreatmentAdd").text("Add");
        $('#imgTreatment').attr("src", "../Images/hair.png");
        editTreatmentID = 0;
    }

    function AddTreatmentItem() {
        var tds = treatmentItemParam;
        if ($("#btnTreatmentAdd").text() == "Update") {

            var tmpobj = new Object();
            tmpobj.id = editTreatmentID;
            tmpobj.description = $('#txtTreatmentDescription').val();
            tmpobj.remarks2 = $('#txtTreatmentDescription2').val();
            tmpobj.remarks3 = $('#txtTreatmentDescription3').val();
            tmpobj.remarks4 = $('#txtTreatmentDescription4').val();
            tmpobj.type = $("#optionTreatmentType").val();
            tmpobj.starttime = tds.eq(13).html();
            tmpobj.endtime = tds.eq(14).html();
            tmpobj.staffid = tds.eq(34).html();
            $.ajax({
                url: '@Url.Action("UpdateTreatment", "POS")',
                data: JSON.stringify({ item: tmpobj }),
                type: 'POST',
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    populateTreatmentList();
                },
                error: function (ts) { showMessage(ts.responseText, "error") }
            });


        }
        else {
            var htmlstr = "";


            var tmpobj = new Object();
            tmpobj.id = 0;
            tmpobj.cussupid = selectedcust.id;
            tmpobj.cussupname = selectedcust.cussupname;
            tmpobj.description = $('#txtTreatmentDescription').val();
            tmpobj.productid = tds.eq(2).html();
            tmpobj.productcode = tds.eq(3).html();
            tmpobj.productdesc = tds.eq(4).html();
            tmpobj.starttime = tds.eq(13).html();
            tmpobj.endtime = tds.eq(14).html();
            tmpobj.resourcecode = $("#socode").val();
            tmpobj.resourcedetailid = tds.eq(1).html();
            tmpobj.staffid = tds.eq(34).html();
            tmpobj.description = $('#txtTreatmentDescription').val();
            tmpobj.remarks2 = $('#txtTreatmentDescription2').val();
            tmpobj.remarks3 = $('#txtTreatmentDescription3').val();
            tmpobj.remarks4 = $('#txtTreatmentDescription4').val();
            tmpobj.type = $("#optionTreatmentType").val();

            var dt = new Date();
            var time = dt.getHours() + ":" + dt.getMinutes();

            $('#txtTreatmentDescription').val("");

            $.ajax({
                url: '@Url.Action("AddNewTreatment", "POS")',
                data: JSON.stringify({ item: tmpobj }),
                type: 'POST',
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    populateTreatmentList();
                },
                error: function (ts) { showMessage(ts.responseText, "error") }
            });
        }

        clearTreatment();

    }

    function populateTreatmentList() {
        var htmlstr = "";
        $.ajax({
            url: '@Url.Action("getSalesOrderCustomerTreatment", "POS")',
            data: { mid: selectedcust.id, productid: treatmentItemProductId },
            type: 'POST',
            success: function (data) {

                if (data.length > 0) {
                    for (var i = 0; i < data.length; i++) {
                        htmlstr += "<tr>";
                        htmlstr += "<td style='display:none'>" + data[i].id + "</td>";
                        var ctmp = getDateFromAspString(data[i].date)
                        var createddate = ctmp.getDate() + "/" + (ctmp.getMonth() + 1) + "/" + ctmp.getFullYear() + ' ' + ctmp.getHours() + ":" + ctmp.getMinutes();

                        htmlstr += "<td style='text-align:left;'>" + createddate + "</td>";
                        htmlstr += "<td style='text-align:left;'>" + data[i].starttime + "</td>";
                        htmlstr += "<td style='text-align:left;'>" + data[i].endtime + "</td>";
                        htmlstr += "<td style='text-align:left;'>" + data[i].staffname + "</td>";
                        htmlstr += "<td style='text-align:left;'>" + data[i].type + "</td>";
                        htmlstr += "<td style='text-align:left;display:none;'>" + data[i].description + "</td>";
                        htmlstr += "<td style='text-align:left;display:none;'>" + data[i].remarks2 + "</td>";
                        htmlstr += "<td style='text-align:left;display:none;'>" + data[i].remarks3 + "</td>";
                        htmlstr += "<td style='text-align:left;display:none;'>" + data[i].remarks4 + "</td>";
                        htmlstr += "<td style='text-align:left;'><a class='btn btn-primary' onclick='EditTreatment(this);' style='font-size:11px;'><i class='fa fa-edit' title='edit'></i></a></td>";

                        htmlstr += "</tr>";
                    }

                    $('#txtTreatmentDescription').val("");
                    $('#tbltreatment tbody').html('');
                    $('#tbltreatment tbody').html(htmlstr);
                    $('#mdlRedeemPointsTreatment').modal('show');

                }
                else {
                    $('#tbltreatment tbody').html("");
                    $('#mdlRedeemPointsTreatment').modal('show');
                }

            },
            error: function (ts) { showMessage(ts.responseText, "error") }

        });
    }


    function EditTreatment(paramtr) {

        var tds = $(paramtr).closest('tr').find('td');
        editTreatmentID = tds.eq(0).html();
        $('#optionTreatmentType').val(tds.eq(5).html());
        $('#txtTreatmentDescription').val(tds.eq(6).html());
        $('#txtTreatmentDescription2').val(tds.eq(7).html());
        $('#txtTreatmentDescription3').val(tds.eq(8).html());
        $('#txtTreatmentDescription4').val(tds.eq(9).html());
        $("#btnTreatmentAdd").text("Update");
        $('#optionTreatmentType').trigger('change');
        $('#optionTreatmentType').trigger('change');
        $('#Treatment_dialog-modal').dialog("open");

    }


    function CloseTreatment() {
        $('#mdlRedeemPointsTreatment').modal('hide');
    }

    function updateSOTreatment() {
        var detl = new Object();

        $('#tblItem > tbody > tr').each(function (i, row) {
            var tds = $(row).find('td');

            if (tds.eq(1).html() == trmResouceId) {

                i = i + 1;
                detl.lineno = i;
                detl.id = tds.eq(1).html();
                detl.productid = tds.eq(2).html();
                detl.productcode = tds.eq(3).html();
                detl.productdesc = tds.eq(4).html();
                detl.qty = tds.eq(6).html();
                detl.uom = tds.eq(7).html();
                detl.unitprice = tds.eq(9).html();
                detl.status = (tds.eq(15).html() == "") ? "" : tds.eq(15).html();
                detl.foc = (tds.eq(22).find('.focCheckbox').is(':checked')) ? 1 : 0;
                detl.rdm = (tds.eq(23).find('.rdmCheckbox').is(':checked')) ? 1 : 0;
                detl.pts = (tds.eq(24).find('.ptsCheckbox').is(':checked')) ? 1 : 0;
                detl.pos = (tds.eq(25).find('.posCheckbox').is(':checked')) ? 1 : 0;
                detl.packagecode = tds.eq(30).html() == "" ? "" : tds.eq(25).html();
                detl.resourcecode = $('#socode').val();
                detl.salesorderid = $('#soid').val();
                detl.currency = "SGD";
                detl.exchangerate = 1;


                var treatmentCollection = new Array();
                var keyid = "";

                for (var x = 0 ; x < treatmentList.length; x++) {
                    if (treatmentList[x].resourcedetailid == trmResouceId) {
                        var tobjtmp = new Object();
                        tobjtmp = treatmentList[x];
                        tobjtmp.resourcedetailid = trmResouceId;
                        tobjtmp.staffid = $("#cbobkstaff").val();
                        treatmentCollection.push(tobjtmp);
                    }
                }

                detl.treatment = treatmentCollection;
                detl.staffserviceid = $("#cbobkstaff").val();
                

            }
        });


        $.ajax({
            url: '@Url.Action("UpdateSOTreatment", "POS")',
            data: JSON.stringify({ item: detl, resource: $('#rcode').val(), cussupid: selectedcust.id, cussupname: selectedcust.cussupname }),
            type: 'POST',
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                for (var x = 0 ; x < treatmentList.length; x++) {
                    if (treatmentList[x].resourcedetailid == trmResouceId) {
                        treatmentList[x].statusfield = "E";
                    }
                }

                if (treatmentList.length > 0) {
                    treatmentList[treatmentList.length - 1].id = data;
                    $('#tbltreatment tr:last td').eq(0).html(data);
                }


            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });

    }

    function getSOTreatmentList() {

        var resourcecode = $('#socode').val();

        $.ajax({
            url: '@Url.Action("getSOTreatmentList", "POS")',
            data: { resourcecode: resourcecode },
            type: 'POST',
            success: function (data) {
                treatmentList = data;
            }
        });

    }


    @*function RemoveTreatmentItem(paramtr) {
        var tds = $(paramtr).closest('tr').find('td');
        var treatmentid = tds.eq(0).html();

        if (treatmentid != "0") {

           $.ajax({
                url: '@Url.Action("RemoveTreatmentItem", "POS")',
                data: { treatmentid: treatmentid },
                type: 'POST',
                success: function (data) {

                }
            });
        }

        var tindex = tds.eq(3).html();
        treatmentList.splice(tindex, 1);
        $(paramtr).closest('tr').remove();
    }*@

    function EditItem(paramtr) {
        selectedItemTr = paramtr;
        ItemUpdateFlag = 1;
        
        $('#btnAddItem').text("Update Item");
       
        var tds = $(paramtr).closest('tr').find('td');
        itemid = tds.eq(1).html();

        if (tds.eq(30).html() != "") {
            editPackageItem = true;
            editPackageQty = parseInt(tds.eq(6).html());
        }

        $('#txtProduct').val(tds.eq(4).html());
        $('#txtQty').val(tds.eq(6).html())
        $('#txtProdDescription').val($('#txtProduct').val() + " : " + tds.eq(3).html() + "\n" + tds.eq(26).html() + "," + tds.eq(27).html() + "," + tds.eq(28).html() + "," + tds.eq(29).html() + "\n" + "UOM :" + tds.eq(7).html());
     
        selectedprod = new Object();
        selectedprod.id = tds.eq(2).html();
        selectedprod.productcode = tds.eq(3).html();
        selectedprod.desc = tds.eq(4).html();
        selectedprod.uom = tds.eq(7).html();
        selectedprod.category = tds.eq(26).html();
        selectedprod.categorysub = tds.eq(27).html();
        selectedprod.brand = tds.eq(28).html();
        selectedprod.RangesNSeries = tds.eq(29).html();
        selectedprod.sellprice = tds.eq(9).html();
        selectedprod.serviceallowance = tds.eq(33).html();
        oldpid = tds.eq(0).html();
    }

    function addItemValidation() {
       
            if ($('#txtQty').val().trim() == "") {
                var msg = "Please key in quantity.";
                var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                showMessage(attrvalue);
                $('#txtQty').focus();
                return false;
            }
        
       
        return true;
    }

    function addItem() {

        if (!(selectedcust) || selectedcust == "undefined") {
            var msg = "Please select customer!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }

        var selStaff = $("#cbobkstaff").val();
        if (selStaff == '' || selStaff == 'undefined') {
            var msg = "Please select staff!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }

        var selFacility = $("#cbofacility").val();
        if (selFacility == '' || selFacility == 'undefined') {
            var msg = "Please select facility!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }

        if (!(selectedprod) || selectedprod == "undefined") {
            var msg = "Please select a product!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }

        var trobj;
        var tds;
        var trs = $('#tblItem > tbody').find('tr')

        if (!isCopy)
            if (addItemValidation() == false) return false;

        if (ItemUpdateFlag == 1) {
        
           $('#btnAddItem').text("Add Item");
            
        }
        else
            itemcount++;

        var qty = 0;
        var up = 0;
   
        if ($("#txtQty").val().trim() != "")
            qty = parseInt($("#txtQty").val());
       
        var lno = itemcount;

        if (ItemUpdateFlag == 1)
            lno = oldpid;
        var lineQty = 0;
        lineQty = $('#txtQty').val();
        

        if (isCopy) {
            lineQty = copiedQty;
            qty = copiedQty;
        }

        if (editPackageItem) {
            var tds = $(selectedItemTr).closest('tr').find('td');
            if (lineQty > parseInt(tds.eq(5).html())) {
                var msg = "Insufficient Balance!";
                var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                showMessage(attrvalue);
                $('#btnAddItem').text("Update Item");
                return;
            }
            else {
                tds.eq(6).html(lineQty);
                if (tds.eq(30).html != "") {
                    var classname = "package_main_" + tds.eq(30).html() + "_" + tds.eq(31).html();
                    var mainRow = $("#tblItem tr." + classname).find('td');
                    if (mainRow.eq(32).html() == "0") {
                        if (lineQty != editPackageQty) {
                            mainRow.eq(32).html("1");
                            mainRow.eq(25).html("<input type='checkbox' class='form-control' disabled/>");
                            mainRow.eq(24).html("<input type='checkbox' class='form-control' disabled/>");
                            mainRow.eq(23).html("<input type='checkbox' class='form-control' disabled/>");
                            mainRow.eq(22).html("<input type='checkbox' class='form-control' disabled/>");
                            mainRow.eq(17).html("<a class='btn btn-default'><i class='fa fa-edit' title='Edit Items'></i></a>");
                        }
                    }
                }
                calculateTotal();
                editPackageItem = false;
                editPackageQty = 0;
                clearProductInfo();
                ItemUpdateFlag = 0;
                itemid = 0;
                return;
            }

        }

        var rowhtml = "";

        if (selectedprod.category == 'Package') {

            var packageClass = "package_" + selectedprod.id + "_" + lno;
            var sellprice = selectedprod.sellprice;
            rowhtml = "<td>" + lno + "</td><td style='display:none'>" + itemid + "</td><td style='display:none'>" + selectedprod.id + "</td><td style='display:none'>" + selectedprod.productcode + "</td><td style='text-align:left;'>" + selectedprod.desc + "</td>"
                 + "<td></td><td>" + lineQty + "</td><td style='display:none;'>" + selectedprod.uom + "</td><td style='display:none;'></td><td>" + sellprice + "</td><td>" + (sellprice * lineQty).toFixed(2) + "</td>"
                 + "<td class='text-left'>" + $("#cbofacility option:selected").text() + "</td>"
                 + "<td class='text-left'>" + $("#cbobkstaff option:selected").text().substring(0, 9) + "...</td>"
                 + "<td></td>"
                 + "<td></td>"
                 + "<td></td>"
                 + "<td class='text-center'><a class='btn btn-primary'><i class='fa fa-play'></i></a></td>"
                 + "<td class='text-center'><a class='btn btn-primary' onclick='EditItem(this);'><i class='fa fa-edit' title='Edit Items'></i></a></td>"
                 + "<td class='text-center'><a class='btn btn-danger' onclick='RemoveItem(this,\"" + packageClass + "\")' title='Remove Item'><i class='fa fa-trash-o'></i></a></td>"
                 + "<td class='text-center'><a class='btn btn-default'><i class='fa fa-files-o' title='Copy Item'></i></a></td>"
                 + "<td class='text-center' style='display:none'><a class='btn btn-warning'><i class='fa fa-user'></i></a></td>"
                 + "<td class='text-center'><a class='btn btn-primary' onclick='ViewTreatmentItem(this)' title='Treatment'><i class='fa fa-medkit'></i></a></td>"
                 + "<td><input type='checkbox' class='form-control' disabled/></td>"
                 + "<td><input type='checkbox' class='form-control' disabled/></td>"
                 + "<td><input type='checkbox' class='ptsCheckbox form-control'  /></td>"
                 + "<td><input type='checkbox' class='posCheckbox form-control'  /></td>"
                 + "<td style='display:none'>" + selectedprod.category + "</td><td style='display:none'>" + selectedprod.categorysub + "</td><td style='display:none'>" + selectedprod.brand + "</td><td style='display:none'>" + selectedprod.RangesNSeries + "</td><td style='display:none'></td>"
                 + "<td style='display:none'></td><td style='display:none'>0</td>"
                 + "<td style='display:none'>" + selectedprod.serviceallowance + "</td>"
                 + "<td style='display:none'>" + $("#cbobkstaff").val() + "</td>"
                 + "<td style='display:none'>" + $("#cbofacility").val() + "</td>";
        }
        else {
            var sellprice = selectedprod.sellprice;
            var prodBalance = getBalanceinPackage(selectedprod.id);
            var redeemedqty = 0;


            rowhtml = "<td>" + lno + "</td><td style='display:none'>" + itemid + "</td><td style='display:none'>" + selectedprod.id + "</td><td style='display:none'>" + selectedprod.productcode + "</td><td style='text-align:left;'>" + selectedprod.desc + "</td>"
                + "<td>" + prodBalance + "</td><td>" + lineQty + "</td><td style='display:none;'>" + selectedprod.uom + "</td><td style='display:none;'>" + redeemedqty + "</td><td>" + sellprice + "</td><td>" + (lineQty * sellprice).toFixed(2) + "</td>"
                + "<td class='text-left'>" + $("#cbofacility option:selected").text() + "</td>"
                + "<td class='text-left'>" + $("#cbobkstaff option:selected").text().substring(0, 9) + "...</td>"
                + "<td></td>"
                + "<td></td>"
                + "<td></td>"
                + "<td class='text-center'><a class='btn btn-primary'><i class='fa fa-play'></i></a></td>"
                + "<td class='text-center'><a class='btn btn-primary' onclick='EditItem(this);'><i class='fa fa-edit' title='Edit Items'></i></a></td>"
                + "<td class='text-center'><a class='btn btn-danger' onclick='RemoveItem(this,\"\")' title='Remove Item'><i class='fa fa-trash-o'></i></a></td>"
                + "<td class='text-center'><a class='btn btn-primary' onclick='CopyItem(this);'><i class='fa fa-files-o' title='Copy Item'></i></a></td>"
                + "<td class='text-center' style='display:none'><a class='btn btn-warning' onclick='StaffItem(this);'><i class='fa fa-user'></i></a></td>"
                + "<td class='text-center'><a class='btn btn-primary' onclick='ViewTreatmentItem(this)' title='Treatment'><i class='fa fa-medkit'></i></a></td>";


            if (selectedprod.category == "Free Services") {
                rowhtml += "<td><input type='checkbox' class='focCheckbox form-control' /></td>";
                rowhtml += "<td><input type='checkbox' class='form-control' disabled/></td>";
                rowhtml += "<td><input type='checkbox' class='form-control' disabled/></td>";
                rowhtml += "<td><input type='checkbox' class='form-control' disabled /></td>";
            }
            else {
                rowhtml += "<td><input type='checkbox' class='form-control' disabled/></td>";
                if (prodBalance > 0)
                    rowhtml += "<td><input type='checkbox'  class='rdmCheckbox form-control' /></td>";
                else
                    rowhtml += "<td><input type='checkbox'  class='form-control' disabled/></td>";

                rowhtml += "<td><input type='checkbox' class='ptsCheckbox form-control' /></td>";
                rowhtml += "<td><input type='checkbox' class='posCheckbox form-control' /></td>";
            }

            rowhtml += "<td style='display:none'>" + selectedprod.category + "</td><td style='display:none'>" + selectedprod.categorysub + "</td><td style='display:none'>" + selectedprod.brand + "</td><td style='display:none'>" + selectedprod.RangesNSeries + "</td><td style='display:none'></td>"
            + "<td style='display:none'></td><td style='display:none'>0</td><td style='display:none'>" + selectedprod.serviceallowance + "</td>";
            rowhtml += "<td style='display:none'>" + $("#cbobkstaff").val() + "</td>"
            rowhtml += "<td style='display:none'>" + $("#cbofacility").val() + "</td>";

        }


        if (itemcount <= 5) {

            if (ItemUpdateFlag == 1) {
                trobj = trs[oldpid - 1];

                var lineNumber = itemcount;

                if (selectedprod.category == 'Package') {
                    $(trobj).removeClass();
                    $(trobj).addClass("package_main_" + selectedprod.id + "_" + lineNumber);
                }
                $(trobj).html(rowhtml);

                if (selectedprod.category == 'Package') {

                    $.ajax({
                        url: '@Url.Action("getProductBundleDetailsWithBalance", "Product")',
                        data: { pid: selectedprod.id, mid: selectedcust.id },
                        type: 'POST',
                        success: function (data) {

                            for (x = 0; x < data.length; x++) {
                                oldpid++

                                var packageQty = (lineQty * data[x].qty);
                                var redeemedqty = 0;

                                var rowhtml = "<td>" + oldpid + "</td><td style='display:none'>" + itemid + "</td><td style='display:none'>" + data[x].productid + "</td><td style='display:none'>" + data[x].productcode + "</td><td style='text-align:left;padding-left:20px;'>" + data[x].description + "</td>"
                                    + "<td>" + data[x].balance + "</td><td>" + packageQty + "</td><td style='display:none;'>" + data[x].uom + "</td><td style='display:none;'>" + redeemedqty + "</td><td></td>"
                                    + "<td></td>"
                                    + "<td class='text-left'>" + $("#cbofacility option:selected").text() + "</td>"
                                    + "<td class='text-left'>" + $("#cbobkstaff option:selected").text().substring(0, 9) + "...</td>"
                                    + "<td></td>"
                                    + "<td></td>"
                                    + "<td></td>"
                                    + "<td class='text-center'><a class='btn btn-primary'><i class='fa fa-play'></i></a></td>"
                                    + "<td class='text-center'><a class='btn btn-primary' onclick='EditItem(this);'><i class='fa fa-edit' title='Edit Items'></i></a></td>"
                                    + "<td class='text-center'><a class='btn btn-danger' onclick='RemoveItem(this,\"\")' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>"
                                    + "<td class='text-center'><a class='btn btn-primary' onclick='CopyItem(this);'><i class='fa fa-files-o' title='Copy Item'></i></a></td>"
                                    + "<td class='text-center' style='display:none'><a class='btn btn-warning' onclick='StaffItem(this);'><i class='fa fa-user'></i></a></td>"
                                    + "<td class='text-center'><a class='btn btn-primary' onclick='ViewTreatmentItem(this)' title='Treatment'><i class='fa fa-medkit'></i></a></td>"
                                    + "<td><input type='checkbox' class='form-control' disabled /></td>"
                                    + "<td><input type='checkbox' class='rdmCheckbox form-control' disabled /></td>"
                                    + "<td><input type='checkbox' class=' form-control' disabled /></td>"
                                    + "<td><input type='checkbox' class='form-control' disabled /></td>"
                                    + "<td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'>" + selectedprod.id + "</td>"
                                    + "<td style='display:none'>" + lineNumber + "</td><td style='display:none'>0</td><td style='display:none'>" + data[x].serviceallowance + "</td>"
                                    + "<td style='display:none'>" + $("#cbobkstaff").val() + "</td>"
                                    + "<td style='display:none'>" + $("#cbofacility").val() + "</td>";

                                trobj = trs[oldpid - 1];

                                $(trobj).addClass("package_" + selectedprod.id + "_" + lineNumber);
                                $(trobj).html(rowhtml);

                            }

                        }
                    });

                }

                $("#btnSOClose").attr("disabled", true);
            }
            else {

                trobj = trs[itemcount - 1];
                var lineNumber = itemcount;
                if (selectedprod.category == 'Package') {
                    $(trobj).removeClass();
                    $(trobj).addClass("package_main_" + selectedprod.id + "_" + lineNumber);
                }
                $(trobj).html(rowhtml);

                if (selectedprod.category == 'Package') {
                    $.ajax({
                        url: '@Url.Action("getProductBundleDetailsWithBalance", "Product")',
                        data: { pid: selectedprod.id, mid: selectedcust.id },
                        type: 'POST',
                        success: function (data) {

                            for (x = 0; x < data.length; x++) {
                                itemcount++
                                var packageQty = (lineQty * data[x].qty);
                                var redeemedqty = 0;

                                var rowhtml = "<td>" + itemcount + "</td><td style='display:none'>" + itemid + "</td><td style='display:none'>" + data[x].productid + "</td><td style='display:none'>" + data[x].productcode + "</td><td style='text-align:left;padding-left:20px;'>" + data[x].description + "</td>"
                                    + "<td>" + data[x].balance + "</td><td>" + packageQty + "</td><td style='display:none;'>" + data[x].uom + "</td><td style='display:none;'>" + redeemedqty + "</td><td></td><td></td>"
                                    + "<td class='text-left'>" + $("#cbofacility option:selected").text() + "</td>"
                                    + "<td class='text-left'>" + $("#cbobkstaff option:selected").text().substring(0, 9) + "...</td>"
                                    + "<td></td>"
                                    + "<td></td>"
                                    + "<td></td>"
                                    + "<td class='text-center'><a class='btn btn-primary'><i class='fa fa-play'></i></a></td>"
                                    + "<td class='text-center'><a class='btn btn-primary'onclick='EditItem(this);' title='Edit Item'><i class='fa fa-edit' title='Edit Items'></i></a></td>"
                                    + "<td class='text-center'><a class='btn btn-danger' onclick='RemoveItem(this,\"\")' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>"
                                    + "<td class='text-center'><a class='btn btn-primary' onclick='CopyItem(this);'><i class='fa fa-files-o' title='Copy Item'></i></a></td>"
                                    + "<td class='text-center' style='display:none'><a class='btn btn-warning' onclick='StaffItem(this);'><i class='fa fa-user'></i></a></td>"
                                    + "<td class='text-center'><a class='btn btn-primary' onclick='ViewTreatmentItem(this)' title='Treatment'><i class='fa fa-medkit'></i></a></td>"
                                    + "<td><input type='checkbox' class='form-control' disabled/></td>"
                                    + "<td><input type='checkbox' class='rdmCheckbox form-control' disabled/></td>"
                                    + "<td><input type='checkbox' class='form-control' disabled/></td>"
                                    + "<td><input type='checkbox' class='form-control' disabled/></td>"
                                    + "<td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'>" + selectedprod.id + "</td>"
                                    + "<td style='display:none'>" + lineNumber + "</td><td style='display:none'>0</td><td style='display:none'>" + data[x].serviceallowance + "</td>"
                                    + "<td style='display:none'>" + $("#cbobkstaff").val() + "</td>"
                                    + "<td style='display:none'>" + $("#cbofacility").val() + "</td>";

                                trobj = trs[itemcount - 1];
                                var trClass = "package_" + selectedprod.id + "_" + lineNumber
                                $(trobj).addClass(trClass);
                                $(trobj).html(rowhtml);

                                if (itemcount > 5) {
                                    $("#tblItem > tbody").append("<tr class='" + trClass + "'>" + rowhtml + "</tr>");
                                }

                            }

                        }
                    });

                }

                $("#btnSOClose").attr("disabled", true);

            }

        }
        else {

            if (ItemUpdateFlag == 1) {
                trobj = trs[oldpid - 1];

                var lineNumber = oldpid;

                if (selectedprod.category == 'Package') {
                    $(trobj).removeClass();
                    $(trobj).addClass("package_main_" + selectedprod.id + "_" + lineNumber);
                }
                $(trobj).html(rowhtml);

                if (selectedprod.category == 'Package') {

                    $.ajax({
                        url: '@Url.Action("getProductBundleDetailsWithBalance", "Product")',
                        data: { pid: selectedprod.id, mid: selectedcust.id },
                        type: 'POST',
                        success: function (data) {

                            for (x = 0; x < data.length; x++) {
                                oldpid++

                                var packageQty = (lineQty * data[x].qty);
                                var redeemedqty = 0;

                                var rowhtml = "<td>" + oldpid + "</td><td style='display:none'>" + itemid + "</td><td style='display:none'>" + data[x].productid + "</td><td style='display:none'>" + data[x].productcode + "</td><td style='text-align:left;padding-left:20px;'>" + data[x].description + "</td>"
                                    + "<td>" + data[x].balance + "</td><td>" + packageQty + "</td><td style='display:none;'>" + data[x].uom + "</td><td style='display:none;'>" + redeemedqty + "</td><td></td>"
                                    + "<td></td>"
                                    + "<td class='text-left'>" + $("#cbofacility option:selected").text() + "</td>"
                                    + "<td class='text-left'>" + $("#cbobkstaff option:selected").text().substring(0, 9) + "...</td>"
                                    + "<td></td>"
                                    + "<td></td>"
                                    + "<td></td>"
                                    + "<td class='text-center'><a class='btn btn-primary'><i class='fa fa-play'></i></a></td>"
                                    + "<td class='text-center'><a class='btn btn-primary' onclick='EditItem(this);'><i class='fa fa-edit'  title='Edit Items'></i></a></td>"
                                    + "<td class='text-center'><a class='btn btn-danger' onclick='RemoveItem(this,\"\")' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>"
                                    + "<td class='text-center'><a class='btn btn-primary' onclick='CopyItem(this);'><i class='fa fa-files-o' title='Copy Item'></i></a></td>"
                                    + "<td class='text-center' style='display:none'><a class='btn btn-warning' onclick='StaffItem(this);'><i class='fa fa-user'></i></a></td>"
                                    + "<td class='text-center'><a class='btn btn-primary' onclick='ViewTreatmentItem(this)' title='Treatment'><i class='fa fa-medkit'></i></a></td>"
                                    + "<td><input type='checkbox' class='form-control' disabled/></td>"
                                    + "<td><input type='checkbox' class='rdmCheckbox form-control' disabled /></td>"
                                    + "<td><input type='checkbox' class='form-control' disabled/></td>"
                                    + "<td><input type='checkbox' class='form-control' disabled/></td>"
                                    + "<td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'>" + selectedprod.id + "</td>"
                                    + "<td style='display:none'>" + lineNumber + "</td><td style='display:none'>0</td><td style='display:none'>" + data[x].serviceallowance + "</td>"
                                    + "<td style='display:none'>" + $("#cbobkstaff").val() + "</td>"
                                    + "<td style='display:none'>" + $("#cbofacility").val() + "</td>";

                                trobj = trs[oldpid - 1];
                                $(trobj).removeClass();
                                $(trobj).addClass("package_" + selectedprod.id + "_" + lineNumber);
                                $(trobj).html(rowhtml);

                            }

                        }
                    });

                }
            }
            else {
                var lineNumber = itemcount;
                if (selectedprod.category == 'Package') {
                    var trClass = "package_main_" + selectedprod.id + "_" + lineNumber;
                    $("#tblItem > tbody").append("<tr class=" + trClass + ">" + rowhtml + "</tr>");
                }
                else {
                    $("#tblItem > tbody").append("<tr>" + rowhtml + "</tr>");
                }

                if (selectedprod.category == 'Package') {
                    $.ajax({
                        url: '@Url.Action("getProductBundleDetailsWithBalance", "Product")',
                        data: { pid: selectedprod.id, mid: selectedcust.id },
                        type: 'POST',
                        success: function (data) {

                            for (x = 0; x < data.length; x++) {
                                itemcount++
                                var packageQty = (lineQty * data[x].qty);
                                var redeemedqty = 0;

                                var rowhtml = "<td>" + itemcount + "</td><td style='display:none'>" + itemid + "</td><td style='display:none'>" + data[x].productid + "</td><td style='display:none'>" + data[x].productcode + "</td><td style='text-align:left;padding-left:20px;'>" + data[x].description + "</td>"
                                    + "<td>" + data[x].balance + "</td><td>" + packageQty + "</td><td style='display:none;'>" + data[x].uom + "</td><td style='display:none;'>" + redeemedqty + "</td><td></td><td></td>"
                                    + "<td class='text-left'>" + $("#cbofacility option:selected").text() + "</td>"
                                    + "<td class='text-left'>" + $("#cbobkstaff option:selected").text().substring(0, 9) + "...</td>"
                                    + "<td></td>"
                                    + "<td></td>"
                                    + "<td></td>"
                                    + "<td class='text-center'><a class='btn btn-primary'><i class='fa fa-play'></i></a></td>"
                                    + "<td class='text-center'><a class='btn btn-default' onclick='EditItem(this);' title='Edit Item'><i class='fa fa-edit' title='Edit Items'></i></a></td>"
                                    + "<td class='text-center'><a class='btn btn-danger' onclick='RemoveItem(this,\"\")' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>"
                                    + "<td class='text-center'><a class='btn btn-primary' onclick='CopyItem(this);'><i class='fa fa-files-o' title='Copy Item'></i></a></td>"
                                    + "<td class='text-center' style='display:none'><a class='btn btn-warning' onclick='StaffItem(this);'><i class='fa fa-user'></i></a></td>"
                                    + "<td class='text-center'><a class='btn btn-primary' onclick='ViewTreatmentItem(this)' title='Treatment'><i class='fa fa-medkit'></i></a></td>"
                                    + "<td><input type='checkbox' class='form-control' disabled/></td>"
                                    + "<td><input type='checkbox' class='rdmCheckbox form-control' disabled/></td>"
                                    + "<td><input type='checkbox' class='form-control' disabled/></td>"
                                    + "<td><input type='checkbox' class='form-control' disabled/></td>"
                                    + "<td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'>" + selectedprod.id + "</td>"
                                    + "<td style='display:none'>" + lineNumber + "</td><td style='display:none'>0</td><td style='display:none'>" + data[x].serviceallowance + "</td>"
                                    + "<td style='display:none'>" + $("#cbobkstaff").val() + "</td>"
                                    + "<td style='display:none'>" + $("#cbofacility").val() + "</td>";


                                var trClass = "package_" + selectedprod.id + "_" + lineNumber
                                $("#tblItem > tbody").append("<tr class='" + trClass + "'>" + rowhtml + "</tr>");

                            }

                        }
                    });

                }




            }
            $("#btnSOClose").attr("disabled", true);
            //undone
        }
        clearProductInfo();
        ItemUpdateFlag = 0;
        itemid = 0;
        calculateTotal();
    }

    function clearProductInfo() {
            $('#txtProduct').val("");
            $('#txtQty').val("");
            $('#txtProdDescription').val("");
            $('#txtRemark').val("");
    }
    function goToListing() {
        var url = "FacilityOrderListing";
        var rcode = $('#rcode').val();
        var form = $('<form action="' + url + '" method="post">' +
          '<input type="hidden" name="rcode"  id="rcode" value="' + rcode + '" />' +
          '</form>');
        $('body').append(form);
        $(form).submit();
    }
    function SaveValidation() {
        var sTime = ""; var eTime = "";
        

        if ($('#status').val().toUpperCase() == "CLOSE") {
            var msg = "System will not allow to edit for closed transaction!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);

            return false;
        };
        if (!(selectedcust) || selectedcust == "undefined") {
            var msg = "Please select customer!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }
        var selStaff = "";
        selStaff = $("#cbobkstaff").val();
        
        if (selStaff == '' || selStaff == 'undefined') {
            var msg = "Please select sale staff!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }
     
        sTime = $("#cboStartTimeHR option:selected").text() + ":" + $("#cboStartTimeMin option:selected").text() + " " + $("#cboStartTimeAMPM option:selected").text();//$('#txtStartTime').val();
        eTime = $("#cboEndTimeHR option:selected").text() + ":" + $("#cboEndTimeMin option:selected").text() + " " + $("#cboEndTimeAMPM option:selected").text();//$('#txtEndTime').val();
   

        if (sTime == "") {
            var msg = "Please enter start time.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }
        else {
            if (isValidTimeFormat(sTime) == false) {
                var msg = "Invalid start time format.";
                var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                showMessage(attrvalue);
                return false;
            }
        }
        if (eTime == "") {
            var msg = "Please enter end time.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }
        else {
            if (isValidTimeFormat(eTime) == false) {
                var msg = "Invalid end time format.";
                var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                showMessage(attrvalue);
                return false;
            }
        }
        var isValidTime = isValidPeriod();






        if (isValidTime == false) {
            var msg = "Start Time should be less than end time!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }
       
    }
    function isValidTimeFormat(strTime) {
        var isValid = true;
        if (strTime.length != 8)
            isValid = false;
        else {
            var intHr = parseInt(strTime.substring(0, 2));
            var intMin = parseInt(strTime.substring(3, 5));
            var strsep = strTime.substring(2, 3);
            var strAMPM = strTime.substring(6, 8).toUpperCase();
            if ((intHr <= 0) || (intHr > 12)) {
                isValid = false;
            }
            if (strsep != ':') {
                isValid = false;
            }
            if ((intMin < 0) || (intMin > 59)) {
                isValid = false;
            }
            if ((strAMPM == "AM") || (strAMPM == "PM")) {
                isValid = true;
            }
            else {
                isValid = false;
            }
        }
        return isValid;
    }
    function SaveSO() {

        if ($("#socode").val() != "") {
            //if (updateSalesOrderStaffAndAsset() == false) {
            //    var msg = "This time slot is unavailable for " + $("#cbofacility :selected").text() + "!";
            //    var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            //    showMessage(attrvalue);
            //    return false;
            //}

            if (SaveValidation() == false) {
                $("#btnConfirm").removeAttr("disabled");
                return false;
            }

            updateSalesOrderDetails();
            updateSelectedOptions();
            updateSalesOrderTime();


            reloadTableItem("Successfully Updated.");
        }
        else {

            var discnt = 0;
            $("#btnConfirm").attr("disabled", true);
            $("#btnSOClose").attr("disabled", true);

            if (SaveValidation() == false) {
                $("#btnConfirm").removeAttr("disabled");
                return false;
            }
            var soid = $('#soid').val();
            var obj = new Object();
            obj.post = 0;
            var detlidArray = "";
            obj.id = soid;
            obj.cussupid = selectedcust.id;
            //obj.type = $('#rcode').val();
            obj.type = "ORDER TAKING";
            obj.cussupname = selectedcust.cussupname;
            obj.staffid = $("#cbobkstaff").val();
            obj.branchassetid = $("#cbofacility").val();
            
            //Commented by ZawZO on 18 Dec 2015, to disable signature pad temponary
            var imgfile = "";

            obj.signaturefile = imgfile;
            obj.status = 'QUEUE';
            $('#status').val('QUEUE');
       
            obj.remark = $('#txtRemark').val();
            obj.starttime = $("#cboStartTimeHR option:selected").text() + ":" + $("#cboStartTimeMin option:selected").text() + " " + $("#cboStartTimeAMPM option:selected").text();//$('#txtStartTime').val();
            obj.endtime = $("#cboEndTimeHR option:selected").text() + ":" + $("#cboEndTimeMin option:selected").text() + " " + $("#cboEndTimeAMPM option:selected").text();//$('#txtEndTime').val();
           
            var tac = 0;
            var tab = 0;
            var tsc = 0;
            var i = 0;
            var detlcount = 0;
            var detlCollection = new Array();

            $('#tblItem > tbody > tr').each(function (i, row) {
                i = i + 1;
                var tds = $(row).find('td');
                if (tds.eq(4).html().trim() != "") {
                    detlcount++;
                    var detl = new Object();
                    detl.lineno = i;
                    detl.id = tds.eq(1).html();
                    if (detl.id != "" || detl.id != 0) detlidArray += detl.id + ",";
                    detl.productid = tds.eq(2).html();
                    detl.productcode = tds.eq(3).html();
                    detl.productdesc = tds.eq(4).html();
                    detl.qty = tds.eq(6).html();
                    detl.uom = tds.eq(7).html();
                    detl.unitprice = tds.eq(9).html();
                    detl.starttime = tds.eq(13).html() == "" ? "" : tds.eq(13).html();
                    detl.endtime = tds.eq(14).html() == "" ? "" : tds.eq(14).html();
                    detl.status = (tds.eq(15).html() == "") ? "QUEUE" : tds.eq(15).html();
                    detl.foc = (tds.eq(22).find('.focCheckbox').is(':checked')) ? 1 : 0;
                    detl.rdm = (tds.eq(23).find('.rdmCheckbox').is(':checked')) ? 1 : 0;
                    detl.pts = (tds.eq(24).find('.ptsCheckbox').is(':checked')) ? 1 : 0;
                    detl.pos = (tds.eq(25).find('.posCheckbox').is(':checked')) ? 1 : 0;
                    detl.packagecode = tds.eq(30).html() == "" ? "" : tds.eq(30).html();
                    detl.packagelineno = tds.eq(31).html() == "" ? 0 : tds.eq(31).html();
                    detl.ispackageselected = tds.eq(32).html() == "" ? 0 : tds.eq(32).html();
                    detl.serviceallowance = tds.eq(33).html() == "" ? 0 : tds.eq(33).html();
                    detl.staffid = tds.eq(34).html() == "" ? 0 : tds.eq(34).html();
                    detl.branchassetid = tds.eq(35).html() == "" ? 0 : tds.eq(35).html();
                    detl.currency = "SGD";
                    detl.exchangerate = 1;

                    var treatmentCollection = new Array();
                    var keyid = "";

                    if (detl.id == "0") {
                        keyid = tds.eq(0).html();
                    }

                    for (var x = 0 ; x < treatmentList.length; x++) {
                        if (treatmentList[x].keyid == keyid) {
                            var tobjtmp = new Object();
                            tobjtmp = treatmentList[x];
                            tobjtmp.resourcedetailid = keyid;
                            tobjtmp.staffid = $("#cbobkstaff").val();
                            treatmentCollection.push(tobjtmp);
                        }
                    }

                    detl.treatment = treatmentCollection;
                    detl.staffserviceid = $("#cbobkstaff").val();
                    detlCollection.push(detl);
                }
            });

            if (detlcount <= 0) {
                $("#btnConfirm").removeAttr("disabled");
                var msg = "Please key in the item.";
                var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                showMessage(attrvalue);
                return false;
            }
            obj.details = detlCollection;
            obj.total_total = $("#txtGrandTotal").val();

            var appid = $("#appid").val();

            $.ajax({
                url: '@Url.Action("SalesOrderSave", "POS")',
                data: JSON.stringify({ objso: obj, resource: $('#rcode').val(), soid: CurSOID, detlids: detlidArray, appid: appid }),
                type: 'POST',
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                async: false,
                success: function (data) {
                    if (data) {
                        CurSOID = 0;
                        var result = data.split(",");
                        if (result.length == 5) {
                            if (result[0] == "SUCCESS" || result[0] == "POSTFAIL") {
                                $("#divAppointment").hide();
                                $('#soid').val(result[1]);
                                var msg = "Successfully Save #" + result[2];
                                var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"success"}';
                                msg = "Successfully saved #" + result[2];

                                $('#txtsono').html("Order# : " + result[2]);
                                $("#socode").val(result[2]);
                                $('#txtQueueNo').html("Queue# : " + result[4]);
                                $("#dateHigher").hide();
                                $("#dateLower").show();

                                showMessage(attrvalue);
                                $("#btnConfirm").removeAttr("disabled");
                                $('#status').val(result[3]);
                                $("#tblItem > tbody").html("");
                                $('#txtcustid').val(selectedcust.id);
                                getItemDetail();
                                $("#queuedOrder").hide();


                            }
                        }
                    }
                },
                error: function (req, status, err) {
                    showMessage(err, "error");
                    $("#btnConfirm").removeAttr("disabled");
                    if ($('#status').val().toUpperCase() == "QUEUE")
                        $("#btnSOClose").removeAttr("disabled");
                }
            });
        }
    }


    function showMessage(attrvalue) {
        $('#btnMessage').attr('data-noty-options', attrvalue);
        $('#btnMessage').trigger("click");
    }
    function newOrder() {
        var url = "SalesOrder";
        var rcode = $('#rcode').val();
        var form = $('<form action="' + url + '" method="post">' +
          '<input type="hidden" name="id"  id="id" value="' + 0 + '" />' +
          '<input type="hidden" name="rcode"  id="rcode" value="' + rcode + '" />' +
          '</form>');
        $('body').append(form);
        $(form).submit();
    }
    function OpenMemberDialog() {
        $('#txtnewname').val("");
        $('#txtnric').val("");
        $('#btnCustomerSave').removeAttr("disabled");
        $('#Customer_dialog-modal').dialog('open');
    }
    function closeCustomerDialog() {
        $('#Customer_dialog-modal').dialog("close");
    }
    function MemberValidation() {
        if ($('#txtnewname').val().trim() == "") {
            alert("Please key in Member Name.");
            $('#txtnewname').focus();
            return false;
        }
        if ($('#txtnric').val().trim() == "") {
            alert("Please key in NRIC.");
            $('#txtnric').focus();
            return false;
        }
        if ($('#txtmobile').val().trim() == "") {
            alert("Please key in Mobile No.");
            $('#txtmobile').focus();
            return false;
        }
        return true;
    }
    function isAvailableTimeSlot() {
        var retval = false;
        var aID = 0; var stime = ""; var etime = "";

        aID = $("#cbofacility").val();
        stime = $("#cboStartTimeHR option:selected").text() + ":" + $("#cboStartTimeMin option:selected").text() + " " + $("#cboStartTimeAMPM option:selected").text();//$('#txtStartTime').val();
        etime = $("#cboEndTimeHR option:selected").text() + ":" + $("#cboEndTimeMin option:selected").text() + " " + $("#cboEndTimeAMPM option:selected").text();//$('#txtEndTime').val();

        $.ajax({
            url: '@Url.Action("isValidFacilityOrder", "POS")',
            data: JSON.stringify({ assetid: aID, starttime: stime, endtime: etime }),
            type: 'POST',
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            async: false,
            success: function (data) {
                if (data == "FALSE") {
                    retval = false;
                }
                else {
                    retval = true;
                }
            },
            error: function (req, status, err) {
                retval = false;
            }
        });
        return retval;
    }


    function getHour24(timeString) {
        time = 0;

        var timeStr = timeString.split(":");
        var minday = timeStr[1].split(" ");

        var hr = timeStr[0].replace(/^0+/, '');
        var min = minday[0];
        var day = minday[1];

        var mins = min / 60;

        if (day == "PM") {
            if (parseInt(hr) == 12)
                time = parseInt(hr) + mins;
            else
                time = parseInt(hr) + 12 + mins;
        }
        else
            time = parseInt(hr) + mins;

        return time;
    }


    function isValidPeriod() {
        var retval = false;
        var stime = ""; var etime = "";

        stime = $("#cboStartTimeHR option:selected").text() + ":" + $("#cboStartTimeMin option:selected").text() + " " + $("#cboStartTimeAMPM option:selected").text();//$('#txtStartTime').val();
        etime = $("#cboEndTimeHR option:selected").text() + ":" + $("#cboEndTimeMin option:selected").text() + " " + $("#cboEndTimeAMPM option:selected").text();//$('#txtEndTime').val();

        var starttime = getHour24(stime);
        var endtime = getHour24(etime);

        var timeDifference = endtime - starttime;

        if (timeDifference > 0) {
            retval = true;
        }
        else {
            retval = false;
        }

        return retval;
    }

    function isServiceValidPeriod() {
        var retval = false;
        var stime = ""; var etime = "";

        stime = $("#txtServiceStartTime").val();
        etime = $("#txtServiceEndTime").val();

        if (stime <= etime) {
            retval = true;
        }
        else {
            retval = false;
        }

        return retval;
    }

    function CHKDuplicateNRICSaveCustomer() {
        var mid = 0;
        var nric = $('#txtnric').val();

        $.ajax({
            url: '@Url.Action("isDuplicateNRIC", "CusSup")',
            data: JSON.stringify({ nric: nric, mid: mid }),
            type: 'POST',
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            async: false,
            success: function (data) {
                if (data == "1") {
                    alert("NRIC already exist.Please Key  in again.");
                    $('#txtnric').focus();
                    return false;
                }
                else {
                    SaveCustomer();
                }
            },
            error: function (req, status, err) {
                return false;
            }
        });
    }

    function OpenBalanceDialog() {

        if (!(selectedcust) || selectedcust == "undefined") {
            var msg = "Please select customer!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }

        $('#txtCBalance').val('');
        $('#txtBBalance').val('');
        $('#txtCReserved').val('');
        $('#txtBReserved').val('');
        $('#txtCAvailable').val('');
        $('#txtBAvailable').val('');
        getMemberCompletebalance(selectedcust.id);
        $('#Balance_dialog-modal').dialog('open');
    }

    function OpenPOS() {
        window.open("../POS/POS");
    }

    function closeBalanceDialog() {
        $('#Balance_dialog-modal').dialog("close");
    }

    function getMemberCompletebalance(mid) {

        $.ajax({
            url: '@Url.Action("getMemberList", "CusSup")',
            data: { mid: mid },
            type: 'POST',
            success: function (data) {
                if (data.length > 0) {
                    $('#txtCBalance').val(data[0].CBalance);
                    $('#txtBBalance').val(data[0].BBalance);
                    $('#txtCReserved').val(data[0].CReserved);
                    $('#txtBReserved').val(data[0].BReserved);
                    $('#txtCAvailable').val(data[0].CAvailable);
                    $('#txtBAvailable').val(data[0].BAvailable);
                }
                else {
                    $('#txtCBalance').val('');
                    $('#txtBBalance').val('');
                    $('#txtCReserved').val('');
                    $('#txtBReserved').val('');
                    $('#txtCAvailable').val('');
                    $('#txtBAvailable').val('');
                }
            },
            error: function (ts) { alert(ts.responseText) }
        });
    }

    function SaveCustomer() {
        var rcode = $('#resource').val();
        if (MemberValidation() == false) return false;
        $('#btnCustomerSave').attr("disabled", "");
        var name = $('#txtnewname').val();
        var nric = $('#txtnric').val();
        var mid = 0;
        var rcode = $('#rcode').val();
        var obj = new Object();
        obj.id = mid;
        obj.cussupname = $('#txtnewname').val();
        obj.nric = $('#txtnric').val();
        obj.mobile = $('#txtmobile').val();
        obj.gender = $('#cbogender').val();
        obj.cussuptype = 'Ordinary';
        obj.status = 'Active';
        obj.photo = "";
        obj.canemail = 0;
        obj.cansms = 0;
        obj.cancall = 0;

        $.ajax({
            url: '@Url.Action("CustomerSave", "CusSup")',
            data: JSON.stringify({ m: obj, rcode: rcode }),
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            type: 'POST',
            async: false,
            success: function (data) {
                if (data) {
                    var result = data.split(",");
                    if (result.length == 5) {
                        if (result[0] == "SUCCESS") {
                            selectedcust = new Object();
                            selectedcust.id = result[1];
                            selectedcust.inhousecode = result[2];
                            selectedcust.cussupname = result[3];
                            selectedcust.mobile = result[4];
                            $('#txtCustomer').val(selectedcust.cussupname + "(" + selectedcust.inhousecode + ")");
                            closeCustomerDialog();
                        }
                    }
                }
            },
            error: function (ts) { alert(ts.responseText); alert("Fail to update cardno."); $('#dialog-modal').dialog("close"); }
        });
    }

    function voidPOS() {

        var soid = $('#soid').val();
        var url = "SOPOS";
        var rcode = "SOPOS";

        var form = $('<form action="' + url + '" method="post">' +
            '<input type="hidden" name="id"  id="id" value="0" />' +
            '<input type="hidden" name="soid"  id="soid" value="' + soid + '" />' +
            '<input type="hidden" name="rcode"  id="rcode" value="' + rcode + '" />' +
            '</form>');

        $('body').append(form);
        $(form).submit();
    }

    function goToPOS() {
        $("#reminderPayment").hide();
        //var noItemsToPay = false;

        //$('#tblItem > tbody > tr').each(function (i, row) {

        //    var tds = $(row).find('td');
        //    if (tds.eq(15).html().trim() == "PARTIAL") {
        //        noItemsToPay = true;
        //    }
        //});

        //if (!noItemsToPay) {
        //    if ($('input.posCheckbox:enabled').length <= 0) {
        //        var msg = "There are no items to pay.";
        //        var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
        //        showMessage(attrvalue);
        //        return;

        //    }


        if ($('input.posCheckbox:checked').length <= 0) {
            var msg = "Please select items to pay.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return;
        }
        //   }

        //if ($('input.posCheckbox:checked:enabled').length <= 0) {
        //    var msg = "Please select items to pay.";
        //    var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
        //    showMessage(attrvalue);
        //    return;
        //}

        updateSelectedOptions();

        updateSalesOrderDetails();

        var soid = $('#soid').val();
        var url = "SOPOS";
        var rcode = "SOPOS";

        var form = $('<form action="' + url + '" method="post">' +
            '<input type="hidden" name="id"  id="id" value="0" />' +
            '<input type="hidden" name="soid"  id="soid" value="' + soid + '" />' +
            '<input type="hidden" name="rcode"  id="rcode" value="' + rcode + '" />' +
            '</form>');

        $('body').append(form);
        $(form).submit();
    }

    function showPaymentList() {

        $('#divPaymentList').empty();

        $.ajax({
            url: '@Url.Action("getSOPOS", "POS")',
            data: { soid: $('#soid').val() },
            type: 'POST',
            success: function (data) {
                populatePaymentList(data);
                $('#mdlPaymentList').modal('show');

            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });
    }

    function getAppointmentDetails() {
        $('#tblAppointment tbody').empty();
        var html = "";
        $.ajax({
            url: '@Url.Action("getAppointmentDetails", "POS")',
            data: { appid: $('#appid').val() },
            type: 'POST',
            success: function (data) {

                if (data.length > 0) {

                    appointmentID = data[0].id;

                    var date = getDateFromAspString(data[0].appdate);
                    date = date.getDate() + "/" + (date.getMonth()+1) +  "/" + date.getFullYear();

                    html += "<tr>";
                    html += "<td style='text-align:center'>" + data[0].id + "</td>";
                    html += "<td style='text-align:center'>" + date + "</td>";
                    html += "<td style='text-align:center'>" + data[0].time + "</td>";
                    html += "<td style='text-align:center'>" + data[0].customername + "</td>";
                    html += "<td style='text-align:center'>" + data[0].mobile + "</td>";
                    html += "<td style='text-align:center'>" + data[0].nric + "</td>";
                    html += "<td style='text-align:center'>" + data[0].staffname + "</td>";
                    html += "<td style='text-align:center'>" + data[0].room + "</td>";
                    html += "<td style='text-align:center'>" + data[0].description + "</td>";
                    html += "<td style='text-align:center'>" + data[0].status + "</td>";
                    html += "</tr>";

                    $('#tblAppointment tbody').append(html);

             


                    if ($("#soid").val() <= 0) {

                   
                        $('#cbobkstaff').val(data[0].staffid);
                        $('#cbofacility').val(data[0].assetid);

                        if (data[0].cussupid != 0) {
                            selectedcust = new Object();
                            selectedcust.id = data[0].cussupid;
                            selectedcust.cussupname = data[0].customername;
                            selectedcust.inhousecode = data[0].customercode;
                            $('#txtCustomer').val(selectedcust.cussupname + "(" + selectedcust.inhousecode + ")");
                        }

                        var strStartTime = data[0].starttime;
                        var strEndTime = data[0].endtime;

                        var startTime = strStartTime.split(":");
                        var endTime = strEndTime.split(":");

                        var startTimeHr = startTime[0];
                        var endTimeHr = endTime[0];

                        var startTimeMin = startTime[1].split(" ")[0];
                        var endTimeMin = endTime[1].split(" ")[0];

                        var startTimeAMPM = startTime[1].split(" ")[1];
                        var endTimeAMPM = endTime[1].split(" ")[1];

                        $("#cboStartTimeHR").val(startTimeHr);
                        $("#cboStartTimeMin").val(startTimeMin);
                        $("#cboStartTimeAMPM").val(startTimeAMPM);

                        $("#cboEndTimeHR").val(endTimeHr);
                        $("#cboEndTimeMin").val(endTimeMin);
                        $("#cboEndTimeAMPM").val(endTimeAMPM);
                    }

                }
                else
                    $('#divAppointment').hide();

            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });


    }

    function GoBackToSO() {

        var url = "SalesOrder";
        var rcode = $('#rcode').val();
        var form = $('<form action="' + url + '" method="post">' +
            '<input type="hidden" name="id"  id="id" value="' + $("#soid").val() + '" />' +
            '<input type="hidden" name="rcode"  id="rcode" value="' + rcode + '" />' +
            '</form>');
        $('body').append(form);
        $(form).submit();

    }

    function populatePaymentList(data) {

        var Htmlstr = "";
        var closeHtml = "</tbody></table>";

        Htmlstr += "<tr>";
        Htmlstr += "<th style='Display:none;'>id</th>";
        Htmlstr += "<th style='width:20px;text-align:left;'>Date</th>";
        Htmlstr += "<th style='width:60px;text-align:left;'>POS#</th>";
        Htmlstr += "<th style='width:40px;text-align:center;'>Sub Total</th>";
        Htmlstr += "<th style='width:40px;text-align:center;'>GST</th>";
        Htmlstr += "<th style='width:40px;text-align:center;'>Discount</th>";
        Htmlstr += "<th style='width:40px;text-align:center;'>Refund</th>";
        Htmlstr += "<th style='width:40px;text-align:center;'>Paid</th>";
        Htmlstr += "<th style='width:40px;text-align:center;'>Total Amt</th>";
        Htmlstr += "<th style='width:10px;'>Status</th>";
        Htmlstr += "</tr></thead><tbody>";

        for (var x = 0; x < data.length; x++) {

            Htmlstr += "<tr id=" + data[x].id + "'>";
            Htmlstr += "<td style='Display:none;'>" + data[x].id + "</td>";

            var ctmp = getDateFromAspString(data[x].createdate);
            var createddate = ctmp.getDate() + "/" + (ctmp.getMonth() + 1) + "/" + ctmp.getFullYear() + ' ' + ctmp.getHours() + ":" + ctmp.getMinutes() + ":" + ctmp.getSeconds();

            Htmlstr += "<td style='text-align:left;'>" + createddate + "</td>";
            Htmlstr += "<td style='text-align:left;'>" + data[x].resourcecode + "</td>";
            Htmlstr += "<td style='text-align:right;'>" + data[x].total_subtotal.toFixed(2) + "</td>";
            Htmlstr += "<td style='text-align:right;'>" + data[x].total_salestax.toFixed(2) + "</td>";
            Htmlstr += "<td style='text-align:right;'>" + data[x].total_discount.toFixed(2) + "</td>";
            Htmlstr += "<td style='text-align:right;'>" + data[x].total_amountrefund.toFixed(2) + "</td>";
            Htmlstr += "<td style='text-align:right;'>" + data[x].total_total.toFixed(2) + "</td>";
            Htmlstr += "<td style='text-align:right;'>" + data[x].total_amount.toFixed(2) + "</td>";
            Htmlstr += "<td style='text-align:center;'>" + data[x].status + "</td>";
            //Htmlstr += "<td><a class='btn btn-danger' title ='Click to void.' onclick='openPasswordDialog(" + data[x].id + ",this);'><i class='fa fa-trash-o '></i></a></td>";
            Htmlstr += "</tr>";
        }

        OpenHtmlstr = "<table class='table table-bordered' id ='tblPaymentList'><thead>";
        $('#divPaymentList').html(OpenHtmlstr + Htmlstr + closeHtml);

    }

    function showPrint() {


        if (!(selectedcust) || selectedcust == "undefined") {
            var msg = "Please select customer!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }

        $('#divPOSPrintList').empty();
        $('#divPTSPrintList').empty();
        $('#divPKGPrintList').empty();

        $('#mdlPrint').modal('show');

        $.ajax({
            url: '@Url.Action("getAllOTReceipt", "POS")',
            data: { soid: $('#soid').val() },
            type: 'POST',
            async: false,
            success: function (data) {
                if (data.pos.length > 0)
                    populatePOSPrintList(data.pos);

                if (data.pts.length > 0)
                    populatePTSPrintList(data.pts);

                if (data.pkg.length > 0)
                    populatePKGPrintList(data.pkg);
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });

        @*$.ajax({
            url: '@Url.Action("getSOPOS", "POS")',
            data: { mid: selectedcust.id, soid: $('#soid').val() },
            type: 'POST',
            async: false,
            success: function (data) {
                if (data.length > 0)
                    populatePOSPrintList(data);
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });

        $.ajax({
            url: '@Url.Action("getSOPTS", "POS")',
            data: { soid: $('#soid').val() },
            type: 'POST',
            async: false,
            success: function (data) {
                if (data.length > 0)
                    populatePTSPrintList(data);
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });

        $.ajax({
            url: '@Url.Action("getSOPKG", "POS")',
            data: { soid: $('#soid').val() },
            type: 'POST',
            async: false,
            success: function (data) {
                if (data.length > 0)
                    populatePKGPrintList(data);
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });*@

    }

    function populatePOSPrintList(data) {

        var Htmlstr = "";
        var closeHtml = "</tbody></table>";

        Htmlstr += "<tr>";
        Htmlstr += "<th style='Display:none;'>id</th>";
        Htmlstr += "<th style='width:20%;text-align:left;'>Date</th>";
        Htmlstr += "<th style='width:25%;text-align:left;'>POS#</th>";
        Htmlstr += "<th style='width:15%;text-align:left;'>Refund</th>";
        Htmlstr += "<th style='width:15%;text-align:left;'>Paid</th>";
        Htmlstr += "<th style='width:15%;text-align:center;'>Total Amt</th>";
        Htmlstr += "<th style='width:5%;'></th>";
        Htmlstr += "</tr></thead><tbody>";

        for (var x = 0; x < data.length; x++) {

            Htmlstr += "<tr id=" + data[x].id + "'>";
            Htmlstr += "<td style='Display:none;'>" + data[x].id + "</td>";

            var ctmp = getDateFromAspString(data[x].createdate);
            var createddate = ctmp.getDate() + "/" + (ctmp.getMonth() + 1) + "/" + ctmp.getFullYear() + ' ' + ctmp.getHours() + ":" + ctmp.getMinutes() + ":" + ctmp.getSeconds();

            Htmlstr += "<td style='text-align:left;'>" + createddate + "</td>";
            Htmlstr += "<td style='text-align:left;'>" + data[x].resourcecode + "</td>";
            Htmlstr += "<td style='text-align:right;'>" + data[x].total_amountrefund.toFixed(2) + "</td>";
            Htmlstr += "<td style='text-align:right;'>" + data[x].total_total.toFixed(2) + "</td>";
            Htmlstr += "<td style='text-align:right;'>" + data[x].total_amount.toFixed(2) + "</td>";
            Htmlstr += "<td><a class='btn btn-primary' title ='Click to print.' onClick='printPOSReceipt(\"" + data[x].id + "\")'><i class='fa fa-print '></i></a></td>";
            Htmlstr += "</tr>";
        }

        OpenHtmlstr = "<label>POS Receipt</label><table class='table table-bordered' id ='tblPrintPOSList'><thead>";
        $('#divPOSPrintList').html(OpenHtmlstr + Htmlstr + closeHtml);

    }

    function populatePTSPrintList(data) {

        var Htmlstr = "";
        var closeHtml = "</tbody></table>";

        Htmlstr += "<tr>";
        Htmlstr += "<th style='Display:none;'>id</th>";
        Htmlstr += "<th style='width:20%;text-align:left;'>Date</th>";
        Htmlstr += "<th style='width:25%;text-align:left;'>Redeem#</th>";
        Htmlstr += "<th style='width:50%;text-align:left;'>Product</th>";
        Htmlstr += "<th style='width:5%;'></th>";
        Htmlstr += "</tr></thead><tbody>";

        for (var x = 0; x < data.length; x++) {

            Htmlstr += "<tr id=" + data[x].id + "'>";
            Htmlstr += "<td style='Display:none;'>" + data[x].id + "</td>";

            var ctmp = getDateFromAspString(data[x].createdate);
            var createddate = ctmp.getDate() + "/" + (ctmp.getMonth() + 1) + "/" + ctmp.getFullYear() + ' ' + ctmp.getHours() + ":" + ctmp.getMinutes() + ":" + ctmp.getSeconds();

            Htmlstr += "<td style='text-align:left;'>" + createddate + "</td>";
            Htmlstr += "<td style='text-align:left;'>" + data[x].resourcecode + "</td>";
            Htmlstr += "<td style='text-align:left;'>" + data[x].product + "</td>";
            Htmlstr += "<td><a class='btn btn-primary' title ='Click to print.' onClick='printPTSReceipt(\"" + data[x].id + "\")'><i class='fa fa-print '></i></a></td>";
            Htmlstr += "</tr>";
        }

        OpenHtmlstr = "<label>PTS Receipt</label><table class='table table-bordered' id ='tblPrintPTSList'><thead>";
        $('#divPTSPrintList').html(OpenHtmlstr + Htmlstr + closeHtml);

    }

    function populatePKGPrintList(data) {

        var Htmlstr = "";
        var closeHtml = "</tbody></table>";

        Htmlstr += "<tr>";
        Htmlstr += "<th style='Display:none;'>id</th>";
        Htmlstr += "<th style='width:20%;text-align:left;'>Date</th>";
        Htmlstr += "<th style='width:60px;text-align:left;display:none;'>PackageCode</th>";
        Htmlstr += "<th style='width:30%;text-align:left;'>Package</th>";
        Htmlstr += "<th style='width:60px;text-align:left;display:none;'>Product Id</th>";
        Htmlstr += "<th style='width:30%;text-align:left;'>Product</th>";
        Htmlstr += "<th style='width:10%;text-align:left;'>UOM</th>";
        Htmlstr += "<th style='width:5%;'></th>";
        Htmlstr += "</tr></thead><tbody>";

        for (var x = 0; x < data.length; x++) {

            Htmlstr += "<tr id=" + data[x].id + "'>";
            Htmlstr += "<td style='Display:none;'>" + data[x].id + "</td>";

            var ctmp = getDateFromAspString(data[x].createdate);
            var createddate = ctmp.getDate() + "/" + (ctmp.getMonth() + 1) + "/" + ctmp.getFullYear() + ' ' + ctmp.getHours() + ":" + ctmp.getMinutes() + ":" + ctmp.getSeconds();

            Htmlstr += "<td style='text-align:left;'>" + createddate + "</td>";
            Htmlstr += "<td style='text-align:left;display:none;'>" + data[x].packagecode + "</td>";
            Htmlstr += "<td style='text-align:left;'>" + data[x].packagedesc + "</td>";
            Htmlstr += "<td style='text-align:left;display:none;'>" + data[x].productid + "</td>";
            Htmlstr += "<td style='text-align:left;'>" + data[x].productdesc + "</td>";
            Htmlstr += "<td style='text-align:left;'>" + data[x].uom + "</td>";
            Htmlstr += "<td><a class='btn btn-primary' title ='Click to print.' onClick='printPKGReceipt(this,\"" + data[x].id + "\")'><i class='fa fa-print '></i></a></td>";
            Htmlstr += "</tr>";
        }

        OpenHtmlstr = "<label>PKG Receipt</label><table class='table table-bordered' id ='tblPrintPKGList'><thead>";
        $('#divPKGPrintList').html(OpenHtmlstr + Htmlstr + closeHtml);

    }

    function printPOSReceipt(id) {
        var posid = id;
        var cdesc = $('#c').val();
        var pdesc = $('#b').val();
        var coname = $('#hidconame').val();
        var coaddress = encodeURIComponent($('#hidcoaddress').val());
        var email = $('#hidemail').val();
        var tel = $('#hidtel').val();
        var fax = $('#hidfax').val();
        var coreg = $('#hidcoregno').val();
        var gstreg = $('#hidgstregno').val();
        var discdesc;

        discdesc = 'Discount';
        var url = "../Reports/POSReceipt.aspx?id=" + posid + "&cdesc=" + cdesc + "&pdesc=" + pdesc + "&cname=" + coname + "&caddress=" + coaddress + "&ctel=" + tel + "&cfax=" + fax + "&cemail=" + email + "&coreg=" + coreg + "&gstreg=" + gstreg + "&discdesc=" + discdesc;
        window.open(url, 'popup_window', 'width=900,height=600,left=10,top=10,resizable=yes');
        UpdatePrintCount();
    }

    function UpdatePrintCount() {
        var rcode = $('#rcode').val();
        var posid = $('#posid').val();
        $.ajax({
            url: '@Url.Action("UpdatePrintCount", "POS")',
            data: JSON.stringify({ posid: posid, resource: $('#rcode').val() }),
            type: 'POST',
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                if (data != "FAIL") {
                    $('#txtprintcount').val(data);
                }
            },
            error: function (req, status, err) {
                showMessage(err, "error");
                $("#btnReprint").removeAttr("disabled");
            }
        });
    }
    function printPTSReceipt(rid) {
        var staffid = $('#staffid').val();
        var citidesc = $('#c').val();
        var bonusdesc = $('#b').val();

        var coname = $('#hidconame').val();
        var coaddress = encodeURIComponent($('#hidcoaddress').val());
        var email = $('#hidemail').val();
        var tel = $('#hidtel').val();
        var fax = $('#hidfax').val();
        var coreg = $('#hidcoregno').val();
        var gstreg = $('#hidgstregno').val();

        if (rid > "0") {
            var strurl = "../Reports/RedemptionReceipt.aspx?id=" + rid + "&staffid=" + staffid + "&citidesc=" + citidesc + "&bonusdesc=" + bonusdesc + "&cname=" + coname + "&caddress=" + coaddress + "&ctel=" + tel + "&cfax=" + fax + "&cemail=" + email + "&coreg=" + coreg + "&gstreg=" + gstreg;
            window.open(strurl, 'popup_window', 'width=900,height=600,left=10,top=10,resizable=yes');
        }

    }

    function printPKGReceipt(row, rid) {
        var tds = $(row).closest('tr').find('td');
        var obj = new Object();
        var memberid = selectedcust.id;
        var pkgcode = $(tds[2]).html();
        var pid = $(tds[4]).html();
        var uom = $(tds[6]).html();
        var sid = $('#staffid').val();
        var citidesc = $('#c').val();
        var bonusdesc = $('#b').val();
        var refno = $('#socode').val();

        var coname = $('#hidconame').val();
        var coaddress = encodeURIComponent($('#hidcoaddress').val());
        var email = $('#hidemail').val();
        var tel = $('#hidtel').val();
        var fax = $('#hidfax').val();
        var coreg = $('#hidcoregno').val();
        var gstreg = $('#hidgstregno').val();

        strurl = "../Reports/SOPackageRedemptionReceipt.aspx?cussupid=" + memberid + "&packagecode=" + pkgcode + "&productid=" + pid + "&uom1=" + uom + "&citidesc=" + citidesc + "&bonusdesc=" + bonusdesc + "&refno=" + refno + "&cname=" + coname + "&caddress=" + coaddress + "&ctel=" + tel + "&cfax=" + fax + "&cemail=" + email + "&coreg=" + coreg + "&gstreg=" + gstreg;

        window.open(strurl, 'popup_window', 'width=900,height=600,left=10,top=10,resizable=yes');
    }



    function openPasswordDialog() {
        //posid = pid;
        //posno = $(paramtr).closest('tr').find('td').eq(2).html();
        $('#txtname').val("");
        $('#txtpwd').val("");
        //Added by ZawZO on 4 Sep 2015
        //$('#txtremarks').val("");

        $('#loginheader').html("Enter user name and password to void");
        $('#Login_dialog-modal').dialog("open");
    }

    function closeLoginDialog() {
        $('#Login_dialog-modal').dialog("close");
    }

    function loadQueuedOrder() {
        $("#queuedOrder").show();
        var html = "";
        $("#queuedOrder").html("");
        var eT = "";
        var sT = "";
        html += "<div class='container-outer legend' style='overflow-x: auto;overflow-y:hidden;padding-bottom:5px;'>";
        html += "<div class='container-inner' style='white-space: nowrap'>";
        $.ajax({
            url: '@Url.Action("getSOToday", "POS")',
            data: { assetid: $("#cbofacility").val() },
            type: 'POST',
            success: function (data) {
                for (var i = 0; i < data.length; i++) {



                    html += "       <a class='quick-button' style='padding-top:0px;background-color:grey;background-image:none;border:1px solid grey;padding-top:5px;padding-left:3px;width:16%;display: inline-block;'>";
                    html += "          <h4 style='margin:5px;text-align:left;color:black;font-weight:700'>" + data[i].resourcecode + "</h4>";
                    html += "          <h6 style='margin:5px;text-align:left;padding-top:2px;'>" + data[i].cussupname + "</h6>";
                    html += "          <h6 style='margin:5px;text-align:left;'>" + data[i].starttime + "-" + data[i].endtime + "</h6>";
                    html += "       </a>";

                    eT = data[i].endtime;
                    if ((i + 1) < data.length) {
                        sT = data[i + 1].starttime;

                        var starttime = getHour24(eT);
                        var endtime = getHour24(sT);

                        var timeDifference = endtime - starttime;

                        if (timeDifference > 0) {
                            html += "       <a class='quick-button' onclick='setTime(\"" + data[i].endtime + "\",\"" + data[i + 1].starttime + "\")' style='padding-top:0px;background-color:white;background-image:none;border:1px solid grey;padding-top:5px;padding-left:3px;width:16%;display: inline-block;'>";
                            html += "          <h4 style='margin:5px;text-align:left;color:black;font-weight:700'>Available Time Slot</h4>";
                            html += "          <h6 style='margin:5px;text-align:left;padding-top:2px;color:black;'>" + data[i].endtime + "-" + data[i + 1].starttime + "</h6>";
                            html += "          <h6 style='margin:5px;text-align:left;color:white;visibility:hidden;'>" + data[i].endtime + "-" + data[i + 1].starttime + "</h6>";
                            html += "       </a>";
                        }
                    }

                }

                html += "   </div>";
                html += "</div>";
                $("#queuedOrder").html(html);

            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });
    }

    function setTime(start, end) {

        var startTime = start.split(":");
        var endTime = end.split(":");

        var startTimeHr = startTime[0];
        var endTimeHr = endTime[0];

        var startTimeMin = startTime[1].split(" ")[0];
        var endTimeMin = endTime[1].split(" ")[0];

        var startTimeAMPM = startTime[1].split(" ")[1];
        var endTimeAMPM = endTime[1].split(" ")[1];

        $("#cboStartTimeHR").val(startTimeHr);
        $("#cboStartTimeMin").val(startTimeMin);
        $("#cboStartTimeAMPM").val(startTimeAMPM);

        $("#cboEndTimeHR").val(endTimeHr);
        $("#cboEndTimeMin").val(endTimeMin);
        $("#cboEndTimeAMPM").val(endTimeAMPM);
    }



    // Appointment
    function openAppointmentModal() {
        populateAppointment();
    }

    function resetAppointment() {

        $("#cboAppFacility").val("");
        $("#txtAppDate").val("");
        $("#txtAppCustomerName").val("");
        $("#txtAppCode").val("");
        $("#txtAppMobile").val("");
        $("#txtAppEmail").val("");
        $("#txtAppNRIC").val("");

        $("#cboAppBookedBy").val($("#staffId").val());
        $('input[name="rbStatus"][value="Booking"]').attr('checked', true);
        $("#cboAppChannel").val("0");
        $("#cboCategory").val("0");
        $("#cboSubCategory").val("0");
        $("#txtAppDescription").val("");
        $("#cboAppStartTimeHR").val("08");
        $("#cboAppStartTimeMin").val("00");
        $("#cboAppStartTimeAMPM").val("AM");

        $("#cboAppEndTimeHR").val("08");
        $("#cboAppEndTimeMin").val("00");
        $("#cboEndTimeAMPM").val("AM");
        $("#sonumber").text("");
        $("#queuenumber").text("");
        $("#btnCreateOrder").hide();
        $("#outstandingBalance").text("");
        $("#btnSaveAppointment").text("Update");

    }


    function populateAppointment() {

        resetAppointment();
        $("#btnSaveAppointment").text("Update");
        $("#btnCreateOrder").show();
        $.ajax({
            url: '@Url.Action("GetAppointmentDetails", "Appointment")',
            data: JSON.stringify({ id: appointmentID }),
            type: 'POST',
            async: false,
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                if (data.length > 0) {
                    $("#txtAppCustomerName").val(data[0].customername);
                    $("#txtAppCode").val(data[0].customercode);
                    $("#txtAppMobile").val(data[0].mobile);
                    $("#txtAppEmail").val(data[0].email);
                    $("#txtAppNRIC").val(data[0].nric);
                    _customerCode = data[0].customercode;
                    getOutstandingBalance(data[0].customercode);

                    $("#txtAppDate").val(data[0].appointmentdate);
                    $("#cboAppStaff").val(data[0].staffid);
                    $("#cboAppFacility").val(data[0].branchassetid);
                    $("#cboAppBookedBy").val(data[0].bookedby);
                    $("#txtAppDescription").val(data[0].description);
                    $("#cboAppChannel").val(data[0].channel);
                    $('input[name="rbStatus"][value="' + data[0].status + '"]').attr('checked', true);

                    var strStartTime = data[0].starttime;
                    var strEndTime = data[0].endtime;

                    var startTime = strStartTime.split(":");
                    var endTime = strEndTime.split(":");

                    var startTimeHr = startTime[0];
                    var endTimeHr = endTime[0];

                    var startTimeMin = startTime[1].split(" ")[0];
                    var endTimeMin = endTime[1].split(" ")[0];

                    var startTimeAMPM = startTime[1].split(" ")[1];
                    var endTimeAMPM = endTime[1].split(" ")[1];

                    $("#cboAppStartTimeHR").val(startTimeHr);
                    $("#cboAppStartTimeMin").val(startTimeMin);
                    $("#cboAppStartTimeAMPM").val(startTimeAMPM);

                    $("#cboAppEndTimeHR").val(endTimeHr);
                    $("#cboAppEndTimeMin").val(endTimeMin);
                    $("#cboAppEndTimeAMPM").val(endTimeAMPM);

                    $("#mdlAppointment").modal('show');
                }

            },
            error: function (ts) { openMessage(ts.responseText, "error") }
        });

    }


    function getOutstandingBalance(code) {
        $.ajax({
            url: '@Url.Action("getOutstandingBalance", "Appointment")',
            data: JSON.stringify({ cussupcode: code }),
            type: 'POST',
            async: false,
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                $("#outstandingBalance").text("Balance: " + data);
            },
            error: function (ts) { openMessage(ts.responseText, "error") }
        });
    }

    function openPackageBalance() {
        $("#tblPackageBalance tbody").html("");
        var id = 0;
   

        $.ajax({
            url: '@Url.Action("GetCustomerIdByCode", "Appointment")',
            data: { code: $("#txtAppCode").val().trim() },
            type: 'POST',
            async: false,
            success: function (data) {
                id = data;
            },
            error: function (ts) { openMessage(ts.responseText, "error") }
        });


        if (id != 0) {

            $.ajax({
                url: '@Url.Action("getPackageDetail", "Appointment")',
                data: { mid: id },
                type: 'POST',
                async: false,
                success: function (data) {
                    var html = "";

                    for (var i = 0; i < data.length; i++) {
                        var ctmp = getDateFromAspString(data[i].date);
                        var createddate = ctmp.getDate() + "/" + (ctmp.getMonth() + 1) + "/" + ctmp.getFullYear();
                        html += "<tr><td>" + (i + 1) + "</td><td style='text-align:left;'>" + createddate + "</td><td style='text-align:left;'>" + data[i].receipt + "</td><td style='text-align:left;'>" + data[i].packagedesc + "</td><td style='text-align:left;'>" + data[i].productdesc + "</td><td>" + data[i].balance + "</td></tr>";
                    }

                    $("#tblPackageBalance tbody").append(html);
                },
                error: function (ts) { openMessage(ts.responseText, "error") }
            });

           $('#mdlPackageBalance').modal("show");

        }
        else {
            openMessage("Please select a customer", "error");
        }

    }

    function openHistory() {
        $("#tblHistory tbody").html("");

        var code = "";

        code = $("#txtAppCode").val().trim();
      
        if (code != "") {

            $.ajax({
                url: '@Url.Action("getAppointmentHistory", "Appointment")',
                data: { code: code },
                type: 'POST',
                success: function (data) {
                    var html = "";

                    for (var i = 0; i < data.length; i++) {

                        html += "<tr>";
                        html += "<td>" + (i + 1) + "</td>";
                        html += "<td style='text-align:left;'>" + data[i].description + "</td>";
                        html += "<td style='text-align:left;'>" + data[i].appointmentdate + "</td>";
                        html += "<td style='text-align:center;'>" + data[i].starttime + " - " + data[i].endtime + "</td>";
                        html += "<td style='text-align:left;'>" + data[i].status + "</td>";
                        html += "</tr>";
                    }

                    $("#tblHistory tbody").append(html);
                    $('#mdlHistory').modal("show");
                },
                error: function (ts) { openMessage(ts.responseText, "error") }
            });

        }
        else {
            openMessage("Please select a customer", "error");
        }
    }


    function openServices() {
        $("#tblProductDetails tbody").html("");
        $('#txtAppProduct').val('');
        $('#txtAppCBalance').val('');
        $('#txtAppBBalance').val('');
        $('#txtAppCReserved').val('');
        $('#txtAppBReserved').val('');
        $('#txtAppCAvailable').val('');
        $('#txtAppBAvailable').val('');

        var id = 0;

        $.ajax({
            url: '@Url.Action("GetCustomerIdByCode", "Appointment")',
            data: { code: $("#txtAppCode").val().trim() },
            type: 'POST',
            async: false,
            success: function (data) {
                id = data;
            },
            error: function (ts) { openMessage(ts.responseText, "error") }
        });


        if (id != 0) {

            $.ajax({
                url: '@Url.Action("getMemberList", "CusSup")',
                data: { mid: id },
                type: 'POST',
                async: false,
                success: function (data) {
                    if (data.length > 0) {
                        $('#txtAppCBalance').val(data[0].CBalance);
                        $('#txtAppBBalance').val(data[0].BBalance);
                        $('#txtAppCReserved').val(data[0].CReserved);
                        $('#txtAppBReserved').val(data[0].BReserved);
                        $('#txtAppCAvailable').val(data[0].CAvailable);
                        $('#txtAppBAvailable').val(data[0].BAvailable);
                    }

                },
                error: function (ts) { alert(ts.responseText) }
            });

            $('#mdlServices').modal("show");
        }
        else {
            openMessage("Please select a customer", "error");
        }

    }

    function initAppointment() {

        $('#cboCategory').on('change', function () {
            var html = "";
            $("#txtAppDescription").val("");
            if (this.value == "1") {
                html += "<option value=''></option>";
                html += "<option value='Color'>Color</option>";
                html += "<option value='Perm'>Perm</option>";
                html += "<option value='Treatment'>Treatment</option>";
                html += "<option value='Cut'>Cut</option>";
                html += "<option value='Child Cut'>Child Cut</option>";
                html += "<option value='GK Treatment'>GK Treatment</option>";
            }
            else if (this.value == "2") {
                html += "<option value=''></option>";
                html += "<option value='Facial'>Facial</option>";
                html += "<option value='Body'>Body</option>";
                html += "<option value='DPL/IPL'>DPL/IPL</option>";
                html += "<option value='Foot'>Foot</option>";
            }
            else if (this.value == "3") {
                html += "<option value=''></option>";
                html += "<option value='Treatment'>Treatment</option>";
                html += "<option value='Gel mani or pedi'>Gel mani or pedi</option>";
                html += "<option value='Gel mani and pedi'>Gel mani and pedi</option>";
                html += "<option value='Gel mani n redo'>Gel mani n redo</option>";
                html += "<option value='Express gel'>Express gel</option>";
                html += "<option value='Express mani or pedi'>Express mani or pedi</option>";
            }

            $("#cboSubCategory").html(html);
        });

        $('#cboSubCategory').on('change', function () {
            if (this.value != "")
                $("#txtAppDescription").val($("#cboCategory option:selected").text() + "-" + this.value);
            else
                $("#txtAppDescription").val("");
        });

        $("#txtAppCustomerName").autocomplete({
            minLength: 3,
            source: function (req, res) {
                jQuery.ajax({
                    url: '@Url.Action("getMemberInfoByName", "Appointment")',
                    cache: false,
                    dataType: 'json',
                    data: { custInfo: $('#txtAppCustomerName').val(), count: 10 },
                    error: function (data) {
                        return false;
                    },
                    success: function (data) {
                        res($.map(data, function (item) {
                            return {
                                label: item.cussupname + "(" + item.inhousecode + ")",
                                value: item.cussupname,
                                id: item.id,
                                inhousecode: item.inhousecode,
                                cussupname: item.cussupname,
                                nric: item.nric,
                                mobile: item.mobile,
                                email: item.email
                            }
                        }));
                    }
                });
            },
            select: function (event, ui) {
                var selectedcusup = ui.item;
                $("#txtAppCode").val(selectedcusup.inhousecode);
                $("#txtAppNRIC").val(selectedcusup.nric);
                $("#txtAppMobile").val(selectedcusup.mobile);
                $("#txtAppEmail").val(selectedcusup.email);
                getOutstandingBalance(selectedcusup.inhousecode);
            }
        });

        $("#txtAppCode").autocomplete({
            minLength: 3,
            source: function (req, res) {
                jQuery.ajax({
                    url: '@Url.Action("getMemberInfoByCode", "Appointment")',
                    cache: false,
                    dataType: 'json',
                    data: { custInfo: $('#txtAppCode').val(), count: 10 },
                    error: function (data) {
                        return false;
                    },
                    success: function (data) {
                        res($.map(data, function (item) {
                            return {
                                label: item.inhousecode + "(" + item.cussupname + ")",
                                value: item.inhousecode,
                                id: item.id,
                                inhousecode: item.inhousecode,
                                cussupname: item.cussupname,
                                nric: item.nric,
                                mobile: item.mobile,
                                email: item.email
                            }
                        }));
                    }
                });
            },
            select: function (event, ui) {
                var selectedcusup = ui.item;

                $("#txtAppCustomerName").val(selectedcusup.cussupname);
                $("#txtAppNRIC").val(selectedcusup.nric);
                $("#txtAppMobile").val(selectedcusup.mobile);
                $("#txtAppEmail").val(selectedcusup.email);

                getOutstandingBalance(selectedcusup.inhousecode);
            }
        });

        $("#btnPrintAppointment").click(function () {
            if (appointmentID != 0) {
                $.ajax({
                    url: '@Url.Action("GetBranchDetails", "Appointment")',
                    data: JSON.stringify({ bcode: $("#bcode").val() }),
                    type: 'POST',
                    async: true,
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    success: function (data) {
                        if (data.length > 0) {
                            var address = data[0].address.replace("#", "No.");
                            var url = "../Reports/AppointmentReceipt.aspx?id=" + appointmentID + "&cname=" + data[0].branchname + "&caddress=" + address + "&ctel=" + data[0].tel + "&cfax=" + data[0].fax + "&cemail=" + data[0].email;
                            window.open(url, 'popup_window', 'width=900,height=600,left=10,top=10,resizable=yes');
                        }
                    },
                    error: function (req, status, err) {
                        openMessage("An error occured while saving. Please contact the administrator.", "error");
                    }
                });
            }
            else {
                openMessage("Please create an appointment", "error");
            }


        });

        $("#txtAppProduct").autocomplete({
            minLength: 3,
            source: function (req, res) {
                jQuery.ajax({
                    url: '@Url.Action("getProductInfoAppointment", "Product")',
                    cache: false,
                    dataType: 'json',
                    data: { prodInfo: $('#txtAppProduct').val(), count: 10 },
                    error: function (data) {
                        return false;
                    },
                    success: function (data) {
                        res($.map(data, function (item) {
                            return {
                                label: item.desc + " per " + item.uom + "(" + item.productcode + ")",
                                value: item.desc,
                                category: item.category,
                                categorysub: item.categorysub,
                                brand: item.brand,
                                RangesNSeries: item.RangesNSeries,
                                uom: item.uom,
                                desc: item.desc,
                                id: item.id,
                                productcode: item.productcode,
                                sellprice: item.sellprice.toFixed(2),
                                serviceallowance: item.serviceallowance.toFixed(2),
                                redeemdollars: item.redeemdollars,
                                redeembonus: item.redeembonus

                            }
                        }));
                    }
                });
            },
            select: function (event, ui) {
                var html = "<tr>";
                html += "<td style='text-align:left'>" + ui.item.productcode + "</td>";
                html += "<td style='text-align:left'>" + ui.item.desc + "</td>";
                html += "<td style='text-align:left'>" + ui.item.uom + "</td>";
                html += "<td>" + ui.item.sellprice + "</td>";
                html += "<td>" + ui.item.redeemdollars + "</td>";
                html += "<td>" + ui.item.redeembonus + "</td>";
                html += "</tr>";
                $("#tblProductDetails tbody").html(html);
            }
        });


    }

    function saveNewAppointment() {

        if (validAppointment()) {

            var stTime = $("#cboAppStartTimeHR option:selected").text() + ":" + $("#cboAppStartTimeMin option:selected").text() + " " + $("#cboAppStartTimeAMPM option:selected").text();
            var eTime = $("#cboAppEndTimeHR option:selected").text() + ":" + $("#cboAppEndTimeMin option:selected").text() + " " + $("#cboAppEndTimeAMPM option:selected").text();
            var starttime = getHour24(stTime);
            var endtime = getHour24(eTime);
            var timeDifference = endtime - starttime;

            if (timeDifference > 0) {
                var obj = new Object();
                obj.customername = $("#txtAppCustomerName").val();
                obj.customercode = $("#txtAppCode").val();
                obj.mobile = $("#txtAppMobile").val();
                obj.email = $("#txtAppEmail").val();
                obj.nric = $("#txtAppNRIC").val();
                obj.staffid = $("#cboAppStaff option:selected").val();
                obj.branchassetid = $("#cboAppFacility option:selected").val();
                obj.appointmentdate = $("#txtAppDate").val();
                obj.starttime = stTime;
                obj.endtime = eTime;
                obj.description = $("#txtAppDescription").val();
                obj.status = $('input[name="rbStatus"]:checked').val()
                obj.channel = $("#cboAppChannel option:selected").val();
                obj.bookedby = $("#cboAppBookedBy option:selected").val();
                obj.source = 0;
                obj.id = appointmentID;

                $.ajax({
                    url: '@Url.Action("UpdateAppointment", "Appointment")',
                    data: JSON.stringify({ app: obj }),
                    type: 'POST',
                    async: false,
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    success: function (data) {
                        if (data == "SUCCESS") {
                            getAppointmentDetails();
                            closeModal('mdlAppointment');
                            openMessage("Successfully updated.", "success");
                        }
                        else {
                            openMessage("An error occured while updating appointment. Please contact the administrator.", "error");
                        }

                    },
                    error: function (req, status, err) {
                        openMessage("An error occured while updating appointment. Please contact the administrator.", "error");
                    }
                });
                
           
            }
            else {
                openMessage("Please input a valid duration.", "error");
            }

        }

    }

    function validAppointment() {
        var isValid = true;

        if ($("#cboAppStaff option:selected").text().trim() == "") {
            isValid = false;
            openMessage("Please Select Staff.", "error");
        }
        else if ($("#txtAppCustomerName").val().trim() == "") {
            isValid = false;
            openMessage("Please Enter Customer Name.", "error");
        }
        else if ($("#cboAppFacility option:selected").text().trim() == "") {
            isValid = false;
            openMessage("Please Select Room.", "error");
        }
         
        else if ($("#txtAppMobile").val().trim() == "") {
            isValid = false;
            openMessage("Please Enter Mobile.", "error");
        }
      

        return isValid;
    }


    function closeModal(modalName) {
        $('#' + modalName).modal('hide');
    }

    function openMessage(msg, type) {
        var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"' + type + '"}';
        showMessage(attrvalue);
    }

</script>

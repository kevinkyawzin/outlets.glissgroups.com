@model BigMac.Models.Invoice_m_Invoice

@{
    ViewBag.Title = "SOPOS";
    Layout = "~/Views/Shared/_GeneralLayoutPage.cshtml";
    string rno = "";
    if (Model.resourcecode == "")
    { rno = ""; }
    else
    { rno = "POS# : " + Model.resourcecode; }
}
@section partialCSS {
    <link href="@Url.Content("~/css/app/salesorder/salesorder_main.css")" rel="stylesheet" type="text/css" />
}
<style>
    .signature-pad {
        position: relative;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-orient: vertical;
        -webkit-box-direction: normal;
        -ms-flex-direction: column;
        flex-direction: column;
        font-size: 10px;
        width: 100%;
        height: 100%;
        max-width: 700px;
        max-height: 460px;
        border: 1px solid #e8e8e8;
        background-color: #fff;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.27), 0 0 40px rgba(0, 0, 0, 0.08) inset;
        border-radius: 4px;
        padding: 16px;
    }

        .signature-pad::before,
        .signature-pad::after {
            position: absolute;
            z-index: -1;
            content: "";
            width: 40%;
            height: 10px;
            bottom: 10px;
            background: transparent;
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.4);
        }

        .signature-pad::before {
            left: 20px;
            -webkit-transform: skew(-3deg) rotate(-3deg);
            transform: skew(-3deg) rotate(-3deg);
        }

        .signature-pad::after {
            right: 20px;
            -webkit-transform: skew(3deg) rotate(3deg);
            transform: skew(3deg) rotate(3deg);
        }

    .signature-pad--body {
        position: relative;
        -webkit-box-flex: 1;
        -ms-flex: 1;
        flex: 1;
        border: 1px solid #f4f4f4;
    }

        .signature-pad--body canvas {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            border-radius: 4px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.02) inset;
        }

    .signature-pad--footer {
        color: #C3C3C3;
        text-align: center;
        font-size: 1.2em;
        margin-top: 8px;
    }

    .signature-pad--actions {
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-pack: justify;
        -ms-flex-pack: justify;
        justify-content: space-between;
        margin-top: 8px;
    }

    .fixme {
        position: relative;
        left: expression( ( 20 + ( ignoreMe2 = document.documentElement.scrollLeft ? document.documentElement.scrollLeft : document.body.scrollLeft ) ) + 'px' );
        background-color: #FFFFFF;
    }

    .table > thead > tr > th {
        word-wrap: break-word;
        padding: 5px 0 5px 0;
        margin: 0px;
        text-align: center;
        vertical-align: central;
        font-weight: 600;
        vertical-align: middle;
    }

    .table > tbody > tr > td {
        text-align: right;
        vertical-align: middle;
        font-size: small;
        height: 25px;
        padding: 1px 5px 1px 5px;
        /*padding:1px;*/
        /*padding:1px 10px 1px 1px;*/
    }

        /*#tblItem > tbody > tr > td {
        text-align: right;
        vertical-align: middle;
        font-size: small;
        height: 25px;
        padding: 1px 5px 1px 5px;
    }*/
        .table > tbody > tr > td > input {
            text-align: right;
            vertical-align: central;
            font-weight: 600;
            font-size: small;
            padding-top: 0px;
            padding-right: 0px;
            font-size: 13px;
        }
    /*.salesheader {
        word-wrap: break-word;
        padding: 0px;
        margin: 0px;
        text-align: center;
        vertical-align: central;
    }*/
    /*table td {
        padding: 0px;
        margin: 0px;
    }*/
    /*thead {
        position: fixed;
        top: 0;
        left: 0;
        background-color: white;
    }*/
    #tblActiveSO .classDataTable {
        text-align: left;
    }
</style>
<input type="hidden" value="@ViewBag.Rcode" id="rcode" />
<input type="hidden" value="@ViewBag.GST" id="gstpercent" />
<input type="hidden" value="@Model.status" id="status" />
<input type="hidden" value="@Model.remark" id="hidposremark" />
<input type="hidden" value="@Model.id" id="posid" />
<input type="hidden" value="@Model.cussupid" id="txtcustid" />
<input type="hidden" value="@Model.cussupname" id="txtcustname" />
<input type="hidden" value="@ViewBag.CussupCode" id="txtcustcode" />
<input type="hidden" value="@Model.printcount" id="txtprintcount" />
<input type="hidden" id="c" value="@ViewBag.CitiDesc" />
<input type="hidden" id="b" value="@ViewBag.BonusDesc" />
<input type="hidden" value="@ViewBag.CoName" id="hidconame" />
<input type="hidden" value="@ViewBag.CoAddress" id="hidcoaddress" />
<input type="hidden" value="@ViewBag.Tel" id="hidtel" />
<input type="hidden" value="@ViewBag.Fax" id="hidfax" />
<input type="hidden" value="@ViewBag.Email" id="hidemail" />
<input type="hidden" value="@ViewBag.CoRegNo" id="hidcoregno" />
<input type="hidden" value="@ViewBag.GSTRegNo" id="hidgstregno" />
<input type="hidden" value="@ViewBag.StaffID" id="hidstaffid" />
<input type="hidden" value="@ViewBag.SoID" id="hidsoid" />
<input type="hidden" value="@ViewBag.InvoiceId" id="hidinvoiceid" />
<input type="hidden" id="hidsignfilename" />
<input type="hidden" value="0" id="insertToRedemption" />
<input type="hidden" value="0" id="isPointsAwarded" />

<div class="row" style="margin-top:-10px;">
    <div class="col-lg-12">
        <div class="box">
            <div class="box-content">
                @using (Html.BeginForm("CampaignDetail", "Campaign", FormMethod.Post, new { @class = "form-horizontal" }))
                {
                    @Html.ValidationSummary(true)
                    <fieldset>
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="col-lg-1" style="color:blueviolet;font-weight:700;height:30px;vertical-align:middle;text-align:right;padding-right:10px;padding-top:5px;">
                                    Customer
                                </div>
                                <div class="col-lg-3" style="padding-left:0px;padding-right:0px;">
                                    <input type='text' class='form-control' style="background-color:yellow;" id="txtCustomer" placeholder="Enter Customer Name / Mobile / Code" />
                                </div>
                                <div class="col-lg-2" style="">
                                    <button id="btnMember" type="button" class="btn btn-primary" value="search" style="width:170px;display:none;" onclick="OpenMemberDialog();">Create New Customer</button>
                                </div>
                                <div class="col-lg-2" style="color:blueviolet;font-weight:700;height:30px;vertical-align:middle;padding-right:0;padding-left:0px;padding-top:5px;">
                                    <span id="txtposno">@rno </span>
                                    <span id="txtvoid1" style="font-weight: 700; color: red; font-size: large; display: none;">&nbsp;(VOID)</span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="col-lg-1" style="color:blueviolet;font-weight:700;height:30px;vertical-align:middle;text-align:right;padding-right:10px;padding-top:5px;">
                                    Staff
                                </div>
                                <div class="col-lg-3" style="padding-left:0px;padding-right:0px;">
                                    @Html.DropDownList("cbobkstaff", new SelectList(@ViewBag.StaffOptions, "id", "name"), string.Empty, new { @class = "form-control" })
                                </div>
                                <div class="col-lg-8" style="text-align:right;padding-right:10px;">@DateTime.Now.ToString("hh:mm:ss dd/MM/yyyy")</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-8" style="padding-top:10px;">
                                <div class="col-lg-12">
                                    <table class="table table-striped table-bordered" id="tblItem">
                                        <thead>
                                            <tr>
                                                <th style="width:30px;">Sr.</th>
                                                <th style="display:none">ID</th>
                                                <th style="display:none">PID</th>
                                                <th style="display:none">Code</th>
                                                <th>Description</th>
                                                <th style="display:none">Service Commission</th>
                                                <th style="width:70px;">Price$</th>
                                                <th style="width:40px;">Qty</th>
                                                <th style="width:50px;">UOM</th>
                                                <th style="display:none">Dicount Percent</th>
                                                <th style="width:70px;">Discount$</th>
                                                <th style="width:70px;">Amt$</th>
                                                <th style="width:50px;">Rwd Pts</th>
                                                <th style="width:50px;">Gliss Pts</th>
                                                <th style="width:50px;">Status</th>
                                                <td style="width:30px;"></td>
                                                <td style="width:30px;"></td>
                                                <td style="width:30px;display:none;"></td>
                                                <td style="width:30px;display:none;"></td>
                                                <th style="display:none">cat</th>
                                                <th style="display:none">subcat</th>
                                                <th style="display:none">brand</th>
                                                <th style="display:none">R&C</th>
                                                <th style="display:none">RPoint</th>
                                                <th style="display:none">R$</th>
                                                <th style="display:none">detailid</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                                <div class="col-lg-12" style="padding-top:10px;">
                                    <div class="col-lg-3" style="text-align:left;">Course</div>
                                    <table class="table table-striped table-bordered" id="tblPackageDetls">
                                        <thead>
                                            <tr>
                                                <th style="width:30px;">Line No</th>
                                                <th style="width:120px;">Description</th>
                                                <th style="width:30px;">Qty</th>
                                                <th style="width:50px;">UOM</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                                <div class="col-lg-12" style="padding-top:10px;">
                                    <table class="table table-striped table-bordered" id="tblPayment">
                                        <thead>
                                            <tr>
                                                <th style="width:30px;">Sr</th>
                                                <th>Payment Mode</th>
                                                <th style="width:100px;">Amount</th>
                                                <th style="width:50px;"></th>
                                                <th style="width:50px;"></th>
                                                <th style="display:none;"></th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                                <div id="divPreviousPayment" class="col-lg-12" style="padding-top:20px;display:none;">
                                    <div class="col-lg-6"></div>
                                    <div class="col-lg-3" style="text-align:right;padding-right:0px;"><b> Previous Payment : </b></div>
                                    <div class="col-lg-2">
                                        <input style="text-align:right;" class="form-control" value="0.00" id="txtPreviousPayment" type="text" disabled />
                                    </div>
                                    <div class="col-lg-1" style="padding-left:0px;">
                                        <a class='btn btn-primary' title='Previous Payment' onclick="showPaymentList()"><i class='fa fa-list-alt'></i></a>
                                    </div>
                                </div>
                                <br />
                                <br />
                                <br />
                                <div class="col-lg-12" style="padding-top:10px;">
                                    <div class="col-lg-3" style="text-align:right;">Remark   :</div>
                                    <div class="col-lg-8">
                                        <textarea rows="3" style="width: 100%; overflow: hidden; word-wrap: break-word; resize: horizontal;" id="txtRemark"> </textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-4">
                                <div class="box" style="display:none;">
                                    <div class="box-header">
                                        <i class="fa fa-edit"></i>&nbsp;Item Entry
                                    </div>
                                    <div class="box-content">
                                        <div class="col-sm-12">
                                            <div class="col-lg-9">
                                                <div class="form-group">
                                                    <label class="control-label">Product</label>
                                                    <div class="controls" style="padding-right:10px;"><input type='text' class='form-control' id="txtProduct" placeholder="Enter Product Name/Code" /></div>
                                                </div>
                                            </div>
                                            <div class="col-lg-3">
                                                <div class="form-group" style="padding-right: 10px;">
                                                    <label class="control-label">Qty</label>
                                                    <div class="controls"><input type='text' class='form-control' style="text-align:right" id="txtQty" /></div>
                                                </div>
                                            </div>
                                            <div class="clearfix"></div>
                                            <div class="col-lg-4">
                                                <div class="form-group" style="padding-right: 10px;">
                                                    <label class="control-label">Unit Price</label>
                                                    <div class="controls"><input type='text' class='form-control' id="txtUnitPrice" style="text-align:right" disabled="disabled" /></div>
                                                </div>
                                            </div>

                                            <div class="col-lg-4">
                                                <div class="form-group" style="padding-right: 10px;">
                                                    <label class="control-label">Rwd Pts</label>
                                                    <div class="controls"><input type='text' class='form-control' style="text-align:right" id="txtRwdPts" /></div>
                                                </div>
                                            </div>
                                            <div class="col-lg-4">
                                                <div class="form-group">
                                                    <label class="control-label">Gliss Pts</label>
                                                    <div class="controls"><input type='text' class='form-control' id="txtCitiPts" style="text-align:right" disabled="disabled" /></div>
                                                </div>
                                            </div>
                                            <div class="clearfix"></div>
                                            <div class="col-lg-12">
                                                <div class="form-group">
                                                    <label class="control-label">Description</label>
                                                    <div class="controls">
                                                        <textarea rows="3" style="width: 100%; overflow: hidden; word-wrap: break-word; resize: horizontal;" id="txtProdDescription" disabled="disabled"> </textarea>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-20">
                                                <div style="width:100%;padding:0px 0px 0px 0px;">
                                                    <button type="button" id="btnMiscItem" class="btn btn-success" value="MiscItem" onclick="OpenMiscLoginDialog();" style="width:24%;text-align:center;font-size:14px;padding-left:0px;padding-right:0px">Misc Item</button>
                                                    <button type="button" id="btnSalesKit" data-toggle='modal' data-target='#mdlSalesKit' class="btn btn-success" value="Catalog" onclick="selectSalesKit(this);" style="width:22%;font-size:14px;text-align:center;padding-left:0px;padding-right:0px">Sales Kit</button>
                                                    <button type="button" id="btnCatalog" class="btn btn-success" value="Catalog" onclick="OpenProductDialog();" style="width:20%;text-align:center;font-size:14px;padding-left:0px;padding-right:0px">Catalog</button>
                                                    <button type="button" id="btnAddItem" class="btn btn-success" value="Print" onclick="addItem();" style="width:30%;text-align:center;font-size:14px;padding-left:0px;padding-right:0px">Add Item</button>
                                                </div>
                                            </div>
                                            <div class="clearfix"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-13">
                                    <div style="text-align:right;">
                                        <table style="width:100%">
                                            <tr>
                                                @*<td style="width:50%;background-color:gray;text-align:center;border-style:ridge;" colspan="2" >Jumbo Jet Loyalty Program</td>*@
                                                <td style="width:25%;padding-right:10px;"><label class="control-label">Total Rwd Pts</label></td>
                                                <td style="width:20%;padding-bottom:5px;"><input type="text" class="form-control" id="txtTotalAwardBonus" value="0" style="text-align:right" disabled="disabled" /></td>
                                                <td style="width:25%;padding-right:10px;"><label class="control-label">Sub Total</label> </td>
                                                <td style="width:20%;padding-bottom:5px;"><input type="text" class="form-control" id="txtSubTotal" value="@Model.total_subtotal" style="text-align:right" disabled="disabled" /></td>
                                            </tr>
                                            <tr>
                                                @*<td style="width:35%;padding-right:10px;border-style:ridge;">Rewarded Points</td>
                                                    <td style="width:15%;border-style:ridge;"><input type='text' class='form-control' id="txtTotalAwardBonus" style="text-align:right" disabled="disabled" /></td>*@
                                                <td style="width:25%;padding-right:10px;"><label class="control-label">Total Gliss Pts</label></td>
                                                <td style="width:20%;padding-bottom:5px;"><input type="text" class="form-control" id="txtTotalAwardCitiDollars" value="0" style="text-align:right" disabled="disabled" /></td>
                                                <td style="width:20%;padding-right:10px;"><label class="control-label">GST</label></td>
                                                <td style="width:20%;padding-bottom:5px;"><input type="text" class="form-control" id="txtGST" value="@Model.total_salestax" style="text-align:right" disabled="disabled" /></td>
                                            </tr>
                                            <tr>
                                                @*<td style="width:35%;padding-right:10px;border-style:ridge;">Rewarded Gliss$</td>
                                                    <td style="width:15%;border-style:ridge;"><input type='text' class='form-control' id="txtTotalAwardCitiDollars" style="text-align:right" disabled="disabled" /></td>*@
                                                <td style="width:50%;" colspan="2"></td>
                                                <td style="padding-right:10px;">
                                                    <label class="control-label" id="lblDispercent">Discount </label>
                                                </td>
                                                <td style="padding-bottom:5px;">
                                                    <input type="hidden" id="hidDisPercent" />
                                                    <input type="text" class="form-control" value="@Model.total_discount" style="text-align:right;" id="txtDiscount" onchange="calculateTotal();" />
                                                </td>
                                            </tr>
                                            <tr>
                                                <td></td>
                                                <td><span id="txtvoid2" style="font-weight:700;color:red;font-size:large;text-align:center;display:none;">(VOID)&nbsp;&nbsp;&nbsp;</span></td>
                                                <td style="padding-right:10px;"><label class="control-label" style="color: #356E35">Grand Total</label> </td>
                                                <td style="padding-bottom:5px;"><input type="text" style="background-color: yellow; text-align: right" class="form-control" id="txtGrandTotal" value="@Model.total_total" disabled="disabled" /></td>
                                            </tr>
                                            <tr>
                                                <td></td>
                                                <td></td>
                                                <td style="padding-right:10px;"><label class="control-label">Refund</label></td>
                                                <td style="padding-bottom:5px;"><input type="text" class="form-control" id="txtRefund" value="0" style="text-align:right" disabled="disabled" /></td>
                                            </tr>
                                            <tr>
                                                <td></td>
                                                <td></td>
                                                <td style="padding-right:10px;"><label class="control-label">Change</label></td>
                                                <td style="padding-bottom:5px;"><input type="text" class="form-control" id="txtChange" value="@Model.changes" style="text-align:right" disabled="disabled" /></td>
                                            </tr>
                                            <tr>
                                                <td></td>
                                                <td></td>
                                                <td style="padding-right:10px;"><label class="control-label">Balance</label></td>
                                                <td style="padding-bottom:5px;"><input type="text" class="form-control" id="txtBalance" style="text-align:right" disabled="disabled" /></td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-13">
                                            <div style="padding:10px 10px 0px 0px; text-align:right;white-space:nowrap;">
                                                <button type="button" id="btnPay" class="btn btn-danger" style="width: 50px;text-align:center" value="AddPayment" onclick="OpenPaymentDialog();">Pay</button>
                                                <button type="button" id="btnRefund" class="btn btn-danger" style="width: 80px;text-align:center" value="AddRefund" onclick="OpenPaymentDialog();">Refund</button>
                                                <button type="button" id="btnClearItem" class="btn btn-success" style="background-color: #931313; width: 75px;text-align:center;display:none;" onclick="clearUnclosedInvoiceDetailsgrd();">Clear All</button>
                                                @*<button type="button" id="btnPOSListing" class="btn btn-success" style="background-color: #931313; width: 90px;text-align:center" onclick='goToListing();'>Listing</button>*@
                                                <button type="button" id="btnBack" class="btn btn-success" style="background-color: #931313; width: 60px;text-align:center" onclick="GoBackToSO()">Back</button>
                                                <button type="button" id="btnSOListing" class="btn btn-success" style="background-color: #931313; width: 90px;text-align:center" onclick='goToSOListing();'>Listing</button>
                                                <button type="button" id="btnReprint" class="btn btn-success" style="background-color: #931313; width: 80px;text-align:center" onclick="PrintClick(); SavePOS(1);">Reprint</button>
                                                <button type="button" id="btnPOSClose" class="btn btn-success" style="background-color: #931313; width: 60px;text-align:center;display:none;" onclick="SavePOS(1);">Close</button>
                                                <button type="button" id="btnHold" class="btn btn-success" style="background-color: #931313; width: 60px;text-align:center;display:none;" onclick="SavePOS(0);">Hold</button>
                                                <button type="button" id="btnPOSNew" class="btn btn-success" style="background-color: #931313; width: 90px;text-align:center;display:none;" onclick="newPOS();">New POS</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </fieldset>
                }
            </div>
        </div>
    </div>
</div>

<ul class="noty_cont noty_layout_topRight" id="ulBalance"></ul>
<button id="btnMessage" class="btn btn-primary noty" data-noty-options='{"text":"Please select Member","layout":"topRight","type":"error"}' style="display:none;">Top Right</button>

<div id="Payment_dialog-modal">
    <div class="col-lg-10" id="divPaymentDialog">
        <div class="col-lg-12" style="padding: 10px 10px 10px;text-align:left;">
            <input type="radio" name="rdPayment" value="Full" onclick="clearPaymentDialog();" checked> Full Payment&nbsp;&nbsp;&nbsp;
            <input type="radio" name="rdPayment" value="Deposit" onclick="clearPaymentDialog();">Deposit
        </div>
        <table id="tblPMode" style="width:100%;border-spacing:5px;border-collapse:separate;padding-left:10px;margin-top:10px;">
            <thead>
                <tr>
                    <th style="display:none;">PMode</th>
                    <th style="width:120px;">Payment Mode</th>
                    <th style="width:80px;">Amount</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div>
            <input type="hidden" id="txtplineno" />
        </div>
        <div id="divDepositBalance" class="col-lg-12" style="text-align:right;display:none;">
            <div class="col-lg-6">
            </div>
            <div class="col-lg-3" id="lblDepositBalance">
                Balance
            </div>
            <div class="col-lg-3">
                <input class="form-control" type="text" id="txtDepositBalance" disabled="" style="width:65px;">
            </div>
        </div>
        <div class="col-lg-12" style="padding: 10px 10px 10px;text-align:right;">
            <button type="button" id="btnPaymentSave" onclick="payPOS();" class="btn btn-primary" style="width:100px;">Save</button>
            <button type="button" id="btnStaffClose" onclick="closePaymentDialog();" class="btn btn-primary" style="width:100px;">Cancel</button>
        </div>
    </div>
</div>
<div id="Discount_dialog-modal">
    <div class="col-lg-12" id="divDiscountDialog" style="overflow-style:scrollbar;">
        <div style="width:100%;background-color: #EEE;padding: 10px 10px 10px;font-weight:bold;color:black;">
            Discount
        </div>
        <div style="padding-top:20px;">
            <table>
                <tr>
                    <td style="width:120px;">Discount %</td>
                    <td style="padding-bottom:10px;">@Html.DropDownList("cbodispercent", new SelectList(@ViewBag.DiscountOptions, "value", "value"), string.Empty)</td>
                </tr>
                <tr>
                    <td style="width:120px;">User Name</td>
                    <td style="padding-bottom:10px;"><input type="text" class="form-control" id="txtDisUserName" /></td>
                </tr>
                <tr>
                    <td>Password</td>
                    <td><input type="password" class="form-control" id="txtDisPassword" /></td>
                </tr>
                <tr>
                    <td></td>
                    <td><div id="divDiscLogInErr"></div></td>
                </tr>
            </table>
        </div>
        <div class="col-lg-12" style="padding: 10px 10px 10px;text-align:right;">
            <button type="button" id="btnDiscountlogIn" onclick="loginForDisPercent();" class="btn btn-primary" style="width:100px;">OK</button>
            <button type="button" id="btnDiscountClose" onclick="closeDiscountDialog();" class="btn btn-primary" style="width:100px;">Cancel</button>
        </div>
    </div>
</div>
<div id="Misc_Entry_LogIn_dialog-modal">
    <div class="col-lg-12" id="divMiscLogInDialog" style="overflow-style:scrollbar;">
        <div style="width:100%;background-color: #EEE;padding: 10px 10px 10px;font-weight:bold;color:black;">
            Misc Item Entry Log In
        </div>
        <div style="padding-top:20px;">
            <table>
                <tr>
                    <td style="width:120px;">User Name</td>
                    <td style="padding-bottom:10px;"><input type="text" class="form-control" id="txtMiscUserName" /></td>
                </tr>
                <tr>
                    <td>Password</td>
                    <td><input type="password" class="form-control" id="txtMiscPassword" /></td>
                </tr>
                <tr>
                    <td></td>
                    <td><div id="divMiscLogInErr"></div></td>
                </tr>
            </table>
        </div>
        <div class="col-lg-12" style="padding: 10px 10px 10px;text-align:right;">
            <button type="button" id="btnMisclogIn" onclick="loginForMiscDialog();" class="btn btn-primary" style="width:100px;">OK</button>
            <button type="button" id="btnMiscClose" onclick="closeMiscLogInDialog();" class="btn btn-primary" style="width:100px;">Cancel</button>
        </div>
    </div>
</div>
<div id="Misc_Entry_dialog-modal">
    <div class="col-lg-13" id="divMiscLogInDialog" style="overflow-style:scrollbar;">
        <div style="width:100%;background-color: #EEE;padding: 10px 10px 10px;font-weight:bold;color:black;">
            Misc Item Entry
        </div>
        <div style="padding-top:20px;">
            <table>
                <tr>
                    <td style="width:120px;">Description</td>
                    <td style="padding-bottom:10px;"><input type="text" class="form-control" id="txtMiscItemDesc" style="width:450px;" /></td>
                </tr>
                <tr>
                    <td>Unit Price</td>
                    <td><input type="text" class="form-control" id="txtMiscPrice" style="width:80px;" /></td>
                </tr>
                <tr>
                    <td></td>
                    <td><div id="divMiscEntryErr"></div></td>
                </tr>
            </table>
        </div>
        <div class="col-lg-12" style="padding: 10px 10px 10px;text-align:right;">
            <button type="button" id="btnMiscSave" onclick="addmiscitem();" class="btn btn-primary" style="width:100px;">OK</button>
            <button type="button" id="btnMiscEntryClose" onclick="closeMiscEntryDialog();" class="btn btn-primary" style="width:100px;">Cancel</button>
        </div>
    </div>
</div>


<div id="Product_dialog-modal">
    <div class="col-lg-12" id="divProductDialog">
        <div style="width:100%;background-color: #EEE;padding: 10px 10px 10px;font-weight:bold;color:black;">
            Product Catalog
        </div>
        <table style="width:100%;border-spacing:5px;border-collapse:separate;padding-left:10px;margin-top:10px;">
            <tr>
                <td>Type</td>
                <td colspan="2">@Html.DropDownList("cboPCat", new SelectList(@ViewBag.CategoryOptions, "category", "category"), new { @class = "form-control" })</td>
            </tr>
            <tr>
                <td>Category</td>
                <td colspan="2">@Html.DropDownList("cboPSubCat", new SelectList(@ViewBag.SubCategoryOptions, "category", "category"), new { @class = "form-control" })</td>
            </tr>
            <tr>
                <td>Brand</td>
                <td colspan="2">@Html.DropDownList("cboBpbrand", new SelectList(@ViewBag.BrandOptions, "value", "value"), new { @class = "form-control" })</td>
            </tr>
            <tr>
                <td>Ranges & Series</td>
                <td colspan="2">@Html.DropDownList("cboBprnc", new SelectList(@ViewBag.RangesNSeriesOptions, "value", "value"), new { @class = "form-control" })</td>
            </tr>
            <tr>
                <td>UOM</td>
                <td colspan="2">@Html.DropDownList("cboPUOM", new SelectList(@ViewBag.UOMOptions, "UOM", "UOM"), new { @class = "form-control" })</td>
            </tr>
            <tr>
                <td>Product<input type="hidden" id="txtBundleID" /></td>
                <td colspan="2" style="width:250px;">
                    <!--<select id="cboProduct" class="form-control"></select>-->
                    <input type="text" id="txtDesc" class="form-control" />
                </td>
            </tr>
            <tr>
                <td>Unit Price</td>
                <td colspan="2" style="width:100px;"><input type="text" id="txtProductPrice" class="form-control" /></td>
            </tr>
            <tr>
                <td></td>
                <td><button type="button" id="btnBundleSave" onclick="selectItem()" class="btn btn-primary" style="width:100px;">OK</button></td>
                <td><button type="button" id="btnClose" onclick="CloseProductDialog()" class="btn btn-primary" style="width:100px;">Cancel</button></td>
            </tr>
        </table>
    </div>
</div>

<div id="Member_dialog-modal">
    <div class="col-lg-12" id="divMemberDialog" style="overflow-style:scrollbar;">
        <div style="width:100%;background-color: #EEE;padding: 10px 10px 10px;font-weight:bold;color:black;">
            Create Member
        </div>
        <div id="divMember">
            <table style="width:100%;border-spacing:5px;border-collapse:separate;">
                <tr>
                    <td style="width:20px;"></td>
                    <td style="width:200px;">Name</td>
                    <td colspan="2" style="width:200px;"><input id="txtname" class="form-control" /></td>
                    <td><span style="color:red;">*</span></td>
                </tr>
                <tr>
                    <td></td>
                    <td>NRIC</td>
                    <td colspan="2"><input id="txtnric" class="form-control" /></td>
                    <td><span style="color:red;">*</span></td>
                </tr>
                <tr>
                    <td></td>
                    <td>Card Type</td>
                    <td colspan="2">@Html.DropDownList("cbocardtype", new SelectList(@ViewBag.CardTypeOptions, "value", "value"), new { @class = "form-control" })</td>
                </tr>
                <tr>
                    <td></td>
                    <td>Expiry Date</td>
                    <td colspan="2"><input type="text" id="txtExpiryDate" class="form-control date-picker" data-date-format="dd/mm/yyyy" value="@string.Format("{0:d}",ViewBag.ExpYear)" disabled /></td>
                    <td></td>
                </tr>
                <tr>
                    <td></td>
                    <td>Mobile</td>
                    <td colspan="2"><input id="txtmobile" class="form-control" /></td>
                    <td><span style="color:red;">*</span></td>
                </tr>
                <tr style="display:none;">
                    <td></td>
                    <td>Card Number</td>
                    <td colspan="2"><input id="txtcardno" class="form-control" /></td>
                    <td><span style="color:red;">*</span></td>
                </tr>

                <tr>
                    <td></td>
                    <td></td>
                    <td style="width:60px;"><button type="button" id="btnCardSave" onclick="CHKDuplicateNRICSaveMembership();" class="btn btn-primary" style="width:100px;">Save</button></td>
                    <td style="width:60px;"><button type="button" id="btnClose" onclick="closeMemberDialog()" class="btn btn-primary" style="width:100px;">Cancel</button></td>
                    <td></td>
                </tr>
            </table>
        </div>
    </div>
</div>

<div id="Signature_dialog-modal" style="padding:0px;">
    <div id="signature-pad" class="signature-pad" style="height:300px;">
        <div class="signature-pad--body">
            <canvas id="canvassignature"></canvas>
        </div>
        <div class="signature-pad--footer">
            <div class="description">Sign above</div>
            <div class="signature-pad--actions">
                <div>
                    <button id="btnClearSignature" type="button" class="button" data-action="clear">Clear</button>
                    <button id="btnUndoSignature" type="button" class="button" data-action="undo">Undo</button>
                    <button id="btnCloseSignature" type="button" class="button" data-action="close">Close</button>
                </div>
                <div>
                    <button id="btnSaveSignature" type="button" class="button" data-action="save">Save</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="Staff_dialog-modal">
    <div class="col-lg-12" id="divStaffDialog" style="overflow-style:scrollbar;">
        <div style="width:100%;background-color: #EEE;padding: 10px 10px 10px;font-weight:bold;color:black;">
            Sales Staff Entry
        </div>
        <div style="display:none;">
            @Html.DropDownList("cbostaff", new SelectList(@ViewBag.StaffOptions, "id", "name"), new { @class = "form-control" })
        </div>
        <div id="divSalesStaff">
        </div>
        <div class='clearfix'></div>
        <div style="width:100%;padding: 10px 10px 10px;text-align:right;">
            <button type="button" id="btnStaffSave" onclick="SalesSaffSave();" class="btn btn-primary" style="width:120px;">Save</button>
            <button type="button" id="btnStaffAdd" onclick="StaffNewRow();" class="btn btn-primary" style="width:120px;">Add Row</button>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-lg-12">
        <div class="box">
            <div class="col-sm-2">
                <a class="quick-button" href="~/Access/BranchStaffIndex">
                    <i class="fa fa-home"></i>
                    <p>Home</p>
                </a>
            </div>
        </div>
        <div class="box">
            <div class="col-sm-2">
                <a class="quick-button" href="~/Reports/DailySalesClosing.aspx">
                    <i class="fa fa-user"></i>
                    <p>Daily Closing</p>
                </a>
            </div>
        </div>
        <div class="box">
            <div class="col-sm-2">
                <a class="quick-button" href="~/Reports/DailySalesClosingDetails.aspx">
                    <i class="fa fa-user"></i>
                    <p>Daily Closing Details</p>
                </a>
            </div>
        </div>
        <div class="box" style="display:none;">
            <div class="col-sm-2">
                <a class="quick-button" data-toggle='modal' data-target='#mdlActiveSO' onclick="selectSalesOrder(this);">
                    <i class="fa fa-user"></i>
                    <p>Outstanding Balance List</p>
                </a>
            </div>
        </div>
        <div class="box" style="display:none;">
            <div class="col-sm-2">
                <a class="quick-button" onclick="return OpenProductCreation();">
                    <i class="fa fa-dollar"></i>
                    <p>Package</p>
                </a>
            </div>
        </div>

    </div>
</div>
<div id="InsertTo1MMClub_dialog-modal">
    <div class="col-lg-12" id="divInsertTo1MMClubDialog">
        <div style="width:100%;background-color: #EEE;padding: 10px 10px 10px;font-weight:bold;color:black;">
            <p id="topUpMessage"></p>
            Is the Customer willing to participate in the 1MMClub Rewards Program?
        </div>
        <div class='clearfix'></div>
        <div style="width:100%;padding: 10px 10px 10px;">
            <button type="button" id="btnInsertTo1MMClubYes" onclick="InsertToRedemption(1);" class="btn btn-primary" style="width:80px;">Yes</button>
            <button type="button" id="btnInsertTo1MMClubNo" onclick="InsertToRedemption(0);" class="btn btn-primary" style="width:80px;">No</button>
        </div>
    </div>
</div>
<div class="modal fade" id="mdlActiveSO" tabindex="-1" role="dialog" aria-labelledby="mdlActiveSOLabel" aria-hidden="true">
    <div class="modal-dialog" id="SO_dialog-modal" style="width: 850px; top: 20px; ">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="mdlAccessRightLabel">Outstanding Listing</h4>
            </div>

            <div class="widget-body no-padding">
                <div style="padding: 10px 10px 10px 10px; background-color: #FAFAFA;">
                    <div style="width: 100%;">
                        <table id="tblActiveSO" class="table table-striped table-bordered table-hover" width="100%">
                            <thead>
                                <tr>
                                    <th style='width:200px;' data-hide="phone,tablet">Date</th>
                                    <th style='width:50px;' data-hide="phone,tablet">Sales Order #</th>
                                    <th style='width:100px;' data-hide="phone,tablet">Customer</th>
                                    <th style='width:90px;text-align:center;' data-hide="phone,tablet">Deposit</th>
                                    <th style='width:90px;text-align:center;' data-hide="phone,tablet">Balance</th>
                                    <th style='width:90px;text-align:center;' data-hide="phone,tablet">Total</th>
                                    <th style='width:60px;'></th>
                                    @*<th rowspan =' 2' style='width:60px;'></th>*@
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<div class="modal fade" id="mdlSalesKit" tabindex="-1" role="dialog" aria-labelledby="mdlSalesKitLabel" aria-hidden="true">
    <div class="modal-dialog" id="SalesKit_dialog-modal" style="width: 1250px; top: 20px; ">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="mdlAccessRightLabel">Sales Kits Listing</h4>
            </div>

            <div class="widget-body no-padding">
                <div style="padding: 10px 10px 10px 10px; background-color: #FAFAFA;">
                    <div style="width: 100%;">
                        <div class="col-lg-12" id="divSalesKitList"></div>
                    </div>
                </div>
            </div>

        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<div class="modal fade" id="mdlSalesKitItem" tabindex="-1" role="dialog" aria-labelledby="mdlSalesKitItemLabel" aria-hidden="true">
    <div class="modal-dialog" id="SaleKit_Item_dialog-modal" style="width: 1200px;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="mdlAccessRightLabel">Sales Kit Item Listing</h4>
            </div>
            <div class="widget-body no-padding">
                <div style="padding: 10px 10px 10px 10px; background-color: #FAFAFA;">
                    <div style="width: 100%;">
                        <div class="col-lg-12" id="divSalesKitItemList"></div>
                    </div>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<div class="modal fade" id="mdlPaymentList" tabindex="-1" role="dialog" aria-labelledby="mdlPaymentListLabel" aria-hidden="true">
    <div class="modal-dialog" id="PaymentList_dialog-modal" style="width: 900px;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="mdlAccessRightLabel">Payment History</h4>
            </div>
            <div class="widget-body no-padding">
                <div style="padding: 10px 10px 10px 10px; background-color: #FAFAFA;">
                    <div style="width: 100%;">
                        <div class="col-lg-12" id="divPaymentList"></div>
                    </div>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<script type="text/javascript">
    var load = 0;
    var selectedCatprod;
    var selectedprod;
    var selectedcust;
    var itemcount = 0;
    var itemid = 0;
    var oldpid = 0;
    var pcount = 0;
    var selectedItemTr;
    var selectedPaymentTr;
    var ItemUpdateFlag = 0;
    var prodcol;
    var pamount = 0;
    var total = 0;
    var Staffs = new Array();
    var stblrowcount = 0;
    //Added by ZawZO on 7 Dec 2015
    var CurSOID = 0;
    var selSalesOrder;
    var btnobj = new Object();
    var listOfNewItem = new Array();
    //Added by ZawZO on 7 Dec 2015
    var btnosaleskitbj = new Object();
    var isReprintClick = false;

    var oldBalance = 0;
    var isItemsUpdated = false;

    $(document).ready(function () {
       
        var wrapper = document.getElementById("signature-pad");
        var clearButton = wrapper.querySelector("[data-action=clear]");

        var undoButton = wrapper.querySelector("[data-action=undo]");
        var closeButton = wrapper.querySelector("[data-action=close]");
        var savePNGButton = wrapper.querySelector("[data-action=save-png]");
        var saveJPGButton = wrapper.querySelector("[data-action=save-jpg]");
        var saveSVGButton = wrapper.querySelector("[data-action=save-svg]");
        var saveButton = wrapper.querySelector("[data-action=save]");

        var canvas = wrapper.querySelector("canvas");

        var signaturePad = new SignaturePad(canvas, {
            // It's Necessary to use an opaque color when saving image as JPEG;
            // this option can be omitted if only saving as PNG or SVG
            backgroundColor: 'rgb(255, 255, 255)'
        });

        // Adjust canvas coordinate space taking into account pixel ratio,
        // to make it look crisp on mobile devices.
        // This also causes canvas to be cleared.
        function resizeCanvas() {
            // When zoomed out to less than 100%, for some very strange reason,
            // some browsers report devicePixelRatio as less than 1
            // and only part of the canvas is cleared then.
            var ratio = Math.max(window.devicePixelRatio || 1, 1);

            // This part causes the canvas to be cleared
            //canvas.width = canvas.offsetWidth * ratio;
            //canvas.height = canvas.offsetHeight * ratio;
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;

            canvas.getContext("2d").scale(ratio, ratio);

            // This library does not listen for canvas changes, so after the canvas is automatically
            // cleared by the browser, SignaturePad#isEmpty might still return false, even though the
            // canvas looks empty, because the internal data of this library wasn't cleared. To make sure
            // that the state of this library is consistent with visual state of the canvas, you
            // have to clear it manually.
            signaturePad.clear();
        }

        // On mobile devices it might make more sense to listen to orientation change,
        // rather than window resize events.
        window.onresize = resizeCanvas;
        resizeCanvas();

        function download(dataURL, filename) {
            if (navigator.userAgent.indexOf("Safari") > -1 && navigator.userAgent.indexOf("Chrome") === -1) {
                window.open(dataURL);
            } else {
                var blob = dataURLToBlob(dataURL);
                var url = window.URL.createObjectURL(blob);

                var a = document.createElement("a");
                a.style = "display: none";
                a.href = url;
                a.download = filename;

                document.body.appendChild(a);
                a.click();

                window.URL.revokeObjectURL(url);
            }
        }

        // One could simply use Canvas#toBlob method instead, but it's just to show
        // that it can be done using result of SignaturePad#toDataURL.
        function dataURLToBlob(dataURL) {
            // Code taken from https://github.com/ebidel/filer.js
            var parts = dataURL.split(';base64,');
            var contentType = parts[0].split(":")[1];
            var raw = window.atob(parts[1]);
            var rawLength = raw.length;
            var uInt8Array = new Uint8Array(rawLength);

            for (var i = 0; i < rawLength; ++i) {
                uInt8Array[i] = raw.charCodeAt(i);
            }

            return new Blob([uInt8Array], { type: contentType });
        }

        clearButton.addEventListener("click", function (event) {
            signaturePad.clear();
        });

        undoButton.addEventListener("click", function (event) {
            var data = signaturePad.toData();

            if (data) {
                data.pop(); // remove the last dot or line
                signaturePad.fromData(data);
            }
        });

        closeButton.addEventListener("click", function (event) {
            $('#Signature_dialog-modal').dialog('close');
            ($("#isPointsAwarded").val() == "1") ? InsertToRedemption(0) : OpenInsertTo1MMClubDialog();
        
        });

        saveButton.addEventListener("click", function (event) {
            var currentdate = new Date();
            var fileName = "Sign_" + currentdate.getFullYear() + "_" + currentdate.getMonth() + "_" + currentdate.getDay() + "_" + currentdate.getHours() + currentdate.getMinutes() + currentdate.getSeconds() + currentdate.getMilliseconds();
            $('#hidsignfilename').val(fileName + '.png');

            var imageData = signaturePad.toDataURL();

            var formData = new FormData();
            formData.append('fileData', imageData);
            formData.append('fileName', fileName);
            var xhr = new XMLHttpRequest();
            xhr.addEventListener('load', function () { });
            xhr.open('POST', "../POS/UploadSignImage", true);
            xhr.send(formData);

            $('#Signature_dialog-modal').dialog('close');
            ($("#isPointsAwarded").val() == "1") ? InsertToRedemption(0) : OpenInsertTo1MMClubDialog();
          
        });

        //savePNGButton.addEventListener("click", function (event) {
        //    if (signaturePad.isEmpty()) {
        //        alert("Please provide a signature first.");
        //    } else {
        //        var dataURL = signaturePad.toDataURL();
        //        download(dataURL, "signature.png");
        //    }
        //});


        getCustomer();
        getProduct();
        //Commented by ZawZO on 21 Jan 2016
        //getProducts();

        //Added by ZawZO on 6 Dec 2015
        getCommonPayments();
        showActiveSOList();
        //Added by ZawZO on 9 Dec 2015
        showSalesKitList();
        $("#txtPaidAmount").on('input', function (event) {
            this.value = this.value.replace(/[^0-9\.]/g, '');
        });

        $("#txtQty").on('input', function (event) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });

        $("#txtUnitPrice").on('input', function (event) {
            this.value = this.value.replace(/[^0-9\.]/g, '');
        });

        $("#txtGST").on('input', function (event) {
            this.value = this.value.replace(/[^0-9\.]/g, '');
        });

        $("#txtRwdPts").on('input', function (event) {
            this.value = this.value.replace(/[^0-9\.]/g, '');
        });

        $("#txtCitiPts").on('input', function (event) {
            this.value = this.value.replace(/[^0-9\.]/g, '');
        });

        $("#txtDiscount").on('input', function (event) {
            this.value = this.value.replace(/[^0-9\.]/g, '');
        });

        $("#txtChange").on('input', function (event) {
            this.value = this.value.replace(/[^0-9\.]/g, '');
        });

        //$('#txtQty').change(function e() { calculateSubTotal(); });
        //$('#txtGST').change(function e() { calculateTotal(); });
        //$('#txtDiscount').change(function e() { calculateTotal(); });



        $('#Signature_dialog-modal').dialog({
            width: 600,
            //height: 380,
            modal: true,
            autoOpen: false,
            open: function (event, ui) {
                //$('.ui-widget-header').removeClass('ui-widget-header').html('');
            }
        });

        $('#Product_dialog-modal').dialog({
            //position: [400, 100],
            width: 450,
            hight: 400,
            modal: true,
            autoOpen: false,
            open: function (event, ui) {
                $('.ui-widget-header').removeClass('ui-widget-header').htm('');
            }
        });
        $('#Payment_dialog-modal').dialog({
            //position: [400, 100],
            width: 450,
            hight: 400,
            modal: true,
            autoOpen: false,
            open: function (event, ui) {
                $('.ui-widget-header').removeClass('ui-widget-header').htm('');
            },
            close: function () {
                //SalesStaffValidation();
            }
        });

        var soptions = {
            modal: true,
            height: 280,
            minHeight: 280,
            maxHeight: 280,
            width: 350,
            minWidth: 350,
            maxWidth: 350,
            dialogClass: "sfFormwrapper"
        };
        //$('#Payment_dialog-modal').dialog('option', soptions);
        //Added by ZawZO on 13 May 2015
        $('#Discount_dialog-modal').dialog({
            //position: [280, 120],
            modal: true,
            autoOpen: false,
            open: function (event, ui) {
                $('.ui-widget-header').removeClass('ui-widget-header').htm('');
            },
            close: function () {
                //SalesStaffValidation();
            }
        });

        var soptions = {
            modal: true,
            height: 280,
            minHeight: 280,
            maxHeight: 280,
            width: 350,
            minWidth: 350,
            maxWidth: 350,
            dialogClass: "sfFormwrapper"
        };
        $('#Discount_dialog-modal').dialog('option', soptions);
        //Added by ZawZO on 22 Mar 2016
        $('#Misc_Entry_LogIn_dialog-modal').dialog({
            //position: [280, 120],
            modal: true,
            autoOpen: false,
            open: function (event, ui) {
                $('.ui-widget-header').removeClass('ui-widget-header').htm('');
            },
            close: function () {
                //SalesStaffValidation();
            }
        });

        var soptions = {
            modal: true,
            height: 280,
            minHeight: 280,
            maxHeight: 280,
            width: 350,
            minWidth: 350,
            maxWidth: 350,
            dialogClass: "sfFormwrapper"
        };
        $('#Misc_Entry_LogIn_dialog-modal').dialog('option', soptions);
        //Added by ZawZO on 22 Mar 2016
        $('#Misc_Entry_dialog-modal').dialog({
            //position: [280, 120],
            modal: true,
            autoOpen: false,
            open: function (event, ui) {
                $('.ui-widget-header').removeClass('ui-widget-header').htm('');
            },
            close: function () {
                //SalesStaffValidation();
            }
        });
        var soptions = {
            modal: true,
            height: 280,
            minHeight: 280,
            maxHeight: 280,
            width: 650,
            minWidth: 650,
            maxWidth: 650,
            dialogClass: "sfFormwrapper"
        };
        $('#Misc_Entry_dialog-modal').dialog('option', soptions);

        var posid = $('#posid').val();

       
        if (posid == "0") {
            //Changed by ZawZO 22 Jan 2016
            var soid = $('#hidsoid').val();
            if (soid == 0) {
                fillItemTable(1);
                calculateChangeBalance();
            }
            else {
                //Added by ZawZO on 22 Jan 2016
                $('#cbobkstaff').val($('#hidstaffid').val());
                $('#txtCustomer').val($('#txtcustname').val() + "(" + $('#txtcustcode').val() + ")");
                selectedcust = new Object();
                selectedcust.id = $('#txtcustid').val();
                selectedcust.cussupname = $('#txtcustname').val();
                selectedcust.inhousecode = $('#txtcustcode').val();
                var invoiceid = $('#hidinvoiceid').val();

                getPreviousPaymentBySOID();
                //getVoidedBySOID();
                if (invoiceid == 0) {
                    getItemDetailFromFacilityOrder();
                    if ($('#txtBalance').val() >= 0) {
                        $("#btnPay").removeAttr("disabled");
                        $("#btnRefund").attr("disabled", true);
                    }
                    else {
                        $("#btnRefund").removeAttr("disabled");
                        $("#btnPay").attr("disabled", true);
                    }
                }
                else {
                    NewPOSFromSO(invoiceid, 1);
                }
            }
        }
        else {
            //Added by ZawZO on 20 May 2015
            $('#cbobkstaff').val($('#hidstaffid').val());

            $('#txtCustomer').val($('#txtcustname').val() + "(" + $('#txtcustcode').val() + ")");
            selectedcust = new Object();
            selectedcust.id = $('#txtcustid').val();
            selectedcust.cussupname = $('#txtcustname').val();
            selectedcust.inhousecode = $('#txtcustcode').val();
            //Added by ZawZO on 18 Mar 2016
            $('#txtRemark').val($('#hidposremark').val());

            getPreviousPayment();
            getItemDetail();
            getPayment();
            getSaleStaffs();
            //Changed by ZawZO on 11 Dec 2015
            if ($('#status').val().toUpperCase() == "CLOSE" || $('#status').val().toUpperCase() == "VOID") {
                $('#btnAddItem').attr("disabled", true);
                $('#btnCatalog').attr("disabled", true);
            }
            else {
                $('#btnAddItem').attr("disabled", false);
                $('#btnCatalog').attr("disabled", false);
            }
        }

        if ($('#status').val().toUpperCase() == "CLOSE" || $('#status').val().toUpperCase() == "VOID") {
            $('#btnPOSClose').attr("disabled", true);
            //Added by ZawZO on 5 Dec 2015, to disable payment btn when status is closed or void
            $('#btnPay').attr("disabled", true);
            //Added by ZawZO on 17 Mar 2016, to disable clear all btn when status is closed or void
            $('#btnClearItem').attr("disabled", true);
        }
        if ($('#status').val().toUpperCase() == "VOID") {
            $('#txtvoid1').show();
            $('#txtvoid2').show();
        }

        $('#cboPCat').change(function e() {
            refreshPSubCatOptions();
            //getProducts(0);
        });
        $('#cboPSubCat').change(function e() {
            refreshPBrandOptions();
            //getProducts(0);
        });
        $('#cboBpbrand').change(function e() {
            refreshPRangesNSeriesOptions();
            //getProducts(0);
        });
        $('#cboBprnc').change(function e() {
            //getProducts(0);
        });
        //Changed by ZawZO on 21 Mar 2016
        //$('#cboProduct').change(function e() { selectCboProduct(); });
        $("#txtProductPrice").on('input', function (event) {
            this.value = this.value.replace(/[^0-9\.]/g, '');
        });

        $('#Member_dialog-modal').dialog({
            //position: [280, 120],
            modal: true,
            autoOpen: false,
            open: function (event, ui) {
                $('.ui-widget-header').removeClass('ui-widget-header').htm('');
            },
        });

        var moptions = {
            modal: true,
            height: 350,
            minHeight: 350,
            maxHeight: 350,
            width: 530,
            minWidth: 530,
            maxWidth: 530,
            dialogClass: "sfFormwrapper"
        };
        $('#Member_dialog-modal').dialog('option', moptions);

        $('#InsertTo1MMClub_dialog-modal').dialog({
            modal: true,
            autoOpen: false,
            open: function (event, ui) {
                $('.ui-widget-header').removeClass('ui-widget-header').htm('');
            },
            close: function () {
                CloseInsertTo1MMClubDialog();
            }
        });

        var options = {
            modal: true,
            height: 230,
            minHeight: 230,
            maxHeight: 230,
            width: 500,
            minWidth: 500,
            maxWidth: 500,
            dialogClass: "sfFormwrapper"
        };

        $('#InsertTo1MMClub_dialog-modal').dialog('option', options);

        $('#txtPaidAmount').live("keypress", function (e) {
            if (e.keyCode == 13) {
                btnPaymentSave.focus()
                return false; // prevent the button click from happening
            }
        });

        $('#txtmobile').live("keypress", function (e) {
            if (e.keyCode == 13) {
                btnCardSave.focus()
                return false; // prevent the button click from happening
            }
        });

        $('#Staff_dialog-modal').dialog({
            //position: [280, 120],
            modal: true,
            autoOpen: false,
            open: function (event, ui) {
                $('.ui-widget-header').removeClass('ui-widget-header').htm('');
            },
            close: function () {
                SalesStaffValidation();
            }
        });

        var soptions = {
            modal: true,
            height: 380,
            minHeight: 380,
            maxHeight: 380,
            width: 530,
            minWidth: 530,
            maxWidth: 530,
            dialogClass: "sfFormwrapper"
        };
        $('#Staff_dialog-modal').dialog('option', soptions);

    });

    function PrintClick() {
        isReprintClick = true;
    }


    function InsertToRedemption(insert) {
        $('#insertToRedemption').val(insert);
        CloseInsertTo1MMClubDialog();
        oldBalance = parseFloat($("#txtBalance").val());
        SavePayment();
        SavePOS(1);

    }

    function payPOS() {
        $('#Signature_dialog-modal').dialog('open');
        $("#Signature_dialog-modal").siblings('div.ui-dialog-titlebar').remove();
        $("[aria-describedby=Signature_dialog-modal]").css("border", "solid 1px #A9A9A9");
        var canvas = document.getElementsByTagName('canvas')[0];
        canvas.width = 495;
        canvas.height = 209;
    }

    function OpenInsertTo1MMClubDialog() {
        $('#InsertTo1MMClub_dialog-modal').dialog('open');
    }

    function CloseInsertTo1MMClubDialog() {
        $('#InsertTo1MMClub_dialog-modal').dialog('close');
    }

    function getCustomer() {
        $("#txtCustomer").autocomplete({
            minLength: 3,
            source: function (req, res) {
                jQuery.ajax({
                    url: '@Url.Action("getMemberInfo", "CusSup")',
                    cache: false,
                    dataType: 'json',
                    data: { custInfo: $('#txtCustomer').val(), count: 10 },
                    error: function (data) {
                        return false;
                    },
                    success: function (data) {
                        res($.map(data, function (item) {
                            return {
                                label: item.cussupname + "(" + item.inhousecode + ")",
                                value: item.cussupname + "(" + item.inhousecode + ")",
                                id: item.id,
                                inhousecode: item.inhousecode,
                                cussupname: item.cussupname
                            }
                        }));
                    }
                });
            },
            select: function (event, ui) {
                selectedcust = ui.item;
            }
        });
    }

    function getProduct() {
        $("#txtProduct").autocomplete({
            minLength: 3,
            source: function (req, res) {
                jQuery.ajax({
                    url: '@Url.Action("getProductInfo", "Product")',
                    cache: false,
                    dataType: 'json',
                    data: { prodInfo: $('#txtProduct').val(), count: 10 },
                    error: function (data) {
                        return false;
                    },
                    success: function (data) {
                        res($.map(data, function (item) {
                            return {
                                label: item.desc + " per " + item.uom + "(" + item.productcode + ")",
                                value: item.desc,
                                category: item.category,
                                categorysub: item.categorysub,
                                brand: item.brand,
                                RangesNSeries: item.RangesNSeries,
                                uom: item.uom,
                                desc: item.desc,
                                id: item.id,
                                productcode: item.productcode,
                                sellprice: item.sellprice,
                                servicecommission: item.servicecommission,
                                awardbonus: item.awardbonus,
                                awarddollars: item.awarddollars
                            }
                        }));
                    }
                });
            },
            select: function (event, ui) {
                selectedprod = ui.item;
                $("#txtUnitPrice").val(selectedprod.sellprice.toFixed(2));
                $("#txtProdDescription").val(selectedprod.desc + " : " + selectedprod.productcode + "\n" + selectedprod.category + "," + selectedprod.categorysub + "," + selectedprod.brand + "," + selectedprod.RangesNSeries + "\nUOM: " + selectedprod.uom);
                $('#txtQty').val("1");
                $('#txtRwdPts').val(selectedprod.awardbonus.toFixed(2));
                $('#txtCitiPts').val(selectedprod.awarddollars.toFixed(2));

                //Added by ZawZO on 13 May 2015
                if (selectedprod.category == 'Package') {
                    getPackagedetail(selectedprod.id);
                }
                else {
                    clearProductBundleDetailgrd();
                }
                $('#txtQty').focus();
            }
        });
        //Added by ZawZO on 4 Dec 2015
        $('#txtProduct').keypress(function (e) {
            if (e.keyCode == 13) {  // detect the enter key
                var AltCode = $('#txtProduct').val();
                if (AltCode != '') {
                    $.ajax({
                        url: '@Url.Action("getProductInfoByAltCode", "Product")',
                        data: { altCode: AltCode },
                        type: 'POST',
                        success: function (data) {
                            if (data.length > 0) {
                                $("#txtUnitPrice").val(data[0].sellprice.toFixed(2));
                                $("#txtProdDescription").val(data[0].desc + " : " + data[0].productcode + "\n" + data[0].category + "," + data[0].categorysub + "," + data[0].brand + "," + data[0].RangesNSeries + "\nUOM: " + data[0].uom);
                                $('#txtQty').val("1");
                                //Added by ZawZO on 18 Jan 2016
                                selectedprod = new Object();
                                selectedprod.id = data[0].id;
                                selectedprod.desc = data[0].desc;
                                selectedprod.productcode = data[0].productcode;
                                selectedprod.category = data[0].category;
                                selectedprod.categorysub = data[0].categorysub;
                                selectedprod.brand = data[0].brand;
                                selectedprod.rangesNSeries = data[0].rangesNSeries;
                                selectedprod.uom = data[0].uom;

                                if (selectedprod.category == 'Package') {
                                    getPackagedetail(selectedprod.id);
                                }
                                else {
                                    clearProductBundleDetailgrd();
                                }
                                $('#txtQty').focus();
                            }
                        },
                        error: function (ts) {
                            alert(ts.responseText)
                        }
                    });
                }
            }
        });

    }
    //Added by ZawZO on 13 May 2015
    function getPackagedetail(productid) {
        $.ajax({
            url: '@Url.Action("getProductBundleDetails", "Product")',
            data: { pid: productid },
            type: 'POST',
            success: function (data) {
                populateProductBundleDetail(data);
            }
        });
    }

    //Added by ZawZO on 13 May 2015
    function populateProductBundleDetail(data) {
        var htmlstr = "";
        var x = 0;
        if (data) {
            for (x; x < data.length; x++) {
                htmlstr = htmlstr + "<tr><td>" + data[x].lineno + "</td><td style='text-align:left;'>" + data[x].description + "</td><td>" + data[x].qty + "</td><td style='text-align:left;'>" + data[x].uom + "</td></tr>"
            }
        }
        $("#tblPackageDetls > tbody").append(htmlstr);
    }
    //Added by ZawZO on 13 May 2015
    function clearProductBundleDetailgrd() {
        $("#tblPackageDetls > tbody").empty();
    }
    function getProducts(value) {
        var ptype = $('#cboPCat').val();
        var pcategory = $('#cboPSubCat').val();
        var pbrand = $('#cboBpbrand').val();
        var prnc = $('#cboBprnc').val();

        $.ajax({
            url: '@Url.Action("getProductInfoByFilter", "Product")',
            data: { ptype: ptype, pcategory: pcategory, pbrand: pbrand, prnc: prnc },
            type: 'POST',
            success: function (data) {
                var Htmlstr = "";
                if (data.length > 0) prodcol = data;
                for (var x = 0; x < data.length; x++) {
                    Htmlstr += "<option value=" + data[x].id + ">" + data[x].desc + " (per " + data[x].uom + ")</option>";
                }
                $('#cboProduct').html(Htmlstr).show();
                //if (value != '0') $('#cboProduct').val(value);
                selectCboProduct();
            }
        });
    }
    //Added by ZawZO on 5 Dec 2015
    function refreshPSubCatOptions() {
        var pcat = $('#cboPCat').val();
        $.ajax({
            url: '@Url.Action("getProductCatSubOptions", "Product")',
            data: { pCat: pcat },
            type: 'POST',
            success: function (data) {
                var Htmlstr = "";
                for (var x = 0; x < data.length; x++) {
                    Htmlstr += "<option value=" + data[x].Category + ">" + data[x].Category + "</option>";
                }
                $('#cboPSubCat').html(Htmlstr).show();
                //if (value != '0') $('#cboPSubCat').val(value);
            }
        });
    }
    //Added by ZawZO on 5 Dec 2015
    function refreshPBrandOptions() {
        var pcat = $('#cboPCat').val();
        var psubcat = $('#cboPSubCat').val();
        if (pcat == '') {
            showMessage('Please choose product type.', "error");
        }
        else if (psubcat == '') {
            showMessage('Please choose product category.', "error");
        }
        else {
            $.ajax({
                url: '@Url.Action("getProductBrandOptions", "Product")',
                data: { pCat: pcat, pSubCat: psubcat },
                type: 'POST',
                success: function (data) {
                    var Htmlstr = "";
                    for (var x = 0; x < data.length; x++) {
                        Htmlstr += "<option value=" + data[x].value + ">" + data[x].value + "</option>";
                    }
                    $('#cboBpbrand').html(Htmlstr).show();
                    //if (value != '0') $('#cboBpbrand').val(value);
                }
            });
        }
    }
    //Added by ZawZO on 5 Dec 2015
    function refreshPRangesNSeriesOptions() {
        var pcat = $('#cboPCat').val();
        var psubcat = $('#cboPSubCat').val();
        var pbrand = $('#cboBpbrand').val();
        if (pcat == '') {
            showMessage('Please choose product type first.', "error");
        }
        else if (psubcat == '') {
            showMessage('Please choose product category first.', "error");
        }
        else if (pbrand == '') {
            showMessage('Please choose product brand first.', "error");
        }
        else {
            $.ajax({
                url: '@Url.Action("getProductRangeNSeriesOptions", "Product")',
                data: { pCat: pcat, pSubCat: psubcat, pBrand: pbrand },
                type: 'POST',
                success: function (data) {
                    var Htmlstr = "";
                    for (var x = 0; x < data.length; x++) {
                        Htmlstr += "<option value=" + data[x].value + ">" + data[x].value + "</option>";
                    }
                    $('#cboBprnc').html(Htmlstr).show();
                    //if (value != '0') $('#cboBprnc').val(value);
                }
            });
        }
    }
    //Added by ZawZO on 23 Mar 2016
    function SaveProductCatalog() {
        if (catalogItemValidation() == true) {
            var objp = new Object();
            var cboPCat = document.getElementById("cboPCat");
            var cat = cboPCat.options[cboPCat.selectedIndex].text;
            var cboPSubCat = document.getElementById("cboPSubCat");
            var catsub = cboPSubCat.options[cboPSubCat.selectedIndex].text;
            var cboBpbrand = document.getElementById("cboBpbrand");
            var br = cboBpbrand.options[cboBpbrand.selectedIndex].text;
            var cboBprnc = document.getElementById("cboBprnc");
            var rs = cboBprnc.options[cboBprnc.selectedIndex].text;
            var cboPUOM = document.getElementById("cboPUOM");
            var uom = cboPUOM.options[cboPUOM.selectedIndex].text;
            var txtdesc = document.getElementById("txtDesc");
            var desc = txtdesc.value;
            var txtProductPrice = document.getElementById("txtProductPrice");
            var unitprice = txtProductPrice.value;
            $.ajax({
                url: '@Url.Action("saveProductCatalog", "POS")',
                data: { pCat: cat, pCatSub: catsub, pBr: br, pRs: rs, pUOM: uom, pDesc: desc, pPrice: unitprice },
                type: 'POST',
                success: function (data) {
                    if (data.length > 0) {
                        selectedprod = new Object();
                        selectedprod.id = data[0].id;
                        selectedprod.category = cat;
                        selectedprod.categorysub = catsub;
                        selectedprod.brand = br;
                        selectedprod.RangesNSeries = rs;
                        selectedprod.uom = uom;
                        selectedprod.desc = desc;
                        selectedprod.productcode = data[0].productcode;
                        selectedprod.sellprice = unitprice;
                        selectedprod.servicecommission = 0;
                        //Added by ZawZO on 19 Aug 2016
                        selectedprod.awardbonus = 0;
                        selectedprod.awarddollars = 0;

                        $("#txtProduct").val(selectedprod.desc);
                        $("#txtUnitPrice").val(parseFloat(selectedprod.sellprice).toFixed(2));
                        $("#txtProdDescription").val(selectedprod.desc + " : " + selectedprod.productcode + "\n" + selectedprod.category + "," + selectedprod.categorysub + "," + selectedprod.brand + "," + selectedprod.RangesNSeries + "\nUOM: " + selectedprod.uom);
                        $('#txtQty').val("1");
                    }
                }
            });
        }
    }
    //Added by ZawZO on 23 Mar 2016
    function addmiscitem() {
        if (miscItemValidation() == true) {
            var desc = $("#txtMiscItemDesc").val();
            $.ajax({
                url: '@Url.Action("getMiscProductDetails", "POS")',
                data: {},
                type: 'POST',
                success: function (data) {

                    if (data.length > 0) {

                        selectedprod = new Object();
                        selectedprod.id = data[0].id;
                        selectedprod.category = data[0].category;
                        selectedprod.categorysub = data[0].categorysub;
                        selectedprod.brand = data[0].brand;
                        selectedprod.RangesNSeries = data[0].rangesNSeries;
                        selectedprod.uom = data[0].uom;
                        selectedprod.desc = $("#txtMiscItemDesc").val();
                        selectedprod.productcode = data[0].productcode;
                        selectedprod.sellprice = $("#txtMiscPrice").val();;
                        selectedprod.servicecommission = 0;
                        //Added by ZawZO on 19 Aug 2016
                        selectedprod.awardbonus = 0;
                        selectedprod.awarddollars = 0;

                        $("#txtProduct").val(selectedprod.desc);
                        $("#txtUnitPrice").val(parseFloat(selectedprod.sellprice).toFixed(2));
                        $("#txtProdDescription").val(selectedprod.desc + " : " + selectedprod.productcode + "\n" + selectedprod.category + "," + selectedprod.categorysub + "," + selectedprod.brand + "," + selectedprod.RangesNSeries + "\nUOM: " + selectedprod.uom);
                        $('#txtQty').val("1");
                        $('#divMiscEntryErr').html('');
                        $("#txtMiscItemDesc").val('');
                        $("#txtMiscPrice").val('');
                        closeMiscEntryDialog();
                    }
                }
            });
        }
    }
    //Added by ZawZO on 30 Nov 2015
    function getCommonPayments() {
        $.ajax({
            url: '@Url.Action("getPaymentModes", "POS")',
            data: {},
            type: 'POST',
            success: function (data) {
                populatePaymentModes(data);
            }
        });
    }
    //Added by ZawZO on 13 May 2015
    function populatePaymentModes(data) {
        var htmlstr = "";
        var x = 0;
        var len = data.length;
        if (data) {
            for (x; x < data.length; x++) {
                //htmlstr = htmlstr + "<tr id=" + x + "><td style='width:80px;text-align:left;background-color: #EEE;font-weight:bold;color:black;'>" + data[x].paymentmode + "</td>";
                htmlstr = htmlstr + "<tr id=" + x + "><td style='display:none;'>" + data[x].paymentmode + "</td>";
                if (data[x].paymentmode.trim() == "Redemption" || data[x].paymentmode.trim() == "TopUp" || data[x].paymentmode.trim() == "IPP % OCBC" || data[x].paymentmode.trim() == "IPP % UOB" || data[x].paymentmode.trim() == "Amex" || data[x].paymentmode.trim() == "Voucher") {
                    htmlstr = htmlstr + "<td style='width:120px'><button disabled='disabled' type='button' id='btnPMode" + x + "' class='btn btn-primary' style='background-color: #931313; width: 220px;' onclick='populatePayAmt(" + x + "," + len + ");'>" + data[x].paymentmode + "</button></td>";
                    htmlstr = htmlstr + "<td style='width:80px;text-align:left;'><input class='form-control' type='text' id ='txtPayAmt" + x + "' onkeyup='refreshPaymentdialog(" + x + "," + len + ");' disabled/></td></tr>";
                } else {
                    htmlstr = htmlstr + "<td style='width:120px'><button type='button' id='btnPMode" + x + "' class='btn btn-primary' style='background-color: #931313; width: 220px;' onclick='populatePayAmt(" + x + "," + len + ");'>" + data[x].paymentmode + "</button></td>";
                    htmlstr = htmlstr + "<td style='width:80px;text-align:left;'><input class='form-control' type='text' id ='txtPayAmt" + x + "' onkeyup='refreshPaymentdialog(" + x + "," + len + ");'/></td></tr>";
                }
            }
        }
        $("#tblPMode > tbody").append(htmlstr);
    }
    //Added by ZawZO on 18 Dec 2015
    function populatePayAmt(idx, len) {
        var i = 0;
        $('input[name=rdPayment][value=Full]').attr('checked', true);
        for (i; i < len; i++) {
            var txtbox = '#txtPayAmt' + i;
            var bal = $('#txtBalance').val();
            if (i == idx) {
                $(txtbox).val(bal);
            }
            else {
                $(txtbox).val('');
            }
        }
    }
    //Added by ZawZO on 20 Dec 2015
    function refreshPaymentdialog(idx, len) {
        var i = 0;
        var bal = $('#txtBalance').val();
        if (idx == 0) {
            for (i = 1; i < len; i++) {
                var txtbox = '#txtPayAmt' + i;
                var bal = $('#txtBalance').val();
                //$(txtbox).val('');
            }

            if ($("input[type='radio'][name='rdPayment']:checked").val() != "Full")
                $('#txtDepositBalance').val(CalcBalanceAmt(len));
        }
        else {
            var selectedPmnt = "";
            var selected = $("input[type='radio'][name='rdPayment']:checked");
            if (selected.length > 0) {
                selectedPmnt = selected.val();
            }
            for (i = 0; i < len; i++) {
                var txtbox = '#txtPayAmt' + i;
                if (i == 0) {
                    if (selectedPmnt == "Full") {
                        //var payamt = $('#txtPayAmt' + idx).val();
                        var payamt = CalcPayAmt(len);
                        var curbal = parseFloat(bal - payamt).toFixed(2);
                        if (curbal > 0) {
                            $(txtbox).val(curbal);
                        }
                        else {
                            $(txtbox).val('');
                        }
                    }
                    else {
                        $('#txtDepositBalance').val(CalcBalanceAmt(len));
                        //$(txtbox).val('');
                    }
                }
            }
        }
    }
    //Added by ZawZO on 23 Mar 2016
    function CalcPayAmt(len) {
        var Total = 0;
        var Tmp = 0;
        for (j = 1; j < len; j++) {
            if ($('#txtPayAmt' + j).val() != "") {
                tmp = parseFloat($('#txtPayAmt' + j).val());
                Total += tmp;
            }
        }
        return Total;
    }

    function CalcBalanceAmt(len) {
        var total = 0;
        var tmp = 0;
        for (i = 0; i < len; i++) {
            if ($('#txtPayAmt' + i).val() != "") {
                tmp = parseFloat($('#txtPayAmt' + i).val());
                total += tmp;
            }
        }
        var balance = parseFloat($('#txtBalance').val()) - total;

        if (balance < 0) {
            $("#lblDepositBalance").html("Change");
            balance = Math.abs(balance);
        }
        else
            $("#lblDepositBalance").html("Balance");

        return balance;
    }
    function clearPaymentDialog() {
        $("#lblDepositBalance").html("Balance");
        var selected = $("input[type='radio'][name='rdPayment']:checked").val();
        (selected == "Full") ? $('#divDepositBalance').hide() : $('#divDepositBalance').show();

        $('#tblPMode > tbody > tr').each(function (i, row) {
            var txts = $(row).find('input');
            if (i == 0) {
                var bal = $('#txtBalance').val();
                $(txts[0]).val(bal);
            }
            else {
                $(txts[0]).val('');
            }
        });
    }
    function selectCboProduct() {
        selectedCatprod = new Object();
        var pindex = $('#cboProduct :selected').index();
        selectedCatprod.id = $('#cboProduct').val();
        selectedCatprod.category = $('#cboPCat').val();
        selectedCatprod.categorysub = $('#cboPSubCat').val();
        selectedCatprod.brand = $('#cboBpbrand').val();
        selectedCatprod.RangesNSeries = $('#cboBprnc').val();
        selectedCatprod.uom = $('#cboPUOM').val();
        selectedCatprod.desc = $('#txtDesc').val();
        selectedCatprod.productcode = prodcol[pindex].productcode;
        selectedCatprod.sellprice = prodcol[pindex].sellprice;
        selectedCatprod.servicecommission = prodcol[pindex].servicecommission;
        //Added by ZawZO on 19 Aug 2016
        selectedCatprod.awardbonus = prodcol[pindex].awardbonus;
        selectedCatprod.awarddollars = prodcol[pindex].awarddollars;

        $('#txtProductPrice').val(prodcol[pindex].sellprice);
    }

    function selectItem() {
        //Added by ZawZO on 21 Mar 2016
        SaveProductCatalog();
        CloseProductDialog();
        $('#txtQty').focus();
    }
    function OpenProductDialog(itemid, paramtr) {
        //Added by ZawZO on 21 Mar 2016
        $('#cboPCat').val("");
        $('#cboPSubCat').val("");
        $('#cboBpbrand').val("");
        $('#cboBprnc').val("");
        $('#cboPUOM').val("");
        $('#txtDesc').val("");
        $('#txtProductPrice').val("");

        $('#Product_dialog-modal').dialog('open');
    }
    function CloseProductDialog() {
        //Added by ZawZO on 21 Mar 2016
        $('#cboPCat').val("");
        $('#cboPSubCat').val("");
        $('#cboBpbrand').val("");
        $('#cboBprnc').val("");
        $('#cboPUOM').val("");
        $('#txtDesc').val("");
        $('#txtProductPrice').val("");
        $('#Product_dialog-modal').dialog("close");
    }
    function getItemDetail() {
        var posid = $('#posid').val();

        $.ajax({
            url: '@Url.Action("getItemDetail", "POS")',
            data: { posid: posid },
            type: 'POST',
            success: function (data) {
                populateItemDetail(data);
                calculateSubTotal();

            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });
    }
    function populateItemDetail(data) {
        var htmlstr = "";
        itemcount = 0;
        var x = 0;
        var posid = $('#posid').val();
        var posstatus = $('#status').val().toUpperCase();
        if (data) {
            for (x; x < data.length; x++) {
                itemcount++;
                htmlstr = htmlstr + "<tr><td>" + data[x].lineno + "</td><td style='display:none'>" + data[x].id + "</td><td style='display:none'>" + data[x].productid + "</td>";
                htmlstr = htmlstr + "<td style='display:none'>" + data[x].productcode + "</td><td style='text-align:left;'>" + data[x].productdesc + "</td>";
                htmlstr = htmlstr + "<td style='display:none'>" + data[x].servicecommission + "</td><td>" + data[x].unitprice.toFixed(2) + "</td>";
                htmlstr = htmlstr + "<td>" + data[x].qty + "</td><td>" + data[x].uom + "</td><td style='display:none'>" + data[x].discountpercent + "</td>";
                htmlstr = htmlstr + "<td>" + data[x].discountamount.toFixed(2) + "</td><td>" + (data[x].lineamount.toFixed(2) - data[x].discountamount.toFixed(2)).toFixed(2) + "</td>";

                if (data[x].awardbonus == null) {
                    htmlstr = htmlstr + "<td></td><td></td>";
                }
                else {
                    htmlstr = htmlstr + "<td>" + (data[x].awardbonus * data[x].qty).toFixed(2) + "</td><td>" + (data[x].awarddollars * data[x].qty).toFixed(2) + "</td>";
                }

                if (posid == "0") {
                    htmlstr = htmlstr + "<td><a class='btn btn-warning' onclick='ShowStaffs(this)' title='Sales Staff'><i class='fa fa-user'></i></a></td>";
                    htmlstr = htmlstr + "<td><a class='btn btn-primary' onclick='OpenDiscountDialog(this);'><i class='fa fa-minus' title='Discount'></i></a></td>";
                    htmlstr = htmlstr + "<td style='display:none;'><a class='btn btn-primary' onclick='EditItem(this);'><i class='fa fa-edit' title='Edit Items'></i></a></td>";
                    htmlstr = htmlstr + "<td style='display:none;'><a class='btn btn-danger' onclick='RemoveItem(this)' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>";
                }
                else {
                    //Changed by ZawZO on 11 Dec 2015
                    if (posstatus == "ACTIVE") {
                        htmlstr = htmlstr + "<td><a class='btn btn-warning' onclick='ShowStaffs(this)' title='Sales Staff'><i class='fa fa-user'></i></a></td>";
                        htmlstr = htmlstr + "<td><a class='btn btn-primary' onclick='OpenDiscountDialog(this);'><i class='fa fa-minus' title='Discount'></i></a></td>";
                        htmlstr = htmlstr + "<td style='display:none;'><a class='btn btn-primary' onclick='EditItem(this);'><i class='fa fa-edit' title='Edit Items'></i></a></td>";
                        htmlstr = htmlstr + "<td style='display:none;'><a class='btn btn-danger' onclick='RemoveItem(this)' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>";
                    }
                    else {
                        htmlstr = htmlstr + "<td style='width:51px'></td><td style='width:51px'></td><td style='width:51px;display:none;'></td><td style='width:display:none;'></td>";
                    }
                }
                htmlstr = htmlstr + "<td style='display:none'>" + data[x].category + "</td><td style='display:none'>" + data[x].categorysub + "</td><td style='display:none'>" + data[x].brand + "</td><td style='display:none'>" + data[x].RangesNSeries + "</td>";
                //Added by ZawZO on 19 Aug 2016
                htmlstr = htmlstr + "<td style='display:none'>" + data[x].awardbonus + "</td><td style='display:none'>" + data[x].awarddollars + "</td>";
                htmlstr = htmlstr + "</tr>";
            }
        }
        $("#tblItem > tbody").append(htmlstr);
        fillItemTable(x + 1);
    }
    //Added by ZawZO on 21 Jan 2016
    function getItemDetailFromFacilityOrder() {
        var soid = $('#hidsoid').val();
        $.ajax({
            url: '@Url.Action("getItemDetailFromFacilityOrder", "POS")',
            data: { soid: soid },
            type: 'POST',
            success: function (data) {
                populateItemDetailFromFacilityOrder(data);
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });
    }
    //Added by ZawZO on 21 Jan 2016
    function populateItemDetailFromFacilityOrder(data) {
        $('#txtCustomer').attr("disabled", true);
        var htmlstr = "";
        itemcount = 0;
        var x = 0;
        var posid = $('#posid').val();
        var posstatus = $('#status').val().toUpperCase();
        var tot = 0; var disctot = 0;
        if (data) {
            for (x; x < data.length; x++) {
                itemcount++;

                if (data[x].status == "VOID")
                    htmlstr = htmlstr + "<tr style='color:red;'>";
                else
                    htmlstr = htmlstr + "<tr>";

                htmlstr = htmlstr + "<td>" + data[x].lineno + "</td><td style='display:none'>" + data[x].id + "</td><td style='display:none'>" + data[x].productid + "</td>";
                htmlstr = htmlstr + "<td style='display:none'>" + data[x].productcode + "</td><td style='text-align:left;'>" + data[x].productdesc + "</td>";
                htmlstr = htmlstr + "<td style='display:none'>" + data[x].servicecommission + "</td><td>" + data[x].unitprice.toFixed(2) + "</td>";
                htmlstr = htmlstr + "<td>" + data[x].qty + "</td><td>" + data[x].uom + "</td><td style='display:none'>" + data[x].discountpercent + "</td>";


                htmlstr = htmlstr + "<td>" + data[x].discountamount.toFixed(2) + "</td><td>" + data[x].lineamount.toFixed(2) + "</td>";
                tot = tot + data[x].lineamount.toFixed(2);
                disctot = disctot + data[x].discountamount;
                htmlstr = htmlstr + "<td>" + (data[x].awardbonus * data[x].qty).toFixed(2) + "</td><td>" + (data[x].awarddollars * data[x].qty).toFixed(2) + "</td><td>" + data[x].status + "</td>";
                if (posid == "0") {
                    htmlstr = htmlstr + "<td><a class='btn btn-warning' onclick='ShowStaffs(this)' title='Sales Staff'><i class='fa fa-user'></i></a></td>";
                    htmlstr = htmlstr + "<td><a class='btn btn-primary' onclick='OpenDiscountDialog(this);'><i class='fa fa-minus' title='Discount'></i></a></td>";
                    htmlstr = htmlstr + "<td style='display:none;'><a class='btn btn-primary' onclick='EditItem(this);'><i class='fa fa-edit' title='Edit Items'></i></a></td>";
                    htmlstr = htmlstr + "<td style='display:none;'><a class='btn btn-danger' onclick='RemoveItem(this)' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>";
                }
                else {
                    if (posstatus == "ACTIVE") {
                        htmlstr = htmlstr + "<td><a class='btn btn-warning' onclick='ShowStaffs(this)' title='Sales Staff'><i class='fa fa-user'></i></a></td>";
                        htmlstr = htmlstr + "<td><a class='btn btn-primary' onclick='OpenDiscountDialog(this);'><i class='fa fa-minus' title='Discount'></i></a></td>";
                        htmlstr = htmlstr + "<td><a class='btn btn-primary' onclick='EditItem(this);'><i class='fa fa-edit' title='Edit Items'></i></a></td>";
                        htmlstr = htmlstr + "<td><a class='btn btn-danger' onclick='RemoveItem(this)' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>";
                    }
                    else {
                        htmlstr = htmlstr + "<td style='width:51px'></td><td style='width:51px'></td><td style='width:51px;display:none;'></td><td style='width:51px;display:none;'></td>";
                    }
                }
                htmlstr = htmlstr + "<td style='display:none'>" + data[x].category + "</td><td style='display:none'>" + data[x].categorysub + "</td><td style='display:none'>" + data[x].brand + "</td><td style='display:none'>" + data[x].RangesNSeries + "</td>";
                //Added by ZawZO on 19 Aug 2016
                htmlstr = htmlstr + "<td style='display:none'>" + data[x].awardbonus + "</td><td style='display:none'>" + data[x].awarddollars + "</td>";
                htmlstr = htmlstr + "<td style='display:none'>" + data[x].detailid + "</td>";
                htmlstr = htmlstr + "</tr>";
            }
        }

        $("#tblItem > tbody").append(htmlstr);

        //var subtot = tot / (1 + (parseFloat($("#gstpercent").val()) / 100.0));

        //subtot = subtot.round(2);
        //var gst = subtot * (parseFloat($("#gstpercent").val()) / 100.0);
        //gst = gst.round(2);
        //if ((gst + subtot) != tot)
        //    gst = gst + (tot - (gst + subtot));
        //$('#txtSubTotal').val(subtot);
        //$('#txtDiscount').val(disctot.toFixed(2));
        //$("#txtGST").val(gst.round(2));

        calculateSubTotal();
        calculateTotal();
        fillItemTable(x + 1);
    }

    function fillItemTable(r) {
        var htmlstr = "";
        var posid = $('#posid').val();
        var posstatus = $('#status').val().toUpperCase();
        if (itemcount < 5) {
            for (var x = r; x <= 5; x++) {
                htmlstr = htmlstr + "<tr><td>" + x + "</td><td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='text-align:left;'></td>";
                //Changed by ZawZO on 19 Aug 2016
                htmlstr = htmlstr + "<td style='display:none'></td><td></td><td></td><td></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td></td><td></td><td></td><td></td><td></td>";
                if (posid == "0") {
                    htmlstr = htmlstr + "<td><a class='btn btn-warning' onclick='ShowStaffs(this)' title='Sales Staff'><i class='fa fa-user'></i></a></td>";
                    htmlstr = htmlstr + "<td><a class='btn btn-primary' onclick='OpenDiscountDialog(this);'><i class='fa fa-minus' title='Discount'></i></a></td>";
                    htmlstr = htmlstr + "<td style='display:none;'><a class='btn btn-primary' onclick='EditItem(this);'><i class='fa fa-edit' title='Edit Items'></i></a></td>";
                    htmlstr = htmlstr + "<td style='display:none;'><a class='btn btn-danger' onclick='RemoveItem(this)' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>";
                }
                else {
                    //Changed by ZawZO on 11 Dec 2015
                    if (posstatus == "ACTIVE") {
                        htmlstr = htmlstr + "<td><a class='btn btn-warning' onclick='ShowStaffs(this)' title='Sales Staff'><i class='fa fa-user'></i></a></td>";
                        htmlstr = htmlstr + "<td><a class='btn btn-primary' onclick='OpenDiscountDialog(this);'><i class='fa fa-minus' title='Discount'></i></a></td>";
                        htmlstr = htmlstr + "<td style='display:none;'><a class='btn btn-primary' onclick='EditItem(this);'><i class='fa fa-edit' title='Edit Items'></i></a></td>";
                        htmlstr = htmlstr + "<td style='display:none;'><a class='btn btn-danger' onclick='RemoveItem(this)' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>";
                    }
                    else {
                        htmlstr = htmlstr + "<td></td><td></td><td style='display:none;'></td><td style='display:none;'></td>";
                    }
                }
                htmlstr = htmlstr + "<td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'></td>";
                //Added by ZawZO on 19 Aug 2016
                htmlstr = htmlstr + "<td style='display:none'></td><td style='display:none'></td>";
                htmlstr = htmlstr + "</tr>";
            }
        }


        $("#tblItem > tbody").append(htmlstr);
    }
    function getPayment() {
        var posid = $('#posid').val();
        $.ajax({
            url: '@Url.Action("getPOSPayment", "POS")',
            data: { posid: posid },
            type: 'POST',
            success: function (data) {
                populatePaymentDetail(data);
                calculateChangeBalance();
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });
    }

    function getPreviousPayment() {
        $("#divPreviousPayment").show();
        var posid = $('#posid').val();
        $.ajax({
            url: '@Url.Action("getPreviousPOSPayment", "POS")',
            data: { posid: posid },
            type: 'POST',
            async: false,
            success: function (data) {
                var previousPayments = 0;
                for (var i = 0; i < data.length; i++) {
                    previousPayments += data[i].total_amountreceived;
                }

                $("#txtPreviousPayment").val(previousPayments.toFixed(2));
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });
    }

    function getPreviousPaymentBySOID() {
        $("#divPreviousPayment").show();
        var soid = $('#hidsoid').val();
        $.ajax({
            url: '@Url.Action("getPreviousSOPOSPaymentBySOID", "POS")',
            data: { soid: soid },
            type: 'POST',
            async: false,
            success: function (data) {
                var previousPayments = 0;

                for (var i = 0; i < data.length; i++) {
                    previousPayments += data[i].total_amountreceived;
                }

                $("#txtPreviousPayment").val(previousPayments.toFixed(2));
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });
    }


    @*function getVoidedBySOID() {

        var soid = $('#hidsoid').val();
        $.ajax({
            url: '@Url.Action("getVoidedBySOID", "POS")',
            data: { soid: soid },
            type: 'POST',
            async: false,
            success: function (data) {
                var refund = 0;

                for (var i = 0; i < data.length; i++) {
                    refund += data[i].total_amountrefund;
                }

                $("#txtRefund").val(refund.toFixed(2));
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });
    }*@

    function getSaleStaffs() {
        var posid = $('#posid').val();
        $.ajax({
            url: '@Url.Action("getSaleStaffs", "POS")',
            data: { posid: posid },
            type: 'POST',
            success: function (data) {
                Staffs = data;
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });
    }

    function populatePaymentDetail(data) {
        var htmlstr = "";
        pcount = 0;
        if (data) {
            for (var x = 0; x < data.length; x++) {
                pcount++;
                htmlstr += "<tr><td>" + pcount + "</td><td style='text-align:left;'>" + data[x].paymentmode + "</td>";
                htmlstr += "<td>" + data[x].amountrecd.toFixed(2) + "</td>";
                if ($('#status').val().toUpperCase() == "CLOSE" || $('#status').val().toUpperCase() == "VOID") {
                    //Changed by ZawZO on 17 Mar 2016, to hide buttons on payment grid when status is Closed or void
                    //htmlstr += "<td><a class='btn btn-primary' disabled='disabled' onclick='EditPayment(this);'><i class='fa fa-edit' title='Edit Items'></i></a></td>";
                    //htmlstr += "<td><a class='btn btn-danger' disabled='disabled' onclick='RemovePayment(this)' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>";
                    htmlstr += "<td></td>";
                    htmlstr += "<td></td>";
                }
                else {
                    htmlstr += "<td><a class='btn btn-primary' onclick='EditPayment(this);'><i class='fa fa-edit' title='Edit Items'></i></a></td>";
                    htmlstr += "<td><a class='btn btn-danger' onclick='RemovePayment(this)' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>";
                }
                htmlstr += "<td style='display:none;'>" + data[x].id + "</td></tr>";
            }
        }
        $("#tblPayment > tbody").append(htmlstr);
    }

    function GoBackToSO() {

        var url = "SalesOrder";
        var rcode = $('#rcode').val();
        var form = $('<form action="' + url + '" method="post">' +
            '<input type="hidden" name="id"  id="id" value="' + $("#hidsoid").val() + '" />' +
            '<input type="hidden" name="rcode"  id="rcode" value="' + rcode + '" />' +
            '</form>');
        $('body').append(form);
        $(form).submit();

    }
    function OpenPaymentDialog() {
        if ($('#txtCustomer').val().trim() == "") {
            var msg = "Please key in customer.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            $('#txtCustomer').focus();
            return false;
        }
        else if ($('#cbobkstaff').val().trim() == "") {
            var msg = "Please key in staff.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            $('#cbobkstaff').focus();
            return false;
        }
        else {
            //var posid = $('#posid').val();
            //window.open("../Reports/Signature_Pad.aspx?id=" & posid, "_blank", "width=250, height=180");
            //Added by ZawZO on 13 May 2015
            var bal = $('#txtBalance').val();
            $('#txtplineno').val(0);
            //Changed by ZawZO on 13 May 2015
            $('#txtPaidAmount').val(bal);
            //Added by ZawZO on 16 Dec 2015
            $('#tblPMode > tbody > tr').each(function (i, row) {
                if (i == 0) {
                    var txts = $(row).find('input');
                    $(txts[0]).val(bal);
                }
            });
            $('#Payment_dialog-modal').dialog('open');
        }
    }

    function closePaymentDialog() {
        $('#Payment_dialog-modal').dialog("close");
    }

    function SavePayment() {
        $("#tblPayment > tbody").empty(); pcount = 0;
        $('#tblPMode > tbody > tr').each(function (i, row) {
            i = i + 1;
            var tds = $(row).find('td');
            var txts = $(row).find('input');
            var Amt = $(txts[0]).val();
            if (Amt > 0) {
                pcount++;
                $("#tblPayment > tbody").append("<tr><td>" + pcount + "</td><td style='text-align:left;'>" + tds.eq(0).html() + "</td><td>" + parseFloat(Amt).toFixed(2) + "</td><td><a class='btn btn-primary' onclick='EditPayment(this);'><i class='fa fa-edit' title='Edit Items'></i></a></td><td><a class='btn btn-danger' onclick='RemovePayment(this)' title='Remove Item'><i class='fa fa-trash-o '></i></a></td><td style='display:none;'>0</td></tr>");
            }
            if (Amt < 0) {
                pcount++;
                $("#tblPayment > tbody").append("<tr><td>" + pcount + "</td><td style='text-align:left;'>Refund</td><td>" + Math.abs(parseFloat(Amt).toFixed(2)) + "</td><td><a class='btn btn-primary' onclick='EditPayment(this);'><i class='fa fa-edit' title='Edit Items'></i></a></td><td><a class='btn btn-danger' onclick='RemovePayment(this)' title='Remove Item'><i class='fa fa-trash-o '></i></a></td><td style='display:none;'>0</td></tr>");

            }

        });
        $('#Payment_dialog-modal').dialog("close");
        $("#btnPOSClose").attr("disabled", true);
        calculateChangeBalance();
        $('#tblPMode > tbody > tr').each(function (i, row) {
            var txts = $(row).find('input');
            $(txts[0]).val('');
        });


    }


    function RemovePayment(paramtr) {
        $(paramtr).closest('tr').remove(); pcount--;
        $("#btnPOSClose").attr("disabled", true);
        //Added by ZawZO on 13 May 2015, to refresh balance after remvoving payment record.
        calculateChangeBalance();
    }
    function RemoveItem(paramtr) {
        if (itemcount > 5) {
            $(paramtr).closest('tr').remove(); itemcount--;
        }
        else {

            $(paramtr).closest('tr').remove(); itemcount--;
            fillItemTable(5);

        }
        lineNoReorder();
        //clearProductBundleDetailgrd();
        calculateSubTotal();
        $("#btnPOSClose").attr("disabled", true);

    }
    //Added by ZawZO on 30 Nov 2015
    function lineNoReorder() {
        var table = document.getElementById('tblItem');
        var rowCount = table.rows.length;
        var noRowSelected = 1;
        for (var i = 1; i < rowCount; i++) {
            var row = table.rows[i];
            row.cells[0].innerHTML = i;
        }
    }
    function OpenDiscountDialog(paramtr) {
        //Changed by ZawZO on 13 May 2015
        var tds = $(paramtr).closest('tr').find('td');
        selectedprod = new Object();
        selectedprod.id = tds.eq(2).html();
        selectedprod.productcode = tds.eq(3).html();
        selectedprod.desc = tds.eq(4).html();
        selectedprod.servicecommission = tds.eq(5).html();
        selectedprod.sellprice = tds.eq(6).html();
        selectedprod.uom = tds.eq(8).html();
        selectedprod.category = tds.eq(19).html();
        selectedprod.categorysub = tds.eq(20).html();
        selectedprod.brand = tds.eq(21).html();
        selectedprod.RangesNSeries = tds.eq(22).html();

        selectedprod.awardbonus = tds.eq(23).html();
        selectedprod.awarddollars = tds.eq(24).html();
        selectedprod.detailid = tds.eq(25).html();

        oldpid = tds.eq(0).html();
        $('#cbodispercent').val(tds.eq(9).html())
        $('#txtQty').val(tds.eq(7).html());
        $('#divDiscLogInErr').html('');
        $('#txtDisUserName').val('');
        $('#txtDisPassword').val('');
        $('#Discount_dialog-modal').dialog('open');
    }
    //Added by ZawZO on 14 May 2015
    function closeDiscountDialog() {
        $('#Discount_dialog-modal').dialog("close");
    }
    //Added by ZawZO on 14 May 2015
    function loginForDisPercent() {
        var disusername = $('#txtDisUserName').val();
        var dispwd = $('#txtDisPassword').val();
        var dispercent = $('#cbodispercent').val();
        $.ajax({
            url: '@Url.Action("getDiscpercentbyUserName", "POS")',
            data: JSON.stringify({ uname: disusername, pwd: dispwd }),
            type: 'POST',
            async: false,
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                if (data != '-1') {
                    //Changed by ZawZO on 17 Dec 2015

                    var lno = oldpid;
                    var trs = $('#tblItem > tbody').find('tr');
                    var Qty = $('#txtQty').val();
                    var discamt = (selectedprod.sellprice * Qty) * (dispercent / 100);
                    var tot = (selectedprod.sellprice * Qty) - discamt.toFixed(2);
                    var rowhtml = "<td>" + lno + "</td><td style='display:none'>" + itemid + "</td><td style='display:none'>" + selectedprod.id + "</td>"
                        + "<td style='display:none'>" + selectedprod.productcode + "</td><td style='text-align:left;'>" + selectedprod.desc + "</td>"
                        + "<td style='display:none'>" + selectedprod.servicecommission + "</td><td>" + selectedprod.sellprice + "</td>"
                        + "<td>" + $('#txtQty').val() + "</td><td>" + selectedprod.uom + "</td><td style='display:none'>" + dispercent + "</td>"
                        + "<td>" + discamt.toFixed(2) + "</td><td>" + tot.toFixed(2) + "</td>"
                        + "<td>" + (selectedprod.awardbonus * Qty).toFixed(2) + "</td><td>" + (selectedprod.awarddollars * Qty).toFixed(2) + "</td>"
                        + "<td></td>"
                        + "<td><a class='btn btn-warning' onclick='ShowStaffs(this)' title='Sales Staff'><i class='fa fa-user'></i></a></td>"
                        + "<td><a class='btn btn-primary' onclick='OpenDiscountDialog(this);'><i class='fa fa-minus' title='Discount'></i></a></td>"
                        + "<td style='display:none;'><a class='btn btn-primary' onclick='EditItem(this);'><i class='fa fa-edit' title='Edit Items'></i></a></td>"
                        + "<td style='display:none;'><a class='btn btn-danger' onclick='RemoveItem(this)' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>"
                        + "<td style='display:none'>" + selectedprod.category + "</td><td style='display:none'>" + selectedprod.categorysub + "</td>"
                        + "<td style='display:none'>" + selectedprod.brand + "</td><td style='display:none'>" + selectedprod.RangesNSeries + "</td>"
                        + "<td style='display:none'>" + selectedprod.awardbonus + "</td><td style='display:none'>" + selectedprod.awarddollars + "</td><td style='display:none'>" + selectedprod.detailid + "</td>"

                    var trobj = trs[oldpid - 1];
                    $(trobj).html(rowhtml);

                    $('#txtDisUserName').val("");
                    $('#txtDisPassword').val("");
                    $('#cbodispercent').val("");
                    $('#txtQty').val("");
                    $('#Discount_dialog-modal').dialog("close");
                    calculateSubTotal();
                }
                else {
                    $('#divDiscLogInErr').html('Invalid User Name or Password.');
                }
            },
            error: function (req, status, err) {
                showMessage(err, "error");
                $('#divDiscLogInErr').html('Invalid User Name or Password.');
            }
        });
    }
    //Added by ZawZO on 22 Mar 2016
    function OpenMiscLoginDialog() {
        $('#divMiscLogInErr').html('');
        $('#txtMiscUserName').val('');
        $('#txtMiscPassword').val('');
        $('#Misc_Entry_LogIn_dialog-modal').dialog('open');
    }
    //Added by ZawZO on 22 Mar 2016
    function closeMiscLoginDialog() {
        $('#Misc_Entry_LogIn_dialog-modal').dialog("close");
    }
    //Added by ZawZO on 22 Mar 2016
    function loginForMiscDialog() {
        var miscusername = $('#txtMiscUserName').val();
        var miscpwd = $('#txtMiscPassword').val();
        $.ajax({
            url: '@Url.Action("isValidUserForMiscEntry", "POS")',
            data: JSON.stringify({ uname: miscusername, pwd: miscpwd }),
            type: 'POST',
            async: false,
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                if (data == '1') {
                    $('#txtMiscUserName').val("");
                    $('#txtMiscPassword').val("");
                    $('#Misc_Entry_LogIn_dialog-modal').dialog("close");
                    OpenMiscEntryDialog();
                }
                else {
                    $('#divMiscLogInErr').html('Invalid User Name or Password.');
                    $('#txtMiscUserName').focus();
                }
            },
            error: function (req, status, err) {
                showMessage(err, "error");
                $('#divMiscLogInErr').html('Invalid User Name or Password.');
            }
        });
    }
    //Added by ZawZO on 22 Mar 2016
    function OpenMiscEntryDialog() {
        $('#divMiscEntryErr').html('');
        $('#txtMiscItemDesc').val('');
        $('#txtMiscPrice').val('');
        $('#Misc_Entry_dialog-modal').dialog('open');
    }
    //Added by ZawZO on 22 Mar 2016
    function closeMiscEntryDialog() {
        $('#Misc_Entry_dialog-modal').dialog("close");
    }
    //Added By ZawZO on 8 Dec 2015
    function showActiveSOList() {
        var oTable = $('#tblActiveSO').dataTable({
            "aaSorting": [[0, "resourcecode"], [1, "desc"]], // Default 1st column sorting
            "bProcessing": true,
            "aoColumnDefs": [
                {
                    "bVisible": false, "aTargets": [0]
                }
            ],
            "aoColumnDefs": [
                {
                    "aTargets": [0],
                    "mRender": function (data, type, full) {
                        if (data) {
                            var ctmp = getDateFromAspString(data);
                            return (ctmp.getDate() + "/" + ctmp.getMonth() + "/" + ctmp.getFullYear());
                        }
                        return "";
                    }
                },
                {
                    "aTargets": [6],
                    "mRender": function (data, type, full) {
                        if (data) {

                            var ptsAwarded = 0;
                            if (full.total_amountreceived != 0)
                                ptsAwarded = 1;

                            var html = "<a class='btn btn-primary btn-sm' onclick='NewPOSFromSO(" + data + "," + ptsAwarded + ");' ><i class='glyphicon glyphicon-edit' title='Edit Items'></i></a>";
                            return html;
                        }
                    }
                }
            ],
            "sAjaxSource": 'getActiveSalesOrderListWithPaging?',
            "bStateSave": true, // Remember paging & filters
            "bDeferRender": false,
            "bServerSide": true,
            "bDestroy": true,
            "oSearch": { "sSearch": "" },
            "aoColumns": [
                         { "sWidth": "80px", "mDataProp": "createdate" }, { "sWidth": "120px", "sClass": "classDataTable", "mDataProp": "resourcecode" }, { "sWidth": "140px", "sClass": "classDataTable", "mDataProp": "cussupname" },
                         { "sWidth": "80px", "mDataProp": "total_amountreceived" }, { "sWidth": "80px", "mDataProp": "total_subtotal" }, { "sWidth": "80px", "mDataProp": "total_total" }, { "sWidth": "80px", "mDataProp": "id" },
            ]
        });
    }
    //Added by ZawZO on 8 Dec 2015
    function selectSalesOrder(btn) {
        btnobj = btn;
    }
    //Added by ZawZO on 8 Dec 2015
    function NewPOSFromSO(id, ptsAwarded) {

        $.ajax({
            url: '@Url.Action("getSalesOrder", "POS")',
            data: JSON.stringify({ soid: id }),
            type: 'POST',
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                if (data) {
                    clearProductInfo();
                    clearProductBundleDetailgrd();

                    populateSOtoNewPOS(data);
                    $("#isPointsAwarded").val(ptsAwarded);

                }
            },
            error: function (req, status, err) {
                showMessage(err, "error");
            }
        });
        $('#mdlActiveSO').find('.close').trigger('click');
    }
    //Added by ZawZO on 13 May 2015
    function populateSOtoNewPOS(data) {
        //$('#posid').val(0);
        CurSOID = data[0].id;
        selectedcust = new Object();
        selectedcust.id = data[0].cussupid;
        selectedcust.inhousecode = data[0].inhousecode;
        selectedcust.cussupname = data[0].cussupname;
        $('#txtcustcode').val(data[0].inhousecode);
        $('#txtcustname').val(data[0].cussupname);
        $('#txtCustomer').val($('#txtcustname').val() + "(" + $('#txtcustcode').val() + ")");
        //Added by ZawZO on 15 Dec 2015
        $('#cbobkstaff').val(data[0].staffid);


        $('#txtRemark').val(data[0].remark);

        var bal = 0;

        //if (data[0].total_amountreceived > data[0].total_total) {
        //    bal = 0;
        //}
        //else {
        bal = (data[0].total_total - data[0].total_amountreceived) + data[0].total_amountrefund;

        //}
        // $('#txtSubTotal').val(bal.toFixed(2));
        $('#txtGST').val(0);
        // $('#txtGrandTotal').val(bal.toFixed(2));
        $('#txtChange').val(0);
        $('#txtBalance').val(bal.toFixed(2));
        //$('#txtRefund').val(data[0].total_amountrefund.toFixed(2));

        $('#txtGrandTotal').val(data[0].total_total.toFixed(2));
        $('#txtRefund').val(data[0].total_amountrefund.toFixed(2));
        $('#txtSubTotal').val(data[0].total_total.toFixed(2));

        $('#btnPay').attr("disabled", false);
        $('#btnPOSClose').attr("disabled", false);
        $('#btnClearItem').attr("disabled", false);
        disableAddingProducts();
        var addPrice = 0;

        $.ajax({
            url: '@Url.Action("getSalesOrderDetails", "POS")',
            data: { soid: data[0].id },
            type: 'POST',
            success: function (oldData) {
                addPrice = 0;
                var soid = $('#hidsoid').val();
                $.ajax({
                    url: '@Url.Action("getItemDetailFromFacilityOrder", "POS")',
                    data: { soid: soid },
                    type: 'POST',
                    success: function (newData) {

                        for (var i = 0; i < newData.length; i++) {

                            var found = false;
                            for (var x = 0; x < oldData.length; x++) {
                                if (oldData[x].detailid == newData[i].detailid) {
                                    found = true;
                                }
                            }

                            if (!found) {
                                var count = oldData.length;
                                newData[i].lineno = count;
                                addPrice = addPrice + newData[i].qty * newData[i].unitprice;
                                oldData.push(newData[i]);
                            }
                        }

                        populateSODetltoItmDetl(oldData, bal);


                        $('#txtGrandTotal').val((data[0].total_total + addPrice).toFixed(2));
                        $('#txtSubTotal').val((data[0].total_total + addPrice).toFixed(2));
                        $('#txtBalance').val((bal + addPrice).toFixed(2));

                        var cashamt = 0;
                        $('#tblPayment > tbody > tr').each(function (i, row) {
                            var tds = $(row).find('td');
                            var amt = parseFloat(tds.eq(2).html());

                            if (tds.eq(1).html() == 'Cash') {
                                cashamt += amt;
                            }

                            if (tds.eq(1).html() == 'Refund') {
                                cashrefund += amt;
                            }
                        });

                        changes = cashamt - oldBalance;



                        if (changes > 0)
                            $('#txtChange').val((changes).toFixed(2));



                        if ($('#txtBalance').val() >= 0) {
                            $("#btnPay").removeAttr("disabled");
                            $("#btnRefund").attr("disabled", true);
                        }
                        else {
                            $("#btnRefund").removeAttr("disabled");
                            $("#btnPay").attr("disabled", true);
                        }

                    },
                    error: function (ts) { showMessage(ts.responseText, "error") }
                });



                $('#btnHold').attr("disabled", true);
                $('#txtCustomer').attr("disabled", true);
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });
    }


    //Added by ZawZO on 13 May 2015
    function populateSODetltoItmDetl(data, bal) {

        var htmlstr = "";
        itemcount = 0;
        var x = 0;
        var posid = $('#posid').val();
        clearInvoiceDetailsgrd();
        if (data) {

            for (x; x < data.length; x++) {
                itemcount++;

                if (data[x].status == "VOID")
                    htmlstr = htmlstr + "<tr style='color:red;'>";
                else
                    htmlstr = htmlstr + "<tr>";

                htmlstr = htmlstr + "<td>" + data[x].lineno + "</td><td style='display:none'>" + data[x].id + "</td><td style='display:none'>" + data[x].productid + "</td>";
                htmlstr = htmlstr + "<td style='display:none'>" + data[x].productcode + "</td><td style='text-align:left;'>" + data[x].productdesc + "</td>";
                htmlstr = htmlstr + "<td style='display:none'>" + data[x].servicecommission + "</td>";
                htmlstr = htmlstr + "<td>" + data[x].unitprice.toFixed(2) + "</td>";
                htmlstr = htmlstr + "<td>" + data[x].qty + "</td><td>" + data[x].uom + "</td>";
                htmlstr = htmlstr + "<td style='display:none'>0</td><td>" + data[x].discountamount.toFixed(2) + "</td>";

                htmlstr = htmlstr + "<td>" + ((data[x].qty * data[x].unitprice) - data[x].discountamount).toFixed(2) + "</td>";
                htmlstr = htmlstr + "<td>0</td><td>0</td>";
                if (data[x].status == null) {
                    htmlstr = htmlstr + "<td></td>";
                }
                else {
                    htmlstr = htmlstr + "<td>" + data[x].status + "</td>";
                }


                htmlstr = htmlstr + "<td style='width:51px'></td><td style='width:51px'></td><td style='width:51px;display:none;'></td><td style='width:51px;display:none;'></td>";
                htmlstr = htmlstr + "<td style='display:none'>" + data[x].category + "</td><td style='display:none'>" + data[x].categorysub + "</td>";
                htmlstr = htmlstr + "<td style='display:none'>" + data[x].brand + "</td><td style='display:none'>" + data[x].RangesNSeries + "</td>";
                //Added by ZawZO on 19 Aug 2016
                htmlstr = htmlstr + "<td style='display:none'>" + data[x].awardbonus + "</td><td style='display:none'>" + data[x].awarddollars + "</td>";
                htmlstr = htmlstr + "<td style='display:none'>" + data[x].detailid + "</td>";
                htmlstr = htmlstr + "</tr>";


            }
        }

        $("#tblItem > tbody").append(htmlstr);
        fillItemTableforNewSO(x + 1);
    }
    function fillItemTableforNewSO(r) {
        var htmlstr = "";
        if (itemcount < 5) {
            for (var x = r; x <= 5; x++) {

                htmlstr = htmlstr + "<tr><td>" + x + "</td><td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='text-align:left;'>";
                htmlstr = htmlstr + "</td><td style='display:none'></td><td></td><td></td>";
                htmlstr = htmlstr + "<td></td><td style='display:none'></td><td></td><td></td><td></td><td></td><td></td>";
                htmlstr = htmlstr + "<td></td><td></td><td style='display:none;'></td><td style='display:none;'></td>";
                htmlstr = htmlstr + "<td style='display:none'></td><td style='display:none'></td><td style='display:none'></td><td style='display:none'></td>";
                //Added by ZawZO on 19 Aug 2016
                htmlstr = htmlstr + "<td style='display:none'></td><td style='display:none'></td><td style='display:none'></td>";
                htmlstr = htmlstr + "</tr>";
            }
        }
        $("#tblItem > tbody").append(htmlstr);
    }
    //Added By ZawZO on 9 Dec 2015
    function showSalesKitList() {
        $.ajax({
            url: '@Url.Action("getSalesKitsList", "POS")',
            data: {},
            type: 'POST',
            success: function (data) {
                populateSaleKitsList(data);
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });
    }

    function disableAddingProducts() {
        $('#btnMiscItem').attr("disabled", true);
        $('#btnCatalog').attr("disabled", true);
        $('#btnSalesKit').attr("disabled", true);
        $('#btnAddItem').attr("disabled", true);

    }
    function enableAddingProducts() {
        $('#btnMiscItem').attr("disabled", false);
        $('#btnCatalog').attr("disabled", false);
        $('#btnSalesKit').attr("disabled", false);
        $('#btnAddItem').attr("disabled", false);
        $('#cbobkstaff').attr("disabled", false);
        $('#cbofacility').attr("disabled", false);
    }
    //Added by ZawZO on 14 Dec 2015
    function populateSaleKitsList(data) {
        var htmlstr = ""; var count = 0;
        if (data) {
            for (var x = 0; x < data.length; x++) {
                count++;
                htmlstr += "<div class='col-sm-2'><a class='quick-button' data-toggle='modal' data-target='#mdlSalesKitItem' onclick='displaySalesKitsItemList(" + data[x].id + ")'><i class='fa fa-briefcase'></i><p>" + data[x].desc + "</p></a></div>";
                if ((count % 6) == 0) {
                    htmlstr += "<div class='clearfix'></div><br/>";
                }
            }
            if ((count % 6) != 0) {
                htmlstr += "<div class='clearfix'></div><br/>";
            }
            //Added by ZawZO on 17 Mar 2016
            htmlstr += "<div class='row'>"
            htmlstr += "<div class='col-lg-13'>";
            htmlstr += "<div style='padding:10px 10px 0px 0px; text-align:right;'>";
            htmlstr += "<button type='button' id='btnSaleKitItemClose' class='btn btn-success' style='background-color: #931313; width: 55px;' onclick='closeSalesKitDialog();'>Close</button>";
            htmlstr += "</div></div></div>";

            $('#divSalesKitList').html(htmlstr);
        }
    }
    //Added by ZawZO on 8 Dec 2015
    function selectSalesKit(btn) {
        btnosaleskitbj = btn;
    }
    //Added By ZawZO on 11 Dec 2015
    function showSalesKitItemList(skid) {
        $.ajax({
            url: '@Url.Action("getSalesKitItemList", "POS")',
            data: { skpid: skid },
            type: 'POST',
            success: function (data) {
                populateSaleKitItemsList(data);
            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });
    }
    //Added by ZawZO on 14 Dec 2015
    function populateSaleKitItemsList(data) {
        var htmlstr = "";
        var count = 0
        if (data) {
            for (var x = 0; x < data.length; x++) {
                count++;
                var itemdisplay = data[x].desc + "<br>" + "$ " + data[x].sellprice;
                //Added by ZawZO on 7 Jun 2016
                var isExist = isalredyexistSalesKitItem(data[x].productcode);

                htmlstr += "<div class='col-sm-2'><a class='quick-button' onclick='populateSalesKitDtlstogrd(" + data[x].id + ")'><i class='fa fa-briefcase'></i><p>" + itemdisplay + "</p>";
                //Changed by ZawZO on 7 Jun 2016
                if (isExist == 1) {
                    htmlstr += "</a><input type='checkbox' id='" + data[x].id + "' disabled='disabled' checked></div>";
                }
                else {
                    htmlstr += "</a><input type='checkbox' id='" + data[x].id + "' disabled='disabled'></div>";
                }

                if ((count % 5) == 0) {
                    htmlstr += "<div class='clearfix'></div><br/>";
                }
            }
            if ((count % 5) != 0) {
                htmlstr += "<div class='clearfix'></div><br/>";
            }
            //Added by ZawZO on 17 Mar 2016
            htmlstr += "<div class='row'>";
            htmlstr += "<div class='col-lg-13'>";
            htmlstr += "<div style='padding:10px 10px 0px 0px; text-align:right;'>";
            htmlstr += "<button type='button' id='btnSaleKitClose' class='btn btn-success' style='background-color: #931313; width: 55px;' onclick='closeSalesKitItemDialog();'>Close</button>";
            htmlstr += "</div></div></div>";

            $('#divSalesKitItemList').html(htmlstr);
        }
    }
    //Added by ZawZO on 7 Jun 2016
    function isalredyexistSalesKitItem(pcode) {
        var isExist = 0;
        var trs = $('#tblItem > tbody  >tr').each(function (i, row) {
            var tds = $(row).find('td');
            var productcode = tds.eq(3).html();
            if (productcode == pcode) {
                isExist = 1;
            }
        });
        return isExist;
    }
    //Added by ZawZO on 12 Dec 2015
    function populateSalesKitDtlstogrd(pId) {
        if (document.getElementById(pId).checked) {
            alert("This sale kit item was already added before.");
        }
        else {

            var trobj;
            var trs = $('#tblItem > tbody').find('tr');
            itemcount++;
            var rowhtml = "";
            var lno = itemcount;
            $.ajax({
                url: '@Url.Action("getSalesKitItemDetail", "POS")',
                data: { pid: pId },
                async: false,
                type: 'POST',
                success: function (data) {
                    if (data) {
                        var total = data[0].sellprice;
                        rowhtml = "<td>" + lno + "</td><td style='display:none'>" + itemid + "</td><td style='display:none'>" + data[0].id + "</td>"
                           + "<td style='display:none'>" + data[0].productcode + "</td><td style='text-align:left;'>" + data[0].desc + "</td>"
                           + "<td style='display:none'>" + data[0].servicecommission + "</td><td>" + data[0].sellprice + "</td><td>1</td>"
                           + "<td style='text-align:left;'>" + data[0].uom + "</td><td style='display:none'>0</td><td style='text-align:right;'>0.0</td>"
                           + "<td style='text-align:right;'>" + total + "</td>"
                           + "<td>" + (data[0].awardbonus * 1) + "</td><td>" + (data[0].awarddollars * 1) + "</td>"
                           + "<td><a class='btn btn-warning' onclick='ShowStaffs(this)' title='Sales Staff'><i class='fa fa-user'></i></a></td>"
                           + "<td><a class='btn btn-primary' onclick='OpenDiscountDialog(this)'><i class='fa fa-minus' title='Discount'></i></a></td>"
                           + "<td><a class='btn btn-primary' onclick='EditItem(this)'><i class='fa fa-edit' title='Edit Items'></i></a></td>"
                           + "<td><a class='btn btn-danger' onclick='RemoveItem(this)' title='Remove Item'><i class='fa fa-trash-o'></i></a></td>"
                           + "<td style='display:none'>" + data[0].category + "</td><td style='display:none'>" + data[0].categorysub + "</td>"
                           + "<td style='display:none'>" + data[0].brand + "</td><td style='display:none'>" + data[0].rangesNSeries + "</td>"
                           + "<td style='display:none'>" + data[0].awardbonus + "</td><td style='display:none'>" + data[0].awarddollars + "</td>"
                    }
                },
                error: function (ts) { showMessage(ts.responseText, "error") }
            });

            if (itemcount <= 5) {
                trobj = trs[itemcount - 1];
                $(trobj).html(rowhtml);
            }
            else {
                $("#tblItem > tbody").append("<tr>" + rowhtml + "</tr>");
            }
            ItemUpdateFlag = 0;
            itemid = 0;
            document.getElementById(pId).checked = true;

            calculateSubTotal();
        }

    }
    //Added by ZawZO on 8 Dec 2015
    function displaySalesKitsItemList(pID) {
        $('#mdlSalesKit').find('.close').trigger('click');
        showSalesKitItemList(pID);
    }
    //Added by ZawZO on 17 Mar 2016
    function closeSalesKitItemDialog() {
        $('#mdlSalesKitItem').find('.close').trigger('click');
    }
    //Added by ZawZO on 17 Mar 2016
    function closeSalesKitDialog() {
        $('#mdlSalesKit').find('.close').trigger('click');
    }
    function clearInvoiceDetailsgrd() {
        $("#tblItem > tbody").empty();
    }
    //Added by ZawZO on 17 Mar 2016
    function clearUnclosedInvoiceDetailsgrd() {
        clearInvoiceDetailsgrd();
        fillItemTable(1);
        calculateSubTotal();
        itemcount = 0;
    }
    function clearPaymentsgrd() {
        $("#tblPayment > tbody").empty();
    }
    function ShowStaffs(paramtr) {
        var tds = $(paramtr).closest('tr').find('td');
        itemid = tds.eq(1).html();
        oldpid = tds.eq(0).html();
        showStaffGrid(Staffs);
        $('#Staff_dialog-modal').dialog('open');
    }
    function showStaffGrid(data) {
        var htmlstr = "<table class='table table-striped table-bordered' id ='tblSalesStaff' style='overflow-x:scroll;width:100%;'><thead><tr><td style='display:none'>index</td><td style='display:none'>ID</td><td style='display:none'>StaffID</td><td style='width:80px;'>Sr.</td><td>Name</td><td style='width:80px;'>Persent</td><td style='width:50px;'></td></tr></thead><tbody>";
        var x = 0;
        stblrowcount = 0;
        if (data) {
            for (x; x < data.length; x++) {
                if (data[x].oldpid == oldpid) {
                    htmlstr = htmlstr + "<tr><td style='display:none'>" + x + "</td><td style='display:none'>" + data[x].id + "</td><td style='display:none'>" + data[x].staffid + "</td><td><input class='form-control' type='text' value ='" + (stblrowcount + 1) + "' /></td></td><td ><select v='" + data[x].staffid + "' class='form-control' >" + $('#cbostaff').html() + "</select></td></td><td style='text-align:right;'><input class='form-control' type='text' value='" + data[x].percent + "' /></td>"
                    + "<td><a class='btn btn-danger' onclick='RemoveStaff(this)' title='Remove Item'><i class='fa fa-trash-o '></i></a></td></tr>";
                    stblrowcount++;
                }
            }
        }
        if (stblrowcount > 0) {
            $('#divSalesStaff').html(htmlstr + "</tbody></table>");

            $("#tblSalesStaff > tbody > tr").find('select').each(function (index) {
                $(this).val($(this).attr("v"));
            });
        }
        else {
            htmlstr = htmlstr + "<tr><td style='display:none'>-1</td><td style='display:none'>0</td><td style='display:none'>0</td><td><input class='form-control' type='text' value ='" + (stblrowcount + 1) + "' /></td></td><td ><select class='form-control' >" + $('#cbostaff').html() + "</select></td></td><td style='text-align:right;'><input class='form-control' type='text' value='100' /></td>"
            + "<td><a class='btn btn-danger' onclick='RemoveStaff(this)' title='Remove Item'><i class='fa fa-trash-o '></i></a></td></tr>";
            stblrowcount++;
            $('#divSalesStaff').html(htmlstr + "</tbody></table>");
        }
    }

    function closeStaffDialog() {
        $('#Staff_dialog-modal').dialog("close");
    }

    function RemoveStaff(paramtr) {
        var tds = $(paramtr).closest('tr').find('td');
        var itemindex = tds.eq(0).html();
        Staffs.splice(itemindex, 1);
        showStaffGrid(Staffs);
    }

    function SalesStaffValidation() {
        var totalpercent = 0;
        $('#tblSalesStaff > tbody > tr').each(function (i, row) {
            var txts = $(row).find('input');
            totalpercent += parseInt($(txts[1]).val());

        });
        if (totalpercent != 100) {
            var attrvalue = '{"text":"Total Sales Percentage must be 100 for sales staff.","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }
        else {
            return true;
        }
    }

    function SalesSaffSave() {
        var posid = $('#posid').val();
        var sindex = 0;

        $('#tblSalesStaff > tbody  > tr').each(function (index) {
            var tds = $(this).find('td');
            var txts = $(this).find('input');

            sindex = tds.eq(0).html();
            if (sindex == "-1") {
                var obj = new Object();
                obj.id = 0;
                obj.invoiceid = posid;
                obj.oldpid = oldpid;
                obj.lineno = $(txts[0]).val();
                obj.staffid = $(this).find('select').val();
                obj.percent = $(txts[1]).val();
                Staffs.push(obj);
            }
            else {
                Staffs[sindex].lineno = $(txs[0]).val();
                Staffs[sindex].staffid = $(this).find('select').val();
                Staffs[sindex].percent = $(txts[1]).val();
            }
        });

        $('#Staff_dialog-modal').dialog('close');
    }

    function StaffNewRow() {
        if (stblrowcount < 3) {
            var percent = 0;
            if (stblrowcount == 0)
            { percent = 100; }
            else if (stblrowcount == 1)
            { percent = 50; }
            else
            { percent = 33; }
            var Htmlstr = "<tr id='S_0'><td style='Display:none;'>-1</td><td style='Display:none;'>0</td><td style='Display:none;'>0</td>" + "<td ><input class='form-control' type='text' value ='" + (stblrowcount + 1) + "' /></td><td ><select class='form-control' >" + $('#cbostaff').html() + "</select></td><td ><input class='form-control' type='text' value='" + percent + "' /></td>";
            Htmlstr += "<td><a class='btn btn-danger'  onclick='RemoveStaff(this)' title ='Remove Staff'><i class='fa fa-trash-o '></i></a></td></tr>";
            $("#tblSalesStaff").append(Htmlstr);
            stblrowcount++;

            var trs = $("#tblSalesStaff > tbody").find('tr');
            if (trs.length == 2) {
                var tds = $(trs[0]).find('td');
                var txts = tds.eq(5).find('input');
                $(txts).val(50);
            }
            else if (trs.length == 3) {
                var tds = $(trs[0]).find('td');
                var txts = tds.eq(5).find('input');
                $(txts).val(34);
                var tds2 = $(trs[1]).find('td');
                var txts2 = tds2.eq(5).find('input');
                $(txts2).val(33);
            }
        }
    }
    function EditItem(paramtr) {
        selectedItemTr = paramtr;
        ItemUpdateFlag = 1;
        $('#btnAddItem').text("Update Item");
        var tds = $(paramtr).closest('tr').find('td');
        if (tds.eq(10).html().trim() == "") return false;
        itemid = tds.eq(1).html();
        $('#txtProduct').val(tds.eq(4).html());
        $('#txtQty').val(tds.eq(7).html())
        $('#txtUnitPrice').val(tds.eq(6).html());
        $('#txtProdDescription').val($('#txtProduct').val() + " : " + tds.eq(3).html() + "\n" + tds.eq(18).html() + "," + tds.eq(19).html() + "," + tds.eq(20).html() + "," + tds.eq(21).html() + "\n" + "UOM :" + tds.eq(8).html());
        $('#txtRwdPts').val(tds.eq(22).html());
        $('#txtCitiPts').val(tds.eq(23).html());

        selectedprod = new Object();
        selectedprod.id = tds.eq(2).html();
        selectedprod.productcode = tds.eq(3).html();
        selectedprod.desc = tds.eq(4).html();
        selectedprod.servicecommission = tds.eq(5).html();
        selectedprod.sellprice = tds.eq(6).html();
        selectedprod.uom = tds.eq(8).html();
        selectedprod.category = tds.eq(18).html();
        selectedprod.categorysub = tds.eq(19).html();
        selectedprod.brand = tds.eq(18).html(20);
        selectedprod.RangesNSeries = tds.eq(21).html();
        //Added by ZawZO on 19 Aug 2016
        selectedprod.awardbonus = tds.eq(22).html();
        selectedprod.awarddollars = tds.eq(23).html();

        oldpid = tds.eq(0).html();
    }
    function catalogItemValidation() {
        if ($('#cboPCat').val().trim() == "") {
            var msg = "Please choose product category.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            $('#cboPCat').focus();
            return false;
        }
        if ($('#cboPSubCat').val().trim() == "") {
            var msg = "Please choose product sub category.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            $('#cboPSubCat').focus();
            return false;
        }
        if ($('#cboBpbrand').val().trim() == "") {
            var msg = "Please choose product brand.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            $('#cboBpbrand').focus();
            return false;
        }
        if ($('#cboBprnc').val().trim() == "") {
            var msg = "Please choose product range and series.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            $('#cboBprnc').focus();
            return false;
        }
        if ($('#cboPUOM').val().trim() == "") {
            var msg = "Please choose product UOM.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            $('#cboPUOM').focus();
            return false;
        }
        if ($('#txtDesc').val().trim() == "") {
            var msg = "Please type in product description.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            $('#txtDesc').focus();
            return false;
        }
        if ($('#txtProductPrice').val().trim() == "") {
            var msg = "Please key in product price.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            $('#txtProductPrice').focus();
            return false;
        }
        return true;
    }
    function miscItemValidation() {
        if ($('#txtMiscItemDesc').val().trim() == "") {
            var msg = "Please key in description.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            $('#txtMiscItemDesc').focus();
            return false;
        }
        if ($('#txtMiscPrice').val().trim() == "") {
            var msg = "Please key in price.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            $('#txtMiscPrice').focus();
            return false;
        }
        return true;
    }
    function addItemValidation() {
        if ($('#txtProduct').val().trim() == "") {
            var msg = "Please key in product.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            $('#txtProduct').focus();
            return false;
        }
        if ($('#txtQty').val().trim() == "") {
            var msg = "Please key in quantity.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            $('#txtQty').focus();
            return false;
        }
        return true;
    }

    function addItem() {

        clearProductBundleDetailgrd();
        var trobj;
        var tds;
        var trs = $('#tblItem > tbody').find('tr')

        if (addItemValidation() == false) return false;

        if (ItemUpdateFlag == 1) {
            $('#btnAddItem').text("Add Item");
        }
        else
            itemcount++;

        var qty = 0;
        var up = 0;

        if ($("#txtQty").val().trim() != "")
            qty = parseInt($("#txtQty").val());
        if ($("#txtUnitPrice").val().trim() != "")
            up = parseFloat($("#txtUnitPrice").val());

        var total = qty * up;
        var lno = itemcount;
        if (ItemUpdateFlag == 1)
            lno = oldpid;

        var rowhtml = "<td>" + lno + "</td><td style='display:none'>" + itemid + "</td><td style='display:none'>" + selectedprod.id + "</td><td style='display:none'>" + selectedprod.productcode + "</td><td style='text-align:left;'>" + selectedprod.desc + "</td><td style='display:none'>" + selectedprod.servicecommission + "</td>"
            + "<td>" + $('#txtUnitPrice').val() + "</td><td>" + $('#txtQty').val() + "</td><td>" + selectedprod.uom + "</td><td style='display:none'>0</td><td>0.0</td><td>" + total.toFixed(2) + "</td>"
            + "<td>" + (selectedprod.awardbonus * $('#txtQty').val()).toFixed(2) + "</td><td>" + (selectedprod.awarddollars * $('#txtQty').val()).toFixed(2) + "</td>"
            + "<td><a class='btn btn-warning' onclick='ShowStaffs(this)' title='Sales Staff'><i class='fa fa-user'></i></a></td>"
            + "<td><a class='btn btn-primary' onclick='OpenDiscountDialog(this);'><i class='fa fa-minus' title='Discount'></i></a></td>"
            + "<td><a class='btn btn-primary' onclick='EditItem(this);'><i class='fa fa-edit' title='Edit Items'></i></a></td>"
            + "<td><a class='btn btn-danger' onclick='RemoveItem(this)' title='Remove Item'><i class='fa fa-trash-o '></i></a></td>"
            + "<td style='display:none'>" + selectedprod.category + "</td><td style='display:none'>" + selectedprod.categorysub + "</td>"
            + "<td style='display:none'>" + selectedprod.brand + "</td><td style='display:none'>" + selectedprod.RangesNSeries + "</td>"
            + "<td style='display:none'>" + selectedprod.awardbonus + "</td><td style='display:none'>" + selectedprod.awarddollars + "</td>";
        if (itemcount <= 5) {
            if (ItemUpdateFlag == 1) {
                trobj = trs[oldpid - 1];
                $(trobj).html(rowhtml);
                $("#btnPOSClose").attr("disabled", true);
            }
            else {
                //Changed by ZawZO on 21 Oct 2015
                trobj = trs[itemcount - 1];
                $(trobj).html(rowhtml);
                $("#btnPOSClose").attr("disabled", true);
            }
        }
        else {
            //Changed by ZawZO on 15 Dec 2015
            if (ItemUpdateFlag == 1) {
                trobj = trs[oldpid - 1];
                $(trobj).html(rowhtml);
            }
            else {
                $("#tblItem > tbody").append("<tr>" + rowhtml + "</tr>");
            }
            $("#btnPOSClose").attr("disabled", true);
        }
        clearProductInfo();
        calculateSubTotal();
        ItemUpdateFlag = 0;
        itemid = 0;
    }

    function clearProductInfo() {
        $('#txtProduct').val("");
        $('#txtQty').val("");
        $('#txtUnitPrice').val("");
        $('#txtProdDescription').val("");
        $('#txtRwdPts').val("");
        $('#txtCitiPts').val("");
    }

    function calculateSubTotal() {
        var total = 0;
        var disctotal = 0;
        //Added by ZawZO on 20 Aug 2016
        var awardbonustotal = 0;
        var awarddollarstotal = 0;

        var trs = $('#tblItem > tbody  >tr').each(function (i, row) {
            var tds = $(row).find('td');
            //Changed by ZawZO ON 18 Dec 2015
            if (tds.eq(11).html().trim() != "") {
                total += parseFloat(tds.eq(11).html());
            }
            if (tds.eq(10).html().trim() != "") {
                disctotal += parseFloat(tds.eq(10).html());
            }
            //Added by ZawZO on 19 Aug 2016
            if (tds.eq(22).html().trim() != "") {
                var awardbonus = tds.eq(22).html();
                if (awardbonus != null) {
                    awardbonustotal += parseFloat(tds.eq(22).html()) * tds.eq(7).html();
                }
            }
            //Added by ZawZO on 19 Aug 2016
            if (tds.eq(23).html().trim() != "") {
                var awarddollars = tds.eq(23).html();
                if (awarddollars != null) {
                    awarddollarstotal += parseFloat(tds.eq(23).html()) * tds.eq(7).html();

                }
            }
        });


        if (isNaN(awarddollarstotal)) {
            awarddollarstotal = 0;
        }

        if (isNaN(awardbonustotal)) {
            awardbonustotal = 0;
        }

        total = total.round(2);
        //Added by ZawZO on 19 Aug 2016
        awardbonustotal = awardbonustotal.round(2);
        awarddollarstotal = awarddollarstotal.round(2);

        var subtotal = total / (1 + (parseFloat($("#gstpercent").val()) / 100.0));
        subtotal = subtotal.round(2);
        var gst = subtotal * (parseFloat($("#gstpercent").val()) / 100.0);
        gst = gst.round(2);
        if ((gst + subtotal) != total)
            gst = gst + (total - (gst + subtotal));

        $('#txtSubTotal').val(subtotal);
        //Added by ZawZO on 19 Aug 2016

        if (awardbonustotal == null || awarddollarstotal == null) {
            awardbonustotal = 0;
            awarddollarstotal = 0;
        }

        $('#txtTotalAwardBonus').val(awardbonustotal.toFixed(2));
        $('#txtTotalAwardCitiDollars').val(awarddollarstotal.toFixed(2));
        //Added by ZawZO on 18 Dec 2015
        $('#txtDiscount').val(disctotal);

        $("#txtGST").val(gst.round(2));
        calculateTotal();
    }

    function calculateTotal() {
        var st = 0;
        var gst = 0;
        var dis = 0;

        if ($("#txtSubTotal").val().trim() != "")
            st = parseFloat($("#txtSubTotal").val());
        if ($("#txtGST").val().trim() != "")
            gst = parseFloat($("#txtGST").val());
        //Changed by ZawZO on 18 Dec 2015

        dis = parseFloat($("#txtDiscount").val());
        //Changed by ZawZO on 6 Jan 2016

        var total = st + gst;
        $('#txtGrandTotal').val(total.toFixed(2));
        calculateChangeBalance();
    }
    //Added by ZawZO on 14 May 2015
    function calcDiscount(subTotal, gstamt) {
        var disPercent = $('#hidDisPercent').val();
        if (disPercent == '')
            disPercent = 0;
        var disAmt = 0;
        disAmt = (subTotal + gstamt) * (disPercent / 100);
        $("#txtDiscount").val(disAmt.toFixed(2));
    }
    function calculateChangeBalance() {
        //Added by ZawZO on 31 Dec 2015

        var cashamt = 0;
        var cashrefund = 0;

        pamount = 0;
        var Grandtot = parseFloat($('#txtGrandTotal').val());
        var prevPayment = parseFloat($('#txtPreviousPayment').val());
        var refund = parseFloat($('#txtRefund').val());

        $('#tblPayment > tbody > tr').each(function (i, row) {
            var tds = $(row).find('td');
            var amt = parseFloat(tds.eq(2).html());
            pamount += amt;
            if (tds.eq(1).html() == 'Cash') {
                cashamt += amt;
            }

            if (tds.eq(1).html() == 'Refund') {
                cashrefund += amt;
            }
        });

        var tmpcal = Grandtot - pamount;
        var changes = 0;
        if (cashamt > 0) {
            changes = cashamt - (Grandtot - prevPayment);
        }
        else {
            changes = 0;
        }


        if (changes > 0) {
            $('#txtChange').val(changes.toFixed(2));
        }
        else {
            $('#txtChange').val("0");
        }

        if (cashrefund > 0) {
            $('#txtRefund').val(cashrefund.toFixed(2));
        }
        else {
            $('#txtRefund').val("0");
        }

        if ($('#status').val().toUpperCase() == "VOID") {
            tmpcal = pamount;
        }

        if (tmpcal < 0) {
            tmpcal = (tmpcal * -1);
            $('#txtBalance').val("0");
        }
        else {
            if ($('#status').val().toUpperCase() == "VOID") {
                $('#txtBalance').val(tmpcal.toFixed(2));
            }
            else {
                if ((tmpcal - prevPayment) - refund < 0) {
                    $('#txtBalance').val("0");
                }
                else {
                    $('#txtBalance').val(((tmpcal - prevPayment) - refund).toFixed(2));
                }
            }

        }
    }
    function goToListing() {
        var url = "POSListing";
        var rcode = $('#rcode').val();
        var form = $('<form action="' + url + '" method="post">' +
          '<input type="hidden" name="rcode"  id="rcode" value="' + rcode + '" />' +
          '</form>');
        $('body').append(form);
        $(form).submit();
    }

    function goToSOListing() {
        var url = "FacilityOrderListing";
        var rcode = $('#rcode').val();
        var form = $('<form action="' + url + '" method="post">' +
          '<input type="hidden" name="rcode"  id="rcode" value="' + rcode + '" />' +
          '</form>');
        $('body').append(form);
        $(form).submit();
    }

    function SaveValidation() {
        if ($('#status').val().toUpperCase() == "CLOSE") {
            if (!isReprintClick) {
                var msg = "System will not allow to edit for closed transaction!";
                var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            }
            showMessage(attrvalue);
            isReprintClick = false;
            printReceipt();
            return false;
        };
        if ($('#status').val().toUpperCase() == "VOID") {
            if (!isReprintClick) {
                var msg = "System will not allow to edit for void transaction!";
                var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            }
            showMessage(attrvalue);
            isReprintClick = false;
            printReceipt();
            return false;
        };

        var tmpcal = total - pamount;

        if (!(selectedcust) || selectedcust == "undefined") {
            var msg = "Please select customer!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }

        //Added by ZawZO on 18 May 2015
        var selStaff = $("#cbobkstaff").val();
        if (selStaff == '' || selStaff == 'undefined') {
            var msg = "Please select sale staff!";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }
    }
    function SavePOS(pflag) {

        var discnt = 0;

        $("#btnReprint").attr("disabled", true);
        $("#btnPOSClose").attr("disabled", true);

        if (SaveValidation() == false) {
            $("#btnReprint").removeAttr("disabled");
            return false;
        }
        var posid = $('#posid').val();
        var obj = new Object();
        //Changed by ZawZO on 7 Dec 2015
        if (pflag == "1") {
            $('#status').val("CLOSE");
            obj.post = 1;
        }
        else {
            $('#status').val("ACTIVE");
            obj.post = 0;
        }
        var s = $('#status').val();
        var itemidArray = "";
        obj.id = posid;
        obj.cussupid = selectedcust.id;
        obj.type = $('#rcode').val();
        obj.cussupname = selectedcust.cussupname;
        //Added by ZawZO on 12 May 2015
        obj.staffid = $("#cbobkstaff").val();
        //Commented by ZawZO on 18 Dec 2015, to disable signature pad temponary
        var imgfile = "";

        if ($('#hidsignfilename').val().length > 0) {
            imgfile = $('#hidsignfilename').val();
        }
        else {
            imgfile = "";
        }
        obj.signaturefile = imgfile;
        //Changed by ZawZO on 7 Dec 2015
        obj.status = $('#status').val();
        obj.remark = $('#txtRemark').val();
        obj.total_subtotal = $("#txtSubTotal").val().trim();
        obj.total_salestax = $("#txtGST").val().trim();
        obj.total_discount = $("#txtDiscount").val().trim();
        obj.total_total = parseFloat($("#txtGrandTotal").val());
        obj.changes = $("#txtChange").val().trim();
        var tsellprice = 0;
        var tac = 0;
        var tab = 0;
        var tsc = 0;
        var i = 0;
        var itemcount = 0;
        var itemCollection = new Array();

        $('#tblItem > tbody > tr').each(function (i, row) {
            i = i + 1;
            var tds = $(row).find('td');
            if (tds.eq(9).html().trim() != "") {
                itemcount++;
                var item = new Object();
                item.lineno = i;
                item.id = tds.eq(1).html();
                if (item.id != "" || item.id != 0) itemidArray += item.id + ",";
                item.productid = tds.eq(2).html();
                item.productcode = tds.eq(3).html();
                item.productdesc = tds.eq(4).html();
                item.servicecommission = tds.eq(5).html();
                item.unitprice = tds.eq(6).html();
                item.qty = tds.eq(7).html();
                item.uom = tds.eq(8).html();
                item.discountpercent = tds.eq(9).html();
                item.discountamount = tds.eq(10).html();
                item.lineamount = tds.eq(11).html();
                item.detailid = tds.eq(25).html();
                var staffCollection = new Array();
                var si = 0;
                for (si = 0; si < Staffs.length; si++) {
                    if (Staffs[si].oldpid == item.lineno) {
                        var sobj = new Object();
                        sobj = Staffs[si];
                        staffCollection.push(sobj);
                        Staffs.splice(si, 1);
                        si--;
                    }
                }
                item.salestaffs = staffCollection;
                itemCollection.push(item);
            }
        });

        if (itemcount <= 0) {
            $("#btnReprint").removeAttr("disabled");
            var msg = "Please key in the item.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }
        obj.items = itemCollection;

        var pitemidArray = "";
        var paymentCollection = new Array();
        var pcount = 0;
        i = 0;
        $('#tblPayment > tbody > tr').each(function (i, row) {
            i = i + 1;
            var tds = $(row).find('td');
            pcount++;
            var item = new Object();
            item.id = tds.eq(5).html();
            if (item.id != "" || item.id != 0) pitemidArray += item.id + ",";
            item.paymentmode = tds.eq(1).html();
            item.amountrecd = tds.eq(2).html();
            paymentCollection.push(item);
        });

        obj.payments = paymentCollection;

        $.ajax({
            url: '@Url.Action("SOPOSSave", "POS")',
            data: JSON.stringify({ pos: obj, resource: $('#rcode').val(), soid: CurSOID, orderid: $('#hidsoid').val(), bal: $('#txtBalance').val(), itemids: itemidArray, pitemids: pitemidArray, insertToRedemption: $('#insertToRedemption').val() }),
            type: 'POST',
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            async: false,
            success: function (data) {
                if (data) {
                    CurSOID = 0;
              
                    var result = data.split(",");
           
                    if (result.length == 5) {
                        if (result[0] == "SUCCESS" || result[0] == "POSTFAIL") {
                            //Added by ZawZO on 1 Feb 2016

                            $('#posid').val(result[1]);
                       
                            var msg = "Successfully Save #" + result[2];
                            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"success"}';
                            if (pflag == 1)
                            { msg = "Successfully Close #" + result[2]; }
                            if (result[0] == "POSTFAIL") {
                                msg = "Closing is not successful #" + result[2];
                                attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                            }
                            if ($('#status').val().toUpperCase() == "ACTIVE")
                                $("#btnPOSClose").removeAttr("disabled");

                            $('#txtposno').html("POS# : " + result[2]);
                            $('#posid').val(result[1]);

                            showMessage(attrvalue);
                            $("#btnReprint").removeAttr("disabled");
                            $('#status').val(result[3]);
                            $("#tblItem > tbody").html("");

                            NewPOSFromSO(result[4], 1);

                            if ($("#txtBalance").val() >= 0) {
                                $("#btnPay").attr("disabled", false);
                                $("#btnRefund").attr("disabled", true);
                            }
                            else {
                                $("#btnPay").attr("disabled", true);
                                $("#btnRefund").attr("disabled", false);
                            }
             
                            $('#btnAddItem').attr("disabled", true);
                            $('#btnCatalog').attr("disabled", true);
                            if (pflag == 1) {
                                getSaleStaffs();
                                printReceipt();
                                //Added by ZawZO on 10 Dec 2015
                                showActiveSOList();

                            }
                            else {
                                newPOS();
                            }
                        }
                    }
                    else {
                        var msg = "An error occured while saving. Please contact the administrator.";
                        var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
                        showMessage(attrvalue);
                    }
                }
            },
            error: function (req, status, err) {
                showMessage(err, "error");
                $("#btnReprint").removeAttr("disabled");
                if ($('#status').val().toUpperCase() == "ACTIVE")
                    $("#btnPOSClose").removeAttr("disabled");
            }
        });
    }
    function UpdateOrderStatusPaid() {
        var orderid = $('#hidsoid').val();
        if (orderid != 0) {
            $.ajax({
                url: '@Url.Action("UpdateOrderStatusPaid", "POS")',
                data: JSON.stringify({ id: orderid }),
                type: 'POST',
                async: false,
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    if (data == "SUCCESS") { }
                    else { }
                },
                error: function (req, status, err) {
                    showMessage(err, "error");
                }
            });
        }
    }
    function printReceipt() {
        var posid = $('#posid').val();
        var cdesc = $('#c').val();
        var pdesc = $('#b').val();
        var coname = $('#hidconame').val();
        var coaddress = encodeURIComponent($('#hidcoaddress').val());
        var email = $('#hidemail').val();
        var tel = $('#hidtel').val();
        var fax = $('#hidfax').val();
        var coreg = $('#hidcoregno').val();
        var gstreg = $('#hidgstregno').val();
        var discdesc;

        discdesc = 'Discount';
        var url = "../Reports/POSReceipt.aspx?id=" + posid + "&cdesc=" + cdesc + "&pdesc=" + pdesc + "&cname=" + coname + "&caddress=" + coaddress + "&ctel=" + tel + "&cfax=" + fax + "&cemail=" + email + "&coreg=" + coreg + "&gstreg=" + gstreg + "&discdesc=" + discdesc;
        window.open(url, 'popup_window', 'width=900,height=600,left=10,top=10,resizable=yes');
        UpdatePrintCount();
    }

    function UpdatePrintCount() {
        var rcode = $('#rcode').val();
        var posid = $('#posid').val();
        $.ajax({
            url: '@Url.Action("UpdatePrintCount", "POS")',
            data: JSON.stringify({ posid: posid, resource: $('#rcode').val() }),
            type: 'POST',
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                if (data != "FAIL") {
                    $('#txtprintcount').val(data);
                }
            },
            error: function (req, status, err) {
                showMessage(err, "error");
                $("#btnReprint").removeAttr("disabled");
            }
        });
    }
    //Added by ZawZO on 17 Sep 2015
    function ShowSignaturePad() {
        var currentdate = new Date();
        var fileName = "Sign_" + currentdate.getFullYear() + "_" + currentdate.getMonth() + "_" + currentdate.getDay() + "_" + currentdate.getHours() + currentdate.getMinutes() + currentdate.getSeconds() + currentdate.getMilliseconds();
        $('#hidsignfilename').val(fileName + '.jpg');
        window.open("../Reports/Signature_Pad.aspx?signFileName=" + fileName, "_blank", "width=350, height=200");
        //$.ajax({
        //    url: '@Url.Action("showSignaturePad", "POS")',
        //    success: function (data) { }
        //});
    }
    //Added by ZawZO on 18 Sep 2015
    function UploadSignatureImg() {
        var posid = $('#posid').val();
        $.ajax({
            url: '@Url.Action("UploadSignatureImg", "POS")',
            data: { posid: posid },
            success: function (data) { }
        });
    }
    function EditPayment(paramtr) {
        selectedPaymentTr = paramtr;
        $('#txtplineno').val($(paramtr).closest('tr').find('td').eq(0).html());
        $('#cboPayment').val($(paramtr).closest('tr').find('td').eq(1).html())
        $('#txtPaidAmount').val($(paramtr).closest('tr').find('td').eq(2).html());
        $('#Payment_dialog-modal').dialog('open');
    }
    function showMessage(attrvalue) {
        $('#btnMessage').attr('data-noty-options', attrvalue);
        $('#btnMessage').trigger("click");
    }
    function newPOS() {
        var url = "POS";
        var rcode = $('#rcode').val();
        var form = $('<form action="' + url + '" method="post">' +
          '<input type="hidden" name="id"  id="id" value="' + 0 + '" />' +
          '<input type="hidden" name="rcode"  id="rcode" value="' + rcode + '" />' +
          '</form>');
        $('body').append(form);
        $(form).submit();
    }

    function getNewCardNo() {
        $.ajax({
            url: '@Url.Action("getMemberNewCardNo", "CusSup")',
            type: 'POST',
            success: function (data) {
                $('#txtcardno').val(data);
            },
            error: function (ts) { alert(ts.responseText) }
        });
    }
    function OpenMemberDialog() {
        $('#txtcardno').val("");
        $('#txtname').val("");
        $('#txtnric').val("");
        $('#txtTempcardno').val("");
        $('#btnCardSave').removeAttr("disabled");
        getNewCardNo();
        $('#Member_dialog-modal').dialog('open');

    }

    function OpenProductCreation() {

        var selStaff = $("#cbobkstaff").val();
        if (selStaff == '' || selStaff == 'undefined') {
            var msg = "Please select staff.";
            var attrvalue = '{"text":"' + msg + '","layout":"topRight","type":"error"}';
            showMessage(attrvalue);
            return false;
        }
        else {
            $.ajax({
                url: '@Url.Action("setSessionStaff", "POS")',
                data: JSON.stringify({ id: selStaff }),
                type: 'POST',
                success: function (data) {

                },
                error: function (ts) { alert(ts.responseText) }
            });

            window.open("../Product/ProductSave");

        }
    }

    function closeMemberDialog() {
        $('#Member_dialog-modal').dialog("close");
    }


    function MemberValidation() {
        if ($('#txtname').val().trim() == "") {
            alert("Please key in Member Names.");
            $('#txtname').focus();
            return false;
        }

        if ($('#txtnric').val().trim() == "") {
            alert("Please key in NRIC.");
            $('#txtnric').focus();
            return false;
        }

        if ($('#txtmobile').val().trim() == "") {
            alert("Please key in NRIC.");
            $('#txtmobile').focus();
            return false;
        }
        return true;
    }


    function CHKDuplicateNRICSaveMembership() {
        var mid = 0;
        var nric = $('#txtnric').val();

        $.ajax({
            url: '@Url.Action("isDuplicateNRIC", "CusSup")',
            data: JSON.stringify({ nric: nric, mid: mid }),
            type: 'POST',
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            async: false,
            success: function (data) {
                if (data == "1") {
                    alert("NRIC already exist.Please Key  in agin.");
                    $('#txtnric').focus();
                    return false;
                }
                else {
                    SaveMember();
                }
            },
            error: function (req, status, err) {
                return false;
            }
        });
    }

    function SaveMember() {
        var rcode = $('#resource').val();
        if (MemberValidation() == false) return false;
        $('#btnCardSave').attr("disabled", "");
        var name = $('#txtname').val();
        var nric = $('#txtnric').val();
        var ctype = $('#cbocardtype').val();
        var cno = $('#txtcardno').val();
        var mid = 0;
        var rcode = $('#rcode').val();
        var obj = new Object();

        obj.id = mid;
        obj.cussupname = $('#txtname').val();
        obj.nric = $('#txtnric').val();
        obj.status = 'Active';
        obj.photo = "";
        obj.canemail = 0;
        obj.cansms = 0;
        obj.cancall = 0;
        obj.mobile = $('#txtmobile').val();

        var cardCollection = new Array();
        var b1 = new Object();
        b1.id = 0;
        b1.cardtype = $('#cbocardtype').val();
        b1.expirydate = $('#txtExpiryDate').val();
        cardCollection.push(b1);
        obj.cards = cardCollection;
        $.ajax({
            url: '@Url.Action("POSMembershipSave", "CusSup")',
            data: JSON.stringify({ m: obj, rcode: rcode }),
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            type: 'POST',
            async: false,
            success: function (data) {
                if (data) {
                    var result = data.split(",");
                    if (result.length == 4) {
                        if (result[0] == "SUCCESS") {
                            selectedcust = new Object();
                            selectedcust.id = result[1];
                            selectedcust.inhousecode = result[2];
                            selectedcust.cussupname = result[3];
                            $('#txtCustomer').val(selectedcust.cussupname + "(" + selectedcust.inhousecode + ")");
                            closeMemberDialog();
                        }
                    }
                }
            },
            error: function (ts) { alert(ts.responseText); alert("Fail to update cardno."); $('#dialog-modal').dialog("close"); }
        });
    }

    function showPaymentList() {
        $('#divPaymentList').empty();

        $.ajax({
            url: '@Url.Action("getPreviousPaymentSOPOS", "POS")',
            data: { posid: $('#posid').val(), soid: $('#hidsoid').val() },
            type: 'POST',
            success: function (data) {
                populatePaymentList(data);
                $('#mdlPaymentList').modal('show');

            },
            error: function (ts) { showMessage(ts.responseText, "error") }
        });
    }

    function populatePaymentList(data) {

        var Htmlstr = "";
        var closeHtml = "</tbody></table>";

        Htmlstr += "<tr>";
        Htmlstr += "<th style='Display:none;'>id</th>";
        Htmlstr += "<th style='width:20px;text-align:left;'>Date</th>";
        Htmlstr += "<th style='width:60px;text-align:left;'>POS#</th>";
        Htmlstr += "<th style='width:40px;text-align:center;'>Sub Total</th>";
        Htmlstr += "<th style='width:40px;text-align:center;'>GST</th>";
        Htmlstr += "<th style='width:40px;text-align:center;'>Discount</th>";
        Htmlstr += "<th style='width:40px;text-align:center;'>Refund</th>";
        Htmlstr += "<th style='width:40px;text-align:center;'>Paid</th>";
        Htmlstr += "<th style='width:40px;text-align:center;'>Total Amt</th>";
        Htmlstr += "<th style='width:10px;'>Status</th>";
        Htmlstr += "</tr></thead><tbody>";

        for (var x = 0; x < data.length; x++) {

            Htmlstr += "<tr id=" + data[x].id + "'>";
            Htmlstr += "<td style='Display:none;'>" + data[x].id + "</td>";

            var ctmp = getDateFromAspString(data[x].createdate);
            var createddate = ctmp.getDate() + "/" + (ctmp.getMonth() + 1) + "/" + ctmp.getFullYear() + ' ' + ctmp.getHours() + ":" + ctmp.getMinutes() + ":" + ctmp.getSeconds();

            Htmlstr += "<td style='text-align:left;'>" + createddate + "</td>";
            Htmlstr += "<td style='text-align:left;'>" + data[x].resourcecode + "</td>";
            Htmlstr += "<td style='text-align:right;'>" + data[x].total_subtotal.toFixed(2) + "</td>";
            Htmlstr += "<td style='text-align:right;'>" + data[x].total_salestax.toFixed(2) + "</td>";
            Htmlstr += "<td style='text-align:right;'>" + data[x].total_discount.toFixed(2) + "</td>";
            Htmlstr += "<td style='text-align:right;'>" + data[x].total_amountrefund.toFixed(2) + "</td>";
            Htmlstr += "<td style='text-align:right;'>" + data[x].total_total.toFixed(2) + "</td>";
            Htmlstr += "<td style='text-align:right;'>" + data[x].total_amount.toFixed(2) + "</td>";
            Htmlstr += "<td style='text-align:center;'>" + data[x].status + "</td>";
            Htmlstr += "</tr>";
        }

        OpenHtmlstr = "<table class='table table-bordered' id ='tblPaymentList'><thead>";
        $('#divPaymentList').html(OpenHtmlstr + Htmlstr + closeHtml);

    }

</script>

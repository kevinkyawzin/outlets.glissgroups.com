@*@model IEnumerable<BigMac.Models.Product_m_Productdtl>*@

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var i = 0;
}

<div class="row">
    <div style="display:none">
        <div class="box">
            <div class="box-header" data-original-title>
                <h2></h2>
                <div class="box-icon">
                    <a href="#" class="btn-setting"><i class="fa fa-wrench"></i></a>
                    <a href="#" class="btn-minimize"><i class="fa fa-chevron-up"></i></a>
                    <a href="#" class="btn-close"><i class="fa fa-times"></i></a>
                </div>
            </div>
            <div class="box-content">

                <div class="box col-sm-3">
                    <input type="text" class="form-control" placeholder="By Mobile" id="txtMobile" value="@ViewBag.Mobile" />
                </div>
                <div class="box col-sm-6">
                    <input type="text" class="form-control" placeholder="By Member Code/Name/NRIC" id="txtDesc" value="@ViewBag.Filter" />
                </div>
                <div class="box col-sm-2">
                    <button type="button" class="btn btn-primary" onclick="populateMemberList();"> Search </button>
                </div>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>

</div>

<div class="row">
    <div>
        <div class="box">
            <div class="box col-sm-3" style="color:blueviolet;font-weight:700;height:30px;vertical-align:middle;text-align:right;padding-right:10px;padding-top:5px;">
                Department
            </div>
                <div class="box col-sm-3">
                    <input type="hidden" id="hidDeptName" value="0" />
                    @Html.DropDownList("cboDepartmentname", new SelectList(@ViewBag.DepartmentOptions, "departmentname", "departmentname"), new { @class = "form-control" })
                </div>
                <div class="clearfix"></div>
            </div>
    </div>
</div>
            <div class="row">

            </div>


            <div class="row">
                <div class="col-lg-12">
                    <div class="box">

                        <div class="box-header" data-original-title>
                            <h2><i class="fa fa-list-alt"></i><span class="break"></span>Member Listing</h2>
                            <div class="box-icon">
                                <a href="#" class="btn-setting"><i class="fa fa-wrench"></i></a>
                                <a href="#" class="btn-minimize"><i class="fa fa-chev1on-up"></i></a>
                                <a href="#" class="btn-close"><i class="fa fa-times"></i></a>
                            </div>
                        </div>
                        <div class="box-content">
                            <input type="hidden" id="mcode" value="0" />
                            <div id="divMember">
                                <table class='table table-striped table-bordered' id="tblMember" width="100%">
                                    <thead>
                                        <tr>
                                            <th style='width: 120px;'>Member Code</th>
                                            <th style='width: 150px;'>Branch</th>
                                            <th style='width: 200px;'>Name</th>
                                            <th style='width: 200px;'>Department</th>
                                            <th style='width: 120px;'>Mobile</th>
                                         
                                            @*<th colspan='2' style='text-align:center'>Balance</th>*@
                                            @*<th colspan='2' style='text-align:center'>Reserved</th>*@
                                            @*<th colspan='2' style='text-align:center'>Available</th>*@
                                            @*<th style='display:none'>NRIC</th>*@
                                            <th></th>
                                            <th></th>
                                            @*<th rowspan ='2' style='width:60px;'></th>*@
                                        </tr>
                                        @*<tr>*@
                                        @*<th>@ViewBag.CitiDesc</th>*@
                                        @*<th>@ViewBag.BonusDesc</th>*@
                                        @*<th>@ViewBag.CitiDesc</th>*@
                                        @*<th>@ViewBag.BonusDesc</th>*@
                                        @*<th>@ViewBag.CitiDesc</th>*@
                                        @*<th>@ViewBag.BonusDesc</th>*@
                                        @*</tr>*@
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div> @*box-content*@
                    </div> @*box*@
                </div>
            </div> @*row*@

            <div class="row">
                <div class="col-lg-12">
                    <div class="box">

                        <div class="col-sm-2" data-rcode="TOPUP" style="display:none;">
                            <a class="quick-button" onclick="TopUpFunction(this, 2, $('#mcode').val());" data-rcode="TOPUP" style="display:none;">
                                <i class="fa fa-ticket"></i>
                                <p>Club</p>
                            </a>
                        </div>

                        <div class="col-sm-2" style="display:none;" data-rcode="REDEEM">
                            <a class="quick-button" data-rcode="REDEEM" onclick="RedeemFunction(this,2,$('#mcode').val());" style="display:none;">
                                <i class="fa fa-ticket"></i>
                                <p>Redeem</p>
                            </a>
                        </div>

                        <div class="col-sm-2" data-rcode="CREATEMEMBER" style="display:none;">
                            <a class="quick-button" onclick="CreateMemberFunction(this);" data-rcode="CREATEMEMBER">
                                <i class="fa fa-user"></i>
                                <p>Create Member</p>
                            </a>
                        </div>

                        @*<div class="col-sm-2" data-rcode="PROMOTIONLISTING" style="display:none;">
                                <a class="quick-button" data-rcode="PROMOTIONLISTING" onclick="PromotionListingFunction(this);">
                                    <i class="fa fa-list-alt"></i>
                                    <p>Promotion Listing</p>
                                </a>
                            </div>

                            <div class="col-sm-2" data-rcode="PRODUCTLISTING" style="display:none;">
                                <a class="quick-button" data-rcode="PRODUCTLISTING" href="~/Product/ProductListing?rcode=ProductListing&ptype=%">
                                    <i class="fa fa-list-alt"></i>
                                    <p>Product Listing</p>
                                </a>
                            </div>*@

                        <div class="col-sm-2">
                            <a class="quick-button" href="~/Home/Index">
                                <i class="fa fa-home"></i>
                                <p>Home</p>
                            </a>
                        </div>

                    </div>
                </div>
            </div>

            <button id="btnMessage" class="btn btn-primary noty" data-noty-options='{"text":"Please select Member","layout":"topRight","type":"error"}' style="display:none;">Top Right</button>

            <div id="Balance_dialog-modal">
                <div class="col-lg-12" id="divBalDialog" style="overflow-style:scrollbar;">
                    <div style="width:100%;background-color: #EEE;padding: 10px 10px 10px;font-weight:bold;color:black;">
                        Summary
                    </div>
                    <div style="padding-top:20px;">
                        <table>
                            <tr>
                                <td style="width:140px;"></td>
                                <td>Gliss Pts</td>
                                <td>Rwd Pts</td>
                            </tr>
                            <tr>
                                <td style="width:120px;">Balance</td>
                                <td style="padding-bottom:10px;"><div class="controls"><input type='text' class='form-control' id="txtCBalance" style="text-align:right" disabled="disabled" /></div></td>
                                <td style="padding-bottom:10px;"><div class="controls"><input type='text' class='form-control' id="txtBBalance" style="text-align:right" disabled="disabled" /></div></td>
                            </tr>
                            <tr>
                                <td style="width:120px;">Reserved Amount</td>
                                <td style="padding-bottom:10px;"><div class="controls"><input type='text' class='form-control' id="txtCReserved" style="text-align:right" disabled="disabled" /></div></td>
                                <td style="padding-bottom:10px;"><div class="controls"><input type='text' class='form-control' id="txtBReserved" style="text-align:right" disabled="disabled" /></div></td>
                            </tr>
                            <tr>
                                <td style="width:120px;">Available</td>
                                <td style="padding-bottom:10px;"><div class="controls"><input type='text' class='form-control' id="txtCAvailable" style="text-align:right" disabled="disabled" /></div></td>
                                <td style="padding-bottom:10px;"><div class="controls"><input type='text' class='form-control' id="txtBAvailable" style="text-align:right" disabled="disabled" /></div></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-lg-12" style="padding: 10px 10px 10px;text-align:right;">
                        <button type="button" id="btnStaffClose" onclick="closeBalanceDialog();" class="btn btn-primary" style="width:100px;">Close</button>
                    </div>
                </div>
            </div>

            <script type="text/javascript">
                var load = 1;
                $(document).ready(function () {

                    $('#Balance_dialog-modal').dialog({
                        //position: [280, 120],
                        modal: true,
                        autoOpen: false,
                        open: function (event, ui) {
                            $('.ui-widget-header').removeClass('ui-widget-header').htm('');
                        },
                    });

                    var moptions = {
                        modal: true,
                        height: 350,
                        minHeight: 350,
                        maxHeight: 350,
                        width: 530,
                        minWidth: 530,
                        maxWidth: 530,
                        dialogClass: "sfFormwrapper"
                    };

                    $('#Balance_dialog-modal').dialog('option', moptions);

                    $("#cboDepartmentname").change(function () {
                        getMemberList();
                    });
                });

                getMemberList();

                function getMemberList() {
                    var f = $('#txtDesc').val();
                    var mno = $('#txtMobile').val();
                    var s = $('#txtDesc').val();

                    var oTable = $('#tblMember').dataTable({
                        "iDisplayLength": 10, // Default No of Records per page on 1st load
                        "aLengthMenu": [[10, 25, 50, 100], [10, 25, 50, 100]], // Set no of records in per page
                        "aaSorting": [[0, "createdate"], [1, "resourcecode"], [2, "productdesc"]], // Default 1st column sorting
                        "bProcessing": true,
                        //"bJQueryUI": true, //No themeroller
                        "aoColumnDefs": [
                            /*{
                                "aTargets": [4,5,6,7,8,9],
                                "mRender": function (data, type, full) {

                                    var str = "<div style='text-align:right;padding-right:10px;width:100%;'>" + data + "</div>";
                                    return str;
                                }
                            },
                            { "bVisible": false, "aTargets": [10,11] }*/
                             {
                                  "aTargets": [0, 1, 2, 3, 4],
                                  "mRender": function (data, type, full) {
                                      return data;
                                  }
                              },
                             
                              
                            {
                                "aTargets": [5],
                                "mRender": function (data, type, full) {
                                    var str = "<a class='btn btn-success' title ='Click to see balance.' onclick='OpenBalanceDialog(" + data + ");'>Show Balance</a>";
                                    return str;
                                }
                            },
                            {
                                "aTargets": [6],
                                "mRender": function (data, type, full) {

                                    var str = "<a class='btn btn-info' title ='Click to go to details.' onclick='gotoDetails(" + data + ",\"" + full.status + "\");'>Show Details</a>";
                                    return str;
                                }
                            },
                           
                        ], //, { "bVisible": false, "aTargets": [1] }], // Hide Column
                        "sAjaxSource": 'getMemberListWithPaging?filter=' + f + "&department=" + $("#cboDepartmentname").val() +"&mobile=" + mno,
                        "bStateSave": true, // Remember paging & filters
                        "bDeferRender": false,
                        "bServerSide": true,
                        "bDestroy": true,
                        //"bRetrieve": true,
                        //"bDestroy": true,
                        "oSearch": { "sSearch": "" },
                        //"sPaginationType": "full_numbers", // Include page number
                        "aoColumns": [
                                     { "sWidth": "100px", "mDataProp": "inhousecode" }, 
                                     { "sWidth": "100px", "mDataProp": "branchcode" },
                                     { "sWidth": "220px", "mDataProp": "cussupname" }, 
                                     { "sWidth": "150px", "mDataProp": "departmentname" },
                                     { "sWidth": "120px", "mDataProp": "mobile" },
                                   /*
                                     { "sWidth": "120px", "mDataProp": "CBalance" }, { "sWidth": "120px", "mDataProp": "BBalance" },
                                     { "sWidth": "120px", "mDataProp": "CReserved" }, { "sWidth": "120px", "mDataProp": "BReserved" },
                                     { "sWidth": "120px", "mDataProp": "CAvailable" }, { "sWidth": "120px", "mDataProp": "BAvailable" },
                                     { "mDataProp": "nric" }, */
                                     { "sWidth": "80px", "mDataProp": "id" }, { "sWidth": "80px", "mDataProp": "id" }
                        ],
                        "fnDrawCallback": function () {
                            /*$("#tblMember tbody tr").click(function () {
                                var tds = $(this).find("td");
                                window.location.href = "MembershipEnquiry?rcode=MEMBER&mcode=" + tds.eq(0).html();
                            });*/

                            $('#tblMember tbody tr').each(function (index) {
                                this.setAttribute('title', "Click to view detail.");
                                if (index == 0) {
                                    var tds = $(this).find("td");
                                    $('#mcode').val(tds.eq(0).html());
                                }
                            });
                        }
                    });
                }

                function RemoveRow(paramtr, cid) {
                    var result = confirm("Are you sure you want to void as it will collapse all linkings related with this product?");
                    if (result == true) {
                        $(paramtr).closest('tr').remove();
                    }
                }
                //Added by ZawZO on 16 Sep 2015
                function OpenBalanceDialog(mid) {
                    $('#txtCBalance').val('');
                    $('#txtBBalance').val('');
                    $('#txtCReserved').val('');
                    $('#txtBReserved').val('');
                    $('#txtCAvailable').val('');
                    $('#txtBAvailable').val('');
                    getMemberbalance(mid);
                    $('#Balance_dialog-modal').dialog('open');
                }
                //Added by ZawZO on 16 Sep 2015
                function closeBalanceDialog() {
                    $('#Balance_dialog-modal').dialog("close");
                }
                //Added by ZawZO on 16 Sep 2015
                function getMemberbalance(mid) {
                    $.ajax({
                        url: '@Url.Action("getMemberList", "CusSup")',
                        data: { mid: mid },
                        type: 'POST',
                        success: function (data) {
                            if (data.length > 0) {
                                $('#txtCBalance').val(data[0].CBalance);
                                $('#txtBBalance').val(data[0].BBalance);
                                $('#txtCReserved').val(data[0].CReserved);
                                $('#txtBReserved').val(data[0].BReserved);
                                $('#txtCAvailable').val(data[0].CAvailable);
                                $('#txtBAvailable').val(data[0].BAvailable);
                            }
                            else {
                                $('#txtCBalance').val('');
                                $('#txtBBalance').val('');
                                $('#txtCReserved').val('');
                                $('#txtBReserved').val('');
                                $('#txtCAvailable').val('');
                                $('#txtBAvailable').val('');
                            }
                        },
                        error: function (ts) { alert(ts.responseText) }
                    });
                }
                //Added by ZawZO on 16 Sep 2015
                function gotoDetails(mid, status) {
                    if (status == "Active") {
                        var mbcode = "";
                        $.ajax({
                            url: '@Url.Action("getMemberList", "CusSup")',
                            data: { mid: mid },
                            type: 'POST',
                            success: function (data) {
                                if (data.length > 0) {
                                    mbcode = data[0].inhousecode;
                                    window.location.href = "MembershipEnquiry?rcode=MEMBER&mcode=" + mbcode;
                                }
                            },
                            error: function (ts) { alert(ts.responseText) }
                        });
                    }
                    else {
                        showMessage('This user is suspended.', "error");
                    }

                }

                function showMessage(attrvalue) {
                    $('#btnMessage').attr('data-noty-options', attrvalue);
                    $('#btnMessage').trigger("click");
                }
            </script>
